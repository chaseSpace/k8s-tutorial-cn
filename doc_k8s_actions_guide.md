# K8så®æˆ˜ï¼ˆæ›´æ–°ä¸­ï¼‰

æœ¬æ–‡ä»¥ä¸€ä¸ªç®€å•Goåº”ç”¨ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä¸€æ­¥æ­¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨Kubernetesã€‚

æ³¨æ„æ–‡ä¸­å‘½ä»¤è¡Œä½¿ç”¨çš„`kk`æ˜¯kubectlçš„åˆ«åã€‚

## 1. éƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨

### 1.1 ç¼–å†™ä¸€ä¸ªç®€å•çš„Goåº”ç”¨

- [main_multiroute.go](k8s_actions_guide/version1/main_multiroute.go)

è¿™ä¸ªGoåº”ç”¨çš„é€»è¾‘å¾ˆç®€å•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ”¯æŒä»é…ç½®åŠ¨æ€åŠ è½½è·¯ç”±çš„HTTPæœåŠ¡å™¨ã€‚åˆå§‹åŒ–æ­¤åº”ç”¨ï¼š

```shell
go mod init k8s_action
go mod tidy
```

### 1.2 ä½¿ç”¨ConfigMapå­˜å‚¨é…ç½®

ä¼ ç»Ÿæ–¹å¼ä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸å°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨å•ç‹¬æ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™åº”ç”¨ã€‚

åœ¨K8sç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†é…ç½®è¿ç§»åˆ°ConfigMapä¸­ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…å·æŒ‚è½½çš„æ–¹å¼ä¼ é€’ç»™åº”ç”¨ã€‚

- [k8s-manifest/configmap.yaml](k8s_actions_guide/version1/k8s-manifest/configmap.yaml)

æ³¨æ„å°†K8sæ¸…å•æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„ç›®å½•ï¼ˆå¦‚`k8s-manifest`ï¼‰ä¸‹ï¼Œä»¥ä¾¿åç»­æ‰¹é‡éƒ¨ç½²ã€‚

> è™½ç„¶å¯ä»¥åœ¨Dockerfileä¸­ç›´æ¥å°†é…ç½®æ–‡ä»¶æ‰“åŒ…åˆ°å®¹å™¨ï¼Œä½†è¿™ç§æ–¹å¼é€šå¸¸ä¼´éšçš„æ˜¯å°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ä»£ç åº“ä¸­ï¼Œè¿™å¹¶ä¸ç¬¦åˆK8sçš„æœ€ä½³å®è·µã€‚
> åŒæ—¶ä¹Ÿä¸é€‚åˆç”¨æ¥å­˜å‚¨é‡è¦é…ç½®ã€‚

å¦‚æœæœ‰é‡è¦çš„é…ç½®ï¼Œæ¯”å¦‚è¯ä¹¦ç§é’¥æˆ–Tokenä¹‹ç±»çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·ä½¿ç”¨Secretæ¥å­˜å‚¨ã€‚

### 1.3 ä½¿ç”¨Secretå­˜å‚¨æ•æ„Ÿä¿¡æ¯

é€šå¸¸ä¸€ä¸ªåç«¯åº”ç”¨ä¼šé“¾æ¥åˆ°æ•°æ®åº“æ¥å¯¹å¤–æä¾›APIæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºåº”ç”¨æä¾›æ•°æ®åº“å¯†ç ã€‚

è™½ç„¶ConfigMapä¹Ÿå¯ä»¥å­˜å‚¨æ•°æ®ï¼Œä½†Secretæ›´é€‚åˆå­˜å‚¨æ•æ„Ÿä¿¡æ¯ã€‚åœ¨K8sä¸­ï¼ŒSecretç”¨æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å¯†ç ã€Tokenç­‰ã€‚

- [k8s-manifest/secret.yaml](k8s_actions_guide/version1/k8s-manifest/secret.yaml)

#### 1.3.1 åŠ å¯†å­˜å‚¨Secretä¸­çš„æ•°æ®

è™½ç„¶Secretå£°ç§°ç”¨æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯éåŠ å¯†åœ°å­˜å‚¨åœ¨é›†ç¾¤å­˜å‚¨ï¼ˆetcdï¼‰ä¸Šçš„ã€‚
ä»»ä½•æ‹¥æœ‰ API è®¿é—®æƒé™çš„äººéƒ½å¯ä»¥æ£€ç´¢æˆ–ä¿®æ”¹ Secretã€‚

è¯·å‚è€ƒä»¥ä¸‹é“¾æ¥æ¥åŠ å¯†å­˜å‚¨Secretä¸­çš„æ•°æ®ï¼š

- [K8s Secrets](https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/)
- [åŠ å¯† K8s Secrets çš„å‡ ç§æ–¹æ¡ˆ](https://www.cnblogs.com/east4ming/p/17712715.html)

### 1.4 ä½¿ç”¨Dockerfileæ‰“åŒ…åº”ç”¨

è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªDockerfileæ–‡ä»¶å°†Goåº”ç”¨æ‰“åŒ…åˆ°ä¸€ä¸ªé•œåƒä¸­ï¼Œä»¥ä¾¿åç»­éƒ¨ç½²ä¸ºå®¹å™¨ã€‚

- [Dockerfile](k8s_actions_guide/version1/Dockerfile)

æ³¨æ„åœ¨Dockerfileä¸­å®šåˆ¶ä½ çš„Goç‰ˆæœ¬ã€‚

### 1.5 å‡†å¤‡é•œåƒä»“åº“

ä¸ºäº†æ–¹ä¾¿åç»­éƒ¨ç½²ï¼Œæˆ‘ä»¬éœ€è¦å°†æ‰“åŒ…å¥½çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ä¸­ã€‚

ä½œä¸ºæ¼”ç¤ºï¼Œæœ¬æ–‡ä½¿ç”¨Docker Hubä½œä¸ºé•œåƒä»“åº“ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†åº”ç”¨å®‰å…¨ä»¥åŠæé«˜é•œåƒæ‹‰å–é€Ÿåº¦ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ï¼ˆæ­å»ºï¼‰ç§æœ‰çš„ä»“åº“ã€‚

å¸¸ç”¨çš„å¼€æºé•œåƒä»“åº“æœ‰Docker Registryå’ŒHarborã€‚å¦‚æœä½ ä½¿ç”¨äº‘å‚å•†çš„æ‰˜ç®¡é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¬æä¾›çš„é•œåƒä»“åº“äº§å“ã€‚

### 1.6 ç¼–å†™Deploymentæ¨¡æ¿

Deploymentæ˜¯K8sä¸­æœ€å¸¸ç”¨çš„ç”¨æ¥éƒ¨ç½²å’Œç®¡ç†åº”ç”¨çš„èµ„æºå¯¹è±¡ã€‚å®ƒæ”¯æŒåº”ç”¨çš„å¤šå‰¯æœ¬éƒ¨ç½²ä»¥åŠæ•…éšœè‡ªæ„ˆèƒ½åŠ›ã€‚

- [k8s-manifest/deployment.yaml](k8s_actions_guide/version1/k8s-manifest/deployment.yaml)

ä½ å¯ä»¥åœ¨æ¨¡æ¿ä¸­å®šåˆ¶åº”ç”¨çš„å‰¯æœ¬æ•°é‡ã€èµ„æºé™åˆ¶ã€ç¯å¢ƒå˜é‡ç­‰é…ç½®ã€‚

> æ³¨æ„ï¼šä½ å¯èƒ½çœ‹æƒ…å†µéœ€è¦ä¿®æ”¹æ¨¡æ¿ä¸­çš„namespaceï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨defaultå‘½åç©ºé—´ã€‚å› ä¸ºè¿™ä¸åˆ©äºå¯¹ä¸åŒç±»å‹çš„åº”ç”¨è¿›è¡Œéš”ç¦»å’Œèµ„æºé™åˆ¶ã€‚
> æ¯”å¦‚ï¼Œä½ å¯ä»¥ä¸ºåç«¯æœåŠ¡å’Œå‰ç«¯æœåŠ¡åˆ†åˆ«ä½¿ç”¨backendå’Œfrontendå‘½åç©ºé—´ã€‚

**ä¸ºé•œåƒæŒ‡å®šæŒ‡çº¹**  
dockeræ‹‰å–é•œåƒæ—¶æ”¯æŒä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

```shell
docker pull busybox:1.36.1@sha256:7108255e7587de598006abe3718f950f2dca232f549e9597705d26b89b7e7199
# docker images --digests è·å–é•œåƒhash
```

åé¢çš„`sha256:710...`æ˜¯é•œåƒçš„å”¯ä¸€hashã€‚å½“æœ‰äººå†æ¬¡æ¨é€ç›¸åŒtagçš„é•œåƒè¦†ç›–äº†æ—§é•œåƒæ—¶ï¼Œæ‹‰å–æ ¡éªŒå°±ä¼šå¤±è´¥ï¼Œè¿™æ ·å¯ä»¥é¿å…ç‰ˆæœ¬ç®¡ç†æ··ä¹±å¯¼è‡´çš„éƒ¨ç½²äº‹æ•…ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨Deploymentæ¨¡æ¿ä¸­æŒ‡å®šé•œåƒçš„tagçš„åŒæ—¶ä½¿ç”¨`@sha256:...`æ¥æŒ‡å®šé•œåƒçš„hashä»¥æé«˜éƒ¨ç½²å®‰å…¨æ€§ã€‚

### 1.7 ä½¿ç”¨CI/CDæµæ°´çº¿

å®Œæˆå‰è¿°æ­¥éª¤åï¼Œåº”è¯¥å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶å¸ƒå±€ï¼š

```
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ k8s-manifest
â”‚Â Â  â”œâ”€â”€ configmap.yaml
â”‚Â Â  â””â”€â”€ deployment.yaml
â””â”€â”€ main_multiroute.go

```

ç°åœ¨å¯ä»¥å°†å®ƒä»¬æäº¤åˆ°ä»£ç ä»“åº“ä¸­ã€‚ç„¶åä½¿ç”¨CI/CDæµæ°´çº¿æ¥æ„å»ºé•œåƒå¹¶éƒ¨ç½²åº”ç”¨ã€‚

> ä»£ç åº“ä¸­é€šå¸¸ä¼šå­˜å‚¨***éç”Ÿäº§ç¯å¢ƒ**çš„é…ç½®æ–‡ä»¶ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ˆConfigMapå’ŒSecretï¼‰ï¼Œä¸åº”æ”¾åœ¨ä»£ç åº“ä¸­ï¼Œ
> è€Œæ˜¯ä»¥æ‰‹åŠ¨æ–¹å¼æå‰éƒ¨ç½²åˆ°ç¯å¢ƒä¸­ã€‚

å‚è€ƒä¸‹é¢çš„æŒ‡ä»¤æ¥é…ç½®CI/CDæµæ°´çº¿ï¼š

```shell
# å‡è®¾ç°åœ¨å·²ç»è¿›å…¥åˆ°æ„å»ºæœºï¼ˆéœ€è¦è¿æ¥åˆ°k8sé›†ç¾¤ï¼‰

IMAGE=leigg/go_multiroute
TAG=v1 # æ¯æ¬¡è¿­ä»£æ—¶æ‰‹åŠ¨æŒ‡å®š
_IMAGE_=$IMAGE:$TAG

# æ„å»ºé•œåƒï¼ˆå°†leiggæ›¿æ¢ä¸ºä½ çš„é•œåƒä»“åº“åœ°å€ï¼‰
$ docker build . -t $_IMAGE_
...
Successfully built 20e2a541e835
Successfully tagged leigg/go_multiroute:v1

# æ¨é€é•œåƒåˆ°ä»“åº“
$ docker push $_IMAGE_
The push refers to repository [docker.io/leigg/go_multiroute]
f658e2d998f1: Pushed
06d92acd05c8: Pushed
3ce819cc4970: Mounted from library/alpine
v1: digest: sha256:74bf6d94ea9af3e700dfd9fe64e1cc6a04cd75fb792d994c63bbc6d69de9b7ee size: 950

# éƒ¨ç½²åº”ç”¨
$ kk apply -f ./k8s-manifest
configmap/go-multiroute created
deployment.apps/go-multiroute unchanged

# æ›´æ–°åº”ç”¨
$ kk set image deployment/go-multiroute go-multiroute=$_IMAGE_
```

æŸ¥çœ‹åº”ç”¨éƒ¨ç½²æƒ…å†µï¼š

```shell
$ kk get deploy
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
go-multiroute   2/2     2            2           7s
$ kk get po    
NAME                            READY   STATUS    RESTARTS   AGE
go-multiroute-f4f8b64f4-564qq   1/1     Running   0          8s
go-multiroute-f4f8b64f4-v64l6   1/1     Running   0          8s
```

è¿™é‡Œä½¿ç”¨çš„æ˜¯ç®€å•çš„æ»šåŠ¨æ›´æ–°ç­–ç•¥è¿›è¡Œéƒ¨ç½²æ›´æ–°åº”ç”¨ï¼Œå®é™…ç¯å¢ƒä¸­ä½ å¯èƒ½ä¼šæ ¹æ®åº”ç”¨æƒ…å†µè€Œä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–é‡‘ä¸é›€éƒ¨ç½²ï¼Œ
è¿™éƒ¨åˆ†å°†åœ¨æœ¬æ–‡çš„[5.8 éƒ¨ç½²ç­–ç•¥](doc_k8s_actions_guide.md#58-éƒ¨ç½²ç­–ç•¥)ä¸­è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚

### 1.8 ä¸ºæœåŠ¡é…ç½®å¤–éƒ¨è®¿é—®

ç°åœ¨å·²ç»åœ¨é›†ç¾¤å†…éƒ¨éƒ¨ç½²å¥½äº†åº”ç”¨ï¼Œä½†æ˜¯è¿˜æ— æ³•ä»é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚æˆ‘ä»¬éœ€è¦å†éƒ¨ç½²ä»¥ä¸‹èµ„æºæ¥æä¾›å¤–éƒ¨è®¿é—®èƒ½åŠ›ã€‚

- Serviceï¼šä¸ºæœåŠ¡è®¿é—®æä¾›æµé‡çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼ˆæ”¯æŒTCP/UDP/SCTPåè®®ï¼‰
- Ingressï¼šç®¡ç†é›†ç¾¤å¤–éƒ¨è®¿é—®åº”ç”¨çš„è·¯ç”±ç«¯ç‚¹ï¼Œæ”¯æŒHTTP/HTTPSåè®®
    - Ingresséœ€è¦å®‰è£…æŸä¸€ç§Ingressæ§åˆ¶å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¸¸ç”¨çš„æœ‰Nginxã€Traefikã€‚

> å¦‚æœåº”ç”¨æ˜¯éHTTPæœåŠ¡å™¨ï¼ˆå¦‚ä»…TCPã€WebsocketæœåŠ¡ï¼‰ï¼Œåˆ™æ— éœ€Ingressï¼Œä»…ç”¨Serviceæ¥æš´éœ²æœåŠ¡å°±å¯ã€‚

- [k8s-manifest/service.yaml](k8s_actions_guide/version1/k8s-manifest/service.yaml)
- [k8s-manifest/ingress.yaml](k8s_actions_guide/version1/k8s-manifest/ingress.yaml)

éƒ¨ç½²Ingressæ§åˆ¶å™¨çš„æ­¥éª¤è¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯·å‚è€ƒ[åŸºç¡€æ•™ç¨‹](doc_tutorial.md#82-å®‰è£…Nginx-Ingressæ§åˆ¶å™¨)ã€‚

ä¸‹é¢æ˜¯éƒ¨ç½²Serviceå’ŒIngressçš„æ­¥éª¤ï¼š

```shell
$ kk apply -f ./k8s-manifest
configmap/go-multiroute unchanged
deployment.apps/go-multiroute unchanged
ingress.networking.k8s.io/go-multiroute created
service/go-multiroute created

# æ³¨æ„ï¼šservice/kubernetesæ˜¯é»˜è®¤åˆ›å»ºçš„ï¼Œä¸ç”¨ç†ä¼š
$ kk get svc,ingress                           
NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/go-multiroute   ClusterIP   10.96.219.33   <none>        3000/TCP   19s
service/kubernetes      ClusterIP   10.96.0.1      <none>        443/TCP    6d

NAME                                      CLASS   HOSTS   ADDRESS   PORTS   AGE
ingress.networking.k8s.io/go-multiroute   nginx   *                 80      19s
```

ç°åœ¨ï¼Œå¯ä»¥é€šè¿‡Ingressæ§åˆ¶å™¨å¼€æ”¾çš„ç«¯å£æ¥è®¿é—®åº”ç”¨äº†ã€‚ç¬”è€…ç¯å¢ƒå®‰è£…çš„Nginx Ingressæ§åˆ¶å™¨ï¼ŒæŸ¥çœ‹å…¶å¼€æ”¾çš„ç«¯å£ï¼š

```shell
# PORT(S) éƒ¨åˆ†æ˜¯Nginx Ingressæ§åˆ¶å™¨å†…å¯¹å¤–çš„ç«¯å£æ˜ å°„
# å†…éƒ¨80ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨ 30073ï¼Œå†…éƒ¨443ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨30220
kk get svc -ningress-nginx
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.96.171.227   <pending>     80:30073/TCP,443:30220/TCP   3m46s
ingress-nginx-controller-admission   ClusterIP      10.96.7.58      <none>        443/TCP                      3m46s
```

ä½¿ç”¨æ§åˆ¶å™¨çš„ç«¯å£è®¿é—®æœåŠ¡ï¼š

```
# åœ¨ä»»æ„èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¿é—®
$ curl 127.0.0.1:30073/route1
Hello, You are at /route1, Got: route1's content
 
# /route2 å°šæœªåœ¨ingressçš„è§„åˆ™ä¸­å®šä¹‰ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ingressè®¿é—®
$ curl 127.0.0.1:30073/route2
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

OKï¼Œç°åœ¨è®¿é—®æ²¡æœ‰é—®é¢˜äº†ã€‚

#### 1.8.1 ä¸ºä»€ä¹ˆé€šè¿‡30073ç«¯å£è®¿é—®

Nginx Ingressæ§åˆ¶å™¨é»˜è®¤é€šè¿‡NodePortæ–¹å¼éƒ¨ç½²ï¼Œæ‰€ä»¥ä¼šåœ¨å®¿ä¸»æœºä¸Šå¼€æ”¾ä¸¤ä¸ªç«¯å£ï¼ˆæœ¬ä¾‹ä¸­æ˜¯30073å’Œ30220ï¼‰ï¼Œ
è¿™ä¸¤ä¸ªç«¯å£ä¼šåˆ†åˆ«ä»£ç†åˆ°Ingressæ§åˆ¶å™¨å†…éƒ¨çš„80å’Œ443ç«¯å£ã€‚

æœ¬ä¾‹ä¸­éƒ¨ç½²çš„Goåº”ç”¨æ˜¯ä¸€ä¸ªåç«¯æœåŠ¡ï¼Œå¯¹äºå‘å¤–æš´éœ²çš„ç«¯å£å·æ²¡æœ‰è¦æ±‚ã€‚
ä½†å¦‚æœæ˜¯ä¸€ä¸ªå‰ç«¯åº”ç”¨ï¼Œæ¯”å¦‚æ˜¯ä¸€ä¸ªWebç½‘ç«™ï¼Œé‚£ä¹ˆå¯èƒ½å°±æœ‰å¯¹å¤–æš´éœ²80/443ç«¯å£çš„è¦æ±‚ã€‚
æ­¤æ—¶å°±éœ€è¦è°ƒæ•´Ingressæ§åˆ¶å™¨éƒ¨ç½²æ–¹å¼ï¼Œä½¿ç”¨LoadBalanceræˆ–`HostNetwork`æ–¹å¼éƒ¨ç½²ã€‚

### 1.9 æ›´æ–°é…ç½®çš„æœ€ä½³å®è·µ

åº”ç”¨ä¸Šçº¿åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰æ›´æ”¹åº”ç”¨é…ç½®çš„éœ€æ±‚ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯ç›´æ¥æ›´æ–°ç°æœ‰çš„ConfigMapï¼Œç„¶åé‡å¯æ‰€æœ‰Podã€‚
ä½†è¿™ä¸æ˜¯K8sçš„æœ€ä½³å®è·µã€‚åŸå› æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- æ›´æ–°ConfigMapä¸ä¼šè§¦å‘Deploymentä¸­æ‰€æœ‰Podé‡å¯
- è‹¥æ›´æ–°åçš„é…ç½®æœ‰é—®é¢˜ä¸èƒ½è¿…é€Ÿå›æ»šï¼ˆéœ€è¦å†æ¬¡ç¼–è¾‘ç°æœ‰ConfigMapï¼‰ï¼Œå¯¼è‡´æœåŠ¡çŸ­æš‚å®•æœº

è€Œæœ€ä½³å®è·µæ˜¯ä¸ºConfigMapå‘½åå¸¦ä¸Šç‰ˆæœ¬å·å¦‚`app-config-v1`ï¼Œç„¶åéƒ¨ç½²æ–°ç‰ˆæœ¬çš„ConfigMapï¼Œ
å†ä¿®æ”¹Deploymentæ¨¡æ¿ä¸­å¼•ç”¨çš„ConfigMapåç§°ï¼Œæœ€åæ›´æ–°Deploymentï¼ˆè§¦å‘æ‰€æœ‰Podæ»šåŠ¨æ›´æ–°ï¼‰ã€‚

å½“éœ€è¦å›æ»šæ—¶ï¼Œå†æ¬¡æ›´æ–°Deploymentå³å¯ã€‚

## 2. å¼€å‘è€…å·¥ä½œæµ

ä¸ºäº†æé«˜å¼€å‘äººå‘˜çš„å·¥ä½œæ•ˆç‡å’Œæœ€å¤§åŒ–åœ¨æ—¥å¸¸å·¥ä½œä¸­æ¨¡æ‹Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¼€å‘ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæ­å»ºä¸€ä¸ªå¼€å‘é›†ç¾¤æ¥æä¾›ç»™å¼€å‘è€…ä»¬å®Œæˆæ—¥å¸¸å¼€å‘ã€‚
ä½†éšä¹‹è€Œæ¥çš„å°±æ˜¯é›†ç¾¤çš„ç”¨æˆ·ç®¡ç†ã€èµ„æºé¢åº¦é™åˆ¶ä»¥åŠå›æ”¶å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¼€å‘è„šæœ¬æ¥è‡ªåŠ¨åŒ–å®Œæˆè¿™äº›å·¥ä½œã€‚

### 2.1 æ­å»ºä¸åŒç¯å¢ƒçš„é›†ç¾¤

**å¼€å‘é›†ç¾¤**  
æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…±äº«K8sé›†ç¾¤æ¥æä¾›ç»™å¼€å‘è€…ä»¬ä½¿ç”¨ï¼Œä»–ä»¬çš„æ—¥å¸¸å¼€å‘æµç¨‹åŒ…æ‹¬PRæäº¤ã€ä»£ç reviewã€æ„å»ºã€éƒ¨ç½²ç­‰å·¥ä½œéƒ½å°†å’Œç”Ÿäº§ç¯å¢ƒä¿æŒåŸºæœ¬ä¸€è‡´ã€‚

ä½†æˆ‘ä»¬å¿…é¡»ä¸ºæ¯ä¸ªå¼€å‘è€…åˆ†é…å•ç‹¬çš„K8så‘½åç©ºé—´ï¼Œç„¶åè®¾ç½®èµ„æºé¢åº¦é™åˆ¶ï¼Œé˜²æ­¢å¼€å‘è€…ä»¬æ— èŠ‚åˆ¶åœ°ä½¿ç”¨é›†ç¾¤èµ„æºä»¥é€ æˆäº’ç›¸å¹²æ‰°ã€‚
å½“å›¢é˜Ÿè§„æ¨¡è¾ƒå¤§æ—¶ï¼Œå»ºè®®ä¸º10~20äººå…±äº«ä¸€ä¸ªé›†ç¾¤ï¼Œè€Œä¸æ˜¯ä¸Šç™¾äººå…±äº«ä¸€ä¸ªè¶…å¤§é›†ç¾¤ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–é›†ç¾¤çš„ç®¡ç†å·¥ä½œã€‚

**æµ‹è¯•ç¯å¢ƒ**  
å½“å¼€å‘è€…åœ¨å¼€å‘ç¯å¢ƒå®Œæ•´æµ‹è¯•è¿‡è‡ªå·±æäº¤çš„ä»£ç åï¼Œå°±å¯ä»¥è€ƒè™‘éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼Œå¹¶å‘ŠçŸ¥æµ‹è¯•äººå‘˜è¿›è¡Œæµ‹è¯•ã€‚
æµ‹è¯•ç¯å¢ƒé€šå¸¸åªæœ‰ä¸€ä¸ªK8sé›†ç¾¤ç”±æ‰€æœ‰äººå…±äº«ã€‚

**é¢„å‘å¸ƒç¯å¢ƒ**  
å¤§éƒ¨åˆ†å…¬å¸éƒ½ä¼šæœ‰ä¸€ä¸ªé¢„å‘å¸ƒç¯å¢ƒï¼Œç”¨æ¥éƒ¨ç½²ä¸€äº›éœ€è¦ç»è¿‡æµ‹è¯•ç¯å¢ƒéªŒè¯çš„åº”ç”¨ç‰ˆæœ¬ï¼Œæ¯”å¦‚ä¸€äº›æ–°åŠŸèƒ½æˆ–ä¸€äº›éœ€è¦ä¿®å¤çš„bugã€‚
è¿™ä¸ªç¯å¢ƒåº”è¯¥ä¸ç”Ÿäº§ç¯å¢ƒå°½å¯èƒ½ä¿æŒé«˜åº¦ä¸€è‡´ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ•°é‡ã€ç½‘ç»œç­‰å…¶ä»–é…ç½®ï¼Œä¸”ç›¸å¯¹æµ‹è¯•ç¯å¢ƒå…·æœ‰æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶ã€‚
ä¸å…è®¸å¼€å‘è€…éšæ„æ›´æ”¹æ•°æ®åº“ç­‰é…ç½®ï¼Œæµ‹è¯•äººå‘˜åœ¨é¢„å‘å¸ƒç¯å¢ƒåº”æŒ‰ç…§ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†è¿›è¡Œæµ‹è¯•ã€‚

**é•œåƒä»“åº“**  
é•œåƒä»“åº“æ˜¯ç”¨æ¥å­˜æ”¾åº”ç”¨é•œåƒçš„åœ°æ–¹ï¼Œé€šå¸¸ç”±è¿ç»´äººå‘˜æ¥ç»´æŠ¤ã€‚æ¯ä¸ªç¯å¢ƒéƒ½åº”è¯¥æœ‰ä¸€ä¸ªæœ¬åœ°çš„é•œåƒä»“åº“ï¼Œä»¥åŠ å¿«åº”ç”¨éƒ¨ç½²ã€‚

### 2.2 ç®¡ç†å‘˜ä½¿ç”¨çš„è„šæœ¬

ä¸ºäº†ç®€åŒ–é›†ç¾¤çš„ç”¨æˆ·ç®¡ç†ã€èµ„æºé¢åº¦é™åˆ¶ä»¥åŠå›æ”¶å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€äº›è„šæœ¬æ¥ååŠ©ç®¡ç†å‘˜è½»æ¾å®Œæˆè¿™äº›å·¥ä½œã€‚

- [new_user.sh](k8s_actions_guide/version1/k8s-script/new_user.sh)ï¼šåœ¨é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„å‘½åç©ºé—´ã€è§’è‰²å’Œé¢åº¦é™åˆ¶ã€‚
    - æ­¤è„šæœ¬ä¼šåŒæ—¶ç”Ÿæˆ`client-cert-$USER.crt`å’Œ`client-cert-$USER.key`
- [del_user.sh](k8s_actions_guide/version1/k8s-script/del_user.sh)ï¼šåˆ é™¤é›†ç¾¤ä¸­çš„ä¸€ä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆåŒ…å«ç©ºé—´ä¸‹çš„æ‰€æœ‰èµ„æºï¼‰ã€‚
- [setup_kubeconfig.sh](k8s_actions_guide/version1/k8s-script/setup_kubeconfig.sh)ï¼šåˆå§‹åŒ–ç”¨æˆ·ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ã€‚
    - æ­¤è„šæœ¬ä¼šåœ¨æ‰§è¡Œç›®å½•ä¸‹ç”Ÿæˆ`dev-config`æ–‡ä»¶ï¼Œå°†æ­¤æ–‡ä»¶åˆ†å‘ç»™å¯¹åº”å¼€å‘äººå‘˜ä½œä¸ºkubeconfigæ–‡ä»¶å³å¯ã€‚

> ç¬”è€…åœ¨è„šæœ¬ä¸­æ·»åŠ äº†è¯¦å®çš„æ³¨é‡Šï¼Œä½ å¯ä»¥é˜…è¯»å®ƒä»¬æ¥äº†è§£è„šæœ¬ç”¨æ³•å’Œæ­¥éª¤å«ä¹‰ã€‚

### 2.3 æ›´æ–¹ä¾¿çš„æŸ¥è¯¢åº”ç”¨æ—¥å¿—

åº”ç”¨ä¸Šçº¿åï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæœ‰æŸ¥çœ‹åº”ç”¨æ—¥å¿—çš„éœ€æ±‚ã€‚
é»˜è®¤çš„åº”ç”¨æ—¥å¿—åˆ†æ•£å­˜å‚¨åœ¨æ¯ä¸ªPodæ‰€åœ¨èŠ‚ç‚¹çš„`/var/log/pods`ç›®å½•ï¼Œä¸”å®ƒä»¬ä¼šä¼´éšPodçš„æ¶ˆå¤±è€Œè¢«åˆ é™¤ã€‚
è¿™ä¸åˆ©ç”¨å¼€å‘è€…ä»¬æŸ¥çœ‹æ—¥å¿—çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸­å¿ƒåŒ–å­˜å‚¨æ—¥å¿—çš„æ–¹æ¡ˆã€‚
è¯·å‚è€ƒ[Kubernetes æ—¥å¿—æ”¶é›†](doc_log_collection.md)æ¥äº†è§£å¦‚ä½•æ­å»ºæ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚

å¦‚æœå› ä¸ºæŸäº›åŸå› ä¸å¸Œæœ›æ­å»ºæ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼ˆæˆ–è€…è¯´æ˜¯å·æ‡’~ï¼‰ï¼Œ
ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„kubeleté…ç½®æ¥è°ƒæ•´å®¹å™¨æ—¥å¿—çš„å­˜å‚¨å¤§å°å’Œæ–‡ä»¶æ•°é‡ï¼Œå…·ä½“æ­¥éª¤ä¹Ÿè¯·å‚è€ƒ[Kubernetes æ—¥å¿—æ”¶é›†ä¸­çš„
*ä¸šåŠ¡å®¹å™¨æ—¥å¿—*](doc_log_collection.md#11-ä¸šåŠ¡å®¹å™¨æ—¥å¿—)ã€‚
å…¶æ¬¡ï¼Œä½ è¿˜å¯ä»¥å‚è€ƒ[Kubernetes ç»´æŠ¤æŒ‡å¯¼ä¸­çš„*æ—¥å¿—æŸ¥çœ‹*](doc_maintaintion.md#15-æ—¥å¿—æŸ¥çœ‹)æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥é«˜æ•ˆæŸ¥è¯¢å®¹å™¨æ—¥å¿—ã€‚

> é™¤äº†Podæ—¥å¿—ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…³æ³¨é›†ç¾¤ç»„ä»¶æ—¥å¿—ã€èŠ‚ç‚¹æ—¥å¿—ã€é›†ç¾¤å®¡è®¡æ—¥å¿—ã€‚

### 2.4 å¯åŠ¨å¼€å‘

å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…éœ€è¦é¢‘ç¹åœ°æ„å»ºå¹¶æ¨é€é•œåƒã€æ›´æ–°åº”ç”¨ã€æŸ¥çœ‹åº”ç”¨æ—¥å¿—ã€‚
è¿™å…¶ä¸­æœ€ä¸ºé‡è¦çš„æ­¥éª¤å°±æ˜¯é•œåƒtagå®šä¹‰ä»¥åŠæ›´æ–°åº”ç”¨çš„æ“ä½œã€‚

**é•œåƒtagä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰è€Œä¸æ˜¯latest**  
åœ¨æ„å»ºç”¨äºå¼€å‘ç¯å¢ƒçš„è‡ªæµ‹è¯•é•œåƒæ—¶ï¼Œå¯¹äºé•œåƒtagï¼Œå¼€å‘è€…æœ€å¥½æ˜¯ä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰è€Œä¸æ˜¯`latest`ã€‚
ä½¿ç”¨`latest`å¯ä»¥å…å»æ¯æ¬¡æ„å»ºé•œåƒæ—¶éƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹tagçš„éº»çƒ¦ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸ç¡®å®šæ€§ã€‚
å› ä¸ºä½ æ— æ³•å®Œå…¨ç¡®å®šæ‰€æ›´æ–°çš„åº”ç”¨ä½¿ç”¨äº†ä½ åˆšåˆšæ„å»ºå¹¶æ¨é€çš„é•œåƒã€‚å€˜è‹¥ä½ å°†è¯¯ä»¥ä¸ºè‡ªæµ‹æˆåŠŸçš„ä»£ç å‘å¸ƒåˆ°äº†ç”Ÿäº§ç¯å¢ƒï¼Œ
éš¾ä»¥æƒ³è±¡å°†ä¼šå‘ç”Ÿçš„äº‹æƒ…å’Œé¢ä¸´çš„åæœğŸ˜‘ã€‚

**æ›´æ–°åº”ç”¨**  
åœ¨ä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰çš„é•œåƒtagåï¼Œæˆ‘ä»¬å¯ä»¥æ›´ä»å®¹çš„ä½¿ç”¨`kubectl set image...`å‘½ä»¤æ¥æ›´æ–°åº”ç”¨ã€‚
æ³¨æ„ï¼Œåœ¨å¼€å‘ä»¥åŠåç»­çš„ä¸Šçº¿è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦ä¿®æ”¹ä»£ç åº“ä¸­çš„Deployment YAMLæ–‡ä»¶ã€‚

### 2.5 ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ä¸ºå¼€å‘ææ•ˆ

#### 2.5.1 IDEæ’ä»¶

ç¼–å†™æ­¤æ–‡æ—¶å·²ç»æ˜¯2024å¹´äº†ï¼Œä¸»æµçš„VSCodeå’ŒJetbrainså®¶æ—IDEéƒ½å·²ç»æœ‰å¤§é‡çš„Kubernetesæ’ä»¶å¯ç”¨ï¼Œ
è¿™äº›æ’ä»¶å¯ä»¥å¸®åŠ©å¼€å‘è€…é€šè¿‡å›¾å½¢åŒ–çš„æ–¹å¼ä¸å¼€å‘ç¯å¢ƒçš„K8sé›†ç¾¤è¿›è¡Œä¾¿æ·äº¤äº’ï¼Œå…å»æ‰‹åŠ¨è¾“å…¥kubectlå‘½ä»¤çš„ç¹çã€‚

#### 2.5.2 K9sç»ˆç«¯é¢æ¿

K9sæ˜¯ä¸€ä¸ªç»ˆç«¯å½¢å¼çš„K8sèµ„æºé¢æ¿ï¼Œå®ƒæ”¯æŒåœ¨ç»ˆç«¯ä¸­ä»¥å¯è§†åŒ–æ–¹å¼æŸ¥çœ‹å’Œç®¡ç†Kubernetesé›†ç¾¤ä¸­çš„èµ„æºï¼ŒåŒ…æ‹¬Podã€Deploymentã€Serviceç­‰ã€‚
å®ƒæ”¯æŒä»¥æ–¹å‘é”®ã€å›è½¦é”®å’Œç©ºæ ¼é”®ä¸é¢æ¿äº¤äº’ï¼Œå…å»æ‰‹æ•²å‘½ä»¤çš„éº»çƒ¦ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒå’Œé¢„å‘å¸ƒç¯å¢ƒï¼ˆä¹ŸåŒ…æ‹¬ç”Ÿäº§ç¯å¢ƒï¼‰å®‰è£…K9sï¼Œè¿™æ ·å¯ä»¥æ›´ä¾¿æ·çš„æŸ¥çœ‹åº”ç”¨çŠ¶æ€ã€æ—¥å¿—ã€äº‹ä»¶ã€ä»¥åŠè¿›å…¥Podå†…çš„å®¹å™¨Shellï¼Œæå¤§åœ°æ”¹å–„äº†K8sçš„ä½¿ç”¨ä½“éªŒã€‚

#### 2.5.3 å¼€æºK8sæ—¥å¿—å·¥å…·

å¸¸è§„æŸ¥çœ‹å®¹å™¨æ—¥å¿—çš„å‘½ä»¤æ˜¯`kubectl logs`ï¼Œä½†è¿™ä¸ªå‘½ä»¤æœ‰ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ï¼š

- ä¸€æ¬¡åªèƒ½æŸ¥çœ‹ä¸€ä¸ªPodçš„æ—¥å¿—ï¼ˆè‹¥ä¸ä½¿ç”¨`-l`çš„è¯ï¼‰
- ä¸èƒ½æŒ‡å®šDeploymentã€Serviceã€Jobã€Statefulå’ŒIngressåç§°è¿›è¡Œæ—¥å¿—æŸ¥çœ‹
- ä¸èƒ½æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podæ—¥å¿—
- ä¸æ”¯æŒé¢œè‰²æ‰“å°

ç­‰ç­‰ã€‚ä½ å¯ä»¥ä½¿ç”¨å¼€æºçš„K8s Podæ—¥å¿—æŸ¥çœ‹å·¥å…·æ¥æé«˜æ•ˆç‡ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ *Kubernetes ç»´æŠ¤æŒ‡å¯¼*
ä¸­çš„[æ—¥å¿—æŸ¥çœ‹](doc_maintaintion.md#15-æ—¥å¿—æŸ¥çœ‹)å°èŠ‚ã€‚

#### 2.5.4 K8sèµ„æºæ¸…å•é£é™©åˆ†æå·¥å…·

æˆ–è®¸åœ¨è¾ƒå°çš„é›†ç¾¤ä¸­æˆ–è€…æ˜¯ä¸é‚£ä¹ˆé‡è¦çš„ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šå»ç‰¹åˆ«æ³¨æ„K8sèµ„æºæ¸…å•çš„ç¼–å†™è§„èŒƒï¼Œä¾‹å¦‚å¯¹å®¹å™¨çš„CPU/å†…å­˜é™åˆ¶ã€è®¾ç½®å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡ç­‰ã€‚
ä½†æˆ‘ä»¬éœ€è¦çŸ¥é“ï¼ŒPodä¸­çš„å®¹å™¨æ˜¯æœ¬è´¨ä¸Šæ¥è¯´è¿˜æ˜¯è¿è¡Œåœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„ï¼Œä¸å®‰å…¨çš„èµ„æºæ¸…å•å¯èƒ½ä¼šå¯¼è‡´å®¹å™¨åœ¨èŠ‚ç‚¹ä¸Šè¢«æ¶æ„åˆ©ç”¨ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤è¢«æ”»å‡»ã€‚

å¥½åœ¨å·²ç»æœ‰ä¸å°‘å¼€æºå·¥å…·å¯ä»¥ååŠ©æˆ‘ä»¬è½»æ¾å®Œæˆèµ„æºæ¸…å•çš„ä¿®å¤å·¥ä½œï¼Œè¿™é‡Œæ¨èä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š

- [KubeLinter](https://github.com/stackrox/kube-linter)
- [KubeSec](https://kubesec.io/)
- [kube-score](https://github.com/zegl/kube-score)
- [polaris](https://github.com/FairwindsOps/polaris)

ä½ å¯ä»¥å°†è¿™äº›å·¥å…·ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªæ·»åŠ CI/CDæµæ°´çº¿ä¸­ï¼Œä»¥åœ¨æ¯æ¬¡æäº¤ä»£ç æ—¶è‡ªåŠ¨æ£€æŸ¥èµ„æºæ¸…å•çš„å®‰å…¨æ€§ã€‚

## 3. é‡‡é›†é›†ç¾¤æŒ‡æ ‡

### 3.1 ç®€ä»‹

æŒ‡æ ‡æ˜¯æŒ‡é’ˆå¯¹æŸä¸€ç§èµ„æºåœ¨ä¸€æ®µæ—¶é—´å†…çš„ä½¿ç”¨æƒ…å†µçš„ç»Ÿè®¡ï¼Œä¾‹å¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€ç½‘ç»œå¸¦å®½ã€ç£ç›˜ä½¿ç”¨é‡ç­‰ã€‚

æŒ‡æ ‡é‡‡é›†é€šå¸¸æœ‰ä¸¤ç§è¯´æ³•ï¼Œå³é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§ã€‚é»‘ç›’ç›‘æ§æ˜¯ä»é›†ç¾¤çš„å¤–éƒ¨è§†è§’é‡‡é›†æ•°æ®ã€‚å¤šç”¨äºä¼ ç»Ÿçš„CPUã€å†…å­˜ã€ç£ç›˜ç­‰ç¡¬ä»¶èµ„æºçš„ç›‘æ§ï¼Œ
éå¸¸é€‚ç”¨äºå¯¹åŸºç¡€è®¾æ–½çš„ç›‘æ§ã€‚è€Œç™½ç›’ç›‘æ§æ›´å…³æ³¨åº”ç”¨ç¨‹åºçš„çŠ¶æ€ç»†èŠ‚ï¼Œæ¯”å¦‚HTTPè¯·æ±‚æ€»æ•°ã€500é”™è¯¯è¯·æ±‚æ•°å’Œè¯·æ±‚å»¶è¿Ÿç­‰ã€‚
ç™½ç›’ç›‘æ§è®©æˆ‘ä»¬çŸ¥é“ç³»ç»Ÿä¸ºä»€ä¹ˆå¤„äºå½“å‰çŠ¶æ€ï¼Œè®©æ•…éšœå®šä½è¿›ä¸€æ­¥æœ‰è¿¹å¯å¾ªã€‚

### 3.2 ä¸¤ç§ç›‘æ§æ¨¡å¼

å®ƒä»¬åˆ†åˆ«æ˜¯USEå’ŒREDæ¨¡å¼ã€‚

#### 3.2.1 USEæ¨¡å¼

USEçš„é‡Šä¹‰å¦‚ä¸‹ï¼š

- Uâ€”â€”Utilizationï¼ˆåˆ©ç”¨ç‡ï¼‰
- Sâ€”â€”Saturationï¼ˆé¥±å’Œåº¦ï¼‰
- Eâ€”â€”Errorsï¼ˆé”™è¯¯ç‡ï¼‰

è¿™ç§æ¨¡å¼ä¸“æ³¨äºåŸºç¡€è®¾æ–½ç›‘æ§ï¼Œå¯¹åº”é»‘ç›’ç›‘æ§ã€‚

#### 3.2.2 REDæ¨¡å¼

REDçš„é‡Šä¹‰å¦‚ä¸‹ï¼š

- Râ€”â€”Rateï¼ˆæ¯ç§’æ¥å—çš„è¯·æ±‚æ•°ï¼‰
- Eâ€”â€”Errorï¼ˆæ¯ç§’å¤±è´¥çš„è¯·æ±‚æ•°ï¼‰
- Dâ€”â€”Durationï¼ˆæ¯ä¸ªè¯·æ±‚çš„è€—æ—¶ï¼‰

è¿™ç§æ¨¡å¼ä¸“æ³¨äºåº”ç”¨ç¨‹åºç›‘æ§ï¼Œå¯¹åº”ç™½ç›’ç›‘æ§ã€‚

### 3.3 é‡‡é›†ç›®æ ‡

äº†è§£äº†ä¸Šé¢çš„ç›‘æ§æ¨¡å¼åï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦çŸ¥é“åº”è¯¥åœ¨é›†ç¾¤ä¸­è¿›è¡ŒæŒ‡æ ‡é‡‡é›†çš„ç›®æ ‡æœ‰å“ªäº›ã€‚
è¿™é‡Œç¬”è€…å°†å®ƒä»¬åˆ†ç±»åˆ—å‡ºï¼š

- æ§åˆ¶å¹³é¢ï¼šAPI Serverã€etcdã€Schedulerã€Controller Manager
- å·¥ä½œèŠ‚ç‚¹ï¼škubeletã€å®¹å™¨è¿è¡Œæ—¶ã€kube-proxyã€kube-dnså’ŒPod

ä¸Šé¢é™¤äº†å·¥ä½œèŠ‚ç‚¹çš„Podä»¥å¤–ï¼Œå…¶ä»–å¯ä»¥å½’ç±»ä¸ºåŸºç¡€è®¾æ–½ç»„ä»¶ã€‚æˆ‘ä»¬éœ€è¦ç›‘æ§è¿™äº›ç»„ä»¶æš´éœ²çš„å„é¡¹æŒ‡æ ‡å¹¶åŠæ—¶åšå‡ºå“åº”ï¼Œ
æ‰èƒ½ç¡®ä¿é›†ç¾¤çš„ç¨³å®šè¿è¡Œã€‚

### 3.4 é‡‡é›†æ¶æ„

#### 3.4.1 ä½¿ç”¨Prometheusä½œä¸ºå­˜å‚¨åç«¯

Prometheusæ˜¯CNCFï¼ˆäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼‰ä¸­æ’åä»…æ¬¡äº Kubernetes çš„ä¸€ä¸ªé‡é‡çº§å¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªç”¨äºç›‘æ§å’Œå‘Šè­¦çš„å¼€æºç³»ç»Ÿã€‚
å®ƒæä¾›äº†ä¸€ä¸ªçµæ´»çš„æŸ¥è¯¢è¯­è¨€å«åš**PromQL**ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°æŸ¥è¯¢å’Œåˆ†æç›‘æ§æ•°æ®ã€‚ç›®å‰ï¼ŒPrometheuså·²ç»æ˜¯ä¸šç•Œå…¬è®¤çš„ç›‘æ§äº‹å®æ ‡å‡†ã€‚

Prometheusæ¶æ„å›¾å¦‚ä¸‹
![](./img/prometheus_architecture.png)

ç®€å•æ¥è¯´ï¼ŒPrometheusç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- Prometheus Serverï¼šè´Ÿè´£æ•°æ®é‡‡é›†å’Œå­˜å‚¨ï¼Œå¹¶æä¾›PromQLæŸ¥è¯¢è¯­è¨€çš„æ”¯æŒã€‚
- Push Gatewayï¼šæ”¯æŒä¸´æ—¶æ€§ä»»åŠ¡çš„æ•°æ®é‡‡é›†ã€‚
- Exporterï¼šç”¨äºæš´éœ²è¢«ç›‘æ§ç»„ä»¶çš„æ•°æ®æ¥å£ã€‚
    - å¯¹äºä¸åŒçš„é‡‡é›†ç›®æ ‡ï¼ˆä¾‹å¦‚ä¸»æœºèŠ‚ç‚¹ï¼‰éœ€è¦éƒ¨ç½²å¯¹åº”çš„Exporterï¼Œç„¶åé…ç½®Prometheusä¸»åŠ¨é‡‡é›†å³å¯ã€‚
    - å¸¸è§çš„æœ‰ï¼šnode_exporterã€blackbox_exporterã€mysqld_exporterã€redis_exporterç­‰ã€‚
- Client Libraryï¼šå®¢æˆ·ç«¯åº“ï¼Œä¸ºéœ€è¦ç›‘æ§çš„ç»„ä»¶æä¾›æ–¹ä¾¿çš„æ¥å…¥æ–¹å¼ã€‚
    - å¯¹äºé‚£äº›æ²¡æœ‰Exporterçš„é‡‡é›†ç›®æ ‡ï¼ˆæ¯”å¦‚ä¸šåŠ¡åº”ç”¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯åº“è‡ªè¡Œä¸ŠæŠ¥æ•°æ®åˆ°Prometheus Serverä¸­ã€‚
- Alert-managerï¼šè´Ÿè´£æ¥æ”¶Prometheusçš„å‘Šè­¦ä¿¡æ¯ï¼Œå¹¶å†³å®šå¦‚ä½•å¯¹å‘Šè­¦è¿›è¡Œå¤„ç†ï¼Œå¦‚å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€è°ƒç”¨Webhookç­‰ã€‚

é€šè¿‡ä¸Šé¢çš„æ¶æ„å›¾å’Œæ–‡å­—è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°Prometheusæ”¯æŒä»¥æ¨/æ‹‰çš„æ–¹å¼é‡‡é›†å„ç§ç›®æ ‡æä¾›çš„æŒ‡æ ‡æ•°æ®ã€‚

#### 3.4.2 Prometheuså››ç§æŒ‡æ ‡ç±»å‹

Prometheusä¸­çš„æŒ‡æ ‡å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼š

- Counterï¼ˆè®¡æ•°å™¨ï¼‰
    - ç®€ä»‹ï¼šCounter æ˜¯ä¸€ä¸ªç´¯åŠ å™¨ï¼Œåªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘ã€‚é€šå¸¸ç”¨äºè¡¨ç¤ºç´¯ç§¯çš„äº‹ä»¶è®¡æ•°ï¼Œæ¯”å¦‚è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ€»æ•°ç­‰ã€‚
    - å…¸å‹ç”¨æ³•ï¼šè®°å½•äº‹ä»¶çš„æ€»æ•°é‡ï¼Œä¾‹å¦‚ HTTP è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ•°é‡ã€ä»»åŠ¡å®Œæˆæ¬¡æ•°ç­‰ã€‚
    - ç¤ºä¾‹ï¼šhttp_requests_total, errors_total, tasks_completed_totalã€‚
- Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰
    - ç®€ä»‹ï¼šGauge æ˜¯ä¸€ä¸ªå¯å˜åŒ–çš„æ•°å€¼ï¼Œå¯ä»¥å¢åŠ ä¹Ÿå¯ä»¥å‡å°‘ã€‚ç”¨äºè¡¨ç¤ºå¯å˜çš„åº¦é‡ï¼Œå¦‚æ¸©åº¦ã€å†…å­˜ä½¿ç”¨ç‡ç­‰ã€‚
    - å…¸å‹ç”¨æ³•ï¼šè·Ÿè¸ªéšæ—¶é—´å˜åŒ–çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜å ç”¨é‡ã€è¿æ¥æ•°ç­‰ã€‚
    - ç¤ºä¾‹ï¼šcpu_usage, memory_usage, active_connections.
- Histogramï¼ˆç›´æ–¹å›¾ï¼‰
    - ç®€ä»‹ï¼šHistogram ç»Ÿè®¡å’Œå­˜å‚¨æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå¦‚è¯·æ±‚å“åº”æ—¶é—´çš„åˆ†å¸ƒã€‚
    - å…¸å‹ç”¨æ³•ï¼šè¡¡é‡æŒç»­æ—¶é—´æˆ–å€¼çš„åˆ†å¸ƒæƒ…å†µï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´ã€API è°ƒç”¨è€—æ—¶ç­‰ã€‚
    - ç¤ºä¾‹ï¼šhttp_request_duration_seconds.
- Summaryï¼ˆæ‘˜è¦ï¼‰
    - ç®€ä»‹ï¼šSummary ä¹Ÿç”¨äºè®°å½•æŒç»­æ—¶é—´æ•°æ®ï¼Œä½†å®ƒæä¾›çš„æ˜¯å¯å˜ç²¾åº¦çš„æ‘˜è¦ï¼Œè€Œä¸æ˜¯å›ºå®šæ•°é‡çš„æ¡¶ã€‚
    - å…¸å‹ç”¨æ³•ï¼šä¸ Histogram ç±»ä¼¼ï¼Œç”¨äºè®°å½•æŒç»­æ—¶é—´ï¼Œä½†é€šå¸¸ç”¨äºæ›´å¤æ‚çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¯”å¦‚ p50ã€p90ã€p99 ç­‰åˆ†ä½æ•°ã€‚
    - ç¤ºä¾‹ï¼šapi_request_duration_seconds_summary.

è¿™å››ç§æŒ‡æ ‡ç±»å‹å‡ ä¹è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œå¹¶ä¸”æ¯ç§ç±»å‹éƒ½æä¾›äº†ä¸°å¯Œçš„æ ‡ç­¾ï¼ˆlabelï¼‰ç”¨äºæè¿°æŒ‡æ ‡çš„ç»´åº¦ä¿¡æ¯ã€‚
æˆ‘ä»¬åªéœ€è¦åœ¨æ¨/æ‹‰æ•°æ®æ—¶æŒ‡å®šéœ€è¦é‡‡é›†çš„æŒ‡æ ‡ç±»å‹å’Œæ ‡ç­¾ï¼ŒPrometheuså°±èƒ½è‡ªåŠ¨è¿›è¡Œæ•°æ®é‡‡é›†å’Œå­˜å‚¨ã€‚

#### 3.4.3 ä½¿ç”¨Grafanaä½œä¸ºå¯è§†åŒ–ç»„ä»¶

Prometheusæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå®ƒæœ¬èº«å¹¶ä¸å…·å¤‡å¼ºå¤§çš„å¯è§†åŒ–èƒ½åŠ›ã€‚è¦æƒ³å°†é‡‡é›†åˆ°çš„æŒ‡æ ‡æ•°æ®è¿›è¡Œä¸°å¯Œçš„å¯è§†åŒ–å±•ç¤ºï¼Œ
æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¯è§†åŒ–ç»„ä»¶ï¼Œå®ƒå°±æ˜¯Grafanaã€‚Prometheus+Grafanaæ˜¯ä¸€ä¸ªå¸¸è§çš„å…„å¼Ÿç»„åˆï¼Œå‡ ä¹ä¸ä¼šåˆ†å¼€ä½¿ç”¨ã€‚

Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œå®ƒå¯ä»¥é€šè¿‡å°†æ—¶åºæ•°æ®å¯¼å…¥å…¶ä¸­è€Œå»ºç«‹ä¸€ä¸ªæ•°æ®ä»ªè¡¨ç›˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œ
ä½ åªéœ€è¦é€šè¿‡ä¸€ä¸ªç½‘é¡µä¸Šçš„æ•°æ®å¤§ç›˜å°±èƒ½å¯¹æ•´ä¸ªé›†ç¾¤ï¼ˆåŒ…æ‹¬å‡ åä¸Šç™¾ç”šè‡³æ›´å¤šçš„èŠ‚ç‚¹ï¼‰çš„è¿è¡ŒçŠ¶æ€äº†å¦‚æŒ‡æŒï¼Œè¿™è¯¥æ˜¯å¤šä¹ˆé…·çš„ä¸€ä»¶äº‹æƒ…ã€‚

å½“ç„¶è¿™ä¸ªå…„å¼Ÿç»„åˆå¹¶ä¸ä»…ä»…ç”¨äºKubernetesé›†ç¾¤ç›‘æ§ï¼Œå®ƒè¿˜å¯ä»¥ç”¨äºå„ç§éœ€è¦ç›‘æ§å’Œå¯è§†åŒ–çš„åœºæ™¯ã€‚æ¯”å¦‚åœ¨ä½ çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ
éœ€è¦ç›‘æ§ä»Š/æ˜¨æ—¥çš„è¥æ”¶ã€æ˜¨æ—¥çš„PVã€ä»Šæ—¥çš„UVã€ä»Šæ—¥çš„è®¢å•é‡ç­‰ã€‚

#### 3.4.4 é‡‡é›†å®¹å™¨æŒ‡æ ‡ï¼ˆcAdvisorï¼‰

cAdvisoræ˜¯Googleå¼€æºçš„ä¸€æ¬¾ç”¨äºå±•ç¤ºå’Œåˆ†æå®¹å™¨è¿è¡ŒçŠ¶æ€çš„å¯è§†åŒ–å·¥å…·ã€‚é€šè¿‡åœ¨ä¸»æœºä¸Šè¿è¡ŒCAdvisorç”¨æˆ·å¯ä»¥è½»æ¾çš„è·å–åˆ°å½“å‰ä¸»æœºä¸Šå®¹å™¨çš„è¿è¡Œç»Ÿè®¡ä¿¡æ¯ï¼Œ
ä¾‹å¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€ç½‘ç»œå¸¦å®½å’Œç£ç›˜ä½¿ç”¨é‡ç­‰ã€‚ä½ å¯ä»¥å‚è€ƒ [cadvisorçš„å®‰è£…ä¸ä½¿ç”¨][cadvisor] æ¥è¿›ä¸€æ­¥äº†è§£å®ƒçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚

cAdvisoræš´éœ²äº†Prometheusæ”¯æŒçš„æŒ‡æ ‡æ ¼å¼ï¼Œé€šè¿‡äºŒè€…ç»“åˆï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾è·å–åˆ°Kubernetesé›†ç¾¤ä¸­çš„Podå†…éƒ¨å®¹å™¨çº§åˆ«çš„ç›‘æ§æ•°æ®ã€‚

> kubeletä¹Ÿæ˜¯é€šè¿‡å†…ç½®cAdvisoræ¥ç›‘æ§å®¹å™¨æŒ‡æ ‡ã€‚

#### 3.4.5 Metrics Server

Metrics Serveræ˜¯K8sçš„ä¸€ä¸ªé™„åŠ ç»„ä»¶ï¼Œå®ƒå®ç°äº†API Serverå®šä¹‰çš„[Metrics API][MetricsAPI]ã€‚
Metrics APIä¸»è¦ä¸ºç”¨æˆ·æä¾›é›†ç¾¤ä¸­å¤„äºè¿è¡ŒçŠ¶æ€çš„Podå’ŒNodeçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ
è®¾è®¡ç”¨äºK8sçš„HPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ä»¥åŠVPAï¼ˆVertical Pod Autoscalingï¼ŒPodå‚ç›´è‡ªåŠ¨ä¼¸ç¼©ï¼‰åŠŸèƒ½ã€‚

Metrics Serverå†…éƒ¨é€šè¿‡è°ƒç”¨kubelet APIæ¥ç›‘æ§å®¹å™¨æ•°æ®ï¼Œç„¶åé€šè¿‡Metrics APIæš´éœ²ç»™API Serverä½¿ç”¨ã€‚
å½“å®‰è£…Metrics Serveråï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`kubelet top`å‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤ä¸­Podå’ŒNodeçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚å…³äºå®ƒçš„å®‰è£…å’Œä½¿ç”¨ç»†èŠ‚ï¼Œ
ä½ å¯ä»¥å‚è€ƒç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« *K8sè¿›é˜¶æ•™ç¨‹*ä¸­çš„ [å®‰è£…Metrics Serveræ’ä»¶](doc_tutorial_senior.md#341-å®‰è£…Metrics-Serveræ’ä»¶)
ä¸€èŠ‚ã€‚

äº†è§£æ›´å¤šï¼š

- [Resource Metrics Pipeline](https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/)
- [Metrics Server](https://github.com/kubernetes-incubator/metrics-server)

#### 3.4.6 è‡ªå®šä¹‰æŒ‡æ ‡

å‰é¢æˆ‘ä»¬è¯´åˆ°ä½¿ç”¨Prometheus+Grafanaçš„ç»„åˆæ¥ç›‘æ§Kubernetesé›†ç¾¤ï¼Œè¿™ç§æ–¹å¼å·²ç»å¯ä»¥ç›‘æ§ä»»ä½•çš„æŒ‡æ ‡æ•°æ®ã€‚
å¦‚æœæˆ‘ä»¬æƒ³è¦æŠŠPrometheusä¸­å­˜å‚¨çš„æŒ‡æ ‡æ•°æ®é€šè¿‡æš´éœ²ç»™Kubernetes API Serverï¼Œç„¶åé€šè¿‡kubectlå‘½ä»¤è¡Œæ¥æŸ¥è¯¢ï¼Œ
é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æŒ‡æ ‡çš„æ–¹å¼æ¥å®Œæˆï¼Œè¿™éœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£…**prometheus-adapter**ï¼Œ
å¹¶åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­ç¼–å†™éœ€è¦æŸ¥è¯¢çš„æŒ‡æ ‡ä¿¡æ¯ï¼Œå¤§è‡´æ­¥éª¤è¯·å‚è€ƒ*K8sè¿›é˜¶æ•™ç¨‹*
ä¸­çš„[3.4.6 ä½¿ç”¨å¤šé¡¹æŒ‡æ ‡ã€è‡ªå®šä¹‰æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡](doc_tutorial_senior.md#346-ä½¿ç”¨å¤šé¡¹æŒ‡æ ‡è‡ªå®šä¹‰æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡)ã€‚

ä½†è¯·æ³¨æ„ï¼Œå¦‚æœä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨kubectlæ¥æŸ¥è¯¢æŒ‡æ ‡ï¼Œé‚£å…¶å®å¤§å¯ä¸å¿…ï¼Œå› ä¸ºæ€§ä»·æ¯”å¤ªä½ï¼ˆæœ‰ä¸€å®šç»´æŠ¤æˆæœ¬ï¼‰ï¼Œä½¿ç”¨GrafanaæŸ¥è¯¢è¶³ä»¥ã€‚
ä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡æ›´å¤šæ˜¯ä¸ºäº†å®ŒæˆHPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰å’ŒVPAï¼ˆVertical Pod
Autoscalingï¼ŒPodå‚ç›´è‡ªåŠ¨ä¼¸ç¼©ï¼‰å·¥ä½œã€‚

### 3.5 å‘Šè­¦

æœ‰äº†æŒ‡æ ‡æ•°æ®åï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®SLOï¼ˆæœåŠ¡æ°´å¹³ç›®æ ‡ï¼‰æ¥è®¾ç½®ç›¸åº”çš„å‘Šè­¦è§„åˆ™ï¼ˆåœ¨Grafanaä¸­è®¾ç½®ï¼‰ã€‚SLOæ˜¯å¯¹æœåŠ¡çš„æŸäº›å¯æµ‹é‡ç‰¹æ€§è®¾ç½®çš„ç›®æ ‡æœŸæœ›ï¼Œ
ä¾‹å¦‚å¯ç”¨æ€§ã€ååé‡ã€é¢‘ç‡å’Œå“åº”æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰SLOï¼Œæˆ‘ä»¬å¯¹æœåŠ¡å°±ä¼šæŠ±æœ‰ä¸åˆ‡å®é™…çš„æœŸæœ›ï¼Œä¹Ÿæ— æ³•è®¾ç½®åˆé€‚çš„å‘Šè­¦è§„åˆ™ã€‚
å¯¹äºKubernetesè¿™æ ·æœåŠ¡å…·æœ‰é«˜åº¦è‡ªæ„ˆèƒ½åŠ›çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬åº”è¯¥é’ˆå¯¹ç»ˆç«¯ç”¨æˆ·çš„æœåŠ¡ä½“éªŒæ¥è®¾ç½®å‘Šè­¦è§„åˆ™ã€‚
ä¾‹å¦‚ï¼Œä¸ºå‰ç«¯æœåŠ¡è®¾ç½®çš„SLOæ˜¯å“åº”æ—¶é—´ä¸å¾—é«˜äº20msï¼Œå½“è§‚æµ‹åˆ°ä¸€æ®µæ—¶é—´å†…çš„å¹³å‡å“åº”æ—¶é—´é«˜äº20msï¼Œå°±éœ€è¦åŠæ—¶å‘å‡ºå‘Šè­¦ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„æ³¨æ„ç‚¹ä»¥ä¾›å‚è€ƒï¼š

- ä»…å¯¹å…³é”®æŒ‡æ ‡è¿›è¡Œå‘Šè­¦ï¼Œå¹¶å¿½ç•¥ä¸€äº›å¯ä»¥è¢«K8sè‡ªåŠ¨å¤„ç†çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚CPU/å†…å­˜åˆ©ç”¨ç‡ç­‰
- è®¾ç½®åˆç†çš„é˜ˆå€¼å‘¨æœŸï¼Œé¿å…è¿‡çŸ­çš„å‘¨æœŸå¯¼è‡´é¢‘ç¹å‘Šè­¦ã€‚æœ€åæœ‰ä¸€å¥—é˜ˆå€¼è®¾ç½®è§„èŒƒï¼Œæ¥é¿å…ä¸ªæ€§åŒ–çš„é˜ˆå€¼è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥éµå¾ª5minã€10minã€30minã€1hè¿™æ ·çš„ç‰¹å®šé¢‘ç‡æ¥ç»Ÿä¸€é…ç½®é˜ˆå€¼å‘¨æœŸ
- åœ¨é…ç½®å‘Šè­¦è§„åˆ™æ—¶ï¼Œåº”è¯¥ç¡®ä¿é€šçŸ¥ä¸­åŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚æœåŠ¡åç§°ã€å‘Šè­¦æŒç»­æ—¶é—´ã€å»ºè®®å¤„ç†æªæ–½ç­‰
- å‘Šè­¦é€šçŸ¥ä¸è¦å‘ç»™ä¸€ç¾¤äººï¼Œè€Œæ˜¯ä»…å‘ç»™éœ€è¦å…³æ³¨æˆ–å¤„ç†é—®é¢˜çš„äººï¼Œå¦åˆ™å®¹æ˜“è¢«å½“æˆä¸é‡è¦çš„ä¿¡æ¯è€Œè¢«å¿½ç•¥

## 4. æ—¥å¿—ç›‘æ§

æ—¥å¿—ç›‘æ§æ˜¯ç›‘æ§ç³»ç»Ÿä¸­çš„é‡è¦ä¸€ç¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜å’Œæ¢å¤æœåŠ¡ã€‚Kubernetesä¸­çš„æ—¥å¿—ç›‘æ§ç›®æ ‡åŒ…å«ï¼š

- èŠ‚ç‚¹æ—¥å¿—ï¼ˆèŠ‚ç‚¹å…³é”®æœåŠ¡çš„æ—¥å¿—ã€‚ä¾‹å¦‚å®¹å™¨è¿è¡Œæ—¶ç»„ä»¶çš„æ—¥å¿—ã€å†…æ ¸æ—¥å¿—ç­‰ï¼‰
- Kubernetesç»„ä»¶æ—¥å¿—ï¼ˆå¦‚API Serverã€ControllerManagerå’ŒSchedulerï¼‰
- å®¹å™¨æ—¥å¿—ï¼ˆä¸»è¦æ˜¯åº”ç”¨æ—¥å¿—ï¼‰
- Kuberneteså®¡è®¡æ—¥å¿—ï¼ˆä¸æƒé™ç›¸å…³ï¼Œéå¸¸é‡è¦ï¼‰

å¦‚æœä½ ä½¿ç”¨äº‘æ‰˜ç®¡çš„Kubernetesé›†ç¾¤ï¼Œé‚£å»ºè®®ä½ ä¹Ÿä½¿ç”¨æ‰˜ç®¡çš„æ—¥å¿—ç›‘æ§æœåŠ¡ï¼Œè¿™æ ·æœ‰åŠ©äºå¤§å¹…é™ä½è¿ç»´æˆæœ¬ã€‚ç»´æŠ¤è‡ªå»ºçš„æ—¥å¿—æœåŠ¡èµ·åˆçœ‹èµ·æ¥ä¸é”™ï¼Œ
ä½†éšç€ç¯å¢ƒå¤æ‚åº¦çš„å¢é•¿ï¼Œç»´æŠ¤å·¥ä½œä¼šå˜å¾—è¶Šæ¥è¶Šè´¹æ—¶è´¹åŠ›ã€‚

å¦‚æœé€‰æ‹©è‡ªå»ºæ—¥å¿—æœåŠ¡ï¼Œå‘ä½ æ¨èç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« [Kubernetes æ—¥å¿—æ”¶é›†](doc_log_collection.md)ã€‚
è¿™ç¯‡æ–‡ç« ä¼šæ‰‹æŠŠæ‰‹æŒ‡å¯¼ä½ å¦‚ä½•å®Œæˆé›†ç¾¤çš„æ—¥å¿—æ”¶é›†å·¥ä½œã€‚

## 5. CI/CDæµæ°´çº¿

CI/CDçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ï¼Œè¦†ç›–ä»£ç ä»æäº¤åˆ°éƒ¨ç½²å†åˆ°ç”Ÿäº§çš„å…¨æµç¨‹ã€‚æˆ‘ä»¬åº”è¯¥é¿å…è¿›è¡Œæ‰‹åŠ¨æ›´æ–°ï¼Œå› ä¸ºè¿™æ ·åšå¾ˆå®¹æ˜“å‡ºé”™ï¼Œ
å®¹æ˜“å¯¼è‡´é…ç½®æ¼‚ç§»ï¼Œè¿˜ä¼šè®©éƒ¨ç½²å˜å¾—è„†å¼±ï¼Œå¯¼è‡´åº”ç”¨äº¤ä»˜çš„æ•´ä½“æ•æ·æ€§ä¸§å¤±ã€‚

æ„å»ºä¸€ä¸ªé«˜åº¦é›†æˆçš„æµæ°´çº¿èƒ½å¤Ÿè®©æˆ‘ä»¬ä¿¡å¿ƒåè¶³åœ°å°†åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæœ¬èŠ‚å°†å…·ä½“ä»‹ç»è¿™ä¸ªæ„å»ºè¿‡ç¨‹ã€‚

### 5.1 å®Œæ•´çš„æµæ°´çº¿ç¤ºä¾‹

å¦‚ä¸‹ï¼š

- æ¨é€ä»£ç å˜æ›´åˆ°ä»£ç ä»“åº“ï¼ˆGitæˆ–SVNï¼‰
- è¿è¡ŒAPPæ„å»º
- è¿è¡ŒAPPæµ‹è¯•
- åŸºäºæµ‹è¯•æˆåŠŸçš„APPä»£ç æ„å»ºé•œåƒ
- æ¨é€é•œåƒåˆ°é•œåƒä»“åº“
- éƒ¨ç½²APPåˆ°Kubernetesï¼ˆå¯èƒ½åŸºäºä¸åŒçš„ç­–ç•¥ï¼Œå¦‚æ»šåŠ¨æ›´æ–°ã€è“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²ï¼‰

### 5.2 ä»£ç ç‰ˆæœ¬æ§åˆ¶

æ¯ä¸ªCI/CDæµæ°´çº¿éƒ½å§‹äºç‰ˆæœ¬æ§åˆ¶ï¼Œå®ƒç”¨äºç»´æŠ¤åº”ç”¨ä»£ç å’Œé…ç½®æ–‡ä»¶çš„å˜æ›´è®°å½•ã€‚é…ç½®æ–‡ä»¶å¯èƒ½åŒ…æ‹¬K8sæ¸…å•ä»¥åŠHelm Chartã€‚
è€Œç‰ˆæœ¬æ§åˆ¶ç­–ç•¥åˆ™æœ‰å¤šç§é€‰æ‹©ï¼Œè¿™å–å†³äºç»„ç»‡ç»“æ„å’Œè´£ä»»åˆ’åˆ†ã€‚ä½†è¯·æ³¨æ„ï¼Œåº”è¯¥å°½é‡è®©å¼€å‘è€…å’Œè¿ç»´å·¥ç¨‹å¸ˆåœ¨åŒä¸€ä¸ªä»£ç å­˜å‚¨åº“ä¸­è¿›è¡Œå†™ä½œï¼Œ
è¿™æœ‰åŠ©äºç»Ÿä¸€ç®¡ç†å’Œä¿è¯ä»£ç å’Œè¿ç»´è„šæœ¬ç‰©æ–™å§‹ç»ˆä¿æŒåŒ¹é…ã€‚

### 5.3 æŒç»­é›†æˆ

æŒç»­é›†æˆï¼ˆCIï¼‰æ­¥éª¤æ˜¯å°†ä»£ç å˜æ›´æŒç»­åœ°é›†æˆåˆ°ç‰ˆæœ¬æ§åˆ¶åº“çš„è¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œ
å°±æ˜¯å°†æ¯ä¸€æ¬¡ä»£ç æäº¤éƒ½å½“åšä¸€ä¸ªæ–°çš„åº”ç”¨ç‰ˆæœ¬è¿›è¡Œæ„å»ºï¼Œè¿™æ ·ä¸€æ¥å°±èƒ½åŠæ—¶å‘ç°å“ªä¸€æ¬¡ä»£ç æäº¤å¯¼è‡´æ„å»ºå¤±è´¥ï¼Œä»è€Œå¿«é€Ÿä¿®å¤ä»£ç ã€‚

### 5.4 æµ‹è¯•

å½“åº”ç”¨æ„å»ºæˆåŠŸåï¼Œåº”è¯¥é©¬ä¸Šæ‰§è¡Œé¢„è®¾çš„æµ‹è¯•å‘½ä»¤ã€‚ä¾‹å¦‚ï¼ŒGoåº”ç”¨å¯ä»¥ä½¿ç”¨`go test`æ‰§è¡Œä¸€ç»„å•å…ƒæµ‹è¯•ã€‚
å½“æµ‹è¯•é€šè¿‡æ—¶ï¼Œæ‰èƒ½å°†ä»£ç æ‰“åŒ…ä¸ºé•œåƒï¼›ä¸€æ—¦æµ‹è¯•å¤±è´¥ï¼Œåº”ç«‹å³åœæ­¢æµæ°´çº¿å·¥ä½œï¼Œå¹¶æä¾›æ­¤æ­¥éª¤å¤±è´¥çš„æ—¥å¿—è¾“å‡ºã€‚

> é™¤äº†å¯¹åº”ç”¨çš„å•å…ƒæµ‹è¯•ï¼Œä½ å¯èƒ½è¿˜éœ€è¦é¢„è®¾å…¶ä»–æµ‹è¯•è„šæœ¬å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œå¯¹K8sæ¸…å•æ–‡ä»¶çš„é£é™©æ£€æµ‹å‘½ä»¤ä»¥åŠå¯¹Helm Chartæ–‡ä»¶çš„lintæµ‹è¯•å‘½ä»¤ã€‚

### 5.5 é•œåƒæ„å»º

åœ¨å®Œæˆé•œåƒæ„å»ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æå‰å†™å¥½Dockerfileã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒSize
- ä½¿ç”¨å…·æœ‰å°‘é‡å‘½ä»¤çš„åŸºç¡€é•œåƒä»¥å‡å°‘å®‰å…¨é£é™©ï¼Œä¾‹å¦‚Scratchã€Alpineå’ŒDistrolessç­‰
    - ä½¿ç”¨è¿™ç±»åŸºç¡€é•œåƒæ—¶ï¼Œä½ å¯èƒ½è¿˜éœ€è¦äº†è§£å®ƒä»¬çš„è°ƒè¯•æ–¹æ³•ï¼Œä»¥æ›´å¥½çš„åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨

### 5.6 æ·»åŠ é•œåƒæ ‡ç­¾

åœ¨å°†é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¹‹å‰ï¼Œéœ€è¦ç»™é•œåƒæ‰“ä¸Šæ ‡ç­¾ã€‚åˆç†çš„é•œåƒæ ‡ç­¾èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè¯†åˆ«é•œåƒç‰ˆæœ¬ï¼Œåœ¨CIæµæ°´çº¿ä¸­æ„å»ºçš„æ¯ä¸ªé•œåƒéƒ½åº”è¯¥æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡ç­¾ã€‚

æœ‰ä»¥ä¸‹å‡ ç§æ ‡ç­¾ç­–ç•¥å¯ä¾›ä½¿ç”¨ï¼š

- æ„å»ºå·ï¼ˆåœ¨å¼€å§‹æ„å»ºæ—¶ç”±æ„ä»¶ç³»ç»Ÿäº§ç”Ÿçš„ä¸€ä¸ªé€’å¢ç¼–å·ï¼‰
- GitHashï¼ˆä»£ç æäº¤æ—¶äº§ç”Ÿçš„GitHashç ï¼Œæœ‰åŠ©äºåœ¨ä»£ç æäº¤è®°å½•ä¸­æº¯æºï¼‰
- GitHash-æ„å»ºå·ï¼ˆæ¨èï¼‰

### 5.7 æŒç»­éƒ¨ç½²

æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰æ­¥éª¤æ˜¯å°†åº”ç”¨é•œåƒéƒ¨ç½²åˆ°åº”ç”¨è¿è¡Œç¯å¢ƒï¼ˆå¦‚æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒï¼‰çš„è¿‡ç¨‹ã€‚
è¿™ä¸€æ­¥æˆ‘ä»¬åªéœ€è¦åœ¨CDç³»ç»Ÿä¸­æå‰é…ç½®å¥½Kubernetesçš„ServerUrlã€è¯ä¹¦ä»¥åŠTokenï¼Œç„¶åç”±CDç³»ç»Ÿè‡ªåŠ¨å®Œæˆéƒ¨ç½²/æ›´æ–°æ­¥éª¤ã€‚

### 5.8 éƒ¨ç½²ç­–ç•¥

æœ¬èŠ‚è®¨è®ºçš„éƒ¨ç½²ç­–ç•¥ï¼ŒåŒ…æ‹¬æ»šåŠ¨æ›´æ–°ã€è“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚

#### 5.8.1 æ»šåŠ¨æ›´æ–°

æ»šåŠ¨æ›´æ–°ï¼ˆrolling updateï¼‰æ˜¯Kubernetesä¸­æœ€å¸¸ç”¨ä¹Ÿæ˜¯Deploymenté»˜è®¤çš„éƒ¨ç½²æ›´æ–°ç­–ç•¥ã€‚å®ƒé€šè¿‡é€æ­¥æ›´æ–°Podçš„æ–¹å¼ï¼Œç¡®ä¿åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆå¯ç”¨ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨å‡†å¤‡æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆæ‰§è¡Œ`kubectl set image...`å‘½ä»¤æ¥ä¿®æ”¹Deploymentä¸­åº”ç”¨å®¹å™¨çš„é•œåƒæ ‡ç­¾ã€‚
ç„¶åï¼ŒKubernetesä¼šé€æ­¥æ›´æ–°Deploymentä¸­çš„Podï¼Œç¡®ä¿åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆå¯ç”¨ã€‚åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œ
å¦‚æœç”±äºé•œåƒé—®é¢˜å¯¼è‡´æ–°çš„Podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼ŒKubernetesä¼šæš‚åœæ›´æ–°ï¼Œå¾…æˆ‘ä»¬è§£å†³é—®é¢˜åé‡æ–°æ„å»ºæ–°çš„é•œåƒï¼Œå†é‡æ–°æ“ä½œæ­¤æ­¥éª¤å®Œæˆæ›´æ–°ã€‚
æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸‹é¢çš„kubectlå‘½ä»¤æ¥è¾…åŠ©å®Œæˆæ»šåŠ¨æ›´æ–°ï¼š

- é€šè¿‡`kubectl rollout pause`å‘½ä»¤æ¥æš‚åœæ»šåŠ¨æ›´æ–°ï¼Œå¹¶åœ¨ç¡®è®¤æ–°Podæ­£å¸¸å¯åŠ¨ä¸”æ¥å—æµé‡åå†ç»§ç»­æ›´æ–°ã€‚
- é€šè¿‡`kubectl rollout undo`å‘½ä»¤æ¥å›æ»šDeploymentçš„æœ¬æ¬¡æ›´æ–°ï¼Œæ‰§è¡Œå‘½ä»¤åDeploymentå†…çš„åº”ç”¨å®¹å™¨çš„é•œåƒæ ‡ç­¾å°†æ¢å¤åˆ°æ—§å€¼ï¼Œ
  åŒæ—¶å½“å‰æ›´æ–°å¤±è´¥çš„Podä¹Ÿä¼šè¢«æ—§æ ‡ç­¾çš„é•œåƒæ›¿æ¢ã€‚

ä¸ºäº†æ›´å¥½çš„å®ç°çƒ­æ›´æ–°ä»¥åŠå‡å°‘ç»ˆç«¯ç”¨æˆ·æ„ŸçŸ¥ï¼Œå»ºè®®åœ¨Deploymentä¸­é…ç½®`readiness probe`å’Œ`preStop`å­—æ®µã€‚
`readiness probe`ç”¨äºç¡®ä¿éƒ¨ç½²çš„æ–°ç‰ˆæœ¬Podåœ¨å‡†å¤‡å°±ç»ªåæ‰èƒ½æ¥å—æµé‡ï¼›è€Œ`preStop`ç”¨äºåœ¨Podè¢«åˆ é™¤å‰æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œä¾‹å¦‚åº”ç”¨è¿›ç¨‹çš„é€€å‡ºæ“ä½œã€‚

æ»šåŠ¨æ›´æ–°æ—¶ï¼Œé›†ç¾¤ä¸­ä¼šåŒæ—¶å­˜åœ¨æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„Podï¼Œæ‰€ä»¥å¯¹äºä¸æ”¯æŒå¤šè¿›ç¨‹éƒ¨ç½²çš„åº”ç”¨ï¼ˆæ¯”å¦‚Deploymentçš„`replicas`
è®¾ç½®ä¸º1ï¼‰ï¼Œæ³¨æ„è¦åœ¨PodSpecä¸­è®¾ç½®æ›´æ–°ç­–ç•¥ä¸º`Recreate`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„`rollingUpdate`ã€‚

#### 5.8.2 è“ç»¿éƒ¨ç½²

è“ç»¿éƒ¨ç½²æ˜¯æŒ‡åœ¨å·²ç»å­˜åœ¨ä¸€å¥—ç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡éƒ¨ç½²ä¸€å¥—æ–°çš„åº”ç”¨ç¯å¢ƒï¼Œç„¶åå°†ç”¨æˆ·æµé‡å¿«é€Ÿåˆ‡æ¢ï¼ˆé€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼‰åˆ°æ–°ç‰ˆæœ¬çš„åº”ç”¨ä¸Šã€‚
è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ—§çš„ç¯å¢ƒå«åšè“ï¼ˆblueï¼‰ï¼Œæ–°éƒ¨ç½²çš„ç¯å¢ƒå«åšç»¿ï¼ˆgreenï¼‰ã€‚å½“æ–°ç¯å¢ƒå­˜åœ¨é—®é¢˜æ—¶ï¼Œå†å¿«é€Ÿåˆ‡æ¢åˆ°æ—§ç¯å¢ƒå³å¯ã€‚
è“ç»¿éƒ¨ç½²æœ€å¤§çš„ä¼˜ç‚¹æ˜¯å®ç°é›¶åœæœºéƒ¨ç½²ã€‚

è¿™å¥—ç­–ç•¥çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™å­˜åœ¨ä¸å°‘éš¾ç‚¹ã€‚è“ç»¿éƒ¨ç½²é€šå¸¸æ„å‘³ç€ä¸€æ¬¡åˆ‡æ¢ä¸€æ•´ä¸ªç¯å¢ƒã€‚æ¯”å¦‚ï¼Œå½“å‰åº”ç”¨ç”±ä¸€ä¸ªå‰¯æœ¬æ•°é‡ä¸º10çš„Deploymentç¯å¢ƒï¼ˆå¦‚åä¸º`app-deploy-v1`
ï¼‰ç»„æˆï¼Œ
é‚£ä¹ˆè¿˜éœ€è¦éƒ¨ç½²ä¸€å¥—æ–°çš„Deploymentç¯å¢ƒï¼ˆå¦‚åä¸º`app-deploy-v2`ï¼Œä½†`label`ä¸åŒï¼‰ï¼Œå‰¯æœ¬æ•°é‡ä»ç„¶ä¸º10ã€‚è¿™ä¸¤å¥—ç¯å¢ƒæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œ
æ‰€ä»¥ä¼šå ç”¨å¢åŠ ä¸€å€çš„ç¡¬ä»¶èµ„æºã€‚ç„¶åæˆ‘ä»¬éœ€è¦å¯¹æ–°çš„Deploymentè¿›è¡Œå®Œæ•´çš„æµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡åï¼Œ
åœ¨Kubernetesçš„Serviceæ¨¡æ¿ä¸­ä¿®æ”¹Selectoræ¥åˆ‡æ¢æµé‡åˆ°æ–°çš„Deploymentã€‚å¾…æ–°ç¯å¢ƒæ­£å¸¸è¿è¡Œä¸€æ®µæ—¶é—´åï¼ˆç”±å…·ä½“æƒ…å†µå†³å®šï¼‰ï¼Œå†é”€æ¯æ—§çš„ç¯å¢ƒã€‚

è¿™é‡Œï¼Œç®€è¦åˆ—å‡ºè“ç»¿éƒ¨ç½²çš„å‡ ä¸ªéš¾ç‚¹ï¼š

- å¤šç‰ˆæœ¬åŒæ—¶å­˜åœ¨çš„é—®é¢˜ã€‚åº”ç”¨å¿…é¡»æ”¯æŒå¤šç‰ˆæœ¬åŒæ—¶å­˜åœ¨ï¼Œå¦åˆ™ä¸é€‚ç”¨æœ¬éƒ¨ç½²æ–¹æ³•ã€‚
- æ•°æ®åº“è¿ç§»é—®é¢˜ã€‚åº”ç”¨é€šå¸¸ä¼šè®¿é—®æ•°æ®åº“ï¼Œè€Œä¸”éœ€è¦æ‰§è¡Œäº‹åŠ¡ã€‚æ“ä½œè€…å¿…é¡»è€ƒè™‘åˆ°æ–°æ—§ç‰ˆæœ¬å¯¹åŒæ—¶æ‰§è¡Œäº‹åŠ¡æ“ä½œçš„å…¼å®¹æ€§ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚
- éœ€è¦å…·å¤‡åŒæ—¶ç»´æŠ¤ä¸¤å¥—ç¯å¢ƒçš„èƒ½åŠ›ã€‚
- ç”±äºæ›´æ–°ç²’åº¦å¤§ï¼Œè™½ç„¶å¯ä»¥å¿«é€Ÿåˆ‡æ¢æµé‡ï¼Œä½†å¯èƒ½ä¼šå› ä¸ºæ“ä½œå¤±è¯¯å¯¼è‡´ä¸¥é‡çš„æœåŠ¡ä¸­æ–­å½±å“ã€‚ä¸€å®šè¦è¿›è¡Œé¢„å…ˆçš„ã€å¤šæ¬¡çš„å®Œæ•´æµç¨‹æ“ä½œæ¼”ç»ƒã€‚

#### 5.8.3 é‡‘ä¸é›€éƒ¨ç½²

é‡‘ä¸é›€éƒ¨ç½²æ˜¯æ¯”è“ç»¿éƒ¨ç½²æ›´ä¿å®ˆä¸€ç‚¹çš„éƒ¨ç½²ç­–ç•¥ã€‚é¦–å…ˆï¼Œé‡‘ä¸é›€éƒ¨ç½²ç­–ç•¥ä¸­ï¼Œä¹Ÿéœ€è¦åŒæ—¶éƒ¨ç½²ä¸¤ä¸ªåŸºæœ¬ç›¸åŒçš„ç¯å¢ƒã€‚æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œ
é‡‘ä¸é›€éƒ¨ç½²ä¸­ï¼Œç”¨æˆ·æµé‡æ˜¯æŒ‰æ¯”ä¾‹æˆ–æ¡ä»¶é€æ¸åˆ‡æ¢åˆ°æ–°ç¯å¢ƒï¼Œè€Œä¸æ˜¯åƒè“ç»¿éƒ¨ç½²é‚£æ ·ä¸€æ¬¡æ€§åœ°å…¨éƒ¨åˆ‡æ¢ã€‚
ä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†æºå¸¦ç‰¹å®šHeaderé”®å€¼çš„è¯·æ±‚è·¯ç”±åˆ°æ–°ç¯å¢ƒã€‚

> åœ¨å¤§éƒ¨åˆ†ç§»åŠ¨åº”ç”¨é¡¹ç›®ä¸­ï¼Œå®¢æˆ·ç«¯äººå‘˜é€šå¸¸ä¼šé€šè¿‡ç‰¹å®šçš„Headeré”®å€¼æ¥æ ‡è¯†å½“å‰ç”¨æˆ·ä½¿ç”¨çš„åŒ…ç¯å¢ƒï¼Œæ¯”å¦‚æµ‹è¯•åŒ…/æ­£å¼åŒ…/ç°åº¦åŒ…ã€‚

é‡‘ä¸é›€éƒ¨ç½²ç›¸å¯¹è“ç»¿éƒ¨ç½²çš„ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥å°èŒƒå›´éªŒè¯æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬çš„åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰é—®é¢˜åå†å®Œå…¨åˆ‡æ¢ã€‚
å³ä½¿æ–°ç¯å¢ƒå­˜åœ¨é—®é¢˜ï¼Œå…¶å½±å“ä¹Ÿé™åˆ¶åœ¨è¾ƒå°èŒƒå›´ã€‚è¿™ç§å‘å¸ƒæ–¹å¼é€šå¸¸ä¹Ÿå«åšA/Bå‘å¸ƒæˆ–ç°åº¦å‘å¸ƒã€‚

åœ¨Kubernetesä¸­å¯ä»¥é€šè¿‡Ingressæ¥å®ç°æŒ‰æ¯”ä¾‹åˆ†é…æµé‡çš„åŠŸèƒ½ï¼Œå¸¸ç”¨çš„Ingressæ§åˆ¶å™¨å¦‚Nginxã€Traefikç­‰éƒ½æ”¯æŒã€‚
åˆ†é…æµé‡çš„ç­–ç•¥åŒ…æ‹¬HTTP Headerçš„Key/Valueã€Cookieã€æ¯”ä¾‹é…ç½®ç­‰ã€‚

æ³¨æ„ï¼Œå®è·µé‡‘ä¸é›€éƒ¨ç½²æ—¶éœ€è¦å¤„ç†ä¸è“ç»¿éƒ¨ç½²ç›¸åŒçš„é—®é¢˜ï¼ŒåŒ…æ‹¬å¤šç‰ˆæœ¬å…±å­˜ã€æ•°æ®åº“è¿ç§»ç­‰ã€‚

- [ä½¿ç”¨ Nginx Ingress å®ç°é‡‘ä¸é›€å‘å¸ƒ](https://cloud.tencent.com/document/product/457/48907)

### 5.9 ä¸€äº›å»ºè®®

CI/CDæµæ°´çº¿é…ç½®å¾ˆéš¾ä¸€å¼€å§‹å°±åšåˆ°å®Œç¾ï¼Œä½†å¯ä»¥å‚è€ƒä¸‹é¢åŸåˆ™æ¥å°½å¯èƒ½å®Œå–„æµç¨‹ï¼š

- åœ¨CIä¸­å…³æ³¨è‡ªåŠ¨åŒ–å’Œæ„å»ºé€Ÿåº¦ã€‚ä¼˜åŒ–æ„å»ºé€Ÿåº¦èƒ½å¤Ÿåœ¨ä»£ç æäº¤æ—¶å¿«é€Ÿå®Œæˆæ„å»ºï¼Œä¸ºå¼€å‘è€…æä¾›æ›´å¿«é€Ÿçš„åé¦ˆã€‚
- åœ¨æµæ°´çº¿ä¸­é…ç½®å¯é ä¸”å®Œå–„çš„æµ‹è¯•è„šæœ¬ã€‚ä»¥ä¾¿åœ¨ä»£ç æäº¤æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ä»£ç ä¸­çš„é—®é¢˜ï¼Œä»¥ä¾¿å¿«é€Ÿä¿®å¤å’ŒéªŒè¯ã€‚
- å°½å¯èƒ½ä¼˜åŒ–é•œåƒå¤§å°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ‹‰å–é•œåƒçš„æ—¶é—´ï¼Œæé«˜æ„å»ºé€Ÿåº¦ï¼Œè¿˜èƒ½å‡å°‘å®¹å™¨è¿è¡Œæ—¶çš„å†…å­˜æ¶ˆè€—å’Œå—æ”»å‡»é¢ã€‚
- å¦‚æœè¿˜ä¸ç†Ÿæ‚‰CDï¼Œå¯ä»¥å…ˆä»ç®€å•æ˜“ç”¨çš„æ»šåŠ¨æ›´æ–°å¼€å§‹ã€‚åç»­å†è€ƒè™‘ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒæˆ–è“ç»¿éƒ¨ç½²ã€‚
- åœ¨CDç¯èŠ‚ï¼Œä¸€å®šè¦æ³¨æ„å¯¹å®¢æˆ·ç«¯è¿æ¥çš„é‡æ–°å»ºç«‹å’Œæ•°æ®åº“ç»“æ„çš„å˜æ›´è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œå°½å¯èƒ½å‡å°‘å¯¹ç”¨æˆ·ç«¯çš„å½±å“ã€‚
- ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•æ—¶ï¼Œåº”è¯¥ä»å°è§„æ¨¡å¼€å§‹ï¼Œé€æ­¥æ‰©å¤§æµ‹è¯•èŒƒå›´ã€‚

## å‚è€ƒ

- [Kuberneteså®æˆ˜@ç¾ Brendan Burns Eddie Villalba](https://book.douban.com/subject/35346815/)

[MetricsAPI]: https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-api

[cadvisor]: https://learn.lianglianglee.com/ä¸“æ /ç”±æµ…å…¥æ·±åƒé€%20Docker-å®Œ/08%20%20å®¹å™¨ç›‘æ§ï¼šå®¹å™¨ç›‘æ§åŸç†åŠ%20cAdvisor%20çš„å®‰è£…ä¸ä½¿ç”¨.md
