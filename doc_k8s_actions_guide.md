# Kubernetes å®æˆ˜æŒ‡å¯¼ï¼ˆæ›´æ–°ä¸­ï¼‰

æœ¬æ–‡ä»¥ä¸€ä¸ªç®€å•Goåº”ç”¨ä¸ºä¾‹ï¼Œæ¼”ç¤ºå¦‚ä½•ä¸€æ­¥æ­¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨Kubernetesã€‚

## 1. éƒ¨ç½²ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨

### 1.1 ç¼–å†™ä¸€ä¸ªç®€å•çš„Goåº”ç”¨

- [main_multiroute.go](k8s_actions_guide/version1/go_code/main_multiroute.go)

è¿™ä¸ªGoåº”ç”¨çš„é€»è¾‘å¾ˆç®€å•ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ”¯æŒä»é…ç½®åŠ¨æ€åŠ è½½è·¯ç”±çš„HTTPæœåŠ¡å™¨ã€‚åˆå§‹åŒ–æ­¤åº”ç”¨ï¼š

```shell
go mod init k8s_action
go mod tidy
```

### 1.2 ä½¿ç”¨ConfigMapå­˜å‚¨é…ç½®

ä¼ ç»Ÿæ–¹å¼ä¸‹ï¼Œæˆ‘ä»¬é€šå¸¸å°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨å•ç‹¬æ–‡ä»¶ä¸­ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…å‘½ä»¤è¡Œå‚æ•°ä¼ é€’ç»™åº”ç”¨ã€‚

åœ¨K8sç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬éœ€è¦å°†é…ç½®è¿ç§»åˆ°ConfigMapä¸­ï¼Œå¹¶é€šè¿‡ç¯å¢ƒå˜é‡æˆ–è€…å·æŒ‚è½½çš„æ–¹å¼ä¼ é€’ç»™åº”ç”¨ã€‚

- [base_manifest/configmap.yaml](k8s_actions_guide/version1/base_manifest/configmap.yaml)

æ³¨æ„å°†K8sæ¸…å•æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„ç›®å½•ï¼ˆå¦‚`base_manifest`ï¼‰ä¸‹ï¼Œä»¥ä¾¿åç»­æ‰¹é‡éƒ¨ç½²ã€‚

> è™½ç„¶å¯ä»¥åœ¨Dockerfileä¸­ç›´æ¥å°†é…ç½®æ–‡ä»¶æ‰“åŒ…åˆ°å®¹å™¨ï¼Œä½†è¿™ç§æ–¹å¼é€šå¸¸ä¼´éšçš„æ˜¯å°†é…ç½®æ–‡ä»¶å­˜å‚¨åœ¨ä»£ç åº“ä¸­ï¼Œè¿™å¹¶ä¸ç¬¦åˆK8sçš„æœ€ä½³å®è·µã€‚
> åŒæ—¶ä¹Ÿä¸é€‚åˆç”¨æ¥å­˜å‚¨é‡è¦é…ç½®ã€‚

å¦‚æœæœ‰é‡è¦çš„é…ç½®ï¼Œæ¯”å¦‚è¯ä¹¦ç§é’¥æˆ–Tokenä¹‹ç±»çš„æ•æ„Ÿä¿¡æ¯ï¼Œè¯·ä½¿ç”¨Secretæ¥å­˜å‚¨ã€‚

### 1.3 ä½¿ç”¨Secretå­˜å‚¨æ•æ„Ÿä¿¡æ¯

é€šå¸¸ä¸€ä¸ªåç«¯åº”ç”¨ä¼šé“¾æ¥åˆ°æ•°æ®åº“æ¥å¯¹å¤–æä¾›APIæœåŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºåº”ç”¨æä¾›æ•°æ®åº“å¯†ç ã€‚

è™½ç„¶ConfigMapä¹Ÿå¯ä»¥å­˜å‚¨æ•°æ®ï¼Œä½†Secretæ›´é€‚åˆå­˜å‚¨æ•æ„Ÿä¿¡æ¯ã€‚åœ¨K8sä¸­ï¼ŒSecretç”¨æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œæ¯”å¦‚å¯†ç ã€Tokenç­‰ã€‚

- [base_manifest/secret.yaml](k8s_actions_guide/version1/base_manifest/secret.yaml)

#### 1.3.1 åŠ å¯†å­˜å‚¨Secretä¸­çš„æ•°æ®

è™½ç„¶Secretå£°ç§°ç”¨æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹å®ƒæ˜¯éåŠ å¯†åœ°å­˜å‚¨åœ¨é›†ç¾¤å­˜å‚¨ï¼ˆetcdï¼‰ä¸Šçš„ã€‚
ä»»ä½•æ‹¥æœ‰ API è®¿é—®æƒé™çš„äººéƒ½å¯ä»¥æ£€ç´¢æˆ–ä¿®æ”¹ Secretã€‚

è¯·å‚è€ƒä»¥ä¸‹é“¾æ¥æ¥åŠ å¯†å­˜å‚¨Secretä¸­çš„æ•°æ®ï¼š

- [K8s Secrets](https://kubernetes.io/zh-cn/docs/concepts/configuration/secret/)
- [åŠ å¯† K8s Secrets çš„å‡ ç§æ–¹æ¡ˆ](https://www.cnblogs.com/east4ming/p/17712715.html)

### 1.4 ä½¿ç”¨Dockerfileæ‰“åŒ…åº”ç”¨

è¿™ä¸€æ­¥ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªDockerfileæ–‡ä»¶å°†Goåº”ç”¨æ‰“åŒ…åˆ°ä¸€ä¸ªé•œåƒä¸­ï¼Œä»¥ä¾¿åç»­éƒ¨ç½²ä¸ºå®¹å™¨ã€‚

- [Dockerfile](k8s_actions_guide/version1/go_code/Dockerfile)

æ³¨æ„åœ¨Dockerfileä¸­å®šåˆ¶ä½ çš„Goç‰ˆæœ¬ã€‚

### 1.5 å‡†å¤‡é•œåƒä»“åº“

ä¸ºäº†æ–¹ä¾¿åç»­éƒ¨ç½²ï¼Œæˆ‘ä»¬éœ€è¦å°†æ‰“åŒ…å¥½çš„é•œåƒä¸Šä¼ åˆ°é•œåƒä»“åº“ä¸­ã€‚

ä½œä¸ºæ¼”ç¤ºï¼Œæœ¬æ–‡ä½¿ç”¨Docker Hubä½œä¸ºé•œåƒä»“åº“ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸ºäº†åº”ç”¨å®‰å…¨ä»¥åŠæé«˜é•œåƒæ‹‰å–é€Ÿåº¦ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ï¼ˆæ­å»ºï¼‰ç§æœ‰çš„ä»“åº“ã€‚

å¸¸ç”¨çš„å¼€æºé•œåƒä»“åº“æœ‰Docker Registryå’ŒHarborã€‚å¦‚æœä½ ä½¿ç”¨äº‘å‚å•†çš„æ‰˜ç®¡é›†ç¾¤ï¼Œå¯ä»¥ä½¿ç”¨å®ƒä»¬æä¾›çš„é•œåƒä»“åº“äº§å“ã€‚

### 1.6 ç¼–å†™Deploymentæ¨¡æ¿

Deploymentæ˜¯K8sä¸­æœ€å¸¸ç”¨çš„ç”¨æ¥éƒ¨ç½²å’Œç®¡ç†åº”ç”¨çš„èµ„æºå¯¹è±¡ã€‚å®ƒæ”¯æŒåº”ç”¨çš„å¤šå‰¯æœ¬éƒ¨ç½²ä»¥åŠæ•…éšœè‡ªæ„ˆèƒ½åŠ›ã€‚

- [base_manifest/deployment.yaml](k8s_actions_guide/version1/base_manifest/deployment.yaml)

ä½ å¯ä»¥åœ¨æ¨¡æ¿ä¸­å®šåˆ¶åº”ç”¨çš„å‰¯æœ¬æ•°é‡ã€èµ„æºé™åˆ¶ã€ç¯å¢ƒå˜é‡ç­‰é…ç½®ã€‚

> æ³¨æ„ï¼šä½ å¯èƒ½çœ‹æƒ…å†µéœ€è¦ä¿®æ”¹æ¨¡æ¿ä¸­çš„namespaceï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®ä½¿ç”¨defaultå‘½åç©ºé—´ã€‚å› ä¸ºè¿™ä¸åˆ©äºå¯¹ä¸åŒç±»å‹çš„åº”ç”¨è¿›è¡Œéš”ç¦»å’Œèµ„æºé™åˆ¶ã€‚
> æ¯”å¦‚ï¼Œä½ å¯ä»¥ä¸ºåç«¯æœåŠ¡å’Œå‰ç«¯æœåŠ¡åˆ†åˆ«ä½¿ç”¨backendå’Œfrontendå‘½åç©ºé—´ã€‚

**ä¸ºé•œåƒæŒ‡å®šæŒ‡çº¹**  
dockeræ‹‰å–é•œåƒæ—¶æ”¯æŒä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š

```shell
docker pull busybox:1.36.1@sha256:7108255e7587de598006abe3718f950f2dca232f549e9597705d26b89b7e7199
# docker images --digests è·å–é•œåƒhash
```

åé¢çš„`sha256:710...`æ˜¯é•œåƒçš„å”¯ä¸€hashã€‚å½“æœ‰äººå†æ¬¡æ¨é€ç›¸åŒtagçš„é•œåƒè¦†ç›–äº†æ—§é•œåƒæ—¶ï¼Œæ‹‰å–æ ¡éªŒå°±ä¼šå¤±è´¥ï¼Œè¿™æ ·å¯ä»¥é¿å…ç‰ˆæœ¬ç®¡ç†æ··ä¹±å¯¼è‡´çš„éƒ¨ç½²äº‹æ•…ã€‚

æ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨Deploymentæ¨¡æ¿ä¸­æŒ‡å®šé•œåƒçš„tagçš„åŒæ—¶ä½¿ç”¨`@sha256:...`æ¥æŒ‡å®šé•œåƒçš„hashä»¥æé«˜éƒ¨ç½²å®‰å…¨æ€§ã€‚

### 1.7 ä½¿ç”¨CI/CDæµæ°´çº¿

å®Œæˆå‰è¿°æ­¥éª¤åï¼Œåº”è¯¥å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶å¸ƒå±€ï¼š

```
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ base_manifest
â”‚Â Â  â”œâ”€â”€ configmap.yaml
â”‚Â Â  â”œâ”€â”€ deployment.yaml
â”‚Â Â  â””â”€â”€ secret.yaml
â””â”€â”€ main_multiroute.go
```

ç°åœ¨å¯ä»¥å°†å®ƒä»¬æäº¤åˆ°ä»£ç ä»“åº“ä¸­ã€‚ç„¶åä½¿ç”¨CI/CDæµæ°´çº¿æ¥æ„å»ºé•œåƒå¹¶éƒ¨ç½²åº”ç”¨ã€‚

> ä»£ç åº“ä¸­é€šå¸¸ä¼šå­˜å‚¨***éç”Ÿäº§ç¯å¢ƒ**çš„é…ç½®æ–‡ä»¶ï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒä½¿ç”¨çš„é…ç½®æ–‡ä»¶ï¼ˆConfigMapå’ŒSecretï¼‰ï¼Œä¸åº”æ”¾åœ¨ä»£ç åº“ä¸­ï¼Œ
> è€Œæ˜¯ä»¥æ‰‹åŠ¨æ–¹å¼æå‰éƒ¨ç½²åˆ°ç¯å¢ƒä¸­ã€‚

å‚è€ƒä¸‹é¢çš„æŒ‡ä»¤æ¥é…ç½®CI/CDæµæ°´çº¿ï¼š

```shell
# å‡è®¾ç°åœ¨å·²ç»è¿›å…¥åˆ°æ„å»ºæœºï¼ˆéœ€è¦è¿æ¥åˆ°k8sé›†ç¾¤ï¼‰

IMAGE=leigg/go_multiroute
TAG=v1 # æ¯æ¬¡è¿­ä»£æ—¶æ‰‹åŠ¨æŒ‡å®š
_IMAGE_=$IMAGE:$TAG

# æ„å»ºé•œåƒï¼ˆå°†leiggæ›¿æ¢ä¸ºä½ çš„é•œåƒä»“åº“åœ°å€ï¼‰
$ docker build . -t $_IMAGE_
...
Successfully built 20e2a541e835
Successfully tagged leigg/go_multiroute:v1

# æ¨é€é•œåƒåˆ°ä»“åº“
$ docker push $_IMAGE_
The push refers to repository [docker.io/leigg/go_multiroute]
f658e2d998f1: Pushed
06d92acd05c8: Pushed
3ce819cc4970: Mounted from library/alpine
v1: digest: sha256:74bf6d94ea9af3e700dfd9fe64e1cc6a04cd75fb792d994c63bbc6d69de9b7ee size: 950

# éƒ¨ç½²åº”ç”¨
$ kubectl apply -f ./base_manifest

# æ›´æ–°åº”ç”¨
$ kubectl set image deployment/go-multiroute go-multiroute=$_IMAGE_
```

æŸ¥çœ‹åº”ç”¨éƒ¨ç½²æƒ…å†µï¼š

```shell
$ kubectl get deploy
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
go-multiroute   2/2     2            2           7s
$ kubectl get po    
NAME                            READY   STATUS    RESTARTS   AGE
go-multiroute-f4f8b64f4-564qq   1/1     Running   0          8s
go-multiroute-f4f8b64f4-v64l6   1/1     Running   0          8s
```

è¿™é‡Œä½¿ç”¨çš„æ˜¯ç®€å•çš„æ»šåŠ¨æ›´æ–°ç­–ç•¥è¿›è¡Œéƒ¨ç½²æ›´æ–°åº”ç”¨ï¼Œå®é™…ç¯å¢ƒä¸­ä½ å¯èƒ½ä¼šæ ¹æ®åº”ç”¨æƒ…å†µè€Œä½¿ç”¨è“ç»¿éƒ¨ç½²æˆ–é‡‘ä¸é›€éƒ¨ç½²ï¼Œ
è¿™éƒ¨åˆ†å°†åœ¨æœ¬æ–‡çš„[5.8 éƒ¨ç½²ç­–ç•¥](doc_k8s_actions_guide.md#58-éƒ¨ç½²ç­–ç•¥)ä¸­è¿›è¡Œè¯¦ç»†è®¨è®ºã€‚

### 1.8 ä¸ºæœåŠ¡é…ç½®å¤–éƒ¨è®¿é—®

ç°åœ¨å·²ç»åœ¨é›†ç¾¤å†…éƒ¨éƒ¨ç½²å¥½äº†åº”ç”¨ï¼Œä½†æ˜¯è¿˜æ— æ³•ä»é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚æˆ‘ä»¬éœ€è¦å†éƒ¨ç½²ä»¥ä¸‹èµ„æºæ¥æä¾›å¤–éƒ¨è®¿é—®èƒ½åŠ›ã€‚

- Serviceï¼šä¸ºæœåŠ¡è®¿é—®æä¾›æµé‡çš„è´Ÿè½½å‡è¡¡èƒ½åŠ›ï¼ˆæ”¯æŒTCP/UDP/SCTPåè®®ï¼‰
- Ingressï¼šç®¡ç†é›†ç¾¤å¤–éƒ¨è®¿é—®åº”ç”¨çš„è·¯ç”±ç«¯ç‚¹ï¼Œæ”¯æŒHTTP/HTTPSåè®®
    - Ingresséœ€è¦å®‰è£…æŸä¸€ç§Ingressæ§åˆ¶å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œï¼Œå¸¸ç”¨çš„æœ‰Nginxã€Traefikã€‚

> å¦‚æœåº”ç”¨æ˜¯éHTTPæœåŠ¡å™¨ï¼ˆå¦‚ä»…TCPã€WebsocketæœåŠ¡ï¼‰ï¼Œåˆ™æ— éœ€Ingressï¼Œä»…ç”¨Serviceæ¥æš´éœ²æœåŠ¡å°±å¯ã€‚

- [expose_manifest/service.yaml](k8s_actions_guide/version1/expose_manifest/service.yaml)
- [expose_manifest/ingress.yaml](k8s_actions_guide/version1/expose_manifest/ingress.yaml)

éƒ¨ç½²Ingressæ§åˆ¶å™¨çš„æ­¥éª¤è¿™é‡Œä¸å†èµ˜è¿°ï¼Œè¯·å‚è€ƒ[åŸºç¡€æ•™ç¨‹](doc_tutorial.md#82-å®‰è£…Nginx-Ingressæ§åˆ¶å™¨)ã€‚

ä¸‹é¢æ˜¯éƒ¨ç½²Serviceå’ŒIngressçš„æ­¥éª¤ï¼š

```shell
$ kubectl apply -f ./expose_manifest
ingress.networking.k8s.io/go-multiroute created
service/go-multiroute created

# æ³¨æ„ï¼šservice/kubernetesæ˜¯é»˜è®¤åˆ›å»ºçš„ï¼Œä¸ç”¨ç†ä¼š
$ kubectl get svc,ingress                           
NAME                    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
service/go-multiroute   ClusterIP   10.96.219.33   <none>        3000/TCP   19s
service/kubernetes      ClusterIP   10.96.0.1      <none>        443/TCP    6d

NAME                                      CLASS   HOSTS   ADDRESS   PORTS   AGE
ingress.networking.k8s.io/go-multiroute   nginx   *                 80      19s
```

ç°åœ¨ï¼Œå¯ä»¥é€šè¿‡Ingressæ§åˆ¶å™¨å¼€æ”¾çš„ç«¯å£æ¥è®¿é—®åº”ç”¨äº†ã€‚ç¬”è€…ç¯å¢ƒå®‰è£…çš„Nginx Ingressæ§åˆ¶å™¨ï¼ŒæŸ¥çœ‹å…¶å¼€æ”¾çš„ç«¯å£ï¼š

```shell
# PORT(S) éƒ¨åˆ†æ˜¯Nginx Ingressæ§åˆ¶å™¨å†…å¯¹å¤–çš„ç«¯å£æ˜ å°„
# å†…éƒ¨80ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨ 30073ï¼Œå†…éƒ¨443ç«¯å£æ˜ å°„åˆ°å¤–éƒ¨30220
kubectl get svc -ningress-nginx
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.96.171.227   <pending>     80:30073/TCP,443:30220/TCP   3m46s
ingress-nginx-controller-admission   ClusterIP      10.96.7.58      <none>        443/TCP                      3m46s
```

ä½¿ç”¨æ§åˆ¶å™¨çš„ç«¯å£è®¿é—®æœåŠ¡ï¼š

```
# åœ¨ä»»æ„èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¿é—®
$ curl 127.0.0.1:30073/route1
[v1] Hello, You are at /route1, Got: route1's content
 
# /route2 å°šæœªåœ¨ingressçš„è§„åˆ™ä¸­å®šä¹‰ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ingressè®¿é—®
$ curl 127.0.0.1:30073/route2
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
```

OKï¼Œç°åœ¨è®¿é—®æ²¡æœ‰é—®é¢˜äº†ã€‚

#### 1.8.1 ä¸ºä»€ä¹ˆé€šè¿‡30073ç«¯å£è®¿é—®

Nginx Ingressæ§åˆ¶å™¨é»˜è®¤é€šè¿‡NodePortæ–¹å¼éƒ¨ç½²ï¼Œæ‰€ä»¥ä¼šåœ¨å®¿ä¸»æœºä¸Šå¼€æ”¾ä¸¤ä¸ªç«¯å£ï¼ˆæœ¬ä¾‹ä¸­æ˜¯30073å’Œ30220ï¼‰ï¼Œ
è¿™ä¸¤ä¸ªç«¯å£ä¼šåˆ†åˆ«ä»£ç†åˆ°Ingressæ§åˆ¶å™¨å†…éƒ¨çš„80å’Œ443ç«¯å£ã€‚

æœ¬ä¾‹ä¸­éƒ¨ç½²çš„Goåº”ç”¨æ˜¯ä¸€ä¸ªåç«¯æœåŠ¡ï¼Œå¯¹äºå‘å¤–æš´éœ²çš„ç«¯å£å·æ²¡æœ‰è¦æ±‚ã€‚
ä½†å¦‚æœæ˜¯ä¸€ä¸ªå‰ç«¯åº”ç”¨ï¼Œæ¯”å¦‚æ˜¯ä¸€ä¸ªWebç½‘ç«™ï¼Œé‚£ä¹ˆå¯èƒ½å°±æœ‰å¯¹å¤–æš´éœ²80/443ç«¯å£çš„è¦æ±‚ã€‚
æ­¤æ—¶å°±éœ€è¦è°ƒæ•´Ingressæ§åˆ¶å™¨éƒ¨ç½²æ–¹å¼ï¼Œä½¿ç”¨LoadBalanceræˆ–`HostNetwork`æ–¹å¼éƒ¨ç½²ã€‚

### 1.9 æ›´æ–°é…ç½®çš„æœ€ä½³å®è·µ

åº”ç”¨ä¸Šçº¿åï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæœ‰æ›´æ”¹åº”ç”¨é…ç½®çš„éœ€æ±‚ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯ç›´æ¥æ›´æ–°ç°æœ‰çš„ConfigMapï¼Œç„¶åé‡å¯æ‰€æœ‰Podã€‚
ä½†è¿™ä¸æ˜¯K8sçš„æœ€ä½³å®è·µã€‚åŸå› æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š

- æ›´æ–°ConfigMapä¸ä¼šè§¦å‘Deploymentä¸­æ‰€æœ‰Podé‡å¯
- è‹¥æ›´æ–°åçš„é…ç½®æœ‰é—®é¢˜ä¸èƒ½è¿…é€Ÿå›æ»šï¼ˆéœ€è¦å†æ¬¡ç¼–è¾‘ç°æœ‰ConfigMapï¼‰ï¼Œå¯¼è‡´æœåŠ¡çŸ­æš‚å®•æœº

è€Œæœ€ä½³å®è·µæ˜¯ä¸ºConfigMapå‘½åå¸¦ä¸Šç‰ˆæœ¬å·å¦‚`app-config-v1`ï¼Œç„¶åéƒ¨ç½²æ–°ç‰ˆæœ¬çš„ConfigMapï¼Œ
å†ä¿®æ”¹Deploymentæ¨¡æ¿ä¸­å¼•ç”¨çš„ConfigMapåç§°ï¼Œæœ€åæ›´æ–°Deploymentï¼ˆè§¦å‘æ‰€æœ‰Podæ»šåŠ¨æ›´æ–°ï¼‰ã€‚

å½“éœ€è¦å›æ»šæ—¶ï¼Œå†æ¬¡æ›´æ–°Deploymentå³å¯ã€‚

## 2. å¼€å‘è€…å·¥ä½œæµ

ä¸ºäº†æé«˜å¼€å‘äººå‘˜çš„å·¥ä½œæ•ˆç‡å’Œæœ€å¤§åŒ–åœ¨æ—¥å¸¸å·¥ä½œä¸­æ¨¡æ‹Ÿåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¼€å‘ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæ­å»ºä¸€ä¸ªå¼€å‘é›†ç¾¤æ¥æä¾›ç»™å¼€å‘è€…ä»¬å®Œæˆæ—¥å¸¸å¼€å‘ã€‚
ä½†éšä¹‹è€Œæ¥çš„å°±æ˜¯é›†ç¾¤çš„ç”¨æˆ·ç®¡ç†ã€èµ„æºé¢åº¦é™åˆ¶ä»¥åŠå›æ”¶å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¼€å‘è„šæœ¬æ¥è‡ªåŠ¨åŒ–å®Œæˆè¿™äº›å·¥ä½œã€‚

### 2.1 æ­å»ºä¸åŒç¯å¢ƒçš„é›†ç¾¤

**å¼€å‘é›†ç¾¤**  
æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå…±äº«K8sé›†ç¾¤æ¥æä¾›ç»™å¼€å‘è€…ä»¬ä½¿ç”¨ï¼Œä»–ä»¬çš„æ—¥å¸¸å¼€å‘æµç¨‹åŒ…æ‹¬PRæäº¤ã€ä»£ç reviewã€æ„å»ºã€éƒ¨ç½²ç­‰å·¥ä½œéƒ½å°†å’Œç”Ÿäº§ç¯å¢ƒä¿æŒåŸºæœ¬ä¸€è‡´ã€‚

ä½†æˆ‘ä»¬å¿…é¡»ä¸ºæ¯ä¸ªå¼€å‘è€…åˆ†é…å•ç‹¬çš„K8så‘½åç©ºé—´ï¼Œç„¶åè®¾ç½®èµ„æºé¢åº¦é™åˆ¶ï¼Œé˜²æ­¢å¼€å‘è€…ä»¬æ— èŠ‚åˆ¶åœ°ä½¿ç”¨é›†ç¾¤èµ„æºä»¥é€ æˆäº’ç›¸å¹²æ‰°ã€‚
å½“å›¢é˜Ÿè§„æ¨¡è¾ƒå¤§æ—¶ï¼Œå»ºè®®ä¸º10~20äººå…±äº«ä¸€ä¸ªé›†ç¾¤ï¼Œè€Œä¸æ˜¯ä¸Šç™¾äººå…±äº«ä¸€ä¸ªè¶…å¤§é›†ç¾¤ï¼Œè¿™æ ·å¯ä»¥ç®€åŒ–é›†ç¾¤çš„ç®¡ç†å·¥ä½œã€‚

**æµ‹è¯•ç¯å¢ƒ**  
å½“å¼€å‘è€…åœ¨å¼€å‘ç¯å¢ƒå®Œæ•´æµ‹è¯•è¿‡è‡ªå·±æäº¤çš„ä»£ç åï¼Œå°±å¯ä»¥è€ƒè™‘éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒï¼Œå¹¶å‘ŠçŸ¥æµ‹è¯•äººå‘˜è¿›è¡Œæµ‹è¯•ã€‚
æµ‹è¯•ç¯å¢ƒé€šå¸¸åªæœ‰ä¸€ä¸ªK8sé›†ç¾¤ç”±æ‰€æœ‰äººå…±äº«ã€‚

**é¢„å‘å¸ƒç¯å¢ƒ**  
å¤§éƒ¨åˆ†å…¬å¸éƒ½ä¼šæœ‰ä¸€ä¸ªé¢„å‘å¸ƒç¯å¢ƒï¼Œç”¨æ¥éƒ¨ç½²ä¸€äº›éœ€è¦ç»è¿‡æµ‹è¯•ç¯å¢ƒéªŒè¯çš„åº”ç”¨ç‰ˆæœ¬ï¼Œæ¯”å¦‚ä¸€äº›æ–°åŠŸèƒ½æˆ–ä¸€äº›éœ€è¦ä¿®å¤çš„bugã€‚
è¿™ä¸ªç¯å¢ƒåº”è¯¥ä¸ç”Ÿäº§ç¯å¢ƒå°½å¯èƒ½ä¿æŒé«˜åº¦ä¸€è‡´ï¼ŒåŒ…æ‹¬èŠ‚ç‚¹æ•°é‡ã€ç½‘ç»œç­‰å…¶ä»–é…ç½®ï¼Œä¸”ç›¸å¯¹æµ‹è¯•ç¯å¢ƒå…·æœ‰æ›´ä¸¥æ ¼çš„æƒé™æ§åˆ¶ã€‚
ä¸å…è®¸å¼€å‘è€…éšæ„æ›´æ”¹æ•°æ®åº“ç­‰é…ç½®ï¼Œæµ‹è¯•äººå‘˜åœ¨é¢„å‘å¸ƒç¯å¢ƒåº”æŒ‰ç…§ç”Ÿäº§ç¯å¢ƒçš„æ ‡å‡†è¿›è¡Œæµ‹è¯•ã€‚

**é•œåƒä»“åº“**  
é•œåƒä»“åº“æ˜¯ç”¨æ¥å­˜æ”¾åº”ç”¨é•œåƒçš„åœ°æ–¹ï¼Œé€šå¸¸ç”±è¿ç»´äººå‘˜æ¥ç»´æŠ¤ã€‚æ¯ä¸ªç¯å¢ƒéƒ½åº”è¯¥æœ‰ä¸€ä¸ªæœ¬åœ°çš„é•œåƒä»“åº“ï¼Œä»¥åŠ å¿«åº”ç”¨éƒ¨ç½²ã€‚

### 2.2 ç®¡ç†å‘˜ä½¿ç”¨çš„è„šæœ¬

ä¸ºäº†ç®€åŒ–é›†ç¾¤çš„ç”¨æˆ·ç®¡ç†ã€èµ„æºé¢åº¦é™åˆ¶ä»¥åŠå›æ”¶å·¥ä½œï¼Œæˆ‘ä»¬å¯ä»¥å¼€å‘ä¸€äº›è„šæœ¬æ¥ååŠ©ç®¡ç†å‘˜è½»æ¾å®Œæˆè¿™äº›å·¥ä½œã€‚

- [new_user.sh](k8s_actions_guide/version1/script/new_user.sh)ï¼šåœ¨é›†ç¾¤ä¸­æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·ï¼Œå¹¶åˆ›å»ºç›¸åº”çš„å‘½åç©ºé—´ã€è§’è‰²å’Œé¢åº¦é™åˆ¶ã€‚
    - æ­¤è„šæœ¬ä¼šåŒæ—¶ç”Ÿæˆ`client-cert-$USER.crt`å’Œ`client-cert-$USER.key`
- [del_user.sh](k8s_actions_guide/version1/script/del_user.sh)ï¼šåˆ é™¤é›†ç¾¤ä¸­çš„ä¸€ä¸ªç”¨æˆ·å‘½åç©ºé—´ï¼ˆåŒ…å«ç©ºé—´ä¸‹çš„æ‰€æœ‰èµ„æºï¼‰ã€‚
- [setup_kubeconfig.sh](k8s_actions_guide/version1/script/setup_kubeconfig.sh)ï¼šåˆå§‹åŒ–ç”¨æˆ·ä½¿ç”¨çš„kubeconfigæ–‡ä»¶ã€‚
    - æ­¤è„šæœ¬ä¼šåœ¨æ‰§è¡Œç›®å½•ä¸‹ç”Ÿæˆ`dev-config`æ–‡ä»¶ï¼Œå°†æ­¤æ–‡ä»¶åˆ†å‘ç»™å¯¹åº”å¼€å‘äººå‘˜ä½œä¸ºkubeconfigæ–‡ä»¶å³å¯ã€‚

> ç¬”è€…åœ¨è„šæœ¬ä¸­æ·»åŠ äº†è¯¦å®çš„æ³¨é‡Šï¼Œä½ å¯ä»¥é˜…è¯»å®ƒä»¬æ¥äº†è§£è„šæœ¬ç”¨æ³•å’Œæ­¥éª¤å«ä¹‰ã€‚

### 2.3 æ›´æ–¹ä¾¿çš„æŸ¥è¯¢åº”ç”¨æ—¥å¿—

åº”ç”¨ä¸Šçº¿åï¼Œæˆ‘ä»¬é€šå¸¸ä¼šæœ‰æŸ¥çœ‹åº”ç”¨æ—¥å¿—çš„éœ€æ±‚ã€‚
é»˜è®¤çš„åº”ç”¨æ—¥å¿—åˆ†æ•£å­˜å‚¨åœ¨æ¯ä¸ªPodæ‰€åœ¨èŠ‚ç‚¹çš„`/var/log/pods`ç›®å½•ï¼Œä¸”å®ƒä»¬ä¼šä¼´éšPodçš„æ¶ˆå¤±è€Œè¢«åˆ é™¤ã€‚
è¿™ä¸åˆ©ç”¨å¼€å‘è€…ä»¬æŸ¥çœ‹æ—¥å¿—çš„éœ€æ±‚ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªä¸­å¿ƒåŒ–å­˜å‚¨æ—¥å¿—çš„æ–¹æ¡ˆã€‚
è¯·å‚è€ƒ[Kubernetes æ—¥å¿—æ”¶é›†](doc_log_collection.md)æ¥äº†è§£å¦‚ä½•æ­å»ºæ—¥å¿—æ”¶é›†ç³»ç»Ÿã€‚

å¦‚æœå› ä¸ºæŸäº›åŸå› ä¸å¸Œæœ›æ­å»ºæ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼ˆæˆ–è€…è¯´æ˜¯å·æ‡’~ï¼‰ï¼Œ
ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„kubeleté…ç½®æ¥è°ƒæ•´å®¹å™¨æ—¥å¿—çš„å­˜å‚¨å¤§å°å’Œæ–‡ä»¶æ•°é‡ï¼Œå…·ä½“æ­¥éª¤ä¹Ÿè¯·å‚è€ƒ[Kubernetes æ—¥å¿—æ”¶é›†ä¸­çš„
*ä¸šåŠ¡å®¹å™¨æ—¥å¿—*](doc_log_collection.md#11-ä¸šåŠ¡å®¹å™¨æ—¥å¿—)ã€‚
å…¶æ¬¡ï¼Œä½ è¿˜å¯ä»¥å‚è€ƒ[Kubernetes ç»´æŠ¤æŒ‡å¯¼ä¸­çš„*æ—¥å¿—æŸ¥çœ‹*](doc_maintaintion.md#15-æ—¥å¿—æŸ¥çœ‹)æ¥ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·æ¥é«˜æ•ˆæŸ¥è¯¢å®¹å™¨æ—¥å¿—ã€‚

> é™¤äº†Podæ—¥å¿—ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å…³æ³¨é›†ç¾¤ç»„ä»¶æ—¥å¿—ã€èŠ‚ç‚¹æ—¥å¿—ã€é›†ç¾¤å®¡è®¡æ—¥å¿—ã€‚

### 2.4 å¯åŠ¨å¼€å‘

å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¼€å‘è€…éœ€è¦é¢‘ç¹åœ°æ„å»ºå¹¶æ¨é€é•œåƒã€æ›´æ–°åº”ç”¨ã€æŸ¥çœ‹åº”ç”¨æ—¥å¿—ã€‚
è¿™å…¶ä¸­æœ€ä¸ºé‡è¦çš„æ­¥éª¤å°±æ˜¯é•œåƒtagå®šä¹‰ä»¥åŠæ›´æ–°åº”ç”¨çš„æ“ä½œã€‚

**é•œåƒtagä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰è€Œä¸æ˜¯latest**  
åœ¨æ„å»ºç”¨äºå¼€å‘ç¯å¢ƒçš„è‡ªæµ‹è¯•é•œåƒæ—¶ï¼Œå¯¹äºé•œåƒtagï¼Œå¼€å‘è€…æœ€å¥½æ˜¯ä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰è€Œä¸æ˜¯`latest`ã€‚
ä½¿ç”¨`latest`å¯ä»¥å…å»æ¯æ¬¡æ„å»ºé•œåƒæ—¶éƒ½éœ€è¦æ‰‹åŠ¨ä¿®æ”¹tagçš„éº»çƒ¦ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†ä¸ç¡®å®šæ€§ã€‚
å› ä¸ºä½ æ— æ³•å®Œå…¨ç¡®å®šæ‰€æ›´æ–°çš„åº”ç”¨ä½¿ç”¨äº†ä½ åˆšåˆšæ„å»ºå¹¶æ¨é€çš„é•œåƒã€‚å€˜è‹¥ä½ å°†è¯¯ä»¥ä¸ºè‡ªæµ‹æˆåŠŸçš„ä»£ç å‘å¸ƒåˆ°äº†ç”Ÿäº§ç¯å¢ƒï¼Œ
éš¾ä»¥æƒ³è±¡å°†ä¼šå‘ç”Ÿçš„äº‹æƒ…å’Œé¢ä¸´çš„åæœğŸ˜‘ã€‚

**æ›´æ–°åº”ç”¨**  
åœ¨ä½¿ç”¨ç‰ˆæœ¬åŒ–è¯­ä¹‰çš„é•œåƒtagåï¼Œæˆ‘ä»¬å¯ä»¥æ›´ä»å®¹çš„ä½¿ç”¨`kubectl set image...`å‘½ä»¤æ¥æ›´æ–°åº”ç”¨ã€‚
æ³¨æ„ï¼Œåœ¨å¼€å‘ä»¥åŠåç»­çš„ä¸Šçº¿è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éƒ½ä¸éœ€è¦ä¿®æ”¹ä»£ç åº“ä¸­çš„Deployment YAMLæ–‡ä»¶ã€‚

### 2.5 ä½¿ç”¨ç¬¬ä¸‰æ–¹å·¥å…·ä¸ºå¼€å‘ææ•ˆ

#### 2.5.1 IDEæ’ä»¶

ç¼–å†™æ­¤æ–‡æ—¶å·²ç»æ˜¯2024å¹´äº†ï¼Œä¸»æµçš„VSCodeå’ŒJetbrainså®¶æ—IDEéƒ½å·²ç»æœ‰å¤§é‡çš„Kubernetesæ’ä»¶å¯ç”¨ï¼Œ
è¿™äº›æ’ä»¶å¯ä»¥å¸®åŠ©å¼€å‘è€…é€šè¿‡å›¾å½¢åŒ–çš„æ–¹å¼ä¸å¼€å‘ç¯å¢ƒçš„K8sé›†ç¾¤è¿›è¡Œä¾¿æ·äº¤äº’ï¼Œå…å»æ‰‹åŠ¨è¾“å…¥kubectlå‘½ä»¤çš„ç¹çã€‚

#### 2.5.2 K9sç»ˆç«¯é¢æ¿

K9sæ˜¯ä¸€ä¸ªç»ˆç«¯å½¢å¼çš„K8sèµ„æºé¢æ¿ï¼Œå®ƒæ”¯æŒåœ¨ç»ˆç«¯ä¸­ä»¥å¯è§†åŒ–æ–¹å¼æŸ¥çœ‹å’Œç®¡ç†Kubernetesé›†ç¾¤ä¸­çš„èµ„æºï¼ŒåŒ…æ‹¬Podã€Deploymentã€Serviceç­‰ã€‚
å®ƒæ”¯æŒä»¥æ–¹å‘é”®ã€å›è½¦é”®å’Œç©ºæ ¼é”®ä¸é¢æ¿äº¤äº’ï¼Œå…å»æ‰‹æ•²å‘½ä»¤çš„éº»çƒ¦ã€‚

æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ç¯å¢ƒå’Œé¢„å‘å¸ƒç¯å¢ƒï¼ˆä¹ŸåŒ…æ‹¬ç”Ÿäº§ç¯å¢ƒï¼‰å®‰è£…K9sï¼Œè¿™æ ·å¯ä»¥æ›´ä¾¿æ·çš„æŸ¥çœ‹åº”ç”¨çŠ¶æ€ã€æ—¥å¿—ã€äº‹ä»¶ã€ä»¥åŠè¿›å…¥Podå†…çš„å®¹å™¨Shellï¼Œæå¤§åœ°æ”¹å–„äº†K8sçš„ä½¿ç”¨ä½“éªŒã€‚

#### 2.5.3 å¼€æºK8sæ—¥å¿—å·¥å…·

å¸¸è§„æŸ¥çœ‹å®¹å™¨æ—¥å¿—çš„å‘½ä»¤æ˜¯`kubectl logs`ï¼Œä½†è¿™ä¸ªå‘½ä»¤æœ‰ä¸€äº›å±€é™æ€§ï¼Œæ¯”å¦‚ï¼š

- ä¸€æ¬¡åªèƒ½æŸ¥çœ‹ä¸€ä¸ªPodçš„æ—¥å¿—ï¼ˆè‹¥ä¸ä½¿ç”¨`-l`çš„è¯ï¼‰
- ä¸èƒ½æŒ‡å®šDeploymentã€Serviceã€Jobã€Statefulå’ŒIngressåç§°è¿›è¡Œæ—¥å¿—æŸ¥çœ‹
- ä¸èƒ½æŸ¥çœ‹æŒ‡å®šèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰Podæ—¥å¿—
- ä¸æ”¯æŒé¢œè‰²æ‰“å°

ç­‰ç­‰ã€‚ä½ å¯ä»¥ä½¿ç”¨å¼€æºçš„K8s Podæ—¥å¿—æŸ¥çœ‹å·¥å…·æ¥æé«˜æ•ˆç‡ï¼Œå…·ä½“å¯ä»¥å‚è€ƒ *Kubernetes ç»´æŠ¤æŒ‡å¯¼*
ä¸­çš„[æ—¥å¿—æŸ¥çœ‹](doc_maintaintion.md#15-æ—¥å¿—æŸ¥çœ‹)å°èŠ‚ã€‚

#### 2.5.4 K8sèµ„æºæ¸…å•é£é™©åˆ†æå·¥å…·

æˆ–è®¸åœ¨è¾ƒå°çš„é›†ç¾¤ä¸­æˆ–è€…æ˜¯ä¸é‚£ä¹ˆé‡è¦çš„ä¸šåŠ¡ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šå»ç‰¹åˆ«æ³¨æ„K8sèµ„æºæ¸…å•çš„ç¼–å†™è§„èŒƒï¼Œä¾‹å¦‚å¯¹å®¹å™¨çš„CPU/å†…å­˜é™åˆ¶ã€è®¾ç½®å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡ç­‰ã€‚
ä½†æˆ‘ä»¬éœ€è¦çŸ¥é“ï¼ŒPodä¸­çš„å®¹å™¨æ˜¯æœ¬è´¨ä¸Šæ¥è¯´è¿˜æ˜¯è¿è¡Œåœ¨é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„ï¼Œä¸å®‰å…¨çš„èµ„æºæ¸…å•å¯èƒ½ä¼šå¯¼è‡´å®¹å™¨åœ¨èŠ‚ç‚¹ä¸Šè¢«æ¶æ„åˆ©ç”¨ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤è¢«æ”»å‡»ã€‚

å¥½åœ¨å·²ç»æœ‰ä¸å°‘å¼€æºå·¥å…·å¯ä»¥ååŠ©æˆ‘ä»¬è½»æ¾å®Œæˆèµ„æºæ¸…å•çš„ä¿®å¤å·¥ä½œï¼Œè¿™é‡Œæ¨èä»¥ä¸‹å‡ ä¸ªå·¥å…·ï¼š

- [KubeLinter](https://github.com/stackrox/kube-linter)
- [KubeSec](https://kubesec.io/)
- [kube-score](https://github.com/zegl/kube-score)
- [polaris](https://github.com/FairwindsOps/polaris)

ä½ å¯ä»¥å°†è¿™äº›å·¥å…·ä¸­çš„ä¸€ä¸ªæˆ–å‡ ä¸ªæ·»åŠ CI/CDæµæ°´çº¿ä¸­ï¼Œä»¥åœ¨æ¯æ¬¡æäº¤ä»£ç æ—¶è‡ªåŠ¨æ£€æŸ¥èµ„æºæ¸…å•çš„å®‰å…¨æ€§ã€‚

## 3. é‡‡é›†é›†ç¾¤æŒ‡æ ‡

### 3.1 ç®€ä»‹

æŒ‡æ ‡æ˜¯æŒ‡é’ˆå¯¹æŸä¸€ç§èµ„æºåœ¨ä¸€æ®µæ—¶é—´å†…çš„ä½¿ç”¨æƒ…å†µçš„ç»Ÿè®¡ï¼Œä¾‹å¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€ç½‘ç»œå¸¦å®½ã€ç£ç›˜ä½¿ç”¨é‡ç­‰ã€‚

æŒ‡æ ‡é‡‡é›†é€šå¸¸æœ‰ä¸¤ç§è¯´æ³•ï¼Œå³é»‘ç›’ç›‘æ§å’Œç™½ç›’ç›‘æ§ã€‚é»‘ç›’ç›‘æ§æ˜¯ä»é›†ç¾¤çš„å¤–éƒ¨è§†è§’é‡‡é›†æ•°æ®ã€‚å¤šç”¨äºä¼ ç»Ÿçš„CPUã€å†…å­˜ã€ç£ç›˜ç­‰ç¡¬ä»¶èµ„æºçš„ç›‘æ§ï¼Œ
éå¸¸é€‚ç”¨äºå¯¹åŸºç¡€è®¾æ–½çš„ç›‘æ§ã€‚è€Œç™½ç›’ç›‘æ§æ›´å…³æ³¨åº”ç”¨ç¨‹åºçš„çŠ¶æ€ç»†èŠ‚ï¼Œæ¯”å¦‚HTTPè¯·æ±‚æ€»æ•°ã€500é”™è¯¯è¯·æ±‚æ•°å’Œè¯·æ±‚å»¶è¿Ÿç­‰ã€‚
ç™½ç›’ç›‘æ§è®©æˆ‘ä»¬çŸ¥é“ç³»ç»Ÿä¸ºä»€ä¹ˆå¤„äºå½“å‰çŠ¶æ€ï¼Œè®©æ•…éšœå®šä½è¿›ä¸€æ­¥æœ‰è¿¹å¯å¾ªã€‚

### 3.2 ä¸¤ç§ç›‘æ§æ¨¡å¼

å®ƒä»¬åˆ†åˆ«æ˜¯USEå’ŒREDæ¨¡å¼ã€‚

#### 3.2.1 USEæ¨¡å¼

USEçš„é‡Šä¹‰å¦‚ä¸‹ï¼š

- Uâ€”â€”Utilizationï¼ˆåˆ©ç”¨ç‡ï¼‰
- Sâ€”â€”Saturationï¼ˆé¥±å’Œåº¦ï¼‰
- Eâ€”â€”Errorsï¼ˆé”™è¯¯ç‡ï¼‰

è¿™ç§æ¨¡å¼ä¸“æ³¨äºåŸºç¡€è®¾æ–½ç›‘æ§ï¼Œå¯¹åº”é»‘ç›’ç›‘æ§ã€‚

#### 3.2.2 REDæ¨¡å¼

REDçš„é‡Šä¹‰å¦‚ä¸‹ï¼š

- Râ€”â€”Rateï¼ˆæ¯ç§’æ¥å—çš„è¯·æ±‚æ•°ï¼‰
- Eâ€”â€”Errorï¼ˆæ¯ç§’å¤±è´¥çš„è¯·æ±‚æ•°ï¼‰
- Dâ€”â€”Durationï¼ˆæ¯ä¸ªè¯·æ±‚çš„è€—æ—¶ï¼‰

è¿™ç§æ¨¡å¼ä¸“æ³¨äºåº”ç”¨ç¨‹åºç›‘æ§ï¼Œå¯¹åº”ç™½ç›’ç›‘æ§ã€‚

### 3.3 é‡‡é›†ç›®æ ‡

äº†è§£äº†ä¸Šé¢çš„ç›‘æ§æ¨¡å¼åï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦çŸ¥é“åº”è¯¥åœ¨é›†ç¾¤ä¸­è¿›è¡ŒæŒ‡æ ‡é‡‡é›†çš„ç›®æ ‡æœ‰å“ªäº›ã€‚
è¿™é‡Œç¬”è€…å°†å®ƒä»¬åˆ†ç±»åˆ—å‡ºï¼š

- æ§åˆ¶å¹³é¢ï¼šAPI Serverã€etcdã€Schedulerã€Controller Manager
- å·¥ä½œèŠ‚ç‚¹ï¼škubeletã€å®¹å™¨è¿è¡Œæ—¶ã€kube-proxyã€kube-dnså’ŒPod

ä¸Šé¢é™¤äº†å·¥ä½œèŠ‚ç‚¹çš„Podä»¥å¤–ï¼Œå…¶ä»–å¯ä»¥å½’ç±»ä¸ºåŸºç¡€è®¾æ–½ç»„ä»¶ã€‚æˆ‘ä»¬éœ€è¦ç›‘æ§è¿™äº›ç»„ä»¶æš´éœ²çš„å„é¡¹æŒ‡æ ‡å¹¶åŠæ—¶åšå‡ºå“åº”ï¼Œ
æ‰èƒ½ç¡®ä¿é›†ç¾¤çš„ç¨³å®šè¿è¡Œã€‚

### 3.4 é‡‡é›†æ¶æ„

#### 3.4.1 ä½¿ç”¨Prometheusä½œä¸ºå­˜å‚¨åç«¯

Prometheusæ˜¯CNCFï¼ˆäº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šï¼‰ä¸­æ’åä»…æ¬¡äº Kubernetes çš„ä¸€ä¸ªé‡é‡çº§å¼€æºé¡¹ç›®ï¼Œæ˜¯ä¸€ä¸ªç”¨äºç›‘æ§å’Œå‘Šè­¦çš„å¼€æºç³»ç»Ÿã€‚
å®ƒæä¾›äº†ä¸€ä¸ªçµæ´»çš„æŸ¥è¯¢è¯­è¨€å«åš**PromQL**ï¼Œè®©æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°æŸ¥è¯¢å’Œåˆ†æç›‘æ§æ•°æ®ã€‚ç›®å‰ï¼ŒPrometheuså·²ç»æ˜¯ä¸šç•Œå…¬è®¤çš„ç›‘æ§äº‹å®æ ‡å‡†ã€‚

Prometheusæ¶æ„å›¾å¦‚ä¸‹
![](./img/prometheus_architecture.png)

ç®€å•æ¥è¯´ï¼ŒPrometheusç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

- Prometheus Serverï¼šè´Ÿè´£æ•°æ®é‡‡é›†å’Œå­˜å‚¨ï¼Œå¹¶æä¾›PromQLæŸ¥è¯¢è¯­è¨€çš„æ”¯æŒã€‚
- Push Gatewayï¼šæ”¯æŒä¸´æ—¶æ€§ä»»åŠ¡çš„æ•°æ®é‡‡é›†ã€‚
- Exporterï¼šç”¨äºæš´éœ²è¢«ç›‘æ§ç»„ä»¶çš„æ•°æ®æ¥å£ã€‚
    - å¯¹äºä¸åŒçš„é‡‡é›†ç›®æ ‡ï¼ˆä¾‹å¦‚ä¸»æœºèŠ‚ç‚¹ï¼‰éœ€è¦éƒ¨ç½²å¯¹åº”çš„Exporterï¼Œç„¶åé…ç½®Prometheusä¸»åŠ¨é‡‡é›†å³å¯ã€‚
    - å¸¸è§çš„æœ‰ï¼šnode_exporterã€blackbox_exporterã€mysqld_exporterã€redis_exporterç­‰ã€‚
- Client Libraryï¼šå®¢æˆ·ç«¯åº“ï¼Œä¸ºéœ€è¦ç›‘æ§çš„ç»„ä»¶æä¾›æ–¹ä¾¿çš„æ¥å…¥æ–¹å¼ã€‚
    - å¯¹äºé‚£äº›æ²¡æœ‰Exporterçš„é‡‡é›†ç›®æ ‡ï¼ˆæ¯”å¦‚ä¸šåŠ¡åº”ç”¨ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯åº“è‡ªè¡Œä¸ŠæŠ¥æ•°æ®åˆ°Prometheus Serverä¸­ã€‚
- Alert-managerï¼šè´Ÿè´£æ¥æ”¶Prometheusçš„å‘Šè­¦ä¿¡æ¯ï¼Œå¹¶å†³å®šå¦‚ä½•å¯¹å‘Šè­¦è¿›è¡Œå¤„ç†ï¼Œå¦‚å‘é€é‚®ä»¶ã€çŸ­ä¿¡ã€è°ƒç”¨Webhookç­‰ã€‚

é€šè¿‡ä¸Šé¢çš„æ¶æ„å›¾å’Œæ–‡å­—è¯´æ˜ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°Prometheusæ”¯æŒä»¥æ¨/æ‹‰çš„æ–¹å¼é‡‡é›†å„ç§ç›®æ ‡æä¾›çš„æŒ‡æ ‡æ•°æ®ã€‚

#### 3.4.2 Prometheuså››ç§æŒ‡æ ‡ç±»å‹

Prometheusä¸­çš„æŒ‡æ ‡å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å››ç§ç±»å‹ï¼š

- Counterï¼ˆè®¡æ•°å™¨ï¼‰
    - ç®€ä»‹ï¼šCounter æ˜¯ä¸€ä¸ªç´¯åŠ å™¨ï¼Œåªèƒ½å¢åŠ ï¼Œä¸èƒ½å‡å°‘ã€‚é€šå¸¸ç”¨äºè¡¨ç¤ºç´¯ç§¯çš„äº‹ä»¶è®¡æ•°ï¼Œæ¯”å¦‚è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ€»æ•°ç­‰ã€‚
    - å…¸å‹ç”¨æ³•ï¼šè®°å½•äº‹ä»¶çš„æ€»æ•°é‡ï¼Œä¾‹å¦‚ HTTP è¯·æ±‚æ€»æ•°ã€é”™è¯¯æ•°é‡ã€ä»»åŠ¡å®Œæˆæ¬¡æ•°ç­‰ã€‚
    - ç¤ºä¾‹ï¼šhttp_requests_total, errors_total, tasks_completed_totalã€‚
- Gaugeï¼ˆä»ªè¡¨ç›˜ï¼‰
    - ç®€ä»‹ï¼šGauge æ˜¯ä¸€ä¸ªå¯å˜åŒ–çš„æ•°å€¼ï¼Œå¯ä»¥å¢åŠ ä¹Ÿå¯ä»¥å‡å°‘ã€‚ç”¨äºè¡¨ç¤ºå¯å˜çš„åº¦é‡ï¼Œå¦‚æ¸©åº¦ã€å†…å­˜ä½¿ç”¨ç‡ç­‰ã€‚
    - å…¸å‹ç”¨æ³•ï¼šè·Ÿè¸ªéšæ—¶é—´å˜åŒ–çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚ CPU ä½¿ç”¨ç‡ã€å†…å­˜å ç”¨é‡ã€è¿æ¥æ•°ç­‰ã€‚
    - ç¤ºä¾‹ï¼šcpu_usage, memory_usage, active_connections.
- Histogramï¼ˆç›´æ–¹å›¾ï¼‰
    - ç®€ä»‹ï¼šHistogram ç»Ÿè®¡å’Œå­˜å‚¨æ•°æ®çš„åˆ†å¸ƒæƒ…å†µï¼Œå¦‚è¯·æ±‚å“åº”æ—¶é—´çš„åˆ†å¸ƒã€‚
    - å…¸å‹ç”¨æ³•ï¼šè¡¡é‡æŒç»­æ—¶é—´æˆ–å€¼çš„åˆ†å¸ƒæƒ…å†µï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´ã€API è°ƒç”¨è€—æ—¶ç­‰ã€‚
    - ç¤ºä¾‹ï¼šhttp_request_duration_seconds.
- Summaryï¼ˆæ‘˜è¦ï¼‰
    - ç®€ä»‹ï¼šSummary ä¹Ÿç”¨äºè®°å½•æŒç»­æ—¶é—´æ•°æ®ï¼Œä½†å®ƒæä¾›çš„æ˜¯å¯å˜ç²¾åº¦çš„æ‘˜è¦ï¼Œè€Œä¸æ˜¯å›ºå®šæ•°é‡çš„æ¡¶ã€‚
    - å…¸å‹ç”¨æ³•ï¼šä¸ Histogram ç±»ä¼¼ï¼Œç”¨äºè®°å½•æŒç»­æ—¶é—´ï¼Œä½†é€šå¸¸ç”¨äºæ›´å¤æ‚çš„åˆ†å¸ƒæƒ…å†µï¼Œæ¯”å¦‚ p50ã€p90ã€p99 ç­‰åˆ†ä½æ•°ã€‚
    - ç¤ºä¾‹ï¼šapi_request_duration_seconds_summary.

è¿™å››ç§æŒ‡æ ‡ç±»å‹å‡ ä¹è¦†ç›–æ‰€æœ‰åœºæ™¯ï¼Œå¹¶ä¸”æ¯ç§ç±»å‹éƒ½æä¾›äº†ä¸°å¯Œçš„æ ‡ç­¾ï¼ˆlabelï¼‰ç”¨äºæè¿°æŒ‡æ ‡çš„ç»´åº¦ä¿¡æ¯ã€‚
æˆ‘ä»¬åªéœ€è¦åœ¨æ¨/æ‹‰æ•°æ®æ—¶æŒ‡å®šéœ€è¦é‡‡é›†çš„æŒ‡æ ‡ç±»å‹å’Œæ ‡ç­¾ï¼ŒPrometheuså°±èƒ½è‡ªåŠ¨è¿›è¡Œæ•°æ®é‡‡é›†å’Œå­˜å‚¨ã€‚

#### 3.4.3 ä½¿ç”¨Grafanaä½œä¸ºå¯è§†åŒ–ç»„ä»¶

Prometheusæœ¬è´¨ä¸Šåªæ˜¯ä¸€ä¸ªæ—¶åºæ•°æ®åº“ï¼Œå®ƒæœ¬èº«å¹¶ä¸å…·å¤‡å¼ºå¤§çš„å¯è§†åŒ–èƒ½åŠ›ã€‚è¦æƒ³å°†é‡‡é›†åˆ°çš„æŒ‡æ ‡æ•°æ®è¿›è¡Œä¸°å¯Œçš„å¯è§†åŒ–å±•ç¤ºï¼Œ
æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ä¸ªå¯è§†åŒ–ç»„ä»¶ï¼Œå®ƒå°±æ˜¯Grafanaã€‚Prometheus+Grafanaæ˜¯ä¸€ä¸ªå¸¸è§çš„å…„å¼Ÿç»„åˆï¼Œå‡ ä¹ä¸ä¼šåˆ†å¼€ä½¿ç”¨ã€‚

Grafanaæ˜¯ä¸€ä¸ªå¼€æºçš„åº¦é‡åˆ†æå’Œå¯è§†åŒ–å¹³å°ï¼Œå®ƒå¯ä»¥é€šè¿‡å°†æ—¶åºæ•°æ®å¯¼å…¥å…¶ä¸­è€Œå»ºç«‹ä¸€ä¸ªæ•°æ®ä»ªè¡¨ç›˜ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œ
ä½ åªéœ€è¦é€šè¿‡ä¸€ä¸ªç½‘é¡µä¸Šçš„æ•°æ®å¤§ç›˜å°±èƒ½å¯¹æ•´ä¸ªé›†ç¾¤ï¼ˆåŒ…æ‹¬å‡ åä¸Šç™¾ç”šè‡³æ›´å¤šçš„èŠ‚ç‚¹ï¼‰çš„è¿è¡ŒçŠ¶æ€äº†å¦‚æŒ‡æŒï¼Œè¿™è¯¥æ˜¯å¤šä¹ˆé…·çš„ä¸€ä»¶äº‹æƒ…ã€‚

å½“ç„¶è¿™ä¸ªå…„å¼Ÿç»„åˆå¹¶ä¸ä»…ä»…ç”¨äºKubernetesé›†ç¾¤ç›‘æ§ï¼Œå®ƒè¿˜å¯ä»¥ç”¨äºå„ç§éœ€è¦ç›‘æ§å’Œå¯è§†åŒ–çš„åœºæ™¯ã€‚æ¯”å¦‚åœ¨ä½ çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œ
éœ€è¦ç›‘æ§ä»Š/æ˜¨æ—¥çš„è¥æ”¶ã€æ˜¨æ—¥çš„PVã€ä»Šæ—¥çš„UVã€ä»Šæ—¥çš„è®¢å•é‡ç­‰ã€‚

#### 3.4.4 é‡‡é›†å®¹å™¨æŒ‡æ ‡ï¼ˆcAdvisorï¼‰

cAdvisoræ˜¯Googleå¼€æºçš„ä¸€æ¬¾ç”¨äºå±•ç¤ºå’Œåˆ†æå®¹å™¨è¿è¡ŒçŠ¶æ€çš„å¯è§†åŒ–å·¥å…·ã€‚é€šè¿‡åœ¨ä¸»æœºä¸Šè¿è¡ŒCAdvisorç”¨æˆ·å¯ä»¥è½»æ¾çš„è·å–åˆ°å½“å‰ä¸»æœºä¸Šå®¹å™¨çš„è¿è¡Œç»Ÿè®¡ä¿¡æ¯ï¼Œ
ä¾‹å¦‚CPUä½¿ç”¨ç‡ã€å†…å­˜ä½¿ç”¨é‡ã€ç½‘ç»œå¸¦å®½å’Œç£ç›˜ä½¿ç”¨é‡ç­‰ã€‚ä½ å¯ä»¥å‚è€ƒ [cadvisorçš„å®‰è£…ä¸ä½¿ç”¨][cadvisor] æ¥è¿›ä¸€æ­¥äº†è§£å®ƒçš„åŸºæœ¬åŸç†å’Œä½¿ç”¨æ–¹æ³•ã€‚

cAdvisoræš´éœ²äº†Prometheusæ”¯æŒçš„æŒ‡æ ‡æ ¼å¼ï¼Œé€šè¿‡äºŒè€…ç»“åˆï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾è·å–åˆ°Kubernetesé›†ç¾¤ä¸­çš„Podå†…éƒ¨å®¹å™¨çº§åˆ«çš„ç›‘æ§æ•°æ®ã€‚

> kubeletä¹Ÿæ˜¯é€šè¿‡å†…ç½®cAdvisoræ¥ç›‘æ§å®¹å™¨æŒ‡æ ‡ã€‚

#### 3.4.5 Metrics Server

Metrics Serveræ˜¯K8sçš„ä¸€ä¸ªé™„åŠ ç»„ä»¶ï¼Œå®ƒå®ç°äº†API Serverå®šä¹‰çš„[Metrics API][MetricsAPI]ã€‚
Metrics APIä¸»è¦ä¸ºç”¨æˆ·æä¾›é›†ç¾¤ä¸­å¤„äºè¿è¡ŒçŠ¶æ€çš„Podå’ŒNodeçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µï¼Œ
è®¾è®¡ç”¨äºK8sçš„HPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰ä»¥åŠVPAï¼ˆVertical Pod Autoscalingï¼ŒPodå‚ç›´è‡ªåŠ¨ä¼¸ç¼©ï¼‰åŠŸèƒ½ã€‚

Metrics Serverå†…éƒ¨é€šè¿‡è°ƒç”¨kubelet APIæ¥ç›‘æ§å®¹å™¨æ•°æ®ï¼Œç„¶åé€šè¿‡Metrics APIæš´éœ²ç»™API Serverä½¿ç”¨ã€‚
å½“å®‰è£…Metrics Serveråï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨`kubelet top`å‘½ä»¤æ¥æŸ¥çœ‹é›†ç¾¤ä¸­Podå’ŒNodeçš„CPUå’Œå†…å­˜ä½¿ç”¨æƒ…å†µã€‚å…³äºå®ƒçš„å®‰è£…å’Œä½¿ç”¨ç»†èŠ‚ï¼Œ
ä½ å¯ä»¥å‚è€ƒç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« *K8sè¿›é˜¶æ•™ç¨‹*ä¸­çš„ [å®‰è£…Metrics Serveræ’ä»¶](doc_tutorial_senior.md#341-å®‰è£…Metrics-Serveræ’ä»¶)
ä¸€èŠ‚ã€‚

äº†è§£æ›´å¤šï¼š

- [Resource Metrics Pipeline](https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/)
- [Metrics Server](https://github.com/kubernetes-incubator/metrics-server)

#### 3.4.6 è‡ªå®šä¹‰æŒ‡æ ‡

å‰é¢æˆ‘ä»¬è¯´åˆ°ä½¿ç”¨Prometheus+Grafanaçš„ç»„åˆæ¥ç›‘æ§Kubernetesé›†ç¾¤ï¼Œè¿™ç§æ–¹å¼å·²ç»å¯ä»¥ç›‘æ§ä»»ä½•çš„æŒ‡æ ‡æ•°æ®ã€‚
å¦‚æœæˆ‘ä»¬æƒ³è¦æŠŠPrometheusä¸­å­˜å‚¨çš„æŒ‡æ ‡æ•°æ®é€šè¿‡æš´éœ²ç»™Kubernetes API Serverï¼Œç„¶åé€šè¿‡kubectlå‘½ä»¤è¡Œæ¥æŸ¥è¯¢ï¼Œ
é‚£æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰æŒ‡æ ‡çš„æ–¹å¼æ¥å®Œæˆï¼Œè¿™éœ€è¦åœ¨é›†ç¾¤ä¸­å®‰è£…**prometheus-adapter**ï¼Œ
å¹¶åœ¨å…¶é…ç½®æ–‡ä»¶ä¸­ç¼–å†™éœ€è¦æŸ¥è¯¢çš„æŒ‡æ ‡ä¿¡æ¯ï¼Œå¤§è‡´æ­¥éª¤è¯·å‚è€ƒ*K8sè¿›é˜¶æ•™ç¨‹*
ä¸­çš„[3.4.6 ä½¿ç”¨å¤šé¡¹æŒ‡æ ‡ã€è‡ªå®šä¹‰æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡](doc_tutorial_senior.md#346-ä½¿ç”¨å¤šé¡¹æŒ‡æ ‡è‡ªå®šä¹‰æŒ‡æ ‡å’Œå¤–éƒ¨æŒ‡æ ‡)ã€‚

ä½†è¯·æ³¨æ„ï¼Œå¦‚æœä»…ä»…æ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨kubectlæ¥æŸ¥è¯¢æŒ‡æ ‡ï¼Œé‚£å…¶å®å¤§å¯ä¸å¿…ï¼Œå› ä¸ºæ€§ä»·æ¯”å¤ªä½ï¼ˆæœ‰ä¸€å®šç»´æŠ¤æˆæœ¬ï¼‰ï¼Œä½¿ç”¨GrafanaæŸ¥è¯¢è¶³ä»¥ã€‚
ä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡æ›´å¤šæ˜¯ä¸ºäº†å®ŒæˆHPAï¼ˆHorizontal Pod Autoscalingï¼ŒPodæ°´å¹³è‡ªåŠ¨ä¼¸ç¼©ï¼‰å’ŒVPAï¼ˆVertical Pod
Autoscalingï¼ŒPodå‚ç›´è‡ªåŠ¨ä¼¸ç¼©ï¼‰å·¥ä½œã€‚

### 3.5 å‘Šè­¦

æœ‰äº†æŒ‡æ ‡æ•°æ®åï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®SLOï¼ˆæœåŠ¡æ°´å¹³ç›®æ ‡ï¼‰æ¥è®¾ç½®ç›¸åº”çš„å‘Šè­¦è§„åˆ™ï¼ˆåœ¨Grafanaä¸­è®¾ç½®ï¼‰ã€‚SLOæ˜¯å¯¹æœåŠ¡çš„æŸäº›å¯æµ‹é‡ç‰¹æ€§è®¾ç½®çš„ç›®æ ‡æœŸæœ›ï¼Œ
ä¾‹å¦‚å¯ç”¨æ€§ã€ååé‡ã€é¢‘ç‡å’Œå“åº”æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰SLOï¼Œæˆ‘ä»¬å¯¹æœåŠ¡å°±ä¼šæŠ±æœ‰ä¸åˆ‡å®é™…çš„æœŸæœ›ï¼Œä¹Ÿæ— æ³•è®¾ç½®åˆé€‚çš„å‘Šè­¦è§„åˆ™ã€‚
å¯¹äºKubernetesè¿™æ ·æœåŠ¡å…·æœ‰é«˜åº¦è‡ªæ„ˆèƒ½åŠ›çš„ç³»ç»Ÿï¼Œæˆ‘ä»¬åº”è¯¥é’ˆå¯¹ç»ˆç«¯ç”¨æˆ·çš„æœåŠ¡ä½“éªŒæ¥è®¾ç½®å‘Šè­¦è§„åˆ™ã€‚
ä¾‹å¦‚ï¼Œä¸ºå‰ç«¯æœåŠ¡è®¾ç½®çš„SLOæ˜¯å“åº”æ—¶é—´ä¸å¾—é«˜äº20msï¼Œå½“è§‚æµ‹åˆ°ä¸€æ®µæ—¶é—´å†…çš„å¹³å‡å“åº”æ—¶é—´é«˜äº20msï¼Œå°±éœ€è¦åŠæ—¶å‘å‡ºå‘Šè­¦ã€‚

ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„æ³¨æ„ç‚¹ä»¥ä¾›å‚è€ƒï¼š

- ä»…å¯¹å…³é”®æŒ‡æ ‡è¿›è¡Œå‘Šè­¦ï¼Œå¹¶å¿½ç•¥ä¸€äº›å¯ä»¥è¢«K8sè‡ªåŠ¨å¤„ç†çš„æŒ‡æ ‡ï¼Œä¾‹å¦‚CPU/å†…å­˜åˆ©ç”¨ç‡ç­‰
- è®¾ç½®åˆç†çš„é˜ˆå€¼å‘¨æœŸï¼Œé¿å…è¿‡çŸ­çš„å‘¨æœŸå¯¼è‡´é¢‘ç¹å‘Šè­¦ã€‚æœ€åæœ‰ä¸€å¥—é˜ˆå€¼è®¾ç½®è§„èŒƒï¼Œæ¥é¿å…ä¸ªæ€§åŒ–çš„é˜ˆå€¼è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥éµå¾ª5minã€10minã€30minã€1hè¿™æ ·çš„ç‰¹å®šé¢‘ç‡æ¥ç»Ÿä¸€é…ç½®é˜ˆå€¼å‘¨æœŸ
- åœ¨é…ç½®å‘Šè­¦è§„åˆ™æ—¶ï¼Œåº”è¯¥ç¡®ä¿é€šçŸ¥ä¸­åŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä¾‹å¦‚æœåŠ¡åç§°ã€å‘Šè­¦æŒç»­æ—¶é—´ã€å»ºè®®å¤„ç†æªæ–½ç­‰
- å‘Šè­¦é€šçŸ¥ä¸è¦å‘ç»™ä¸€ç¾¤äººï¼Œè€Œæ˜¯ä»…å‘ç»™éœ€è¦å…³æ³¨æˆ–å¤„ç†é—®é¢˜çš„äººï¼Œå¦åˆ™å®¹æ˜“è¢«å½“æˆä¸é‡è¦çš„ä¿¡æ¯è€Œè¢«å¿½ç•¥

## 4. æ—¥å¿—ç›‘æ§

æ—¥å¿—ç›‘æ§æ˜¯ç›‘æ§ç³»ç»Ÿä¸­çš„é‡è¦ä¸€ç¯ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½é—®é¢˜å’Œæ¢å¤æœåŠ¡ã€‚Kubernetesä¸­çš„æ—¥å¿—ç›‘æ§ç›®æ ‡åŒ…å«ï¼š

- èŠ‚ç‚¹æ—¥å¿—ï¼ˆèŠ‚ç‚¹å…³é”®æœåŠ¡çš„æ—¥å¿—ã€‚ä¾‹å¦‚å®¹å™¨è¿è¡Œæ—¶ç»„ä»¶çš„æ—¥å¿—ã€å†…æ ¸æ—¥å¿—ç­‰ï¼‰
- Kubernetesç»„ä»¶æ—¥å¿—ï¼ˆå¦‚API Serverã€ControllerManagerå’ŒSchedulerï¼‰
- å®¹å™¨æ—¥å¿—ï¼ˆä¸»è¦æ˜¯åº”ç”¨æ—¥å¿—ï¼‰
- Kuberneteså®¡è®¡æ—¥å¿—ï¼ˆä¸æƒé™ç›¸å…³ï¼Œéå¸¸é‡è¦ï¼‰

å¦‚æœä½ ä½¿ç”¨äº‘æ‰˜ç®¡çš„Kubernetesé›†ç¾¤ï¼Œé‚£å»ºè®®ä½ ä¹Ÿä½¿ç”¨æ‰˜ç®¡çš„æ—¥å¿—ç›‘æ§æœåŠ¡ï¼Œè¿™æ ·æœ‰åŠ©äºå¤§å¹…é™ä½è¿ç»´æˆæœ¬ã€‚ç»´æŠ¤è‡ªå»ºçš„æ—¥å¿—æœåŠ¡èµ·åˆçœ‹èµ·æ¥ä¸é”™ï¼Œ
ä½†éšç€ç¯å¢ƒå¤æ‚åº¦çš„å¢é•¿ï¼Œç»´æŠ¤å·¥ä½œä¼šå˜å¾—è¶Šæ¥è¶Šè´¹æ—¶è´¹åŠ›ã€‚

å¦‚æœé€‰æ‹©è‡ªå»ºæ—¥å¿—æœåŠ¡ï¼Œå‘ä½ æ¨èç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« [_Kubernetes æ—¥å¿—æ”¶é›†_](doc_log_collection.md)ã€‚
è¿™ç¯‡æ–‡ç« ä¼šæ‰‹æŠŠæ‰‹æŒ‡å¯¼ä½ å¦‚ä½•å®Œæˆé›†ç¾¤çš„æ—¥å¿—æ”¶é›†å·¥ä½œã€‚

## 5. CI/CDæµæ°´çº¿

CI/CDçš„ç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–çš„è¿‡ç¨‹ï¼Œè¦†ç›–ä»£ç ä»æäº¤åˆ°éƒ¨ç½²å†åˆ°ç”Ÿäº§çš„å…¨æµç¨‹ã€‚æˆ‘ä»¬åº”è¯¥é¿å…è¿›è¡Œæ‰‹åŠ¨æ›´æ–°ï¼Œå› ä¸ºè¿™æ ·åšå¾ˆå®¹æ˜“å‡ºé”™ï¼Œ
å®¹æ˜“å¯¼è‡´é…ç½®æ¼‚ç§»ï¼Œè¿˜ä¼šè®©éƒ¨ç½²å˜å¾—è„†å¼±ï¼Œå¯¼è‡´åº”ç”¨äº¤ä»˜çš„æ•´ä½“æ•æ·æ€§ä¸§å¤±ã€‚

æ„å»ºä¸€ä¸ªé«˜åº¦é›†æˆçš„æµæ°´çº¿èƒ½å¤Ÿè®©æˆ‘ä»¬ä¿¡å¿ƒåè¶³åœ°å°†åº”ç”¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œæœ¬èŠ‚å°†å…·ä½“ä»‹ç»è¿™ä¸ªæ„å»ºè¿‡ç¨‹ã€‚

### 5.1 å®Œæ•´çš„æµæ°´çº¿ç¤ºä¾‹

å¦‚ä¸‹ï¼š

- æ¨é€ä»£ç å˜æ›´åˆ°ä»£ç ä»“åº“ï¼ˆGitæˆ–SVNï¼‰
- è¿è¡ŒAPPæ„å»º
- è¿è¡ŒAPPæµ‹è¯•
- åŸºäºæµ‹è¯•æˆåŠŸçš„APPä»£ç æ„å»ºé•œåƒ
- æ¨é€é•œåƒåˆ°é•œåƒä»“åº“
- éƒ¨ç½²APPåˆ°Kubernetesï¼ˆå¯èƒ½åŸºäºä¸åŒçš„ç­–ç•¥ï¼Œå¦‚æ»šåŠ¨æ›´æ–°ã€è“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²ï¼‰

### 5.2 ä»£ç ç‰ˆæœ¬æ§åˆ¶

æ¯ä¸ªCI/CDæµæ°´çº¿éƒ½å§‹äºç‰ˆæœ¬æ§åˆ¶ï¼Œå®ƒç”¨äºç»´æŠ¤åº”ç”¨ä»£ç å’Œé…ç½®æ–‡ä»¶çš„å˜æ›´è®°å½•ã€‚é…ç½®æ–‡ä»¶å¯èƒ½åŒ…æ‹¬K8sæ¸…å•ä»¥åŠHelm Chartã€‚
è€Œç‰ˆæœ¬æ§åˆ¶ç­–ç•¥åˆ™æœ‰å¤šç§é€‰æ‹©ï¼Œè¿™å–å†³äºç»„ç»‡ç»“æ„å’Œè´£ä»»åˆ’åˆ†ã€‚ä½†è¯·æ³¨æ„ï¼Œåº”è¯¥å°½é‡è®©å¼€å‘è€…å’Œè¿ç»´å·¥ç¨‹å¸ˆåœ¨åŒä¸€ä¸ªä»£ç å­˜å‚¨åº“ä¸­è¿›è¡Œå†™ä½œï¼Œ
è¿™æœ‰åŠ©äºç»Ÿä¸€ç®¡ç†å’Œä¿è¯ä»£ç å’Œè¿ç»´è„šæœ¬ç‰©æ–™å§‹ç»ˆä¿æŒåŒ¹é…ã€‚

### 5.3 æŒç»­é›†æˆ

æŒç»­é›†æˆï¼ˆCIï¼‰æ­¥éª¤æ˜¯å°†ä»£ç å˜æ›´æŒç»­åœ°é›†æˆåˆ°ç‰ˆæœ¬æ§åˆ¶åº“çš„è¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œ
å°±æ˜¯å°†æ¯ä¸€æ¬¡ä»£ç æäº¤éƒ½å½“åšä¸€ä¸ªæ–°çš„åº”ç”¨ç‰ˆæœ¬è¿›è¡Œæ„å»ºï¼Œè¿™æ ·ä¸€æ¥å°±èƒ½åŠæ—¶å‘ç°å“ªä¸€æ¬¡ä»£ç æäº¤å¯¼è‡´æ„å»ºå¤±è´¥ï¼Œä»è€Œå¿«é€Ÿä¿®å¤ä»£ç ã€‚

### 5.4 æµ‹è¯•

å½“åº”ç”¨æ„å»ºæˆåŠŸåï¼Œåº”è¯¥é©¬ä¸Šæ‰§è¡Œé¢„è®¾çš„æµ‹è¯•å‘½ä»¤ã€‚ä¾‹å¦‚ï¼ŒGoåº”ç”¨å¯ä»¥ä½¿ç”¨`go test`æ‰§è¡Œä¸€ç»„å•å…ƒæµ‹è¯•ã€‚
å½“æµ‹è¯•é€šè¿‡æ—¶ï¼Œæ‰èƒ½å°†ä»£ç æ‰“åŒ…ä¸ºé•œåƒï¼›ä¸€æ—¦æµ‹è¯•å¤±è´¥ï¼Œåº”ç«‹å³åœæ­¢æµæ°´çº¿å·¥ä½œï¼Œå¹¶æä¾›æ­¤æ­¥éª¤å¤±è´¥çš„æ—¥å¿—è¾“å‡ºã€‚

> é™¤äº†å¯¹åº”ç”¨çš„å•å…ƒæµ‹è¯•ï¼Œä½ å¯èƒ½è¿˜éœ€è¦é¢„è®¾å…¶ä»–æµ‹è¯•è„šæœ¬å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œå¯¹K8sæ¸…å•æ–‡ä»¶çš„é£é™©æ£€æµ‹å‘½ä»¤ä»¥åŠå¯¹Helm Chartæ–‡ä»¶çš„lintæµ‹è¯•å‘½ä»¤ã€‚

### 5.5 é•œåƒæ„å»º

åœ¨å®Œæˆé•œåƒæ„å»ºæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æå‰å†™å¥½Dockerfileã€‚è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

- ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºå‡å°é•œåƒSize
- ä½¿ç”¨å…·æœ‰å°‘é‡å‘½ä»¤çš„åŸºç¡€é•œåƒä»¥å‡å°‘å®‰å…¨é£é™©ï¼Œä¾‹å¦‚Scratchã€Alpineå’ŒDistrolessç­‰
    - ä½¿ç”¨è¿™ç±»åŸºç¡€é•œåƒæ—¶ï¼Œä½ å¯èƒ½è¿˜éœ€è¦äº†è§£å®ƒä»¬çš„è°ƒè¯•æ–¹æ³•ï¼Œä»¥æ›´å¥½çš„åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨

### 5.6 æ·»åŠ é•œåƒæ ‡ç­¾

åœ¨å°†é•œåƒæ¨é€åˆ°é•œåƒä»“åº“ä¹‹å‰ï¼Œéœ€è¦ç»™é•œåƒæ‰“ä¸Šæ ‡ç­¾ã€‚åˆç†çš„é•œåƒæ ‡ç­¾èƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å¿«é€Ÿè¯†åˆ«é•œåƒç‰ˆæœ¬ï¼Œåœ¨CIæµæ°´çº¿ä¸­æ„å»ºçš„æ¯ä¸ªé•œåƒéƒ½åº”è¯¥æ‹¥æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ ‡ç­¾ã€‚

æœ‰ä»¥ä¸‹å‡ ç§æ ‡ç­¾ç­–ç•¥å¯ä¾›ä½¿ç”¨ï¼š

- æ„å»ºå·ï¼ˆåœ¨å¼€å§‹æ„å»ºæ—¶ç”±æ„ä»¶ç³»ç»Ÿäº§ç”Ÿçš„ä¸€ä¸ªé€’å¢ç¼–å·ï¼‰
- GitHashï¼ˆä»£ç æäº¤æ—¶äº§ç”Ÿçš„GitHashç ï¼Œæœ‰åŠ©äºåœ¨ä»£ç æäº¤è®°å½•ä¸­æº¯æºï¼‰
- GitHash-æ„å»ºå·ï¼ˆæ¨èï¼‰

### 5.7 æŒç»­éƒ¨ç½²

æŒç»­éƒ¨ç½²ï¼ˆCDï¼‰æ­¥éª¤æ˜¯å°†åº”ç”¨é•œåƒéƒ¨ç½²åˆ°åº”ç”¨è¿è¡Œç¯å¢ƒï¼ˆå¦‚æµ‹è¯•ã€é¢„å‘å¸ƒå’Œç”Ÿäº§ç¯å¢ƒï¼‰çš„è¿‡ç¨‹ã€‚
è¿™ä¸€æ­¥æˆ‘ä»¬åªéœ€è¦åœ¨CDç³»ç»Ÿä¸­æå‰é…ç½®å¥½Kubernetesçš„ServerUrlã€è¯ä¹¦ä»¥åŠTokenï¼Œç„¶åç”±CDç³»ç»Ÿè‡ªåŠ¨å®Œæˆéƒ¨ç½²/æ›´æ–°æ­¥éª¤ã€‚

### 5.8 éƒ¨ç½²ç­–ç•¥

æœ¬èŠ‚è®¨è®ºçš„éƒ¨ç½²ç­–ç•¥ï¼ŒåŒ…æ‹¬æ»šåŠ¨æ›´æ–°ã€è“ç»¿éƒ¨ç½²å’Œé‡‘ä¸é›€éƒ¨ç½²ã€‚

#### 5.8.1 æ»šåŠ¨æ›´æ–°

æ»šåŠ¨æ›´æ–°ï¼ˆrolling updateï¼‰æ˜¯Kubernetesä¸­æœ€å¸¸ç”¨ä¹Ÿæ˜¯Deploymenté»˜è®¤çš„éƒ¨ç½²æ›´æ–°ç­–ç•¥ã€‚å®ƒé€šè¿‡é€æ­¥æ›´æ–°Podçš„æ–¹å¼ï¼Œç¡®ä¿åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆå¯ç”¨ã€‚

å…·ä½“æ¥è¯´ï¼Œåœ¨å‡†å¤‡æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆæ‰§è¡Œ`kubectl set image...`å‘½ä»¤æ¥ä¿®æ”¹Deploymentä¸­åº”ç”¨å®¹å™¨çš„é•œåƒæ ‡ç­¾ã€‚
ç„¶åï¼ŒKubernetesä¼šé€æ­¥æ›´æ–°Deploymentä¸­çš„Podï¼Œç¡®ä¿åº”ç”¨åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å§‹ç»ˆå¯ç”¨ã€‚åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œ
å¦‚æœç”±äºé•œåƒé—®é¢˜å¯¼è‡´æ–°çš„Podæ— æ³•æ­£å¸¸å¯åŠ¨ï¼ŒKubernetesä¼šæš‚åœæ›´æ–°ï¼Œå¾…æˆ‘ä»¬è§£å†³é—®é¢˜åé‡æ–°æ„å»ºæ–°çš„é•œåƒï¼Œå†é‡æ–°æ“ä½œæ­¤æ­¥éª¤å®Œæˆæ›´æ–°ã€‚
æ­¤å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸‹é¢çš„kubectlå‘½ä»¤æ¥è¾…åŠ©å®Œæˆæ»šåŠ¨æ›´æ–°ï¼š

- é€šè¿‡`kubectl rollout pause`å‘½ä»¤æ¥æš‚åœæ»šåŠ¨æ›´æ–°ï¼Œå¹¶åœ¨ç¡®è®¤æ–°Podæ­£å¸¸å¯åŠ¨ä¸”æ¥å—æµé‡åå†ç»§ç»­æ›´æ–°ã€‚
- é€šè¿‡`kubectl rollout undo`å‘½ä»¤æ¥å›æ»šDeploymentçš„æœ¬æ¬¡æ›´æ–°ï¼Œæ‰§è¡Œå‘½ä»¤åDeploymentå†…çš„åº”ç”¨å®¹å™¨çš„é•œåƒæ ‡ç­¾å°†æ¢å¤åˆ°æ—§å€¼ï¼Œ
  åŒæ—¶å½“å‰æ›´æ–°å¤±è´¥çš„Podä¹Ÿä¼šè¢«æ—§æ ‡ç­¾çš„é•œåƒæ›¿æ¢ã€‚

ä¸ºäº†æ›´å¥½çš„å®ç°çƒ­æ›´æ–°ä»¥åŠå‡å°‘ç»ˆç«¯ç”¨æˆ·æ„ŸçŸ¥ï¼Œå»ºè®®åœ¨Deploymentä¸­é…ç½®`readiness probe`å’Œ`preStop`å­—æ®µã€‚
`readiness probe`ç”¨äºç¡®ä¿éƒ¨ç½²çš„æ–°ç‰ˆæœ¬Podåœ¨å‡†å¤‡å°±ç»ªåæ‰èƒ½æ¥å—æµé‡ï¼›è€Œ`preStop`ç”¨äºåœ¨Podè¢«åˆ é™¤å‰æ‰§è¡Œæ¸…ç†æ“ä½œï¼Œä¾‹å¦‚åº”ç”¨è¿›ç¨‹çš„é€€å‡ºæ“ä½œã€‚

æ»šåŠ¨æ›´æ–°æ—¶ï¼Œé›†ç¾¤ä¸­ä¼šåŒæ—¶å­˜åœ¨æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„Podï¼Œæ‰€ä»¥å¯¹äºä¸æ”¯æŒå¤šè¿›ç¨‹éƒ¨ç½²çš„åº”ç”¨ï¼ˆæ¯”å¦‚Deploymentçš„`replicas`å­—æ®µè®¾ç½®ä¸º1ï¼‰ï¼Œ
æ³¨æ„è¦åœ¨PodSpecä¸­è®¾ç½®æ›´æ–°ç­–ç•¥ä¸º`Recreate`ï¼Œè€Œä¸æ˜¯ä½¿ç”¨é»˜è®¤çš„`rollingUpdate`ã€‚

#### 5.8.2 è“ç»¿éƒ¨ç½²

è“ç»¿éƒ¨ç½²æ˜¯æŒ‡åœ¨å·²ç»å­˜åœ¨ä¸€å¥—ç”Ÿäº§ç¯å¢ƒçš„åº”ç”¨çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡éƒ¨ç½²ä¸€å¥—æ–°çš„åº”ç”¨ç¯å¢ƒï¼Œç„¶åå°†ç”¨æˆ·æµé‡å¿«é€Ÿåˆ‡æ¢ï¼ˆé€šè¿‡è´Ÿè½½å‡è¡¡å™¨ï¼‰åˆ°æ–°ç‰ˆæœ¬çš„åº”ç”¨ä¸Šã€‚
è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ—§çš„ç¯å¢ƒå«åšè“ï¼ˆblueï¼‰ï¼Œæ–°éƒ¨ç½²çš„ç¯å¢ƒå«åšç»¿ï¼ˆgreenï¼‰ã€‚å½“æ–°ç¯å¢ƒå­˜åœ¨é—®é¢˜æ—¶ï¼Œå†å¿«é€Ÿåˆ‡æ¢åˆ°æ—§ç¯å¢ƒå³å¯ã€‚
è“ç»¿éƒ¨ç½²æœ€å¤§çš„ä¼˜ç‚¹æ˜¯å®ç°é›¶åœæœºéƒ¨ç½²ã€‚

è¿™å¥—ç­–ç•¥çœ‹ä¼¼ç®€å•ï¼Œå®åˆ™å­˜åœ¨ä¸å°‘éš¾ç‚¹ã€‚è“ç»¿éƒ¨ç½²é€šå¸¸æ„å‘³ç€ä¸€æ¬¡åˆ‡æ¢ä¸€æ•´ä¸ªç¯å¢ƒã€‚æ¯”å¦‚ï¼Œ
å½“å‰åº”ç”¨ç”±ä¸€ä¸ªå‰¯æœ¬æ•°é‡ä¸º10çš„Deploymentç¯å¢ƒï¼ˆå¦‚åä¸º`app-deploy-v1`ï¼‰ç»„æˆï¼Œ
é‚£ä¹ˆè¿˜éœ€è¦éƒ¨ç½²ä¸€å¥—æ–°çš„Deploymentç¯å¢ƒï¼ˆå¦‚åä¸º`app-deploy-v2`ï¼Œä½†`label`ä¸åŒï¼‰ï¼Œå‰¯æœ¬æ•°é‡ä»ç„¶ä¸º10ã€‚è¿™ä¸¤å¥—ç¯å¢ƒæ˜¯åŒæ—¶å­˜åœ¨çš„ï¼Œ
æ‰€ä»¥ä¼šå ç”¨å¢åŠ ä¸€å€çš„ç¡¬ä»¶èµ„æºã€‚ç„¶åæˆ‘ä»¬éœ€è¦å¯¹æ–°çš„Deploymentè¿›è¡Œå®Œæ•´çš„æµ‹è¯•ï¼Œæµ‹è¯•é€šè¿‡åï¼Œ
åœ¨Kubernetesçš„Serviceæ¨¡æ¿ä¸­ä¿®æ”¹Selectoræ¥åˆ‡æ¢æµé‡åˆ°æ–°çš„Deploymentã€‚å¾…æ–°ç¯å¢ƒæ­£å¸¸è¿è¡Œä¸€æ®µæ—¶é—´åï¼ˆç”±å…·ä½“æƒ…å†µå†³å®šï¼‰ï¼Œå†é”€æ¯æ—§çš„ç¯å¢ƒã€‚

è¿™é‡Œï¼Œç®€è¦åˆ—å‡ºè“ç»¿éƒ¨ç½²çš„å‡ ä¸ªéš¾ç‚¹ï¼š

- å¤šç‰ˆæœ¬åŒæ—¶å­˜åœ¨çš„é—®é¢˜ã€‚åº”ç”¨å¿…é¡»æ”¯æŒå¤šç‰ˆæœ¬åŒæ—¶å­˜åœ¨ï¼Œå¦åˆ™ä¸é€‚ç”¨æœ¬éƒ¨ç½²æ–¹æ³•ã€‚
- æ•°æ®åº“è¿ç§»é—®é¢˜ã€‚åº”ç”¨é€šå¸¸ä¼šè®¿é—®æ•°æ®åº“ï¼Œè€Œä¸”éœ€è¦æ‰§è¡Œäº‹åŠ¡ã€‚æ“ä½œè€…å¿…é¡»è€ƒè™‘åˆ°æ–°æ—§ç‰ˆæœ¬å¯¹åŒæ—¶æ‰§è¡Œäº‹åŠ¡æ“ä½œçš„å…¼å®¹æ€§ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§ã€‚
- éœ€è¦å…·å¤‡åŒæ—¶ç»´æŠ¤ä¸¤å¥—ç¯å¢ƒçš„èƒ½åŠ›ã€‚
- ç”±äºæ›´æ–°ç²’åº¦å¤§ï¼Œè™½ç„¶å¯ä»¥å¿«é€Ÿåˆ‡æ¢æµé‡ï¼Œä½†å¯èƒ½ä¼šå› ä¸ºæ“ä½œå¤±è¯¯å¯¼è‡´ä¸¥é‡çš„æœåŠ¡ä¸­æ–­å½±å“ã€‚ä¸€å®šè¦è¿›è¡Œé¢„å…ˆçš„ã€å¤šæ¬¡çš„å®Œæ•´æµç¨‹æ“ä½œæ¼”ç»ƒã€‚

#### 5.8.3 é‡‘ä¸é›€éƒ¨ç½²

é‡‘ä¸é›€éƒ¨ç½²æ˜¯æ¯”è“ç»¿éƒ¨ç½²æ›´ä¿å®ˆä¸€ç‚¹çš„éƒ¨ç½²ç­–ç•¥ã€‚é¦–å…ˆï¼Œé‡‘ä¸é›€éƒ¨ç½²ç­–ç•¥ä¸­ï¼Œä¹Ÿéœ€è¦åŒæ—¶éƒ¨ç½²ä¸¤ä¸ªåŸºæœ¬ç›¸åŒçš„ç¯å¢ƒã€‚æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œ
é‡‘ä¸é›€éƒ¨ç½²ä¸­ï¼Œç”¨æˆ·æµé‡æ˜¯æŒ‰æ¯”ä¾‹æˆ–æ¡ä»¶é€æ¸åˆ‡æ¢åˆ°æ–°ç¯å¢ƒï¼Œè€Œä¸æ˜¯åƒè“ç»¿éƒ¨ç½²é‚£æ ·ä¸€æ¬¡æ€§åœ°å…¨éƒ¨åˆ‡æ¢ã€‚
ä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†æºå¸¦ç‰¹å®šHeaderé”®å€¼çš„è¯·æ±‚è·¯ç”±åˆ°æ–°ç¯å¢ƒã€‚

> åœ¨å¤§éƒ¨åˆ†ç§»åŠ¨åº”ç”¨é¡¹ç›®ä¸­ï¼Œå®¢æˆ·ç«¯äººå‘˜é€šå¸¸ä¼šé€šè¿‡ç‰¹å®šçš„Headeré”®å€¼æ¥æ ‡è¯†å½“å‰ç”¨æˆ·ä½¿ç”¨çš„åŒ…ç¯å¢ƒï¼Œæ¯”å¦‚æµ‹è¯•åŒ…/æ­£å¼åŒ…/ç°åº¦åŒ…ã€‚

é‡‘ä¸é›€éƒ¨ç½²ç›¸å¯¹è“ç»¿éƒ¨ç½²çš„ä¼˜ç‚¹æ˜¯ï¼Œå¯ä»¥å°èŒƒå›´éªŒè¯æ–°ç‰ˆæœ¬çš„åº”ç”¨ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬çš„åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æ²¡æœ‰é—®é¢˜åå†å®Œå…¨åˆ‡æ¢ã€‚
å³ä½¿æ–°ç¯å¢ƒå­˜åœ¨é—®é¢˜ï¼Œå…¶å½±å“ä¹Ÿé™åˆ¶åœ¨è¾ƒå°èŒƒå›´ã€‚è¿™ç§å‘å¸ƒæ–¹å¼é€šå¸¸ä¹Ÿå«åšA/Bå‘å¸ƒæˆ–ç°åº¦å‘å¸ƒã€‚

åœ¨Kubernetesä¸­å¯ä»¥é€šè¿‡Ingressæ¥å®ç°æŒ‰æ¯”ä¾‹åˆ†é…æµé‡çš„åŠŸèƒ½ï¼Œå¸¸ç”¨çš„Ingressæ§åˆ¶å™¨å¦‚Nginxã€Traefikç­‰éƒ½æ”¯æŒã€‚
åˆ†é…æµé‡çš„ç­–ç•¥åŒ…æ‹¬HTTP Headerçš„Key/Valueã€Cookieã€æ¯”ä¾‹é…ç½®ç­‰ã€‚

æ³¨æ„ï¼Œå®è·µé‡‘ä¸é›€éƒ¨ç½²æ—¶éœ€è¦å¤„ç†ä¸è“ç»¿éƒ¨ç½²ç›¸åŒçš„é—®é¢˜ï¼ŒåŒ…æ‹¬å¤šç‰ˆæœ¬å…±å­˜ã€æ•°æ®åº“è¿ç§»ç­‰ã€‚

- [ä½¿ç”¨ Nginx Ingress å®ç°é‡‘ä¸é›€å‘å¸ƒ](https://cloud.tencent.com/document/product/457/48907)

#### 5.8.4 ä½¿ç”¨Helm

Helmæ˜¯ä¸€ä¸ªæµè¡Œçš„Kubernetesåº”ç”¨çš„åŒ…ç®¡ç†å·¥å…·ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å‰é¢æåˆ°çš„éƒ¨ç½²ç­–ç•¥ä¸­ç”¨åˆ°å®ƒã€‚

Helmä½¿ç”¨ä¸€ç§å«åšChartçš„åŒ…ç»“æ„æ¥ç»„ç»‡ç¼–æ’Kubernetesåº”ç”¨ï¼Œ
ä¸€ä¸ªKubernetesåº”ç”¨å¯åŒ…å«å¤šä¸ªKubernetesèµ„æºï¼ˆåŒ…æ‹¬Deploymentã€ConfigMap/Secretã€Jobç­‰åœ¨å†…çš„å„ç±»èµ„æºï¼‰ã€‚
ä½¿ç”¨Helmï¼Œæˆ‘ä»¬çš„Kubernetesåº”ç”¨å°±ç›´æ¥æ‹¥æœ‰äº†ç‰ˆæœ¬ç®¡ç†æœºåˆ¶ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡Helmå‘½ä»¤è¿›è¡Œå¿«é€Ÿçš„å‡çº§å’Œå›æ»šã€‚
æ­¤å¤–ï¼ŒHelmæœ€å…³é”®çš„ç‰¹æ€§æ˜¯æ”¯æŒé€šè¿‡Go Templateæ”¯æŒæ¨¡æ¿åŒ–é…ç½®ï¼Œè¿™ä¸ªç‰¹æ€§è®©æˆ‘ä»¬æ— éœ€é¢‘ç¹ä¿®æ”¹Chartï¼Œ
è€Œæ˜¯é€šè¿‡CDå‘½ä»¤æ¥å°†å‚æ•°æ³¨å…¥Chartã€‚

æ¯”å¦‚ï¼Œæˆ‘ä»¬ç”±ä¸€ä¸ªWebåç«¯åº”ç”¨ï¼Œåœ¨ä½¿ç”¨Helmä¹‹å‰ï¼Œè¿™ä¸ªåº”ç”¨ç”±ä¸¤ä¸ªDeploymentç»„æˆï¼ˆæ¯”å¦‚Userå’ŒDBä¸¤ä¸ªæœåŠ¡ï¼‰ã€‚
ç„¶åå‡è®¾è¿™ä¸¤ä¸ªæœåŠ¡éƒ½éœ€è¦åœ¨æœ¬æ¬¡è¿­ä»£ä¸­è¿›è¡Œå‡çº§ï¼Œè‹¥ä¸ä½¿ç”¨Helmï¼Œåˆ™éœ€è¦ä¸€ä¸ªä¸€ä¸ªå‡çº§ï¼ˆæ‰§è¡Œä¸¤æ¬¡å‡çº§æ“ä½œï¼‰ï¼›
è‹¥ä½¿ç”¨Helmï¼Œè¿™ä¸¤ä¸ªDeploymentå°±åŒæ—¶å­˜åœ¨äºä¸€ä¸ªChartä¸­ï¼Œæˆ‘ä»¬ç›´æ¥ç¼–è¾‘å¥½æ–°ç‰ˆæœ¬çš„Chartï¼Œç„¶ååœ¨CDå‘½ä»¤ä¸­æ‰§è¡ŒHelmå‡çº§å‘½ä»¤å³å¯ã€‚
å³ä½¿æœ‰é—®é¢˜ï¼Œä¹Ÿå¯ä»¥ä¸€æ¬¡æ€§å›æ»šChartå†…çš„æ‰€æœ‰èµ„æºï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸ªå›æ»šã€‚å¯è§ï¼ŒHelmå¤§å¤§æé«˜äº†éƒ¨ç½²å’Œå›æ»šçš„æ•ˆç‡ã€‚

å¦‚æœä½ æƒ³è¦è¿›ä¸€æ­¥äº†è§£Helmï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« [_Helmæ‰‹è®°_](doc_helm.md)ã€‚

### 5.9 ä¸€äº›å»ºè®®

CI/CDæµæ°´çº¿é…ç½®å¾ˆéš¾ä¸€å¼€å§‹å°±åšåˆ°å®Œç¾ï¼Œä½†å¯ä»¥å‚è€ƒä¸‹é¢åŸåˆ™æ¥å°½å¯èƒ½å®Œå–„æµç¨‹ï¼š

- åœ¨CIä¸­å…³æ³¨è‡ªåŠ¨åŒ–å’Œæ„å»ºé€Ÿåº¦ã€‚ä¼˜åŒ–æ„å»ºé€Ÿåº¦èƒ½å¤Ÿåœ¨ä»£ç æäº¤æ—¶å¿«é€Ÿå®Œæˆæ„å»ºï¼Œä¸ºå¼€å‘è€…æä¾›æ›´å¿«é€Ÿçš„åé¦ˆã€‚
- åœ¨æµæ°´çº¿ä¸­é…ç½®å¯é ä¸”å®Œå–„çš„æµ‹è¯•è„šæœ¬ã€‚ä»¥ä¾¿åœ¨ä»£ç æäº¤æ—¶ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ä»£ç ä¸­çš„é—®é¢˜ï¼Œä»¥ä¾¿å¿«é€Ÿä¿®å¤å’ŒéªŒè¯ã€‚
- å°½å¯èƒ½ä¼˜åŒ–é•œåƒå¤§å°ï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ‹‰å–é•œåƒçš„æ—¶é—´ï¼Œæé«˜æ„å»ºé€Ÿåº¦ï¼Œè¿˜èƒ½å‡å°‘å®¹å™¨è¿è¡Œæ—¶çš„å†…å­˜æ¶ˆè€—å’Œå—æ”»å‡»é¢ã€‚
- å¦‚æœè¿˜ä¸ç†Ÿæ‚‰CDï¼Œå¯ä»¥å…ˆä»ç®€å•æ˜“ç”¨çš„æ»šåŠ¨æ›´æ–°å¼€å§‹ã€‚åç»­å†è€ƒè™‘ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒæˆ–è“ç»¿éƒ¨ç½²ã€‚
- åœ¨CDç¯èŠ‚ï¼Œä¸€å®šè¦æ³¨æ„å¯¹å®¢æˆ·ç«¯è¿æ¥çš„é‡æ–°å»ºç«‹å’Œæ•°æ®åº“ç»“æ„çš„å˜æ›´è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œå°½å¯èƒ½å‡å°‘å¯¹ç”¨æˆ·ç«¯çš„å½±å“ã€‚
- ç”Ÿäº§ç¯å¢ƒä¸­è¿›è¡Œæµ‹è¯•æ—¶ï¼Œåº”è¯¥ä»å°è§„æ¨¡å¼€å§‹ï¼Œé€æ­¥æ‰©å¤§æµ‹è¯•èŒƒå›´ã€‚

## 6. èµ„æºç®¡ç†

å½“åº”ç”¨éƒ¨ç½²åˆ°Kubernetesé›†ç¾¤ä¸­ä»¥åï¼Œæˆ‘ä»¬çš„å·¥ä½œè¿˜æ²¡æœ‰ç»“æŸï¼Œå› ä¸ºå®æˆ˜ä¸­æ€»æ˜¯ä¼šå‡ºç°å„ç§å„æ ·çš„çªå‘çŠ¶å†µï¼Œ
æ¯”å¦‚ï¼ŒæŸä¸ªæœåŠ¡çªç„¶å˜å¾—éå¸¸æ…¢ï¼ŒæŸä¸ªæœåŠ¡çªç„¶å˜å¾—ä¸å¯ç”¨ï¼ŒæŸä¸ªæœåŠ¡éœ€è¦å¢åŠ å®ä¾‹æ•°é‡ï¼ŒæŸä¸ªæœåŠ¡éœ€è¦å‡å°‘å®ä¾‹æ•°é‡ç­‰ç­‰ã€‚
ä¸ºäº†åº”å¯¹è¿™äº›çªå‘çŠ¶å†µï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨Kuberneteså†…ç½®çš„ä¸€äº›èµ„æºç®¡ç†åŠŸèƒ½ã€‚

å…·ä½“æ¥è¯´ï¼Œæœ¬èŠ‚å°†ä¼šä»‹ç»ä»¥ä¸‹KubernetesåŠŸèƒ½ï¼š

- Podè°ƒåº¦åŸç†
- Podè°ƒåº¦æŠ€æœ¯
    - Podçš„äº²å’Œä¸åäº²å’Œ
    - èŠ‚ç‚¹çš„äº²å’Œä¸åäº²å’Œ
    - èŠ‚ç‚¹é€‰æ‹©å™¨
    - æ±¡ç‚¹å’Œå®¹å¿åº¦
    - æŒ‡å®šèŠ‚ç‚¹åç§°
- Podèµ„æºç®¡ç†
    - Podèµ„æºè¯·æ±‚å’Œé™åˆ¶
    - PodæœåŠ¡è´¨é‡
    - PodDisruptionBudget
    - Namespaceç»´åº¦çš„èµ„æºç®¡ç†
        - ResourceQuota
        - LimitRange
- èµ„æºä¼¸ç¼©
    - Podæ°´å¹³ä¼¸ç¼©
    - Podå‚ç›´ä¼¸ç¼©
    - èŠ‚ç‚¹æ°´å¹³ä¼¸ç¼©

æœ¬æ–‡ä¼šå¯¹è¿™äº›åŠŸèƒ½è¿›è¡Œä¸€ä¸ªå¤§è‡´çš„ä»‹ç»ä»¥åŠç»™å‡ºç›¸åº”çš„å‚è€ƒğŸ”—ï¼Œä½†ä»‹äºç¯‡å¹…ä¸ä¼šå¯¹æ¯ä¸ªåŠŸèƒ½éƒ½è¿›è¡Œè¯¦ç»†çš„ä½¿ç”¨ä»‹ç»ã€‚

### 6.1 Podè°ƒåº¦åŸç†

å½“ä¸€ä¸ªPodè¢«æäº¤åˆ°Kubernetesé›†ç¾¤ä¸­ä»¥åï¼Œ`kube-schduler`ä¼šè´Ÿè´£å†³å®šPodæœ€ç»ˆè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ã€‚
å…·ä½“æ¥è¯´ï¼Œ`kube-schduler`çš„è°ƒåº¦ç®—æ³•å¤§è‡´åˆ†ä¸º**é¢„é€‰ã€ä¼˜é€‰å’Œç»‘å®š**ä¸‰ä¸ªé˜¶æ®µã€‚

**é¢„é€‰é˜¶æ®µ**ä¸»è¦æ˜¯é€šè¿‡ä¸€äº›å†…ç½®è§„åˆ™æ¥è¿‡æ»¤æ‰ä¸ç¬¦åˆéœ€æ±‚çš„èŠ‚ç‚¹ã€‚æ¯”å¦‚ï¼ŒèŠ‚ç‚¹èµ„æºæ˜¯å¦æ»¡è¶³Podçš„èµ„æºè¯·æ±‚å’Œé™åˆ¶ï¼Œ
èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³Podçš„äº²å’Œä¸åäº²å’Œè§„åˆ™ç­‰ç­‰ã€‚å…·ä½“çš„å†…ç½®è§„åˆ™ä»‹ç»å¯ä»¥æŸ¥çœ‹[
_Kubernetesè¿›é˜¶æ•™ç¨‹-é¢„é€‰é˜¶æ®µ_](doc_tutorial_senior.md#411-é¢„é€‰é˜¶æ®µ)ã€‚

**ä¼˜é€‰é˜¶æ®µ**åˆ™æ˜¯åœ¨é¢„é€‰é˜¶æ®µé€‰å‡ºçš„èŠ‚ç‚¹åˆ—è¡¨ä¸­è¿›ä¸€æ­¥å¯¹è¿™äº›èŠ‚ç‚¹è¿›è¡Œæ‰“åˆ†ï¼Œå½“ç„¶ä¹Ÿæ˜¯æ ¹æ®ä¸€äº›å†…ç½®è§„åˆ™ã€‚æ¯”å¦‚èŠ‚ç‚¹ç©ºé—²èµ„æºå¤šçš„å¾—åˆ†æ›´é«˜ã€æœªè¿è¡Œç›¸åŒåº”ç”¨Podçš„èŠ‚ç‚¹å¾—åˆ†æ›´é«˜ç­‰ç­‰ã€‚
å…·ä½“çš„å†…ç½®è§„åˆ™ä»‹ç»å¯ä»¥æŸ¥çœ‹[_Kubernetesè¿›é˜¶æ•™ç¨‹-ä¼˜é€‰é˜¶æ®µ_](doc_tutorial_senior.md#412-ä¼˜é€‰é˜¶æ®µ)ã€‚

**ç»‘å®šé˜¶æ®µ**æ˜¯é€‰æ‹©åˆ†å€¼æœ€é«˜çš„èŠ‚ç‚¹ä½œä¸ºPodè¿è¡Œçš„ç›®æ ‡èŠ‚ç‚¹è¿›è¡Œç»‘å®šï¼ˆå¦‚æœ‰å¤šä¸ªï¼Œåˆ™éšæœºä¸€ä¸ªï¼‰ã€‚

### 6.2 Podè°ƒåº¦æŠ€æœ¯â€”Podçš„äº²å’Œä¸åäº²å’Œ

Podçš„äº²å’Œä¸åäº²å’Œæ˜¯ä¸€é¡¹å¯ä¾›æ‰‹åŠ¨é…ç½®çš„Podèµ„æºè°ƒåº¦æŠ€æœ¯ï¼Œå®ƒå±äºå‰é¢æåˆ°çš„**ä¼˜é€‰é˜¶æ®µ**çš„ä¸€ç§è§„åˆ™ã€‚
æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½®å®ƒæ¥å†³å®šå¦‚ä½•éƒ¨ç½²ç›¸å…³è”çš„ä¸€ç»„Podã€‚

ä¾‹å¦‚ï¼Œä¸ºPodè®¾ç½®äº²å’Œæ€§è§„åˆ™å¯ä»¥è®©Podä»…è¿è¡Œæˆ–å°½å¯èƒ½è¿è¡Œåœ¨æ»¡è¶³æ¡ä»¶ï¼ˆè¿™äº›èŠ‚ç‚¹è¿è¡Œäº†æŸäº›åå¥½Podï¼‰çš„èŠ‚ç‚¹ä¸Šï¼Œç†ç”±å¯èƒ½æ˜¯ä¸ºäº†é›†ä¸­ç®¡ç†æŸäº›Podã€‚
åŒç†ï¼ŒPodçš„åäº²å’Œæ€§è§„åˆ™æ˜¯è®©Podå¿…é¡»æˆ–å°½å¯èƒ½ä¸è¿è¡Œåœ¨æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹ä¸Šï¼Œç†ç”±å¯èƒ½æ˜¯è¿œç¦»è¿è¡Œäº†æŸäº›Podçš„èŠ‚ç‚¹ã€‚

å¦‚æœä½ æƒ³è¿›ä¸€æ­¥äº†è§£æ­¤é¡¹æŠ€æœ¯çš„ä½¿ç”¨é…ç½®æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒ[
_Kubernetesè¿›é˜¶æ•™ç¨‹-Podäº²å’Œæ€§å’Œåäº²å’Œæ€§_](doc_tutorial_senior.md#45-è½¯ç¡¬çš†å¯-podäº²å’Œæ€§å’Œåäº²å’Œæ€§)ã€‚

### 6.3 Podè°ƒåº¦æŠ€æœ¯â€”Nodeçš„äº²å’Œä¸åäº²å’Œ

Nodeçš„äº²å’Œä¸åäº²å’Œä¸Podçš„äº²å’Œä¸åäº²å’Œç±»ä¼¼ï¼Œåªæ˜¯å®ƒçš„é…ç½®ç›®æ ‡é’ˆå¯¹çš„æ˜¯èŠ‚ç‚¹è€Œä¸æ˜¯Podï¼Œ
è¯·ç›´æ¥å‚è€ƒ[_Kubernetesè¿›é˜¶æ•™ç¨‹-èŠ‚ç‚¹äº²å’Œæ€§_](doc_tutorial_senior.md#44-è½¯ç¡¬çš†å¯-èŠ‚ç‚¹äº²å’Œæ€§affinity)ã€‚

### 6.4 Podè°ƒåº¦æŠ€æœ¯â€”èŠ‚ç‚¹é€‰æ‹©å™¨

nodeSelectoræ˜¯å°†Podè°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹æœ€ç®€å•çš„æ–¹æ³•ã€‚ä½¿ç”¨æ­¥éª¤æ˜¯å…ˆä¸ºç›®æ ‡èŠ‚ç‚¹è®¾ç½®æ ‡ç­¾ï¼Œç„¶ååœ¨PodSpecä¸­è®¾ç½®nodeSelectorå­—æ®µã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒnodeSelectoræ˜¯ä¸€é¡¹ç¡¬æ€§è°ƒåº¦é…ç½®ï¼Œè‹¥æ²¡æœ‰æ»¡è¶³æ ‡ç­¾è¦æ±‚çš„èŠ‚ç‚¹ï¼Œåˆ™Podå°†æ— æ³•è°ƒåº¦åˆ°ä»»ä½•èŠ‚ç‚¹ä¸Šï¼ˆå¤„äºPendingçŠ¶æ€ï¼‰ã€‚
ä¾‹å¦‚ï¼Œä½ å¯èƒ½å¸Œæœ›å°†Podè°ƒåº¦åˆ°å…·æœ‰ç‰¹å®šç¡¬ä»¶é…ç½®ï¼ˆå¦‚GPUï¼‰çš„èŠ‚ç‚¹ä¸Šã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾_](doc_tutorial_senior.md#42-ç¡¬æ€§è°ƒåº¦-æŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾nodeselector)

### 6.5 Podè°ƒåº¦æŠ€æœ¯â€”æ±¡ç‚¹ä¸å®¹å¿åº¦

æ±¡ç‚¹ä¸èŠ‚ç‚¹ç»‘å®šï¼ŒèŠ‚ç‚¹æ‹¥æœ‰æ±¡ç‚¹åé˜²æ­¢Podè¢«è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼Œé™¤éPodSpecä¸­é…ç½®äº†å®¹å¿åº¦ï¼ˆé’ˆå¯¹è¯¥æ±¡ç‚¹ï¼‰ã€‚
æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è®¾ç½®æ±¡ç‚¹ï¼ˆtaintï¼‰ï¼Œæ±¡ç‚¹æ˜¯ä¸€ä¸ªé”®å€¼å¯¹ï¼ˆå€¼å¯å¿½ç•¥ï¼‰å’Œæ±¡ç‚¹æ•ˆæœçš„å½¢å¼ï¼Œæ¯”å¦‚`role/log:NoSchedule`ã€‚

æ±¡ç‚¹ä¸åäº²å’Œæ€§ç±»ä¼¼éƒ½æ˜¯ç”¨æ¥æ’æ–¥Podï¼Œä½†å®ƒä»¬ä¹‹é—´æœ‰ä¸€ä¸ªé‡è¦åŒºåˆ«ï¼Œé‚£å°±æ˜¯æ±¡ç‚¹é»˜è®¤æ’æ–¥æ‰€æœ‰çš„Podï¼ˆç›´åˆ°ä¸ºPodè®¾ç½®äº†å¯¹åº”æ±¡ç‚¹çš„å®¹å¿åº¦ï¼‰ã€‚
ä¾‹å¦‚ï¼Œåœ¨ä¸Šçº¿æŸäº›GPUèŠ‚ç‚¹æ—¶ï¼Œå°±å¯ä»¥å°†å®ƒä»¬è®¾ç½®æ±¡ç‚¹ï¼Œè¿™æ ·Podå°±ä¸ä¼šè¢«è°ƒåº¦åˆ°è¿™äº›èŠ‚ç‚¹ä¸Šï¼Œç›´åˆ°ä½ æ‰‹åŠ¨ä¸ºé‚£äº›éœ€è¦GPUçš„Podè®¾ç½®å®¹å¿åº¦ã€‚
è¿˜æœ‰å°±æ˜¯å¯ä»¥ç”¨æ¥æ’ç©ºèŠ‚ç‚¹ï¼Œæ¯”å¦‚ç°åœ¨æƒ³è¦ä¸‹çº¿æˆ–ç»´æŠ¤æŸä¸ªèŠ‚ç‚¹ï¼Œå°±å¯ä»¥ä¸ºå…¶è®¾ç½®ä¸€ä¸ªæ±¡ç‚¹å«åš`maintaining:NoExecute`ï¼Œ
åœ¨çŸ­æš‚æ—¶é—´åï¼ŒKuberneteså°±ä¼šæ’ç©ºè¯¥èŠ‚ç‚¹ä¸Šçš„Podï¼ˆå¼ºåˆ¶æ’ç©ºï¼‰ï¼Œå½“Podè¢«æ’ç©ºåï¼Œå°±å¯ä»¥å°†èŠ‚ç‚¹ä¸‹çº¿æˆ–è¿›è¡Œç»´æŠ¤ã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-æ±¡ç‚¹å’Œå®¹å¿åº¦_](doc_tutorial_senior.md#46-æ±¡ç‚¹å’Œå®¹å¿åº¦)

### 6.6 Podè°ƒåº¦æŠ€æœ¯â€”æŒ‡å®šèŠ‚ç‚¹åç§°

é€šè¿‡åœ¨PodSpecä¸­æŒ‡å®š`nodeName`å­—æ®µï¼Œå¯ä»¥è®©Podç›´æ¥è°ƒåº¦åˆ°æŒ‡å®šèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä¸”å¯ä»¥è‡ªåŠ¨å®¹å¿èŠ‚ç‚¹ä¸Šçš„é™¤äº†åŒ…å«`NoExecute`å½±å“ä»¥å¤–çš„æ±¡ç‚¹ã€‚
è¿™ä¸ªç‰¹æ€§ç”±äºçµæ´»æ€§è¾ƒä½æ‰€ä»¥ä½¿ç”¨è¾ƒå°‘ã€‚ä½¿ç”¨æ—¶éœ€æ³¨æ„ï¼Œè‹¥èŠ‚ç‚¹åç§°ä¸å­˜åœ¨äºé›†ç¾¤çš„èŠ‚ç‚¹åˆ—è¡¨ä¸­ï¼Œåˆ™Podå°†æ— æ³•è°ƒåº¦åˆ°ä»»ä½•èŠ‚ç‚¹ä¸Šï¼Œé€šè¿‡`kubectl get po`
ä¹Ÿæ— æ³•çœ‹åˆ°Podã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-æŒ‡å®šèŠ‚ç‚¹åç§°nodename_](doc_tutorial_senior.md#43-ç¡¬æ€§è°ƒåº¦-æŒ‡å®šèŠ‚ç‚¹åç§°nodename)

### 6.7 Podèµ„æºç®¡ç†â€”è¯·æ±‚å’Œé™åˆ¶

åœ¨å®è·µä¸­ï¼Œä¸€èˆ¬éƒ½éœ€è¦åœ¨PodSpecä¸­è®¾ç½®å®¹å™¨çš„`requests`å’Œ`limits`å­—æ®µï¼Œåˆ†åˆ«è¡¨ç¤ºPodå†…å®¹å™¨å¯¹CPUå’Œå†…å­˜çš„æœ€ä½éœ€æ±‚å’Œæœ€é«˜é™åˆ¶ï¼Œ
å‰è€…å¯ä»¥ä¿è¯Podèƒ½å¤Ÿæ­£å¸¸è°ƒåº¦åˆ°èµ„æºè¶³å¤Ÿçš„èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåè€…æ˜¯ä¸ºäº†é¿å…Podå ç”¨è¿‡å¤šèŠ‚ç‚¹èµ„æºå½±å“åˆ°èŠ‚ç‚¹ä¸Šçš„å…¶ä»–åº”ç”¨ã€‚å½“Podå¯¹èµ„æºçš„å ç”¨è¾¾åˆ°é™åˆ¶åï¼Œ
Podå¯èƒ½å› ä¸ºOOMè€Œé‡å¯æˆ–è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚

å½“ä½ å®‰è£…äº†MetricsServeråï¼Œå°±å¯ä»¥é€šè¿‡`kubectl top nodes`å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚

```shell
# CPUèµ„æºæ˜¯ä»¥millicoreï¼ˆmï¼‰ä¸ºå•ä½ï¼Œ1000m=1core
# å†…å­˜èµ„æºæ˜¯ä»¥byteä¸ºå•ä½ï¼Œ1Mi=1024Ki=1024*1024bytes
$ kubectl top nodes
NAME                      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
test-1.27-control-plane   241m         6%     559Mi           14%       
test-1.27-worker          105m         2%     742Mi           18%       
test-1.27-worker2         93m          2%     1788Mi          45%   
```

æ ¹æ®è¿™äº›ä¿¡æ¯æˆ‘ä»¬å¯ä»¥çŸ¥é“æ‰€æœ‰èŠ‚ç‚¹çš„CPUå’Œå†…å­˜çš„å·²ä½¿ç”¨æƒ…å†µï¼Œä»è€ŒçŸ¥é“ä½•æ—¶è¯¥ä¸ºé›†ç¾¤å¢åŠ èŠ‚ç‚¹ã€‚åŒæ—¶ä¹Ÿå¯ä»¥ä½¿ç”¨`kubectl top po`
æŸ¥çœ‹Podå¯¹èŠ‚ç‚¹èµ„æºçš„ä½¿ç”¨æƒ…å†µã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-å®‰è£…metrics-serveræ’ä»¶_](doc_tutorial_senior.md#341-å®‰è£…metrics-serveræ’ä»¶)

### 6.8 Podèµ„æºç®¡ç†â€”æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰

Podè¢«åˆ›å»ºåä¼šè¢«åˆ†é…ä¸€ä¸ªQoSç­‰çº§ï¼Œå½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œä¼šæ ¹æ®Podçš„QoSç­‰çº§ä½œä¸ºä¾æ®æ¥é©±é€æŸäº›Podã€‚
å…·ä½“åˆ†é…çš„QoSç­‰çº§ç”±Podçš„èµ„æºè¯·æ±‚å’Œé™åˆ¶å†³å®šã€‚ä¸€å…±æœ‰ä»¥ä¸‹3ç§QoSç­‰çº§ï¼š

- Guaranteedï¼šå½“Podä¸­æ¯ä¸ªå®¹å™¨ï¼ˆåŒ…å«åˆå§‹åŒ–å®¹å™¨å’Œæ™®é€šå®¹å™¨ï¼‰éƒ½å®šä¹‰äº†CPUæˆ–å†…å­˜çš„`requests`å’Œ`limits`ä¸”æ•°é¢ç›¸ç­‰æ—¶ï¼Œåˆ†é…æ­¤ç­‰çº§ã€‚
    - æœ€é«˜ä¼˜å…ˆçº§ï¼Œå½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šé€‰æ‹©Killå…¶ä»–ä¸¤ç§ä¼˜å…ˆçº§çš„Podæ¥ä¿è¯æ­¤ç­‰çº§Podçš„æ­£å¸¸è¿è¡Œã€‚
- Burstableï¼šå½“Podä¸­å­˜åœ¨ä¸€ä¸ªå®¹å™¨çš„CPUæˆ–å†…å­˜çš„`requests`å°äº`limits`æ—¶ï¼Œåˆ†é…æ­¤ç­‰çº§ã€‚
    - æ¬¡é«˜ä¼˜å…ˆçº§ï¼Œå½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šé€‰æ‹©Kill BestEffortç­‰çº§çš„Podæ¥ä¿è¯æ­¤ç­‰çº§Podçš„æ­£å¸¸è¿è¡Œã€‚
- BestEffortï¼šå½“Podä¸­æ²¡æœ‰ä»»ä½•å®¹å™¨è®¾ç½®å¯¹CPUæˆ–å†…å­˜çš„`requests`å’Œ`limits`æ—¶ï¼Œåˆ†é…æ­¤ç­‰çº§ã€‚
    - æœ€ä½ä¼˜å…ˆçº§ï¼Œå½“èŠ‚ç‚¹èµ„æºä¸è¶³æ—¶ï¼Œç³»ç»Ÿä¼šä¼˜å…ˆKillæ­¤ç­‰çº§çš„Podã€‚

æ³¨æ„ï¼Œè‹¥æŸä¸ªå®¹å™¨åªè®¾ç½®äº†CPUæˆ–å†…å­˜çš„`limits`å­—æ®µä½†æœªè®¾ç½®`requests`ï¼ŒKubernetesä¼šè‡ªåŠ¨ä¸ºå…¶è®¾ç½®ä¸é™åˆ¶ç›¸ç­‰æ•°é¢çš„è¯·æ±‚ã€‚

æŸ¥çœ‹PodæœåŠ¡è´¨é‡ç­‰çº§çš„å‘½ä»¤ï¼š

```shell
kubectl get po xxx -o jsonpath='{ .status.qosClass}{"\n"}'
```

æ‰€ä»¥ï¼Œä¸ºäº†é¿å…Podè¢«Killï¼Œåº”è¯¥å°½å¯èƒ½ä¸ºé‡è¦ä¸šåŠ¡çš„Podè®¾ç½®Guaranteedçš„QoSç­‰çº§ã€‚

### 6.9 Podèµ„æºç®¡ç†â€”PodDisruptionBudget

æ­£å¸¸è¿è¡Œçš„Podå¯èƒ½åœ¨æŸä¸ªæ—¶å€™è¢«äººå·¥æˆ–æ§åˆ¶å™¨é©±é€ï¼ˆç›¸å½“äºåˆ é™¤ï¼‰ï¼Œé©±é€åŸå› åˆ†ä¸ºä¸¤ç±»ï¼šä¸»åŠ¨
é©±é€å’Œè¢«åŠ¨é©±é€ã€‚ä¸»åŠ¨é©±é€æ˜¯æŒ‡ç”¨æˆ·æˆ–æ§åˆ¶å™¨æ˜ç¡®åœ°æ‰§è¡Œäº†åˆ é™¤æ“ä½œï¼ˆåŒ…æ‹¬å¯¹Podæ¨¡æ¿çš„æ›´æ–°ã€æ’ç©ºèŠ‚ç‚¹ç­‰ï¼‰ï¼›
è€Œè¢«åŠ¨é©±é€æ˜¯æŒ‡ç”±äºèŠ‚ç‚¹èµ„æºä¸è¶³ï¼ŒKubernetesç³»ç»Ÿæ ¹æ®QoSç­‰çº§é€‰æ‹©æ€§åœ°é©±é€Podï¼Œè¢«åŠ¨é©±é€è¿˜åŒ…æ‹¬ç¡¬ä»¶æ•…éšœã€ç½‘ç»œåˆ†åŒºæˆ–å†…æ ¸å´©æºƒç­‰å¼‚å¸¸æƒ…å†µã€‚

ä»»ä½•åŸå› å¯¼è‡´çš„é©±é€éƒ½å¯ä»¥æˆä¸ºå¹²æ‰°ï¼ˆDisruptionï¼‰ï¼Œä¸ºäº†æœ€å¤§ç¨‹åº¦å‡å°‘å¹²æ‰°å¯¹åº”ç”¨çš„å½±å“ï¼Œ
Kuberneteså…è®¸æˆ‘ä»¬è®¾ç½®PDBæ¥ä¿è¯å‘ç”Ÿå¹²æ‰°æ—¶åº”ç”¨ä»ç„¶èƒ½å¤Ÿæ­£å¸¸è¿è¡Œã€‚å…·ä½“æ¥è¯´ï¼ŒPDBå¯ä»¥è®¾ç½®åœ¨å‘ç”Ÿå¹²æ‰°æ—¶ï¼Œ
ä¸æŒ‡å®šæ ‡ç­¾åŒ¹é…çš„Podæœ€å¤šå¯ä»¥è¢«å…³é—­çš„æ•°é‡æˆ–ç™¾åˆ†æ¯”ã€æœ€å°‘å¯ç”¨çš„Podæ•°é‡æˆ–ç™¾åˆ†æ¯”ã€‚

å½“è¿›è¡Œæ’ç©ºï¼ˆdrainï¼‰æ“ä½œæ—¶ï¼Œå¦‚æœè¿åPDBç­–ç•¥ï¼Œæ’ç©ºå‘½ä»¤å°†è¿›å…¥é˜»å¡ã€‚

> æ³¨æ„ï¼šå·¥ä½œè´Ÿè½½èµ„æºï¼ˆDeploymentã€StatefulSetæˆ–ReplicaSetç­‰ï¼‰åœ¨æ»šåŠ¨å‡çº§æ—¶ä¸ä¼šè§¦å‘PDBã€‚

PDBçš„ç¤ºä¾‹æ¨¡æ¿ï¼š

```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: zk-pdb
spec:
  # minAvailable å’Œ maxUnavailable åªèƒ½è®¾ç½®å…¶ä¸€ï¼Œä¸¤è€…éƒ½æ”¯æŒæ•´æ•°å’Œç™¾åˆ†æ¯”
  minAvailable: 2
  # maxUnavailable: 10%
  selector:
    matchLabels:
      app: zookeeper
```

PDBæ ¹æ®selectoråŒ¹é…ä¸€ç»„Podï¼Œå®ƒä»¬å¯ä»¥æ˜¯æŸä¸ªæ§åˆ¶å™¨ï¼ˆå¦‚Deploymentæˆ–StatefulSetç­‰ï¼‰ä¸‹çš„Podï¼Œä¹Ÿå¯ä»¥æ˜¯ç‹¬ç«‹çš„Podã€‚

- [ä¸ºåº”ç”¨ç¨‹åºè®¾ç½®å¹²æ‰°é¢„ç®—](https://kubernetes.io/zh-cn/docs/tasks/run-application/configure-pdb/)

### 6.10 Podèµ„æºç®¡ç†â€”ResourceQuota

å½“å¤šä¸ªå›¢é˜Ÿæˆ–å¤šä¸ªä¸åŒç±»åˆ«çš„åº”ç”¨å…±äº«ä¸€ä¸ªé›†ç¾¤æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦å°†å®ƒä»¬å®‰ç½®åœ¨ä¸åŒçš„å‘½åç©ºé—´ä¸‹è¿›è¡Œç®¡ç†ã€‚è¿›ä¸€æ­¥ï¼Œ
æˆ‘ä»¬è¿˜éœ€è¦å¯¹æ¯ä¸ªå‘½åç©ºé—´çš„èµ„æºé¢åº¦è¿›è¡Œé™åˆ¶ï¼Œå¦åˆ™å°±ä¼šäº’ç›¸å½±å“ï¼Œå¯¼è‡´æ„å¤–ç»“æœã€‚

ResourceQuotaæ˜¯ç”¨äºç®¡ç†å•ä¸ªå‘½åç©ºé—´çš„æ€»èµ„æºé™é¢çš„Kubernetes APIå¯¹è±¡ã€‚å®ƒå¯ä»¥ä¸ºä»¥ä¸‹èµ„æºè¿›è¡Œé™é¢ï¼š

- CPU/å†…å­˜çš„è¯·æ±‚å’Œé™åˆ¶
- å­˜å‚¨å·æ€»é‡
- PVCä¸ªæ•°
- Pod/Service/Deployment/ReplicaSetç­‰èµ„æºçš„ä¸ªæ•°

å½“å‘½åç©ºé—´ä¸­çš„èµ„æºä½¿ç”¨é‡è¾¾åˆ°é™é¢å°±ä¼šè§¦å‘é”™è¯¯æç¤ºã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-é…ç½®æ•´ä½“èµ„æºé…é¢_](doc_tutorial_senior.md#321-é…ç½®æ•´ä½“èµ„æºé…é¢)

### 6.11 Podèµ„æºç®¡ç†â€”LimitRange

ResourceQuotaæ˜¯ç®¡ç†å•ä¸ªå‘½åç©ºé—´çš„æ€»èµ„æºé™é¢ï¼Œä½†æˆ‘ä»¬è¿˜éœ€è¦å¯¹å‘½åç©ºé—´ä¸‹çš„å•ä¸ªå¯¹è±¡æ‰€ä½¿ç”¨çš„èµ„æºè¿›è¡Œé™é¢ï¼Œå¦åˆ™åœ¨å‘½åç©ºé—´å†…çš„å¯¹è±¡ä¹Ÿä¼šäº’ç›¸å½±å“ã€‚
è€ŒLimitRangeåˆ™å¯ä»¥å¸®åŠ©æˆ‘ä»¬è¾¾æˆç›®æ ‡ï¼Œä¾‹å¦‚ï¼Œå®ƒå¯ä»¥è®¾ç½®å‘½åç©ºé—´ä¸‹Podçš„é»˜è®¤CPU/å†…å­˜çš„è¯·æ±‚å’Œé™åˆ¶çš„æ•°å€¼ï¼Œå½“Podçš„è®¾ç½®è¶…å‡ºé™åˆ¶æ—¶æ— æ³•éƒ¨ç½²ï¼Œ
åŒæ—¶å½“LimitRangeé…ç½®åï¼Œæ–°çš„ï¼ˆåŒ…æ‹¬æ§åˆ¶ä¸‹çš„ï¼‰Podå¿…é¡»è®¾ç½®CPU/å†…å­˜çš„è¯·æ±‚å’Œé™åˆ¶ï¼Œå¦åˆ™ä¹Ÿæ— æ³•éƒ¨ç½²ã€‚

é™¤äº†Podï¼ŒLimitRangeè¿˜å¯ä»¥é’ˆå¯¹å®¹å™¨ã€PVCç­‰è®¸å¤šå¯¹è±¡è¿›è¡Œé…ç½®ã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-é…ç½®ä¸ªä½“èµ„æºé…é¢_](doc_tutorial_senior.md#323-é…ç½®ä¸ªä½“èµ„æºé…é¢)

### 6.12 èµ„æºä¼¸ç¼©â€”Podæ°´å¹³ä¼¸ç¼©

å½“Kubernetesä¸­çš„åº”ç”¨çªç„¶é¢ä¸´ä¸šåŠ¡é«˜å³°æœŸï¼Œå›ºå®šå‰¯æœ¬æ•°é‡éƒ¨ç½²çš„Podæ— æ³•æ»¡è¶³ä¸šåŠ¡éœ€æ±‚æ—¶ï¼Œ
æˆ‘ä»¬å¯ä»¥é€šè¿‡Horizontal Pod Autoscalerï¼ˆHPAï¼‰å¯¹Podè¿›è¡Œæ°´å¹³ä¼¸ç¼©ã€‚
HPAæ˜¯Kubernetesæä¾›çš„å¯¹è±¡ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ ¹æ®Podçš„CPU/å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨è°ƒæ•´Podçš„å‰¯æœ¬æ•°é‡ï¼Œä»è€Œå®ç°Podå‰¯æœ¬æ•°é‡çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚

é™¤äº†ä½¿ç”¨Podçš„CPU/å†…å­˜ä½¿ç”¨ç‡ä½œä¸ºä¼¸ç¼©æŒ‡æ ‡ï¼Œè¿˜æ”¯æŒä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ï¼Œä½†è¿™éœ€è¦é¢å¤–éƒ¨ç½²èµ„æºæ¥ä½œä¸ºæŒ‡æ ‡æ¥æºã€‚

- [_Kubernetesè¿›é˜¶æ•™ç¨‹-ä½¿ç”¨HPAæ°´å¹³æ‰©ç¼©Pod_](doc_tutorial_senior.md#34-ä½¿ç”¨hpaæ°´å¹³æ‰©ç¼©pod)

### 6.12 èµ„æºä¼¸ç¼©â€”Podå‚ç›´ä¼¸ç¼©

HPAæ˜¯ä¸€ç§ç®€å•ç›´æ¥çš„å¢åŠ æœåŠ¡ç«¯ååé‡çš„æ–¹å¼ï¼Œä½†å¦‚æœPodç”±å¤šä¸ªå®¹å™¨ç»„æˆï¼Œè€Œåªæœ‰ä¸€ä¸ªæ¥æ”¶æµé‡çš„åº”ç”¨å®¹å™¨ï¼ŒHPAå¯èƒ½ä¼šé€ æˆä¸€äº›èµ„æºæµªè´¹ã€‚
æ­¤æ—¶ï¼Œä½¿ç”¨Vertical Pod Autoscalerï¼ˆVPAï¼‰å¯ä»¥å®ç°Podçš„å‚ç›´ä¼¸ç¼©ã€‚
VPAæ˜¯Kubernetesæä¾›çš„å¯¹è±¡ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æ ¹æ®Podä¸­æ‰€æœ‰å®¹å™¨çš„CPU/å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨è°ƒæ•´Podä¸­æ‰€æœ‰å®¹å™¨çš„CPU/å†…å­˜çš„è¯·æ±‚å’Œé™åˆ¶çš„æ•°å€¼ï¼Œ
ä»è€Œå®ç°Podä¸­æ‰€æœ‰å®¹å™¨çš„CPU/å†…å­˜çš„è‡ªåŠ¨ä¼¸ç¼©ã€‚

VPAå¹¶ä¸æ˜¯KubernetesåŸç”Ÿæä¾›çš„åŠŸèƒ½ï¼Œè€Œæ˜¯ç”±ç¤¾åŒºæä¾›çš„ï¼Œéœ€è¦ä»¥è‡ªå®šä¹‰èµ„æºçš„æ–¹å¼è¿›è¡Œå®‰è£…ã€‚VPAæä¾›å››ç§å·¥ä½œæ¨¡å¼ï¼š

- autoï¼šVPAåœ¨Podåˆ›å»ºæ—¶ä¸ºå…¶åˆ†é…èµ„æºè¯·æ±‚ï¼Œå¹¶åœ¨Podè¿è¡Œæ—¶æ ¹æ®Podçš„èµ„æºä½¿ç”¨ç‡è‡ªåŠ¨è°ƒæ•´èµ„æºè¯·æ±‚ã€‚
    - å½“å‰çš„æ›´æ–°æ˜¯é€šè¿‡åˆ é™¤é‡å»ºï¼ˆç­‰æ•ˆäº`recreate`ï¼‰çš„æ–¹å¼ï¼Œä¸€æ—¦Kubernetesæ”¯æŒåŸåœ°æ›´æ–°ï¼ŒVPAå°†åˆ‡æ¢åˆ°åŸåœ°æ›´æ–°æ¨¡å¼ã€‚
- recreateï¼šVPAåœ¨Podåˆ›å»ºæ—¶ä¸ºå…¶åˆ†é…èµ„æºè¯·æ±‚ï¼Œå¹¶åœ¨Podè¿è¡Œæ—¶æ ¹æ®Podçš„CPU/å†…å­˜ä½¿ç”¨ç‡è‡ªåŠ¨è°ƒæ•´èµ„æºè¯·æ±‚ï¼Œæ›´æ–°æ˜¯ä»¥åˆ é™¤é‡å»ºçš„æ–¹å¼è¿›è¡Œã€‚
- initialï¼šVPAåªåœ¨åˆ›å»ºPodæ—¶åˆ†é…èµ„æºè¯·æ±‚ï¼Œä»¥åä¸ä¼šæ›´æ”¹ã€‚
- offï¼šVPAä¸ä¼šè‡ªåŠ¨æ›´æ”¹Podçš„èµ„æºè¯·æ±‚ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªVPAé…ç½®å®ä¾‹ï¼ˆå®‰è£…VPAåå¯ç”¨ï¼‰ï¼š

```yaml
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: my-app-vpa
spec:
  targetRef:
    apiVersion: "apps/v1"
    kind: Deployment
    name: my-app
  updatePolicy:
    updateMode: "Auto"
```

VPAçš„ä½¿ç”¨æ¯”è¾ƒå¤æ‚ï¼Œæœ‰è®¸å¤šéœ€è¦æ³¨æ„çš„ç‚¹ã€‚ä¾‹å¦‚ï¼ŒVPAä¸å»ºè®®ä¸HPAåŒæ—¶ä½¿ç”¨ï¼ˆé™¤éHPAä½¿ç”¨è‡ªå®šä¹‰æŒ‡æ ‡ä½œä¸ºå‚è€ƒï¼‰ã€‚è‹¥è¦ä½¿ç”¨VPAï¼Œè¯·é˜…è¯»VPAæ–‡æ¡£ï¼Œ
å¹¶è¿›è¡Œè¯¦å°½çš„æµ‹è¯•åå†æŠ•å…¥ç”Ÿäº§ã€‚

- [VPAä½¿ç”¨ä»‹ç»](https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler)

### 6.13 èµ„æºä¼¸ç¼©â€”èŠ‚ç‚¹æ°´å¹³ä¼¸ç¼©

å½“é¢å¯¹å…·æœ‰æ›´å¤§çªå‘æµé‡çš„ä¸šåŠ¡æ—¶ï¼Œè€ƒè™‘å®æ–½èŠ‚ç‚¹ç»´åº¦çš„è‡ªåŠ¨æ°´å¹³ä¼¸ç¼©æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚
ä½†ç›®å‰çš„é›†ç¾¤è‡ªåŠ¨ä¼¸ç¼©åŠŸèƒ½**ä»…æ”¯æŒåœ¨å…¬æœ‰äº‘ä¸Š**è¿è¡Œï¼Œè¿™ç‚¹éœ€è¦æ³¨æ„ã€‚

èŠ‚ç‚¹çš„æ°´å¹³ä¼¸ç¼©ä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µè‡ªåŠ¨è§¦å‘ï¼š

- Podç”±äºèµ„æºä¸è¶³è€Œæ— æ³•å¯åŠ¨æ—¶ï¼ˆå¢åŠ èŠ‚ç‚¹ï¼‰ã€‚
- é›†ç¾¤ä¸­å­˜åœ¨å·²ç»åœ¨è¾ƒé•¿çš„æ—¶é—´æ®µå†…æœªè¢«å……åˆ†åˆ©ç”¨çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å®ƒä»¬çš„Podå¯ä»¥è¢«æ”¾ç½®åœ¨å…¶å®ƒç°æœ‰èŠ‚ç‚¹ä¸Šï¼ˆç¼©å‡èŠ‚ç‚¹ï¼‰ã€‚

èŠ‚ç‚¹æ°´å¹³ä¼¸ç¼©æ˜¯ä¸€ä¸ªé«˜çº§çš„ä¸»é¢˜ï¼Œè€ƒè™‘åœ¨åˆé€‚çš„æ—¶æœºå»å¢å‡èŠ‚ç‚¹ï¼ˆä»¥åŠå¢å‡å“ªäº›èŠ‚ç‚¹ï¼‰æ˜¯ä¸€ä¸ªååˆ†å¤æ‚çš„å†³ç­–è¿‡ç¨‹ï¼Œ
è¿™å…¶ä¸­éœ€è¦è€ƒè™‘åˆ°Podäº²å’Œæ€§å’Œåäº²å’Œæ€§ã€æ±¡ç‚¹ã€è¿è¡ŒPDBçš„Podçš„èŠ‚ç‚¹ç­‰ç­‰ã€‚è‹¥ä½ ç›´æ¥ä½¿ç”¨äº‘æ‰˜ç®¡çš„K8sé›†ç¾¤ï¼Œ
åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨äº‘å‚å•†åŸç”Ÿæ”¯æŒçš„é›†ç¾¤èŠ‚ç‚¹è‡ªåŠ¨ä¼¸ç¼©åŠŸèƒ½ï¼Œè€Œæ— éœ€è‡ªè¡Œè¿ç»´æ­¤åŠŸèƒ½ã€‚

- [Cluster Autoscaler](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler)

## 7. ç½‘ç»œç­–ç•¥ä¸Podå®‰å…¨

### 7.1 ç½‘ç»œç­–ç•¥

é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†ç¾¤ä¸­çš„å·¥ä½œè´Ÿè½½ï¼ˆDeploymentç­‰æ§åˆ¶å™¨ä¸‹çš„Podï¼‰èµ„æºçš„ç½‘ç»œé€šä¿¡æ˜¯å¼€æ”¾çš„ï¼Œå¯ä»¥éšæ„è®¿é—®ã€‚
è¿™åŒ…æ‹¬ï¼ˆå¯èƒ½è·¨å‘½åç©ºé—´çš„ï¼‰Podä¹‹é—´å’ŒPodä¸å¤–éƒ¨ä¸–ç•Œä¹‹é—´çš„äº’é€šæ€§ã€‚
å¼€æ”¾è®¿é—®è™½ç„¶å‡å°‘äº†è¿ç»´å¤æ‚åº¦å’Œå›°æ‰°ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†é£é™©ã€‚ä¾‹å¦‚ï¼ŒDBæœåŠ¡åº”è¯¥åªå…è®¸è¢«éƒ¨åˆ†è¿è¡Œåç«¯æœåŠ¡çš„Podè®¿é—®ï¼Œ
é‚£äº›å‰ç«¯åº”ç”¨Podå’Œå¤–éƒ¨ä¸–ç•Œç»ä¸åº”è¯¥è®¿é—®åˆ°DBæœåŠ¡ã€‚æ­¤æ—¶ï¼Œåº”è¯¥æœ‰ä¸€æ¡ACLï¼ˆè®¿é—®æ§åˆ¶åˆ—è¡¨ï¼Œä¼ ç»Ÿç½‘ç»œå±‚é¢çš„æœ¯è¯­ï¼‰æ¥å®ç°æ­¤ç›®æ ‡ã€‚

å¥½åœ¨ï¼ŒKubernetesæä¾›äº†ä¸€ä¸ªå«åš**NetworkPolicy**çš„APIèµ„æºæ¥ä¸ºé›†ç¾¤çš„ç½‘ç»œå±‚ï¼ˆç¬¬å››å±‚ï¼‰ä¿é©¾æŠ¤èˆªã€‚
NetworkPolicyå¯ä»¥è¢«çœ‹åšæ˜¯é›†ç¾¤ä¸­çš„ä¸€ä¸ªä¸œè¥¿å‘æµé‡é˜²ç«å¢™ï¼Œæ¯ä¸ªç­–ç•¥è§„åˆ™éƒ½é€šè¿‡`podSelector`å±æ€§æ¥åŒ¹é…ä¸€ç»„Podï¼ŒåŒæ—¶æ§åˆ¶å®ƒä»¬çš„æµé‡å‡ºå…¥ã€‚
æ¯æ¡ç½‘ç»œç­–ç•¥éƒ½åº”ç”¨äºPodæµé‡çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªæ–¹å‘ï¼Œå³`Egress`ï¼ˆå‡ºç«™æ–¹å‘ï¼‰å’Œ`Ingress`ï¼ˆå…¥ç«™æ–¹å‘ï¼‰ï¼Œ
æ¯ä¸ªæ–¹å‘æŒ‡å®šç›®çš„åœ°æˆ–æ¥æºæ—¶éƒ½å¯ä»¥é€‰æ‹©ä¸‰ç§æ–¹å¼é™å®šï¼šåŒ¹é…æŸäº›æ ‡ç­¾çš„ä¸€ç»„Podã€ä¸€ä¸ªIPå—æˆ–åŒ¹é…æŸäº›æ ‡ç­¾çš„å‘½åç©ºé—´ï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥åŒæ—¶æŒ‡å®šï¼Œæ˜¯æˆ–çš„å…³ç³»ã€‚
åŒæ—¶è¿˜å¯ä»¥æŒ‡å®šå“ªäº›ç«¯å£å’Œåè®®ï¼ˆæ”¯æŒTCP/UDPï¼‰å¯ä»¥è¢«è®¿é—®ï¼Œæˆ–ä½œä¸ºç›®çš„åœ°ã€‚

æ³¨æ„å‡ ç‚¹ï¼š

- æ¯ä¸ªæ–¹å‘éƒ½å¯ä»¥æŒ‡å®šå¤šä¸ªç›®çš„åœ°æˆ–æ¥æºï¼Œè¿™äº›ç›®çš„åœ°æˆ–æ¥æºä¹‹é—´æ˜¯æˆ–çš„å…³ç³»ã€‚ä½†è¿›ä¸€æ­¥ï¼Œæ¯ä¸ªç›®çš„åœ°æˆ–æ¥æºåˆå¯ä»¥ç”±ä¸Šé¢æåˆ°çš„ä¸‰ç§æ–¹å¼è¿›è¡Œä»»æ„ç»„åˆï¼Œç»„åˆåçš„ç»“æœæ˜¯ä¸”çš„å…³ç³»ï¼Œå…·ä½“è¯·å‚é˜…å®˜æ–‡ã€‚
    - ç®€å•çš„æ€»ç»“å°±æ˜¯å¤–æˆ–å†…ä¸”ã€‚
- å¯¹äºé™¤äº†TCP/UDPä»¥å¤–çš„åè®®çš„è¿‡æ»¤æ”¯æŒï¼Œå–å†³äºé›†ç¾¤æ‰€å®‰è£…çš„CNIç½‘ç»œæ’ä»¶ã€‚
- å¯¹äºä½¿ç”¨`hostNetwork`çš„Podï¼ŒNetworkPolicyæ— æ³•ä¿è¯å¯¹å…¶ç”Ÿæ•ˆã€‚
    - è¿™ç±»Podå¯¹å¤–è®¿é—®æ—¶å…·æœ‰ä¸èŠ‚ç‚¹ç›¸åŒçš„IPï¼Œå¯ä»¥ä½¿ç”¨`ipBlock`è§„åˆ™å…è®¸æ¥è‡ª`hostNetwork`Podçš„æµé‡ã€‚
- ä¸ç®¡æ˜¯å‡ºç«™è¿˜æ˜¯å…¥ç«™æµé‡ç­–ç•¥ï¼Œéƒ½æ˜¯å åŠ ç”Ÿæ•ˆçš„ï¼Œæœ€ç»ˆæ•ˆæœä¸å—é¡ºåºå½±å“ã€‚
    - ç”±æ­¤æ¨æ–­ï¼Œè¾ƒå¤šçš„ç½‘ç»œç­–ç•¥ä¼šå½±å“é›†ç¾¤ç½‘ç»œæ€§èƒ½ã€‚
- æ–°å¢ç­–ç•¥å¯¹ç°æœ‰è¿æ¥çš„å½±å“æ˜¯ä¸ç¡®å®šçš„ï¼Œå…·ä½“è¡Œä¸ºç”±CNIç½‘ç»œæ’ä»¶å†³å®šã€‚
    - ä¾‹å¦‚ï¼Œæ—§ç­–ç•¥æ˜¯å…è®¸æ¥è‡ªæŸä¸ªæºçš„è®¿é—®ï¼Œåº”ç”¨çš„æ–°ç­–ç•¥åˆ™æ˜¯æ‹’ç»è¿™ä¸ªæºçš„è®¿é—®ï¼Œæ­¤æ—¶æ˜¯ç«‹å³åˆ‡æ–­ç°æœ‰è¿æ¥è¿˜æ˜¯ä»…å¯¹æ–°è¿æ¥ç”Ÿæ•ˆ
      å–å†³äºCNIç½‘ç»œæ’ä»¶çš„å®ç°ã€‚
- æ”¯æŒNetworkPolicyçš„CNIç½‘ç»œæ’ä»¶æœ‰ï¼šCalicoã€Antreaã€Ciliumã€Kube-routerã€Romanaã€Weave Netç­‰ã€‚æ³¨æ„ï¼ŒFlannelä¸æ”¯æŒã€‚

#### 7.1.1 å‡ºç«™æµé‡

å½“æ²¡æœ‰`Egress`ç­–ç•¥æ—¶ï¼Œå®ƒå°†é»˜è®¤å…è®¸Podçš„æ‰€æœ‰å‡ºç«™æµé‡ã€‚å½“å­˜åœ¨ä¸€æ¡`Egress`ç­–ç•¥æ—¶ï¼š

- å®ƒå°†æ§åˆ¶ï¼ˆä¸”ä»…ï¼‰ä¸€ç»„é€šè¿‡`podSelector`åŒ¹é…çš„Podçš„å‡ºç«™æµé‡ï¼›
- å®ƒå°†å…è®¸åŒ¹é…çš„ä¸€ç»„Pod**è®¿é—®**æŒ‡å®šç›®æ ‡çš„æµé‡ï¼ŒåŒæ—¶é»˜è®¤å…è®¸è¿™ä¸ªç›®æ ‡ç½‘ç»œçš„åº”ç­”æµé‡ï¼ˆä¸éœ€è¦Ingressè§„åˆ™å…è®¸ï¼‰ï¼›
- è‹¥ç­–ç•¥æ²¡æœ‰æŒ‡å®šå‡ºç«™ç›®æ ‡ï¼Œåˆ™è¡¨ç¤ºä¸å…è®¸ä»»ä½•å‡ºç«™æµé‡ï¼›
- æ‰€åŒ¹é…çš„è¿™ç»„Podè®¿é—®ä»»ä½•éæœ¬åœ°ã€ä¸”éç›®æ ‡çš„æµé‡éƒ½å°†è¢«æ‹’ç»ï¼Œé™¤éæœ‰å…¶ä»–Egressç­–ç•¥æ”¾è¡Œã€‚
- è‹¥ç­–ç•¥æ²¡æœ‰æŒ‡å®š`podSelector`ï¼ˆè¯¥å­—æ®µç•™ç©ºï¼‰ï¼Œåˆ™è¡¨ç¤ºç­–ç•¥æ‰€åœ¨å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰Podéƒ½å°†åº”ç”¨æ­¤ç­–ç•¥ï¼Œé€šå¸¸ç”¨äº**é»˜è®¤æ‹’ç»å‡ºç«™**è§„åˆ™ã€‚

#### 7.1.2 å…¥ç«™æµé‡

å½“æ²¡æœ‰`Ingress`è§„åˆ™æ—¶ï¼Œå®ƒå°†é»˜è®¤å…è®¸Podçš„æ‰€æœ‰å…¥ç«™æµé‡ã€‚å½“å­˜åœ¨ä¸€æ¡`Ingress`ç­–ç•¥æ—¶ï¼š

- å®ƒå°†æ§åˆ¶ï¼ˆä¸”ä»…ï¼‰ä¸€ç»„é€šè¿‡`podSelector`åŒ¹é…çš„Podçš„å…¥ç«™æµé‡ï¼›
- å®ƒå°†å…è®¸ä¸€ç»„åŒ¹é…çš„Pod**æ¥æ”¶**æŒ‡å®šçš„æ¥æºç½‘ç»œçš„æµé‡ï¼ŒåŒæ—¶é»˜è®¤å…è®¸æµå‘è¿™ä¸ªæ¥æºç½‘ç»œçš„åº”ç­”æµé‡ï¼ˆä¸éœ€è¦Egressè§„åˆ™å…è®¸ï¼‰ï¼›
- è‹¥ç­–ç•¥æ²¡æœ‰æŒ‡å®šå…¥ç«™æ¥æºï¼Œåˆ™è¡¨ç¤ºä¸å…è®¸ä»»ä½•å…¥ç«™æµé‡ï¼›
- æ‰€åŒ¹é…çš„è¿™ç»„Podä¸ä¼šæ”¶åˆ°ä»»ä½•éæœ¬åœ°ã€ä¸”éæŒ‡å®šæ¥æºçš„æµé‡ï¼ˆè¢«ç½‘ç»œæ’ä»¶æ‹’ç»ï¼‰ï¼Œé™¤éæœ‰å…¶ä»–Ingressç­–ç•¥æ”¾è¡Œã€‚
- è‹¥ç­–ç•¥æ²¡æœ‰æŒ‡å®š`podSelector`ï¼Œåˆ™è¡¨ç¤ºç­–ç•¥æ‰€åœ¨å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰Podéƒ½å°†åº”ç”¨æ­¤ç­–ç•¥ï¼Œé€šå¸¸ç”¨äº**é»˜è®¤æ‹’ç»å…¥ç«™**è§„åˆ™ã€‚

æ³¨æ„ï¼Œè¦å…è®¸ä»æº Pod åˆ°ç›®çš„ Pod çš„æŸä¸ªè¿æ¥ï¼Œæº Pod çš„å‡ºå£ç­–ç•¥å’Œç›®çš„ Pod çš„å…¥å£ç­–ç•¥éƒ½éœ€è¦å…è®¸æ­¤è¿æ¥ï¼Œ
é™¤éæµé‡æºæ²¡æœ‰åº”ç”¨ä»»ä½•å‡ºç«™ç­–ç•¥æˆ–æµé‡ç›®çš„åœ°æ²¡æœ‰åº”ç”¨ä»»ä½•å…¥ç«™ç­–ç•¥ã€‚

#### 7.1.3 ç¤ºä¾‹

ç¤ºä¾‹æ¨¡æ¿ï¼š[network-policy.yaml](k8s_actions_guide/version1/other_manifest/network-policy.yaml)

æ¨¡æ¿å°†å®ç°ä»¥ä¸‹ç›®æ ‡ï¼š

- é»˜è®¤æ‹’ç»defaultå‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰Podçš„å…¥ç«™æµé‡ï¼›
- å…è®¸defaultå‘½åç©ºé—´ä¸‹æºå¸¦æ ‡ç­¾`access-db: mysql`çš„Podè®¿é—®MySQLæœåŠ¡ï¼ˆæºå¸¦æ ‡ç­¾`db: mysql`ï¼‰ï¼Œç­–ç•¥åº”ç”¨äºDBä¾§çš„å…¥ç«™æµé‡ï¼›
- æ‹’ç»defaultå‘½åç©ºé—´ä¸‹æºå¸¦æ ‡ç­¾`internal: true`çš„Podçš„å‡ºç«™æµé‡ï¼›
- å…è®¸defaultå‘½åç©ºé—´ä¸‹æºå¸¦æ ‡ç­¾`internal: true`çš„Podè®¿é—®`20.2.0.0/16`ç½‘æ®µä¸”ç›®æ ‡ç«¯å£æ˜¯5978çš„TCPç«¯å£ã€‚

> æ³¨æ„ï¼š
> è¯¥ç¤ºä¾‹æ²¡æœ‰å®Œå…¨å±•ç¤ºå‡º`Ingress`å’Œ`Egress`çš„è§„åˆ™ç»„åˆï¼Œ
> æ›´å®Œæ•´çš„ç¤ºä¾‹è¯·å‚è€ƒå®˜æ–¹çš„
> [NetworkPolicy](https://kubernetes.io/zh-cn/docs/concepts/services-networking/network-policies/#networkpolicy-resource)
> æ–‡æ¡£ã€‚

### 7.2 Podå®‰å…¨

#### 7.2.1 Podå®‰å…¨ç­–ç•¥

è™½ç„¶K8sæ‹¥æœ‰RBACçš„æƒé™æ§åˆ¶æœºåˆ¶ï¼Œä½†RBACä»…èƒ½é™åˆ¶ç”¨æˆ·å¯¹K8s APIå¯¹è±¡ï¼ˆå¦‚Pod/Deployment/Serviceç­‰ï¼‰çš„è®¿é—®ï¼Œ
æ— æ³•é™åˆ¶Podå†…éƒ¨çš„å®‰å…¨æƒé™ï¼ˆä¾‹å¦‚æ‹¥æœ‰ç‰¹æƒ/è®¿é—®å®¿ä¸»æœºæ–‡ä»¶ç³»ç»Ÿ/ç‰¹æƒæå‡/ä½¿ç”¨hostNetwork/è®¾ç½®seLinuxç­‰ï¼‰çš„ä½¿ç”¨ã€‚
ä¸€ä¸ªä¸å®‰å…¨çš„é•œåƒï¼Œæˆ–è€…ä¸€ä¸ªé…ç½®äº†ç‰¹æƒæƒé™çš„å®¹å™¨ï¼Œéƒ½å¯èƒ½å¯¼è‡´é›†ç¾¤çš„å®‰å…¨é—®é¢˜ã€‚

å› æ­¤ï¼Œæ—©åœ¨v1.3ç‰ˆæœ¬ä¸­ï¼ŒK8så°±æä¾›äº† **PodSecurityPolicy**ï¼ˆPSPï¼‰ è¿™é¡¹APIå¯¹è±¡æ¥ä¸ºPodè®¾ç½®å®‰å…¨ç­–ç•¥ã€‚
PSPå¯ä»¥é˜²æ­¢Podæœªç»æˆæƒçš„è·å–èŠ‚ç‚¹rootæƒé™æˆ–è®¿é—®èŠ‚ç‚¹çš„å…¶ä»–æ•æ„Ÿèµ„æºï¼ˆå¦‚ç½‘ç»œ/æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰ï¼Œä»è€Œå½±å“é›†ç¾¤çš„å®‰å…¨ã€‚

**PodSecurityPolicyçš„åºŸå¼ƒ**

- ç”±äºPSPåœ¨ä½¿ç”¨ä¸Šçš„ç¹çä»¥åŠéƒ¨åˆ†é™åˆ¶ï¼Œåœ¨v1.21ç‰ˆæœ¬ä¸­ï¼ŒPSPè¢«æ ‡è®°ä¸º`Deprecated`ï¼Œå¹¶åœ¨v1.25ç‰ˆæœ¬ä¸­æ­£å¼å»é™¤ã€‚
- [å¼ƒç”¨ PodSecurityPolicyï¼šè¿‡å»ã€ç°åœ¨ã€æœªæ¥](https://kubernetes.io/zh-cn/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/)

æ‰€ä»¥ï¼Œæœ¬æ–‡ä¸ä¼šä»‹ç»PSPçš„ä½¿ç”¨ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥æŸ¥é˜…å®˜æ–¹æ–‡æ¡£ã€‚

#### 7.2.2 Podå®‰å…¨å‡†å…¥æ§åˆ¶å™¨

å¼ƒç”¨PSPåï¼ŒK8så®˜æ–¹é‡æ–°æ„æ€å¹¶å®ç°äº†ä¸€å¥—æ–°çš„Podå®‰å…¨æ§åˆ¶æœºåˆ¶å«åšPodå®‰å…¨å‡†å…¥æ§åˆ¶å™¨ï¼ˆPod Security Admission Controllerï¼‰ï¼Œ
è¿™å¥—æœºåˆ¶è‡´åŠ›äºåœ¨ä¿ç•™PSPå¤§éƒ¨åˆ†åŠŸèƒ½çš„åŒæ—¶æå‡äº†ä½¿ç”¨ä¸Šçš„ç®€ä¾¿æ€§ï¼Œæœ€å¤§çš„ç‰¹ç‚¹æ˜¯æ”¯æŒæŸ”æ€§ä¸Šçº¿èƒ½åŠ›ã€‚

Podå®‰å…¨å‡†å…¥æ§åˆ¶å™¨æ˜¯K8s v1.22ç‰ˆæœ¬å¼•å…¥çš„ä¸€é¡¹åŠŸèƒ½ï¼ˆæ­¤ç‰ˆæœ¬éœ€è¦ä¿®æ”¹API-Serverçš„å¯åŠ¨å‚æ•°è¿›è¡Œæ‰‹åŠ¨å¼€å¯ï¼‰ï¼Œåœ¨v1.23ç‰ˆæœ¬ä¸­ä½œä¸ºBetaç‰¹æ€§é»˜è®¤å¼€å¯ã€‚
ä¸è¿‡ï¼Œè¿™é¡¹åŠŸèƒ½å¹¶ä¸åƒPSPé‚£æ ·é€šè¿‡APIå¯¹è±¡æ¥æä¾›èƒ½åŠ›ï¼Œè€Œæ˜¯é€šè¿‡K8såŸæœ‰çš„å‡†å…¥æ§åˆ¶å™¨ï¼ˆAdmission Controllerï¼‰æ¥æä¾›èƒ½åŠ›ã€‚
å…·ä½“æ¥è¯´ï¼Œæ–°çš„åŠŸèƒ½é¦–å…ˆæå‡ºäº†ä¸€ä¸ªPodå®‰å…¨æ€§æ ‡å‡†ä¸ºPodå®šä¹‰äº†ä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œè¿™äº›æ ‡å‡†èƒ½å¤Ÿè®©ä½ ä»¥ä¸€ç§æ¸…æ™°ã€ä¸€è‡´çš„æ–¹å¼å®šä¹‰ Pod
çš„å®‰å…¨è¡Œä¸ºã€‚å…¶æ¬¡ï¼Œæ–°åŠŸèƒ½å¢åŠ äº†ä¸€ä¸ªå«åšPodSecurityçš„å‡†å…¥æ§åˆ¶å™¨ï¼Œå®ƒå°†åœ¨å‘½åç©ºé—´ç»´åº¦æ¥æ‰§è¡Œè¿™ä¸ªPodå®‰å…¨æ ‡å‡†ã€‚

Podå®‰å…¨æ ‡å‡†å®šä¹‰äº†ä¸‰ä¸ªéš”ç¦»çº§åˆ«ï¼š**privileged**ã€**baseline** å’Œ **restricted**ï¼Œä»å·¦åˆ°å³åˆ†åˆ«æ˜¯ç‰¹æƒ/åŸºå‡†/ä¸¥æ ¼ï¼Œé™åˆ¶ç¨‹åº¦ä»ä½åˆ°é«˜ã€‚
æˆ‘ä»¬éœ€è¦å…ˆä¸ºå‘½åç©ºé—´è®¾ç½®ä¸€ä¸ªå®‰å…¨æ ‡å‡†ï¼Œä»¥åŠä¸€ä¸ªæ¨¡å¼è¡¨ç¤ºè¿åæ ‡å‡†æ—¶è¯¥å¦‚ä½•å¤„ç†ï¼Œå¯ä»¥è®¾ç½®å¤šä¸ªæ ‡ç­¾ï¼Œä¸”å®‰å…¨æ ‡å‡†å’Œæ¨¡å¼å¯ä»¥ä»»æ„ç»„åˆã€‚
ä¸€å…±æœ‰ä¸‰ä¸ªæ¨¡å¼å¯ç”¨ï¼šenforce/audit/warnï¼Œå…¶ä¸­enforceæ˜¯å¼ºåˆ¶æ¨¡å¼ï¼ˆæ‹’ç»è¿åå®‰å…¨æ ‡å‡†çš„Podï¼‰ï¼Œauditæ˜¯å®¡è®¡æ¨¡å¼ï¼Œwarnæ˜¯è­¦å‘Šæ¨¡å¼ã€‚

ä¸‹é¢çš„æ¸…å•å®šä¹‰äº†ä¸€ä¸ª`my-baseline-namespace`å‘½åç©ºé—´ï¼Œå£°æ˜äº†å¦‚ä¸‹é™åˆ¶ï¼š

- é˜»æ­¢ä»»ä½•ä¸æ»¡è¶³ baseline ç­–ç•¥è¦æ±‚çš„ Podï¼›
- é’ˆå¯¹ä»»ä½•æ— æ³•æ»¡è¶³ restricted ç­–ç•¥è¦æ±‚çš„ã€å·²åˆ›å»ºçš„ Pod ä¸ºç”¨æˆ·ç”Ÿæˆè­¦å‘Šä¿¡æ¯ï¼Œ å¹¶æ·»åŠ å®¡è®¡æ³¨è§£ï¼›
- å°† baseline å’Œ restricted ç­–ç•¥çš„ç‰ˆæœ¬é”å®šåˆ° v1.29ã€‚

```yaml
# æœ¬æ¨¡æ¿æ¥è‡ªå®˜ç½‘ç¤ºä¾‹
apiVersion: v1
kind: Namespace
metadata:
  name: my-baseline-namespace
  labels:
    # å½¢å¼ï¼špod-security.kubernetes.io/<MODE>: <LEVEL>
    pod-security.kubernetes.io/enforce: baseline
    # å½¢å¼ï¼špod-security.kubernetes.io/<MODE>-version: <VERSION>
    # æ³¨ï¼šè¿™ä¸ªæ ‡ç­¾è¡¨ç¤ºæ­¤æ¨¡å¼æŒ‰ç…§æŒ‡å®šç‰ˆæœ¬çš„è§„åˆ™è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæœªæŒ‡å®šï¼Œåˆ™æŒ‰å½“å‰K8sç‰ˆæœ¬
    #  - ä¾‹å¦‚ï¼Œv1.24 åŠä¹‹å‰ç‰ˆæœ¬çš„ Kubelet ä¸å¼ºåˆ¶æ£€æŸ¥ PodSpecä¸­çš„ OS å­—æ®µï¼Œè‹¥ä½ ä¹Ÿä¸å¸Œæœ›æ£€æŸ¥æ­¤å­—æ®µï¼Œåˆ™éœ€è¦é”å®šåˆ°v1.24 åŠä¹‹å‰çš„ç‰ˆæœ¬
    #  - ï¼ˆä½†å¦‚æœå½“å‰ç‰ˆæœ¬æ¯”é”å®šç‰ˆæœ¬è¿˜ä½ï¼Œåˆ™ä½¿ç”¨å½“å‰ç‰ˆæœ¬ï¼Œå³ä½¿ç”¨äºŒè€…ä¹‹é—´è¾ƒä½çš„ç‰ˆæœ¬å¯¹åº”çš„æ£€æŸ¥è§„åˆ™ï¼‰
    pod-security.kubernetes.io/enforce-version: v1.29
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/audit-version: v1.29
    pod-security.kubernetes.io/warn: restricted
    pod-security.kubernetes.io/warn-version: v1.29
```

åœ¨åº”ç”¨è¿™ä¸ªæ¸…å•åï¼Œå‡†å…¥æ§åˆ¶å™¨ä¼šæ£€æŸ¥å½“å‰å‘½åç©ºé—´ä¸­å­˜åœ¨çš„Podï¼Œä»»ä½•è¿å enforce ç­–ç•¥è¦æ±‚çš„ Pod
éƒ½ä¼šé€šè¿‡è­¦å‘Šçš„å½¢å¼æç¤ºã€‚å¯¹äºå·²å­˜åœ¨çš„å‘½åç©ºé—´ï¼Œå¯ä»¥é€šè¿‡ `kubectl label`
å‘½ä»¤è¿›è¡Œä¿®æ”¹ã€‚

ä¸ºå‘½åç©ºé—´è®¾ç½®å¥½å®‰å…¨æ ‡å‡†æ ‡ç­¾åï¼Œæ¥ä¸‹æ¥å°±æ˜¯**æŒ‰ç…§æ‰€è®¾ç½®çš„å®‰å…¨æ ‡å‡†æ¥å¡«å†™/çº æ­£Podæ¨¡æ¿**ã€‚ä¸åŒçš„å®‰å…¨æ ‡å‡†çº§åˆ«å¯¹PodSpecä¸­å­—æ®µçš„è¦æ±‚ä¸åŒï¼Œ
`privileged`æ˜¯ç‰¹æƒçº§åˆ«æ²¡æœ‰é™åˆ¶ï¼›è€Œ`baseline`å’Œ `restricted`åˆ™å­˜åœ¨è¯¸å¤šé™åˆ¶ã€‚
å…·ä½“è¦æ±‚åœ¨ [Podå®‰å…¨æ€§æ ‡å‡†â€”Profile](https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards/#profile-details)
é¡µé¢ä¸­å¯ä»¥æ‰¾åˆ°ã€‚

ä¾‹å¦‚ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ¸…å•åˆ›å»ºçš„`my-baseline-namespace`å‘½åç©ºé—´ï¼Œåœ¨åˆ›å»ºPodæ—¶ï¼Œéœ€è¦æŒ‰ç…§`baseline`å®‰å…¨æ ‡å‡†æ¥å¡«å†™PodSpecã€‚
éƒ¨ç½²ä¸‹é¢çš„Podæ¸…å•å°†ä¼šè¢«æ‹’ç»ï¼Œå¹¶å¾—åˆ°æç¤ºï¼š`Error from server (Forbidden): error when creating "pod_curl.yaml": pods "curl" is forbidden: violates PodSecurity "baseline:v1.29": host namespaces (hostNetwork=true)
`ã€‚

```shell
# pod_curl.yaml
apiVersion: v1
kind: Pod
metadata:
  name: curl
  namespace: my-baseline-namespace
spec:
  hostNetwork: true
  containers:
    - name: curl-container
      image: appropriate/curl
      command: [ "sh","-c", "sleep 1h" ]
```

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`enforce`æ¨¡å¼**ä»…å¯¹åŸç”ŸPodç”Ÿæ•ˆ**ï¼Œä¸ä¼šå¯¹Podæ§åˆ¶å™¨ï¼ˆå¦‚Deploymentï¼‰ç”Ÿæ•ˆã€‚å…¶ä»–ä¸¤ç§æ¨¡å¼åˆ™æ˜¯å¯¹æ§åˆ¶å™¨å’ŒåŸç”ŸPodéƒ½ç”Ÿæ•ˆã€‚

- [Podå®‰å…¨å‡†å…¥](https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-admission/)
- [Podå®‰å…¨æ€§æ ‡å‡†](https://kubernetes.io/zh-cn/docs/concepts/security/pod-security-standards)
- [ä½¿ç”¨åå­—ç©ºé—´æ ‡ç­¾æ¥å®æ–½ Pod å®‰å…¨æ€§æ ‡å‡†](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/enforce-standards-namespace-labels/)

#### 7.2.3 ç™½åå•

Podå®‰å…¨å‡†å…¥æ§åˆ¶å™¨ä¼šå¯¹å‘½åç©ºé—´ä¸‹çš„æ‰€æœ‰Podæˆ–æ§åˆ¶å™¨çš„ PodSpec è¿›è¡Œå®‰å…¨è§„åˆ™æ ¡éªŒï¼Œ
å¦‚æœ PodSpec ä¸­å­˜åœ¨ä¸å®‰å…¨çš„å­—æ®µè®¾ç½®ï¼Œåˆ™æ‹’ç»åˆ›å»ºPodæˆ–ç»™å‡ºæç¤ºã€‚ä½†å‡¡äº‹æ€»æœ‰ä¾‹å¤–ï¼ŒKuberneteså°±å…è®¸åœ¨å‡†å…¥æ§åˆ¶å™¨ä¸­é™æ€é…ç½®è¿™äº›ä¾‹å¤–ï¼Œ
è¿™é‡Œæˆ‘ä»¬ç§°ä½œç™½åå•ï¼Œå®˜æ–¹ç§°ä½œè±å…ï¼ˆExemptionsï¼‰ã€‚

ç™½åå•å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼é…ç½®ï¼š

- Usernameï¼šå…å»å¯¹æŒ‡å®šç”¨æˆ·åˆ›å»ºçš„åŸç”ŸPodçš„å®‰å…¨æ£€æŸ¥ï¼Œæ§åˆ¶å™¨é™¤å¤–ã€‚
- RuntimeClassNameï¼šå…å»å¯¹åŒ…å«æŒ‡å®šè¿è¡Œæ—¶ç±»çš„Podæˆ–æ§åˆ¶å™¨çš„å®‰å…¨æ£€æŸ¥ã€‚
- Namespaceï¼šå…å»å¯¹æŒ‡å®šå‘½åç©ºé—´ä¸‹æ‰€æœ‰Podæˆ–æ§åˆ¶å™¨çš„å®‰å…¨æ£€æŸ¥ã€‚

å…·ä½“é…ç½®æ–¹å¼å¹¶ä¸å¤æ‚ï¼Œè¯·å‚é˜…[å®˜ç½‘æ–‡æ¡£](https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/enforce-standards-admission-controller/#configure-the-admission-controller)ã€‚

## 8. æœåŠ¡ç½‘æ ¼

æœ¬èŠ‚æ˜¯ä¸€ä¸ªç¬”è€…æ–°å¢çš„ä¸€ä¸ªå¤§ç« èŠ‚ï¼Œä¸¥æ ¼æ¥è¯´æœ¬èŠ‚ä¸»é¢˜ä¸K8så¹¶ä¸ç»‘å®šï¼Œä½†ç¬”è€…è®¤ä¸ºæœåŠ¡ç½‘æ ¼æ˜¯åœ¨K8sä¸­è¿è¡Œå¾®æœåŠ¡æ¶æ„çš„ä¸€ä¸ªæµè¡Œçš„å‘å±•æ–¹å‘ï¼ˆå…¶å®åœ¨å¤§å‚æˆ–å›½å†…æ—©å·²æ™®éåº”ç”¨ï¼‰ã€‚
å¯èƒ½ç”±äºæ—©æœŸçš„æ–‡æ¡£æˆ–æ•™ç¨‹ç¼ºå¤±ï¼Œå¯¼è‡´å›½å†…å¼€å‘è€…å¯¹æœåŠ¡ç½‘æ ¼çš„è®¤çŸ¥å’Œå®è·µæ­¥éª¤å¹¶ä¸æ¸…æ™°ï¼Œå› æ­¤åœ¨æœ¬èŠ‚ä¸­ï¼Œç¬”è€…å°†ç»“åˆ
ä¸€äº›æƒå¨ä¹¦ç±ã€å®˜æ–¹æŒ‡å¯¼ä»¥åŠç¬”è€…åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­çš„å®è·µç»éªŒï¼Œå¯¹æœåŠ¡ç½‘æ ¼è¿›è¡Œä¸€ä¸ªç³»ç»Ÿçš„ç†è®ºå’Œå®è·µä»‹ç»ã€‚
æ­¤å¤–ï¼Œæœ¬ç« èŠ‚ä¹Ÿå°†ä½œä¸ºä¸€ä¸ªç‰¹åˆ«ç¯‡åœ¨é¡¹ç›®ä¸»é¡µä¸­è¿›è¡Œå±•ç¤ºã€‚

> æ­¤ç« èŠ‚ä¸­çš„æ¼”ç¤ºå°†ç»§ç»­å¤ç”¨ç¬¬ä¸€èŠ‚ä¸­çš„demoé¡¹ç›®ã€‚

### 8.1 å‡ºç°æ—¶é—´ä¸èƒŒæ™¯

æ—©åœ¨åå¤šå¹´å‰ï¼Œå›½å¤–å°±å¼€å§‹æµè¡Œèµ·äº†ä»å•ä½“æœåŠ¡è½¬å‘å¾®æœåŠ¡æ¶æ„çš„æ½®æµï¼Œå¹¶åœ¨2014å¹´ä¼ å…¥å›½å†…ã€‚
å¾®æœåŠ¡æ¶æ„çš„ä¼˜ç‚¹ä¹Ÿæ˜¯æœ‰ç›®å…±ç¹çš„ï¼Œä¾‹å¦‚æ¾è€¦åˆã€å¿«é€Ÿè¿­ä»£ã€é«˜å¯æ‰©å±•æ€§ã€æ”¯æŒè¯­è¨€å¼‚æ„ç­‰ã€‚ä¹Ÿæ­£æ˜¯å¾®æœåŠ¡æ¶æ„å¸¦ç«äº†äº‘åŸç”Ÿæ¦‚å¿µï¼Œ
å› ä¸ºå¾®æœåŠ¡çš„è¯¸å¤šä¼˜ç‚¹éƒ½èƒ½å¤Ÿåœ¨äº‘åŸç”Ÿç¯å¢ƒä¸‹å¾—åˆ°å®Œç¾ä½“ç°ã€‚

ç„¶è€Œï¼Œæƒ³è¦åœ¨ä¼ä¸šä¸­éƒ¨ç½²å¾®æœåŠ¡æ¶æ„ä¹Ÿä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚ç”±äºå¾®æœåŠ¡æ¶æ„çš„å¤šæœåŠ¡ä»¥åŠå•æœåŠ¡å¤šå‰¯æœ¬ç­‰ç‰¹æ€§ï¼Œ
ä¿è¯æœåŠ¡é—´çš„æ­£å¸¸ã€é«˜æ•ˆä¸”å®‰å…¨çš„é€šä¿¡æ˜¯ä¸€ä¸ªéœ€è¦å¯†åˆ‡å…³æ³¨çš„é—®é¢˜ã€‚ä¼ ç»Ÿå¾®æœåŠ¡æ¶æ„ä¸­ï¼Œ
æˆ‘ä»¬éœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡é…ç½®æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æœåŠ¡è·¯ç”±ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡å®¹é”™ç­‰åŸºç¡€è®¾æ–½ã€‚å½“ç„¶ï¼Œ
æˆ‘ä»¬å¯ä»¥ä¸ºç›¸åŒè¯­è¨€å®ç°çš„å¾®æœåŠ¡é…ç½®ç›¸åŒçš„ä¸€ç³»åˆ—åŸºç¡€è®¾æ–½ï¼Œä½†ä¸€æ—¦å‡ºç°å…¶ä»–è¯­è¨€æ„å»ºçš„æœåŠ¡ï¼Œ
åˆ™åˆè¦å•ç‹¬å»æ·»åŠ è¿™äº›åŸºç¡€è®¾æ–½ï¼Œè¿™å°±é€ æˆäº†é‡å¤å·¥ä½œï¼Œè¿˜å¸¦æ¥äº†å¤§é‡çš„æ’é”™åŠç»´æŠ¤æˆæœ¬ã€‚

ä¸Šé¢æåˆ°çš„ä¸€ç³»åˆ—åŸºç¡€è®¾æ–½ï¼Œå®ƒä»¬å¯èƒ½æ˜¯ç”±ä¸åŒçš„ç¬¬ä¸‰æ–¹åŒ…æä¾›ï¼ˆä¹Ÿå«åšåŸºäºSDKçš„æ¶æ„æ¨¡å¼ï¼‰ï¼Œ
è¿™ç§ç‹¬ç«‹åˆ†æ•£çš„æ–¹å¼ä¹Ÿå¸¦æ¥äº†æœåŠ¡ç»„ä»¶çš„ç‰ˆæœ¬ç®¡ç†ã€ä¾èµ–ç®¡ç†ã€æœåŠ¡éƒ¨ç½²ã€æœåŠ¡ç›‘æ§ç­‰é—®é¢˜çš„å›°æ‰°ã€‚
å¹¶ä¸”ä½¿ç”¨å®ƒä»¬çš„é€»è¾‘ä¸€å®šç¨‹åº¦ä¸Šè€¦åˆåœ¨ä¸šåŠ¡ä»£ç ä¸­ï¼Œè¿™ä¹Ÿä½¿å¾—æ•´ä¸ªä»£ç åº“å˜å¾—è‡ƒè‚¿ä¸”å¢åŠ äº†å¤æ‚åº¦ã€‚

**æœåŠ¡ç½‘æ ¼çš„è¯ç”Ÿ**

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼ŒæœåŠ¡ç½‘æ ¼åº”è¿è€Œç”Ÿã€‚æœåŠ¡ç½‘æ ¼æ˜¯ä¸€ä¸ªåŸºç¡€è®¾æ–½å±‚ï¼Œå®ƒä½äºåº”ç”¨ç¨‹åºå’ŒåŸºç¡€æ¶æ„ä¹‹é—´ï¼Œ
ä¸ºåº”ç”¨ç¨‹åºæä¾›æœåŠ¡é—´é€šä¿¡åŠŸèƒ½ã€‚æœåŠ¡ç½‘æ ¼ç”±ä¸€ç³»åˆ—è½»é‡çº§ç½‘ç»œä»£ç†ç»„æˆï¼Œè¿™äº›ä»£ç†éƒ¨ç½²äºæ¯ä¸ªåº”ç”¨å®ä¾‹æ—ï¼ˆä»¥sidecaræ¨¡å¼ï¼‰ï¼Œ
å¹¶è´Ÿè´£å¤„ç†æœåŠ¡é—´çš„é€šä¿¡ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€æœåŠ¡è·¯ç”±ã€æœåŠ¡ç›‘æ§ã€æœåŠ¡å®¹é”™ç­‰ã€‚ä»æ­¤ï¼Œ
ä¸šåŠ¡ä»£ç åº“ä¸­ä¸å†éœ€è¦åŒ…å«æ¶‰åŠå¤„ç†æœåŠ¡é—´ç½‘ç»œé€šä¿¡çš„é€»è¾‘ï¼Œå›¢é˜Ÿæˆå‘˜çš„ç¼–ç¨‹å·¥ä½œåˆå›å½’åˆ°å•ä½“æœåŠ¡æ¶æ„çš„å¼€å‘æ¨¡å¼ä¸­ï¼Œ
å³åªéœ€è¦ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘çš„å¼€å‘ã€‚

ä¸–ç•Œä¸Šé¦–ä¸ªService Meshäº§å“æ˜¯å›½å¤–çš„Buoyantå…¬å¸åœ¨2017å¹´4æœˆå‘å¸ƒçš„Linkerdã€‚
åŒæ—¶ï¼ŒService Meshæ¦‚å¿µä¹Ÿæ˜¯ç”±è¿™å®¶å…¬å¸çš„CEO William
Morganæå‡ºï¼Œä»–åŒå¹´å‘è¡¨çš„æ–‡ç«  [Whatâ€™s a service meshï¼ŸAnd why do I need one?][Whatâ€™s a service meshï¼ŸAnd why do I need one?]
æ˜¯å¯¹Service Meshæ¦‚å¿µå…¬è®¤æœ€æƒå¨çš„å®šä¹‰ã€‚

ä¹‹æ‰€ä»¥ç§°ä¸ºæœåŠ¡ç½‘æ ¼ï¼Œæ˜¯å› ä¸ºæœ‰äº†ä»£ç†ä¹‹åï¼Œæ‰€æœ‰æœåŠ¡é—´çš„é€šä¿¡éƒ½å˜æˆä»£ç†é—´çš„é€šä¿¡ï¼Œè€Œè¿™äº›ä»£ç†é—´çš„é€šä¿¡åˆå½¢æˆä¸€ä¸ªå·¨å¤§çš„ç½‘æ ¼ï¼Œ
å¹¶ä¸”æ•´å¼ ç½‘æ ¼éƒ½ç”±ä¸€ä¸ªç»Ÿä¸€çš„æ§åˆ¶å¹³é¢æ¥è¿›è¡Œç®¡ç†ã€‚è¿™å¯ä»¥é€šè¿‡ä¸‹é¢çš„å›¾åŠ æ·±ç†è§£

<div align="center">
<img src="img/service-mesh.jpg" width = "450" height = "400" alt=""/>
</div>

### 8.2 å®šä¹‰

"Service Mesh æ˜¯ä¸€ä¸ªå¤„ç†æœåŠ¡é€šè®¯çš„ä¸“é—¨çš„åŸºç¡€è®¾æ–½å±‚ã€‚å®ƒçš„èŒè´£æ˜¯åœ¨ç”±äº‘åŸç”Ÿåº”ç”¨ç»„æˆæœåŠ¡çš„å¤æ‚æ‹“æ‰‘ç»“æ„ä¸‹è¿›è¡Œå¯é çš„è¯·æ±‚ä¼ é€ã€‚
åœ¨å®è·µä¸­ï¼Œå®ƒæ˜¯ä¸€ç»„å’Œåº”ç”¨æœåŠ¡éƒ¨ç½²åœ¨ä¸€èµ·çš„è½»é‡çº§çš„ç½‘ç»œä»£ç†ï¼Œå¯¹åº”ç”¨æœåŠ¡é€æ˜ã€‚" â€”â€” William Morgan

å…·ä½“æ¥è¯´ï¼ŒService Meshä½¿ç”¨çš„ç½‘ç»œä»£ç†æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå®¹å™¨ï¼Œå®ƒä»¥sidecaræ¨¡å¼éƒ¨ç½²åœ¨æ¯ä¸ªå¾®æœåŠ¡ä¾§ï¼ˆå¯¹åº”ç”¨å®ä¾‹å®Œå…¨é€æ˜ï¼‰ï¼Œ
å¹¶ä¸”å®ƒä¼šæ¥ç®¡åŒä¾§çš„åº”ç”¨å®ä¾‹å‘å‡ºå’Œæ¥æ”¶çš„æµé‡ï¼Œæ ¹æ®é…ç½®è§„åˆ™ï¼Œ
å®ƒå¯ä»¥å¯¹æµé‡è¿›è¡Œé‡å®šå‘ã€è·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€ç›‘æ§ã€ç†”æ–­ç­‰åŸæ¥éœ€è¦ç”±å¤šä¸ªå·¥å…·å®Œæˆçš„æ“ä½œã€‚
Service Meshå°†æœåŠ¡é€šä¿¡åŠç›¸å…³ç®¡æ§åŠŸèƒ½ä»ä¸šåŠ¡ç¨‹åºä¸­åˆ†ç¦»å¹¶ä¸‹å±‚åˆ°åŸºç¡€è®¾æ–½å±‚ï¼Œä½¿å…¶å’Œä¸šåŠ¡ç³»ç»Ÿå®Œå…¨è§£è€¦ã€‚

### 8.3 æ§åˆ¶å¹³é¢

æœ€åˆçš„Service Meshäº§å“å½¢æ€ä¸­ï¼Œå¹¶ä¸å­˜åœ¨ç»Ÿä¸€çš„æ§åˆ¶å¹³é¢ï¼Œæ¯ä¸ªä»£ç†çš„é…ç½®è§„åˆ™çš„å˜æ›´éƒ½éœ€è¦å•ç‹¬æ‰‹åŠ¨æ“ä½œï¼Œè¿™å°±æ˜¾å¾—ååˆ†éº»çƒ¦ã€‚
ä½†å¾ˆå¿«ï¼ˆä¹Ÿæ˜¯2017å¹´ï¼‰ï¼Œä»¥Istioä¸ºä»£è¡¨çš„ç¬¬äºŒä»£Service Meshäº§å“å½¢æ€å‡ºç°äº†ï¼Œå®ƒä»¬éƒ½å…·å¤‡ä¸€ä¸ªç»Ÿä¸€æ§åˆ¶å¹³é¢ï¼Œä»£ç†åˆ™ç§°ä¸ºæ•°æ®å¹³é¢ã€‚
é€šè¿‡æ§åˆ¶å¹³é¢ï¼Œæˆ‘ä»¬å¯ä»¥é›†ä¸­ç®¡ç†æ‰€æœ‰ä»£ç†çš„é…ç½®è§„åˆ™ï¼ˆè¿˜åŒ…æ‹¬ä»£ç†çš„æ•°æ®é‡‡é›†ç­‰åŠŸèƒ½ï¼‰ï¼Œ
è€Œæ•°æ®å¹³é¢çš„æ¯ä¸ªä»£ç†è¿˜è´Ÿè´£é‡‡é›†å’Œä¸ŠæŠ¥ç½‘æ ¼æµé‡çš„è§‚æµ‹æ•°æ®ã€‚

### 8.4 Istio

è™½ç„¶åˆ°ç›®å‰ä¸ºæ­¢ï¼Œåœ¨CNCFæ——ä¸‹æ‰˜ç®¡çš„Service Meshç”Ÿæ€åœˆå·²ç»å‘ˆç°ç¹è£å§¿æ€ï¼Œä¾‹å¦‚Linkerdã€Istioã€Consul Connectã€Kumaã€Gloo Meshç­‰ã€‚
ä½†ç”±äºåºå¤§çš„è´¡çŒ®è€…æ•°é‡å’Œç¤¾åŒºæ”¯æŒï¼Œæœ€ç»ˆ**Istioæˆä¸ºæœåŠ¡ç½‘æ ¼é¢†åŸŸçš„é¢†å…ˆè€…**ã€‚èƒ½å¤Ÿä¸ä¹‹æ¯”è¾ƒçš„æ˜¯å•†ä¸šäº§å“Linkerdï¼Œå®ƒçš„ä¼˜åŠ¿æ˜¯æ›´è½»é‡ï¼Œ
é€‚åˆéƒ¨ç½²åœ¨ä¸­å°è§„æ¨¡äº‘ç¯å¢ƒä¸­ï¼Œä½†ç¼ºå°‘éƒ¨åˆ†Istioæ‰æœ‰çš„é«˜çº§åŠŸèƒ½ã€‚å…³äºIstioä¸Linkerdçš„è¯¦ç»†å¯¹æ¯”ï¼Œè¯·æŸ¥çœ‹
[Istio vs Linkerd: The Best Service Mesh for 2023][Istio vs Linkerd]ã€‚

Istioæœ€åˆç”±Googleã€IBMå’ŒLyftç­‰å…¬å¸å…±åŒå¼€å‘ã€‚åœ¨2018å¹´å‘å¸ƒäº†å…¶1.0ç‰ˆæœ¬ã€‚éšåï¼ŒIstioåœ¨2022å¹´4æœˆå®£å¸ƒæèµ ç»™CNCFï¼ˆæ­£å¼å­µåŒ–æ—¶é—´æ˜¯åŒå¹´9æœˆåº•ï¼‰ï¼Œ
æœ€ç»ˆIstioåœ¨2023å¹´7æœˆæ­£å¼æ¯•ä¸šï¼ˆä¸åˆ°ä¸€å¹´ï¼‰ï¼Œä¸”å¦‚ä»Šå·²ç»æœ‰ **æ•°ç™¾å®¶** å…¬å¸ä¸ºå…¶è´¡çŒ®ä»£ç ã€‚
æˆªè‡³å½“å‰ï¼ˆ2024å¹´3æœˆ5æ—¥ï¼‰ï¼Œå®ƒå·²è¿­ä»£è‡³v1.20ï¼Œå¯è§å…¶å‘å±•ä¹‹è¿…é€Ÿã€‚

**Istioçš„å£å·**

â€œSimplify observability, traffic management, security, and policy with the leading service mesh.â€

ä½¿ç”¨é¢†å…ˆçš„æœåŠ¡ç½‘æ ¼æŠ€æœ¯æ¥ç®€åŒ–å¯è§‚æµ‹æ€§ï¼ˆWebUIã€4/7å±‚æµé‡æŒ‡æ ‡ã€å»¶è¿Ÿã€é“¾è·¯è·Ÿè¸ªã€å¥åº·æ£€æŸ¥ã€æ—¥å¿—ã€ç½‘ç»œæ‹“æ‰‘ï¼‰ã€
æµé‡ç®¡ç†ï¼ˆè´Ÿè½½å‡è¡¡ã€å¤šé›†ç¾¤æµé‡è·¯ç”±ã€æœåŠ¡å‘ç°ã€ç†”æ–­/é‡è¯•/è¶…æ—¶/é™é€Ÿã€åŠ¨æ€é…ç½®ã€HTTP 1.1/2/3æ”¯æŒã€TCP/UDP/gRPCæ”¯æŒã€å»¶è¿Ÿæ³¨å…¥ç­‰ï¼‰ã€
å®‰å…¨ï¼ˆè®¤è¯ã€mTLSç­‰ï¼‰å’Œç­–ç•¥ã€‚

> Istioç›®å‰åœ¨ä¸­å›½äº’è”ç½‘å…¬å¸ä¸­å¹¶æ²¡æœ‰å¤§é‡æ™®åŠï¼Œè¿™ä¸»è¦æ˜¯ç”±äºå…¶ä¸Šæ‰‹æˆæœ¬è¾ƒé«˜ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”ç”¨Istioéœ€è¦å›¢é˜Ÿä¸­è‡³å°‘æœ‰ä¸€ä½Istio
> ä¸“å®¶æˆ–æœ‰ä¸°å¯Œå®è·µç»éªŒä¹‹äººï¼Œè€Œä¸”æœ€å¥½å¯¹Istioçš„åŸç†æœ‰æ·±å…¥çš„ç†è§£ï¼Œè¿™æ ·
> æ‰èƒ½åœ¨å‡ºç°é—®é¢˜æ—¶ä¸ä¼šæ‰‹å¿™è„šä¹±ã€‚æ­¤å¤–ï¼Œæ ¹æ®ä¸ªäººç»éªŒï¼Œ
> å¦‚æœä½ ç¯å¢ƒä¸­çš„å¾®æœåŠ¡æ•°é‡ä½äº10ä¸ªï¼Œä¸å»ºè®®ä½¿ç”¨Istioï¼Œå› ä¸ºå®ƒçš„ä¸Šæ‰‹å’Œç»´æŠ¤æˆæœ¬å¯èƒ½ä¼šè¶…è¿‡å…¶å¸¦æ¥çš„æ”¶ç›Šã€‚

#### 8.4.1 åŸºæœ¬æ¶æ„

éƒ¨ç½²åçš„Istioæ¶æ„åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š

- **æ•°æ®å¹³é¢**ï¼šåˆå«æ•°æ®å±‚ï¼Œç”±Nä¸ªä»£ç†æœåŠ¡ï¼ˆæ¯ä¸ªä»£ç†éƒ½æ˜¯ä¸€ä¸ªå«`istio-proxy`çš„sidecarå®¹å™¨ï¼Œå®ƒåŸºäºEnvoyï¼‰ç»„æˆï¼Œ
  è´Ÿè´£ç½‘æ ¼ä¸­çš„æœåŠ¡é€šä¿¡å’Œæµé‡ç®¡æ§ï¼ŒåŒæ—¶ä¼šæ”¶é›†å’Œä¸ŠæŠ¥ç½‘æ ¼æµé‡ç›¸å…³çš„è§‚æµ‹æ•°æ®ã€‚
    - æ—©æœŸé€šè¿‡äººå·¥çš„æ–¹å¼å°†Envoyå®¹å™¨ç¡¬ç¼–ç åˆ°æ¯ä¸ªå·¥ä½œè´Ÿè½½æ¨¡æ¿ä¸­ï¼ŒåæœŸå‘å±•è‡³å¯ä»¥é€šè¿‡Istioçš„sidecaræ³¨å…¥åŠŸèƒ½åœ¨éƒ¨ç½²å·¥ä½œè´Ÿè½½æ—¶è‡ªåŠ¨å‘æ¨¡æ¿æ³¨å…¥Istioå®¹å™¨ï¼ˆé€šè¿‡K8sæä¾›çš„Webhookæœºåˆ¶ï¼‰ï¼Œ
      å¤§å¤§æé«˜ä½¿ç”¨æ•ˆç‡ï¼Œé¿å…äº†å¯¹ä¸šåŠ¡è´Ÿè½½æ¨¡æ¿çš„å…¥ä¾µã€‚
    - ä»£ç†æœåŠ¡ä¼šåŠ«æŒåº”ç”¨å®¹å™¨å‘å‡ºå’Œæ¥æ”¶çš„æµé‡ï¼Œç„¶åæŒ‰é…ç½®è¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œæœ€åå†å†³å®šæ˜¯ä¸¢å¼ƒè¿˜æ˜¯å°†æµé‡è½¬å‘å‡ºå»ã€‚
    - å‘åº”ç”¨Podæ³¨å…¥sidecarå®¹å™¨æ—¶ï¼ŒåŒæ—¶è¿˜ä¼šæ³¨å…¥ä¸€ä¸ª`istio-init`**åˆå§‹åŒ–**å®¹å™¨ï¼Œè´Ÿè´£è®¾ç½®Podçš„iptablesè§„åˆ™ï¼Œä»¥ä¾¿å…¥ç«™/å‡ºç«™æµé‡é€šè¿‡
      sidecar ä»£ç†è½¬å‘ã€‚
    - Istioä¼šè·Ÿè¸ªK8sé›†ç¾¤ä¸­çš„Serviceså’ŒEndpointsçš„å˜åŒ–ï¼Œè¿›è€Œä¸‹å‘åˆ°æ¯ä¸ªEnvoyä»£ç†ä¸­ï¼Œè®©å…¶å¯ä»¥çŸ¥æ™“è½¬å‘çš„å®é™…ç›®çš„åœ°å€ã€‚
- **æ§åˆ¶å¹³é¢**ï¼šåˆå«æ§åˆ¶å±‚ï¼Œç”±ä¸€ä¸ªå«åš`istiod`çš„æœåŠ¡ç»„æˆï¼Œè´Ÿè´£æ•´ä¸ªæ•°æ®å¹³é¢çš„é…ç½®è§„åˆ™ï¼ˆè¿è¡Œæ—¶ï¼‰ä¸‹å‘å’Œè§‚æµ‹æ•°æ®çš„ç®¡ç†ã€‚åŒæ—¶æ”¯æŒèº«ä»½æ ‡è¯†å’Œè¯ä¹¦ç®¡ç†ã€‚
    - istiodå†…éƒ¨æœ‰ä¸‰å¤§ç»„ä»¶ï¼šPilotã€Citadelã€Galley
        - Pilotè´Ÿè´£æ”¶é›†å’Œåˆ†å‘ç½‘æ ¼ä¸­çš„æœåŠ¡é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€è·¯ç”±è§„åˆ™ã€è®¿é—®æ§åˆ¶ç­‰ã€‚
        - Citadelè´Ÿè´£ä¸ºç½‘æ ¼ä¸­çš„æœåŠ¡æä¾›èº«ä»½æ ‡è¯†å’Œè¯ä¹¦ç®¡ç†ï¼ŒåŒ…æ‹¬æœåŠ¡è¯ä¹¦çš„ç­¾å‘ã€è¿‡æœŸæé†’ã€å¯†é’¥è½®æ¢ç­‰ã€‚
        - Galleyè´Ÿè´£å¯¹ç”¨æˆ·æä¾›çš„é…ç½®è¿›è¡Œæ ¼å¼ä»¥åŠå†…å®¹éªŒè¯ã€è½¬æ¢å’Œä¸‹å‘ï¼Œå®ƒç›´æ¥ä¸æ§åˆ¶é¢å†…çš„å…¶ä»–ç»„ä»¶é€šä¿¡ï¼Œä¸»è¦è´Ÿè´£å°†æ§åˆ¶é¢çš„å…¶ä»–ç»„ä»¶ä¸åº•å±‚å¹³å°ï¼ˆå¦‚K8sï¼‰è§£è€¦ã€‚

Istioæ¶æ„å›¾å¦‚ä¸‹ï¼š

<div align="center">
<img src="img/istio-architecture.png" width = "800" height = 600" alt=""/>
</div>


**ç‹¬ç«‹çš„Envoy**  
éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒEnvoyç»„ä»¶æ˜¯å¯ä»¥å•ç‹¬è¿è¡Œçš„ï¼Œå°±åƒä¸€ä¸ªNginxè¿›ç¨‹ä¸€æ ·ï¼Œåªè¦ä½ ä¸ºå®ƒæ·»åŠ åˆç†çš„é…ç½®ã€‚

**éƒ¨ç½²æ¨¡å‹**

Istioæ”¯æŒçš„éƒ¨ç½²æ¨¡å‹æ¯”è¾ƒç¹æ‚ï¼Œå®ƒå¯ä»¥æ ¹æ®å¤šä¸ªç»´åº¦è¿›è¡Œåˆ†ç±»ï¼ŒåŒ…å«é›†ç¾¤æ¨¡å‹/ç½‘ç»œæ¨¡å‹/æ§åˆ¶å¹³é¢æ¨¡å‹/ç½‘æ ¼æ¨¡å‹/ç§Ÿæˆ·æ¨¡å‹ã€‚
ä»»ä½•ä¸€ä¸ªåŒ…å«Istioçš„ç”Ÿäº§ç¯å¢ƒéƒ½æ¶‰åŠè¿™å‡ ä¸ªç»´åº¦ã€‚å½“ç„¶æœ€ç®€å•çš„éƒ¨ç½²æ¨¡å‹å°±å°±æ˜¯å•ä¸€é›†ç¾¤+å•ä¸€ç½‘ç»œ+å•ä¸€æ§åˆ¶å¹³é¢+å•ä¸€ç½‘æ ¼+å•ä¸€ç§Ÿæˆ·ã€‚
å½“éƒ¨ç½²Istioæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®æœåŠ¡è§„æ¨¡å’Œå›¢é˜Ÿæ•°é‡æ¥è§„åˆ’å…·ä½“çš„éƒ¨ç½²æ¨¡å‹ã€‚

> è¯·å‚è€ƒ [éƒ¨ç½²æ¨¡å‹](https://istio.io/latest/zh/docs/ops/deployment/deployment-models/) æ¥è¯¦ç»†äº†è§£Istioçš„éƒ¨ç½²æ¨¡å‹ã€‚


**æ›´å¤šç»†èŠ‚**

- [Envoyä»‹ç»](https://www.thebyte.com.cn/MicroService/Envoy.html)
- [Istioä»‹ç»](https://www.thebyte.com.cn/MicroService/Istio.html)
- [sidecarè‡ªåŠ¨æ³¨å…¥åŸç†](https://istio.io/latest/zh/blog/2019/data-plane-setup/#automatic-injection)
- [sidecaræµé‡æ•è·åŸç†](https://istio.io/latest/zh/blog/2019/data-plane-setup/#traffic-flow-from-application-container-to-sidecar-proxy)

#### 8.4.2 Ambient Mesh

**sidecaræ¨¡å¼çš„å¼Šç—…**

ä¸ç®¡æ˜¯ç¬¬ä¸€ä»£è¿˜æ˜¯ç¬¬äºŒä»£Service MeshæŠ€æœ¯ï¼Œéƒ½å­˜åœ¨ç€ä¸€ä¸ªä»¤äººè¯Ÿç—…ä½†ä¸æ˜“è§£å†³çš„éš¾é¢˜ï¼Œ
é‚£å°±æ˜¯sidecaræ¨¡å¼å¸¦æ¥çš„èµ„æºæ¶ˆè€—å’Œé€šä¿¡æ—¶å»¶é—®é¢˜ã€‚æ ¹æ®ç»Ÿè®¡ï¼Œå¤§éƒ¨åˆ†ä¼ä¸šåœ¨ä½¿ç”¨Istioçš„æ•°æ®å¹³é¢å³Envoyæ—¶çš„å¹³å‡å†…å­˜å¼€é”€éƒ½åœ¨60M~
100Må·¦å³ï¼Œ
å¦‚æœæ˜¯ç¨å¾®å¤§ä¸€ç‚¹çš„è§„æ¨¡æ¯”å¦‚100ä¸ªæœåŠ¡ï¼Œé‚£ä¹ˆsidecarè¿™éƒ¨åˆ†å¼€é”€å°±å¯èƒ½æ¥è¿‘10ä¸ªGï¼Œå¹¶ä¸”ç”±äºæ¯ä¸ªä»£ç†éƒ½ä¼šæ¥æ”¶æ‰€æœ‰çš„æœåŠ¡å‘ç°æ•°æ®ï¼ˆå³ä½¿ä¸éœ€è¦ï¼‰ï¼Œ
è¿™ä¼šå¯¼è‡´ä»£ç†çš„å†…å­˜å¼€é”€ä¼šéšç€æœåŠ¡è§„æ¨¡çš„å¢é•¿è€Œå‘ˆæŒ‡æ•°çº§å¢é•¿ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰sidecarå¸¦æ¥çš„ç½‘ç»œå¤šè·³å’Œè·¯ç”±è®¡ç®—æ‰€å¢åŠ çš„ç½‘ç»œå»¶è¿Ÿé—®é¢˜ï¼Œ
å¹³å‡å»¶è¿Ÿå¤§è‡´ä¸º3ms~5mså·¦å³ï¼Œè¿™å¯¹äºå»¶è¿Ÿæ•æ„Ÿçš„ä¸šåŠ¡ä¸­å¯èƒ½ä¸ä¼šé€‚ç”¨ã€‚

**Istioçš„æ–°æ•°æ®å¹³é¢æ¨¡å¼ï¼šNo sidecarçš„Ambient Mesh**

2022å¹´9æœˆï¼ŒIstioå®˜å®£äº†ä¸€ç§æ–°çš„æ•°æ®å¹³é¢æ¨¡å¼â€”â€”Ambient Meshã€‚å®ƒèƒ½å¤Ÿåœ¨ç®€åŒ–æ“ä½œã€ä¿æŒæ›´å¹¿æ³›çš„åº”ç”¨ç¨‹åºå…¼å®¹æ€§å’Œé™ä½åŸºç¡€è®¾æ–½æˆæœ¬çš„åŒæ—¶ï¼Œ
ä¿æŒIstioçš„é›¶ä¿¡ä»»å®‰å…¨ã€é¥æµ‹å’Œæµé‡ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚æœ€é‡è¦çš„æ˜¯ï¼Œå®ƒæ‘’å¼ƒäº†ä¼ ç»Ÿçš„sidecaréƒ¨ç½²æ¨¡å¼ï¼Œ
è½¬è€Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªé›¶ä¿¡ä»»çš„**ztunnel**ä»£ç†ç”¨æ¥ä¸ºèŠ‚ç‚¹ä¸Šæ‰€æœ‰Podæä¾›mTLSã€é¥æµ‹ã€èº«ä»½éªŒè¯å’ŒL4æˆæƒï¼Œå®ƒå¹¶ä¸ä¼šè§£æHTTPæµé‡ï¼ˆL7ï¼‰ã€‚

è¿™ç§æ–°çš„å¹³é¢æ¨¡å¼å°†Istioçš„åŠŸèƒ½åˆ’åˆ†ä¸ºä¸¤å±‚ï¼š

- åŸºç¡€å±‚ï¼šä½œä¸ºä¸€ä¸ªå¿…éœ€çš„å®‰å…¨è¦†ç›–å±‚ï¼Œå¤„ç†æ‰€æœ‰åº”ç”¨å®ä¾‹çš„è·¯ç”±å’Œé›¶ä¿¡ä»»å®‰å…¨çš„æµé‡ã€‚è¿™ä¸€å±‚äº§ç”Ÿçš„æ€§èƒ½å¼€é”€è¾ƒä½ï¼›
    - å…·ä½“æ¥è¯´ï¼ŒIstioä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ¨ç½²ä¸€ä¸ªä»£ç†ï¼ˆå«åšztunnelï¼‰ï¼Œç”¨æ¥å¤„ç†è¯¥èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰L4æµé‡ï¼ˆå¦‚TCPã€UDPç­‰ï¼‰ï¼›
- åº”ç”¨å±‚ï¼šä½¿ç”¨ä¸€ä¸ªä¸ƒå±‚ä»£ç†æ¥è´Ÿè´£å¤„ç†ä¸ƒå±‚æµé‡ï¼Œå¦‚HTTPã€gRPCç­‰ã€‚è¿™ä¸€å±‚äº§ç”Ÿçš„æ€§èƒ½å¼€é”€å¤§äºåŸºç¡€å±‚ï¼›
    - å…·ä½“æ¥è¯´ï¼ŒIstioä¼šåœ¨é›†ç¾¤ä¸­æ–°å¢ä¸€ä¸ªå‘½åç©ºé—´æ¥éƒ¨ç½²åŸºäºEnvoyçš„Waypointä»£ç†ï¼ˆä»¥Podå½¢å¼ï¼‰ï¼Œç”±å®ƒæ¥å¤„ç†å’Œè½¬å‘**éœ€è¦**
      æ‰§è¡Œä¸ƒå±‚æµé‡ç­–ç•¥çš„å®ä¾‹æµé‡ï¼›
    - Istioçš„æ§åˆ¶å¹³é¢ä¼šè´Ÿè´£Waypointä»£ç†ç­–ç•¥çš„ä¸‹å‘ï¼›
    - Waypointä»£ç†çš„æ•°é‡å¯ä»¥æ ¹æ®é›†ç¾¤æµé‡è§„æ¨¡å®ç°è‡ªåŠ¨ç¼©æ”¾ã€‚

ç”¨æˆ·åœ¨éƒ¨ç½²æ­¤æ¨¡å¼æ—¶å¯èƒ½å¹¶ä¸éœ€è¦å®‰è£…â€œåº”ç”¨å±‚â€ï¼Œå³ä¸éœ€è¦åœ¨å®ä¾‹ä¹‹é—´å¤„ç†ä¸ƒå±‚æµé‡ã€‚è¿™æ ·ä¸€æ¥å°±å¯ä»¥æŒ‰éœ€ä½¿ç”¨Istioæä¾›çš„åŠŸèƒ½ï¼Œ
ç›¸è¾ƒsidecaræ¨¡å¼çš„æ— å·®åˆ«å…¨åŠŸèƒ½æä¾›è€Œè¨€ï¼ŒAmbient Meshæ¨¡å¼å¤§å¤§å‡å°‘äº†Meshæ¶æ„äº§ç”Ÿçš„å¼€é”€ã€‚

**å°šæœªå‡†å¤‡å¥½ç”¨äºç”Ÿäº§ç¯å¢ƒ**

æˆªè‡³ç›®å‰ï¼ˆ2024/3/6ï¼‰ï¼ŒAmbient Meshæ˜¯ä»å¤„äºAlphaé˜¶æ®µçš„ç‰¹æ€§ï¼Œæ¯”é¢„æœŸè¿›åº¦ï¼ˆåŸæœ¬é¢„è®¡2023å¹´åº•Prod Readyï¼‰è¦æ…¢ï¼Œç›¸å…³æ–‡æ¡£è¿˜åœ¨æŒç»­æ›´æ–°ä¸­ï¼Œè¯·æŒç»­è§‚æœ›ã€‚

#### 8.4.3 å®‰è£…è¿‡ç¨‹

##### 8.4.3.1 å®‰è£…

å½“ä½ å‡†å¤‡å¥½å¼€å§‹å­¦ä¹ Istioæ—¶ï¼Œç¬”è€…å»ºè®®ä½ ä½¿ç”¨å…·å¤‡é«˜åº¦å®šåˆ¶åŒ–åŠŸèƒ½çš„`istioctl`å‘½ä»¤è¡Œå·¥å…·è¿›è¡Œå®‰è£…ï¼Œåœ¨ç†Ÿæ‚‰å®‰è£…æµç¨‹åï¼Œå†å°è¯•ä½¿ç”¨Helmæˆ–å…¶ä»–æ–¹å¼è¿›è¡Œå®‰è£…ã€‚
å®Œæ•´çš„å®‰è£…æŒ‡å—è¯·å‚è€ƒ[Istioå®‰è£…æŒ‡å—][Istioå®‰è£…æŒ‡å—]ã€‚

> æ³¨æ„ï¼ŒIstioåŸç”Ÿä¸Kubernetesé›†æˆï¼ˆä½†ä¸ç»‘å®šï¼‰ï¼Œå®‰è£…Istioæ—¶ä¼šå°†ä¸€äº›è‡ªå®šä¹‰èµ„æºå®‰è£…åˆ°Kubernetesé›†ç¾¤ä¸­ï¼Œå› æ­¤è¯·æå‰å‡†å¤‡å¥½ä¸€ä¸ªé›†ç¾¤ä»¥ä¾›å®‰è£…ã€‚

å®‰è£…æ­¥éª¤ï¼š

```shell
# 1. åœ¨istioå‘ç‰ˆé¡µé¢å¤åˆ¶éœ€è¦å®‰è£…çš„`istioctl`é“¾æ¥ï¼ˆæ³¨æ„ä¸æ˜¯istioï¼Œä»¥åŠé€‰æ‹©ç¬¦åˆèŠ‚ç‚¹æ¶æ„çš„ç‰ˆæœ¬ï¼Œä¸‹é¢ä»¥v1.20.3å’Œlinux amd64æ¶æ„ä¸ºä¾‹ï¼‰
# https://github.com/istio/istio/releases

# è¿›å…¥ä»»ä½•ä¸€ä¸ªå…·æœ‰K8sé›†ç¾¤ç®¡ç†å‘˜æƒé™çš„ä¸»æœº
$ wget https://hub.gitmirror.com/?q=https://github.com/istio/istio/releases/download/1.20.3/istioctl-1.20.3-linux-amd64.tar.gz -O istioctl.tar

# è§£å‹
$ tar -zxf istioctl.tar && chmod +x istioctl

# ç”Ÿæˆå³å°†å®‰è£…åˆ°é›†ç¾¤çš„istioèµ„æºçš„k8sæ¸…å•æ–‡ä»¶ï¼Œç¨åç”¨äºéªŒè¯å®‰è£…æ˜¯å¦æˆåŠŸ
$ ./istioctl manifest generate > manifest.yaml

# ä½¿ç”¨é»˜è®¤é…ç½®è¿›è¡Œå®‰è£…
# - æ­¤è¿‡ç¨‹ä¼šå®‰è£…Podï¼Œæ‰€ä»¥éœ€è¦æ‹‰å–è¿œç¨‹é•œåƒï¼Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
$ ./istioctl install
This will install the Istio 1.20.3 "default" profile (with components: Istio core, Istiod, and Ingress gateways) into the cluster. Proceed? (y/N) y
âœ” Istio core installed                                                                                                                                                                    
âœ” Istiod installed                                                                                                                                                                        
âœ” Ingress gateways installed                                                                                                                                                              
âœ” Installation complete                                                                                                 
Made this installation the default for injection and validation.
```

æŸ¥çœ‹å®‰è£…çš„istioéƒ¨åˆ†èµ„æºåˆ—è¡¨ï¼š

```shell
$ kubectl get deploy,svc,hpa,cm,secret -n istio-system
NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-ingressgateway   1/1     1            1           63m
deployment.apps/istiod                 1/1     1            1           68m

NAME                           TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                      AGE
service/istio-ingressgateway   LoadBalancer   20.1.124.145   <pending>     15021:30730/TCP,80:32703/TCP,443:32294/TCP   63m
service/istiod                 ClusterIP      20.1.237.53    <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP        68m

NAME                                                       REFERENCE                         TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/istio-ingressgateway   Deployment/istio-ingressgateway   <unknown>/80%   1         5         1          63m
horizontalpodautoscaler.autoscaling/istiod                 Deployment/istiod                 <unknown>/80%   1         5         1          68m

NAME                                            DATA   AGE
configmap/istio                                 2      68m
configmap/istio-ca-root-cert                    1      5m49s
configmap/istio-gateway-status-leader           0      5m49s
configmap/istio-leader                          0      5m49s
configmap/istio-namespace-controller-election   0      5m49s
configmap/istio-sidecar-injector                2      68m
configmap/kube-root-ca.crt                      1      68m

NAME                     TYPE               DATA   AGE
secret/istio-ca-secret   istio.io/ca-root   5      5m51s

# æŸ¥çœ‹istioå®‰è£…çš„è‡ªå®šä¹‰èµ„æº
$ kubectl -n istio-system get crd
NAME                                                  CREATED AT
authorizationpolicies.security.istio.io               2024-03-08T00:43:31Z
bgpconfigurations.crd.projectcalico.org               2024-03-03T05:22:57Z
bgpfilters.crd.projectcalico.org                      2024-03-03T05:22:57Z
bgppeers.crd.projectcalico.org                        2024-03-03T05:22:57Z
...

# æŸ¥çœ‹istioå®‰è£…çš„roleå’Œrolebinding
$ kubectl -n istio-system get role,rolebinding
NAME                                                      CREATED AT
role.rbac.authorization.k8s.io/istio-ingressgateway-sds   2024-03-08T00:48:32Z
role.rbac.authorization.k8s.io/istiod                     2024-03-08T00:43:32Z

NAME                                                             ROLE                            AGE
rolebinding.rbac.authorization.k8s.io/istio-ingressgateway-sds   Role/istio-ingressgateway-sds   68m
rolebinding.rbac.authorization.k8s.io/istiod                     Role/istiod                     73m
```

æ£€æŸ¥å®‰è£…ç»“æœï¼š

```shell
$ ./istioctl verify-install manifest.yaml                           
1 Istio control planes detected, checking --revision "default" only
âœ” HorizontalPodAutoscaler: istio-ingressgateway.istio-system checked successfully
âœ” Deployment: istio-ingressgateway.istio-system checked successfully
âœ” PodDisruptionBudget: istio-ingressgateway.istio-system checked successfully
...
âœ” Service: istiod.istio-system checked successfully
âœ” ServiceAccount: istiod.istio-system checked successfully
âœ” ValidatingWebhookConfiguration: istio-validator-istio-system.istio-system checked successfully
Checked 15 custom resource definitions
Checked 2 Istio Deployments
âœ” Istio is installed and verified successfully

# æŸ¥çœ‹istioå®‰è£…çš„APIå¯¹è±¡ï¼Œistioä½¿ç”¨å®ƒä»¬æ¥å®Œæˆå„é¡¹ä»»åŠ¡
$ kubectl api-resources |grep istio
wasmplugins                                    extensions.istio.io/v1alpha1           true         WasmPlugin
istiooperators                    iop,io       install.istio.io/v1alpha1              true         IstioOperator
destinationrules                  dr           networking.istio.io/v1beta1            true         DestinationRule
envoyfilters                                   networking.istio.io/v1alpha3           true         EnvoyFilter
gateways                          gw           networking.istio.io/v1beta1            true         Gateway
proxyconfigs                                   networking.istio.io/v1beta1            true         ProxyConfig
serviceentries                    se           networking.istio.io/v1beta1            true         ServiceEntry
sidecars                                       networking.istio.io/v1beta1            true         Sidecar
virtualservices                   vs           networking.istio.io/v1beta1            true         VirtualService
workloadentries                   we           networking.istio.io/v1beta1            true         WorkloadEntry
workloadgroups                    wg           networking.istio.io/v1beta1            true         WorkloadGroup
authorizationpolicies                          security.istio.io/v1                   true         AuthorizationPolicy
peerauthentications               pa           security.istio.io/v1beta1              true         PeerAuthentication
requestauthentications            ra           security.istio.io/v1                   true         RequestAuthentication
telemetries                       telemetry    telemetry.istio.io/v1alpha1            true         Telemetry
```

##### 8.4.3.2 å…³äºIstioOperator

IstioOperatorï¼ˆå®˜æ–¹æœ‰æ—¶ç®€ç§°ä¸º`iop`ï¼‰æ˜¯Istioè§„å®šçš„ä¸€ä¸ªè‡ªå®šä¹‰èµ„æºï¼ˆæŒ‰K8sä¸­çš„CRDæ ¼å¼ï¼‰ï¼Œå®ƒå…è®¸ç”¨æˆ·é…ç½®å’Œéƒ¨ç½²IstioæœåŠ¡ç½‘æ ¼çš„å„ä¸ªç»„ä»¶ã€‚
ä¸ŠèŠ‚ä¸­æˆ‘ä»¬å®‰è£…çš„æ˜¯istioctlæ¨èçš„é»˜è®¤é…ç½®ï¼Œå…·ä½“é…ç½®å†…å®¹å¯é€šè¿‡`./istioctl profile dump`æŸ¥çœ‹ï¼š

```shell
$ ./istioctl profile dump
apiVersion: install.istio.io/v1alpha1
kind: IstioOperator
spec:
  components:
    base:
      enabled: true
    cni:
      enabled: false
    egressGateways:
    - enabled: false
      name: istio-egressgateway
    ingressGateways:
    - enabled: true
      name: istio-ingressgateway
    istiodRemote:
      enabled: false
    pilot:
      enabled: true
...
```

å…¶ä¸­çš„`spec.components`éƒ¨åˆ†æŒ‡å®šäº†éœ€è¦å®‰è£…ï¼ˆ`enable: true`ï¼‰çš„istioæ ¸å¿ƒç»„ä»¶ï¼Œ
é»˜è®¤é…ç½®åªå®‰è£…äº†`base`,`ingressGateways`,`pilot`ã€‚
é€šè¿‡ä»¥ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹å·²å®‰è£…çš„IstioOperatoré…ç½®:

```shell
$ kubectl -n istio-system get IstioOperator installed-state -o yaml
```

æ¯ä¸ªç»„ä»¶çš„ä½œç”¨å¦‚ä¸‹ï¼š

- baseï¼šistioæ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œå®‰è£…æ§åˆ¶å¹³é¢æ—¶å¿…éœ€ï¼›
- cniï¼šistioåæ¥æ·»åŠ çš„ä¸€ä¸ªç»„ä»¶ï¼Œç”¨äºä»£æ›¿åŸå…ˆæ³¨å…¥åˆ°åº”ç”¨Podçš„`istio-init`å®¹å™¨ï¼Œä»¥å®ç°åº”ç”¨å®¹å™¨çš„æµé‡åŠ«æŒåŠŸèƒ½ï¼›
    - å…·ä½“æ¥è¯´ï¼Œåœ¨éƒ¨ç½²åº”ç”¨Podæ—¶ï¼Œistioä¸å†æ³¨å…¥`istio-init`å®¹å™¨ï¼Œè€Œæ˜¯ä½¿ç”¨CNIæ’ä»¶æ¥ä¸ºåº”ç”¨Podé…ç½®ç½‘ç»œã€‚
    - å±äºä¸€é¡¹è¾ƒä¸º**å…ˆè¿›**çš„åŠŸèƒ½ï¼Œæœ¬æ–‡æš‚ä¸ä½¿ç”¨ï¼›
- ingressGatewaysï¼šç½‘æ ¼æµé‡çš„å…¥ç«™ç½‘å…³ï¼Œç”¨äºç®¡æ§ç½‘æ ¼çš„æ‰€æœ‰å…¥ç«™æµé‡ã€‚æ¯”å¦‚TLSè®¾ç½®å’Œè·¯ç”±ç­–ç•¥ç­‰ï¼›
    - å¸¸ç”¨ç»„ä»¶ï¼Œå¯ç”¨äºæ›¿ä»£K8sçš„ingress APIï¼›
- egressGatewaysï¼šç½‘æ ¼æµé‡çš„å‡ºç«™ç½‘å…³ï¼Œä¸ingressç½‘å…³å¯¹ç§°ã€‚ç”¨äºç®¡æ§ç½‘æ ¼å†…çš„æ‰€æœ‰å‡ºç«™æµé‡ï¼›
    - éå¿…éœ€ç»„ä»¶ï¼Œé€‚ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š
        1. ç®¡ç†å‘˜éœ€è¦ä¸¥æ ¼ç®¡æ§ç½‘æ ¼å†…æŸäº›åº”ç”¨çš„å‡ºç«™æµé‡ï¼Œè¿™æ˜¯ä¸€ç§å®‰å…¨éœ€æ±‚ï¼›
        2. é›†ç¾¤å†…çš„èŠ‚ç‚¹æ²¡æœ‰å…¬ç½‘IPï¼Œé€šè¿‡å®‰è£…egressç½‘å…³å¹¶ä¸ºå…¶é…ç½®å…¬ç½‘IPï¼Œå¯ä»¥ä½¿ç½‘æ ¼å†…çš„æµé‡ä»¥å—æ§æ–¹å¼è®¿é—®å¤–éƒ¨æœåŠ¡ï¼›
- istiodRemoteï¼šåœ¨å—å¤–éƒ¨æ§åˆ¶é¢ç®¡ç†çš„ä»é›†ç¾¤ä¸­å®‰è£…istioæ—¶éœ€è¦çš„ç»„ä»¶ï¼Œ
  å¯ä»¥å‚è€ƒ[ä½¿ç”¨å¤–éƒ¨æ§åˆ¶å¹³é¢å®‰è£…Istio][ä½¿ç”¨å¤–éƒ¨æ§åˆ¶å¹³é¢å®‰è£… Istio]ï¼›

- pilotï¼šistioæ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£ç½‘æ ¼å†…çš„æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†ï¼›
    - æœåŠ¡å‘ç°ï¼šè·Ÿè¸ªK8sé›†ç¾¤ä¸­çš„Serviceèµ„æºå˜åŒ–ï¼Œå¹¶å®æ—¶ä¸‹å‘ç»™å„ä¸ªEnvoyä»£ç†ï¼Œé¿å…å„ä»£ç†è½¬å‘æµé‡åˆ°å¤±æ•ˆä¸»æœºï¼›
    - é…ç½®ç®¡ç†ï¼šåŒ…æ‹¬ç½‘æ ¼å†…çš„è·¯ç”±è§„åˆ™å’Œæµé‡è§„åˆ™ç­‰ï¼Œå®ƒä»¬ä»¥K8s CRDçš„å½¢å¼å­˜å‚¨åœ¨é›†ç¾¤ä¸­ã€‚
    - pilotåˆ’åˆ†ä¸ºä¸¤ä¸ªç»„ä»¶ï¼š
        - pilot-discoveryï¼šä½äºistiodå†…éƒ¨ï¼Œè´Ÿè´£å‘ç°é›†ç¾¤å†…çš„é…ç½®å˜åŒ–å’ŒServiceç«¯ç‚¹å˜åŒ–ï¼Œå¹¶é€šè¿‡gRPC streamè¿æ¥å®æ—¶ä¸‹å‘ç»™Envoyä»£ç†ï¼›
        - pilot-agentï¼šä½äºEnvoyä»£ç†å†…éƒ¨ï¼Œè´Ÿè´£ä»pilot-discoveryè·å–æœ€æ–°çš„è¯ä¹¦ã€ç­–ç•¥é…ç½®ä»¥åŠæœåŠ¡ç«¯ç‚¹ï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ°Envoyä»£ç†çš„é…ç½®æ–‡ä»¶ä¸­ï¼›

å…¶ä»–å…³äºIstioOperatoré…ç½®çš„æ“ä½œå‘½ä»¤:

```shell
# æŸ¥çœ‹å†…ç½®çš„é…ç½®åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ¯ä¸ªé…ç½®çš„ä»‹ç»ï¼šhttps://istio.io/latest/zh/docs/setup/additional-setup/config-profiles/
# å®æˆ˜ä¸­æ ¹æ®éœ€æ±‚é€‰æ‹©å“ªä¸ªæ¡£ä½ã€‚
$ istioctl profile list
Istio configuration profiles:
    default
    demo
    empty
    minimal
    openshift
    preview
    remote
# æŸ¥çœ‹demoæ¡£ä½çš„é…ç½®å†…å®¹
$ istioctl profile dump demo

# æŸ¥çœ‹é…ç½®çš„æŸä¸ªéƒ¨åˆ†
$ istioctl profile dump --config-path components.pilot demo
# æŸ¥çœ‹ä¸åŒæ¡£ä½é…ç½®é—´çš„å·®å¼‚ï¼Œä¾‹å¦‚defaultå’Œdemo
$ istioctl profile diff default demo

# å¸è½½istio
$ istioctl uninstall --purge && kubectl delete ns istio-system
```

æœ€åï¼ŒIstioOperatorè‡ªæœ‰ä¸€å¥—é…ç½®è§„èŒƒï¼Œè¯·æŸ¥é˜…[IstioOperator Options](https://istio.io/latest/zh/docs/reference/config/istio.operator.v1alpha1)ã€‚

#### 8.4.4 Envoyä»‹ç»

Envoyæ˜¯ä¸€ä¸ªç”±C++å¼€å‘çš„ã€å¼€æºçš„ã€é¢å‘å¤§å‹ç°ä»£æœåŠ¡æ¶æ„è®¾è®¡çš„**é«˜æ€§èƒ½**L7ä»£ç†å’Œé€šä¿¡æ€»çº¿ã€‚å®ƒäº2016å¹´8æœˆå¼€æºï¼Œ2017å¹´9æœˆæçŒ®ç»™CNCFå¼€å§‹å­µåŒ–ï¼Œ
ååœ¨2018å¹´11æœˆæˆä¸ºCNCFç»§ Kubernetes ä¸ Prometheus ä¹‹åç¬¬ä¸‰ä¸ªæ¯•ä¸šçš„é¡¹ç›®ã€‚Envoyçš„å®šä½æ˜¯åšä¸€ä¸ªé«˜æ€§èƒ½çš„é€šç”¨ä»£ç†ï¼Œå¯ä»¥ä¸ä»»ä½•è¯­è¨€æ„å»ºçš„æœåŠ¡é€šä¿¡ï¼Œ
å®ƒèƒ½å¤Ÿæä¾›æœåŠ¡å‘ç°ã€è´Ÿè½½å‡è¡¡ã€TLSç»ˆæ­¢ã€L3(TCP/UDPç­‰) & HTTP/2 & gRPCä»£ç†ã€ç†”æ–­ã€è¿½è¸ªã€å¥åº·æ£€æŸ¥ã€é™æµç­‰ä¸°å¯Œçš„ç½‘ç»œé€šä¿¡è½¬å‘åŠŸèƒ½ã€‚

> Envoyè¿˜æ”¯æŒä»£ç†MongoDBã€Rediså’ŒPostgresåè®®ã€‚

- [äº†è§£Envoyçš„å®Œæ•´ä»‹ç»](https://cloudnative.to/envoy/intro/what_is_envoy.html)

è™½ç„¶Istioé‡‡ç”¨å…¶ä½œä¸ºé»˜è®¤çš„æ•°æ®å¹³é¢ä»£ç†ï¼Œä½†Envoyå¹¶ä¸ä¸Istioç»‘å®šã€‚Envoyé€šå¸¸ä»¥sidecaræ¨¡å¼éƒ¨ç½²åœ¨åº”ç”¨Podä¸­ï¼Œä½†ä¹Ÿæ”¯æŒä½œä¸ºå‰ç«¯/è¾¹ç¼˜ä»£ç†è§’è‰²éƒ¨ç½²ï¼Œå°±åƒç½‘å…³ä¸€æ ·ã€‚
å‚è€ƒ[æ­¤é¡µé¢](https://jimmysong.io/kubernetes-handbook/usecases/envoy-front-proxy.html)äº†è§£Envoyå¦‚ä½•ä½œä¸ºå‰ç«¯ä»£ç†è¿›è¡Œå·¥ä½œã€‚

**æ˜¾è‘—ä¼˜åŠ¿**

- æ€§èƒ½ï¼šEnvoyæ˜¯C++å¼€å‘çš„é«˜æ€§èƒ½L7ä»£ç†ï¼›
- ä¸°å¯Œç‰¹æ€§ï¼šé€šè¿‡é…ç½®å„ç±»è¿‡æ»¤å™¨æ‰§è¡Œä¸°å¯Œçš„æµé‡å’Œè·¯ç”±ç­–ç•¥ï¼›
- æ”¯æŒå¤šç§åè®®ï¼šæ”¯æŒHTTP/1.1ã€HTTP/2ã€gRPCã€MongoDBã€Redisã€MySQLã€Postgresã€DNSç­‰åè®®ï¼›
- åŠ¨æ€é…ç½®ï¼šé€šè¿‡xDS APIåè®®åŠ¨æ€æ¥æ”¶æ¥è‡ªæ§åˆ¶é¢ä¸‹å‘çš„é…ç½®ï¼Œå®ç°å…é‡å¯æ›´æ–°é…ç½®ã€‚åŒæ—¶ä¹Ÿæ”¯æŒé™æ€é…ç½®ï¼Œåœ¨ä½œä¸ºå‰ç«¯/è¾¹ç¼˜ä»£ç†æ—¶ä¼šç”¨åˆ°ã€‚
    - xDSï¼ˆ`* Discovery Service`çš„ç¼©å†™ï¼‰ï¼Œå…¶åŒ…å«L(istener)DSã€C(luster)DSã€R(oute)DSã€E(ndpint)DSã€S(ecret)DSç­‰åœ¨å†…çš„å¤šä¸ªå‘ç°æœåŠ¡ã€‚

**å››å¤§ç»„ä»¶**  
Envoyå†…éƒ¨æœ‰å››ä¸ªä¸»è¦ç»„ä»¶ï¼Œä¸‹é¢æ ¹æ®å·¥ä½œé¡ºåºæŒ‰åºä»‹ç»ï¼š

- ç›‘å¬å™¨ï¼ˆListenerï¼‰ï¼šç±»ä¼¼Nginxçš„ç›‘å¬ç«¯å£ï¼Œæ¥æ”¶æ¥è‡ªå¤–éƒ¨çš„TCPå…¥ç«™è¿æ¥è¯·æ±‚ï¼›
- è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šå¤„ç†ç›‘å¬å™¨æ¥æ”¶åˆ°çš„å…¥ç«™è¯·æ±‚æ‰€ä¼ è¾“çš„æµé‡ï¼›
    - ä¸»è¦æ˜¯é€šè¿‡é¢„é…ç½®çš„å„ç§è¿‡æ»¤å™¨è¿›è¡Œå·¥ä½œï¼Œå¯ä»¥è¿›è¡Œè¯·æ±‚è·¯ç”±ã€é€Ÿç‡é™åˆ¶ç­‰æ“ä½œï¼›å¤šä¸ªè¿‡æ»¤å™¨ä¹‹é—´é€šè¿‡é“¾å¼é…ç½®å’Œå·¥ä½œï¼›
    - ä¸°å¯Œçš„è¿‡æ»¤å™¨ç±»åˆ«æ˜¯Envoyçš„æ ¸å¿ƒåŠŸèƒ½ä¼˜åŠ¿ã€‚
- è·¯ç”±ï¼ˆRouterï¼‰ï¼šæŒ‡å®šå¦‚ä½•å°†å…¥ç«™è¿æ¥è¯·æ±‚è·¯ç”±åˆ°Envoyä»£ç†å†…éƒ¨é…ç½®çš„Clusterï¼Œè¿™æ˜¯ä¸€ä¸ªæµé‡å‡ºç«™æ­¥éª¤ï¼›
- é›†ç¾¤ï¼ˆClusterï¼‰ï¼šè¿™é‡Œçš„**é›†ç¾¤**ä¸åŒäºä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é›†ç¾¤ï¼Œè€Œæ˜¯æŒ‡æµé‡è½¬å‘çš„ç›®çš„åœ°å€ï¼ˆç±»ä¼¼Nginxçš„upstreamï¼Œå³è½¬å‘çš„åç«¯åœ°å€ï¼‰ï¼ŒåŒæ—¶å¯ä»¥é…ç½®è´Ÿè½½å‡è¡¡ç­‰ç­–ç•¥ã€‚

**å¸¸ç”¨æœ¯è¯­**

- ä¸»æœºï¼ˆHostï¼‰ï¼šä¸€ä¸ªå…·æœ‰ç½‘ç»œé€šä¿¡èƒ½åŠ›çš„ç«¯ç‚¹ï¼Œä¾‹å¦‚æœåŠ¡å™¨ã€ç§»åŠ¨æ™ºèƒ½è®¾å¤‡ç­‰ï¼Œè€Œè¿™é‡Œçš„ host é€šå¸¸ä»£è¡¨ä¸Šæ¸¸æœåŠ¡
- é›†ç¾¤ï¼ˆClusterï¼‰ï¼šé›†ç¾¤æ˜¯Envoyè¿æ¥åˆ°çš„ä¸€ç»„é€»è¾‘ä¸Šç›¸ä¼¼çš„ç«¯ç‚¹ï¼›åœ¨v2ä¸­ï¼ŒRDSé€šè¿‡è·¯ç”±æŒ‡å‘é›†ç¾¤ï¼ŒCDSæä¾›é›†ç¾¤é…ç½®ï¼Œè€ŒEnvoyé€šè¿‡EDSå‘ç°é›†ç¾¤æˆå‘˜ï¼Œå³ç«¯ç‚¹ï¼ˆEndpointï¼‰ï¼›
- ä¸‹æ¸¸ï¼ˆDownstreamï¼‰ï¼šä¸‹æ¸¸ä¸»æœºè¿æ¥åˆ° Envoyï¼Œå‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ï¼Œå®ƒä»¬æ˜¯ Envoy çš„å®¢æˆ·ç«¯ï¼›
- ä¸Šæ¸¸ï¼ˆUpstreamï¼‰ï¼šä¸Šæ¸¸ä¸»æœºæ¥æ”¶æ¥è‡ª Envoy çš„è¿æ¥å’Œè¯·æ±‚å¹¶è¿”å›å“åº”ï¼Œå®ƒä»¬æ˜¯ Envoy ä»£ç†çš„åç«¯æœåŠ¡å™¨ï¼Œå¯èƒ½æ˜¯å®¹å™¨ã€è™šæ‹Ÿæœºã€æœåŠ¡å™¨ï¼›
- ç«¯ç‚¹ï¼ˆEndpointï¼‰ï¼šç«¯ç‚¹å³ä¸Šæ¸¸ä¸»æœºï¼Œæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªé›†ç¾¤çš„æˆå‘˜ï¼Œå¯é€šè¿‡ EDS å‘ç°ï¼›
- ä¾¦å¬å™¨ï¼ˆListenerï¼‰ï¼šä¾¦å¬å™¨æ˜¯èƒ½å¤Ÿç”±ä¸‹æ¸¸å®¢æˆ·ç«¯è¿æ¥çš„å‘½åç½‘ç»œä½ç½®ï¼Œä¾‹å¦‚ç«¯å£æˆ– unix åŸŸå¥—æ¥å­—ç­‰ï¼›
- å­é›†ï¼ˆSubsetï¼‰ï¼šå­é›†æ˜¯å…·æœ‰ç›¸åŒæ ‡ç­¾çš„ç«¯ç‚¹çš„é€»è¾‘åˆ†ç»„ï¼Œä¾‹å¦‚é‡‘ä¸é›€å‘å¸ƒæ—¶é€šå¸¸ä¼šæ ¹æ®ç‰ˆæœ¬æ ‡ç­¾é…ç½®ä¸¤ä¸ªä¸åŒç‰ˆæœ¬çš„æœåŠ¡å­é›†ï¼Œ
  ç„¶åä¸ºä¸¤ä¸ªå­é›†åˆ†é…ä¸åŒçš„æµé‡æƒé‡ï¼ˆå¯èƒ½æ˜¯1:9ï¼‰ï¼›
- ä½ç½®ï¼ˆLocalityï¼‰ï¼šä¸Šæ¸¸ç«¯ç‚¹è¿è¡Œçš„åŒºåŸŸæ‹“æ‰‘ï¼ŒåŒ…æ‹¬åœ°åŸŸã€åŒºåŸŸå’Œå­åŒºåŸŸç­‰ï¼›
- ç®¡ç†æœåŠ¡å™¨ï¼ˆManagement Serverï¼‰ï¼šå®ç° v3 API çš„æœåŠ¡å™¨ï¼Œå®ƒæ”¯æŒå¤åˆ¶å’Œåˆ†ç‰‡ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨ä¸åŒçš„ç‰©ç†æœºå™¨ä¸Šå®ç°é’ˆå¯¹ä¸åŒ xDS API çš„
  API æœåŠ¡ã€‚Istioä¸­æŒ‡æ§åˆ¶é¢ï¼›
- åœ°åŸŸï¼ˆRegionï¼‰ï¼šåŒºåŸŸæ‰€å±åœ°ç†ä½ç½®ï¼›
- åŒºåŸŸï¼ˆZoneï¼‰ï¼šAWS ä¸­çš„å¯ç”¨åŒºï¼ˆAZï¼‰æˆ– GCP ä¸­çš„åŒºåŸŸç­‰ï¼›
- å­åŒºåŸŸï¼šEnvoy å®ä¾‹æˆ–ç«¯ç‚¹è¿è¡Œçš„åŒºåŸŸå†…çš„ä½ç½®ï¼Œç”¨äºæ”¯æŒåŒºåŸŸå†…çš„å¤šä¸ªè´Ÿè½½å‡è¡¡ç›®æ ‡ï¼›
- Meshå’ŒEnvoy Meshï¼šæŒ‡ä»£æœåŠ¡ç½‘æ ¼ï¼Œç”±å¤šä¸ªåŸºäºenvoyä»£ç†çš„sidecaræ„æˆã€‚

> å¦‚ä½•å¿«é€Ÿç†è§£ä¸Šä¸‹æ¸¸æ¦‚å¿µï¼Ÿ
> - ä¸€èˆ¬åªå¯¹ä»£ç†è¿™ä¸ªè§’è‰²è®¨è®ºä¸Šä¸‹æ¸¸æ¦‚å¿µï¼›
> - è¿›å…¥ä»£ç†çš„è¯·æ±‚å³æ˜¯ä¸‹æ¸¸è¯·æ±‚ï¼Œè€Œä»£ç†å†è½¬å‘çš„åˆ™æ˜¯ä¸Šæ¸¸è¯·æ±‚ã€‚ä¾‹å¦‚Nginxåä»£ï¼ŒClientå‘å‡ºçš„æ˜¯ä¸‹æ¸¸è¯·æ±‚ï¼ŒNginxè½¬å‘è‡³Serverçš„æ˜¯ä¸Šæ¸¸è¯·æ±‚ï¼Œ
    æ‰€ä»¥Nginxé…ç½®ä¸­ä½¿ç”¨`upstream`å…³é”®å­—æ¥å®šä¹‰Serverç«¯ç‚¹ï¼›
> - æ³¨æ„ï¼šç†è§£æ­¤æ¦‚å¿µåæ‰èƒ½åœ¨åç»­çš„æ¼”ç¤ºç»ƒä¹ ä¸­æ¸¸åˆƒæœ‰ä½™çš„åˆ†æEnvoyæ—¥å¿—ã€‚

#### 8.4.5 ä½¿ç”¨æ¼”ç¤º

##### 8.4.5.1 sidecaræ³¨å…¥çš„ä¸¤ç§æ–¹å¼

Istioé€šè¿‡ä¸ºå¯¹è±¡æ·»åŠ æ ‡ç­¾ï¼ˆLabelï¼‰çš„æ–¹å¼æ¥å®ç°sidecaræ³¨å…¥ï¼Œå…·ä½“åˆ†ä¸ºè‡ªåŠ¨å’Œæ‰‹åŠ¨ä¸¤ç§ï¼š

- è‡ªåŠ¨æ³¨å…¥ï¼šé€šè¿‡ä¸ºK8sé›†ç¾¤ä¸­çš„å‘½åç©ºé—´ï¼ˆNamespaceï¼‰å¯¹è±¡æ·»åŠ Istioè¯†åˆ«çš„ç‰¹å®šæ ‡ç­¾æ¥å®ç°è‡ªåŠ¨æ³¨å…¥ï¼›
    - å…·ä½“æ¥è¯´ï¼Œå½“K8sé›†ç¾¤ä¸­çš„å‘½åç©ºé—´å¯¹è±¡è¢«æ·»åŠ äº†`istio-injection=enabled`æ ‡ç­¾æ—¶ï¼Œä»»ä½•æ–°çš„ Pod éƒ½å°†åœ¨åˆ›å»ºæ—¶è‡ªåŠ¨æ·»åŠ sidecarã€‚
    - è¿™ç§æ³¨å…¥å¯¹å·¥ä½œè´Ÿè½½æ˜¯å®Œå…¨æ— æ„ŸçŸ¥çš„ï¼Œå®ƒä¸ä¼šä¿®æ”¹èµ„æºæ¨¡æ¿ï¼›
    - è‹¥ä¸å¸Œæœ›Podè¢«æ³¨å…¥sidecarï¼Œåˆ™å¯ä»¥ä¸ºPodå¯¹è±¡æ·»åŠ `sidecar.istio.io/inject="false"`æ ‡ç­¾ï¼ˆæ­¤æ ‡ç­¾ä¼˜å…ˆçº§**é«˜äº**å‘½åç©ºé—´æ ‡ç­¾ï¼‰ï¼›
- æ‰‹åŠ¨æ³¨å…¥ï¼šé€šè¿‡æ‰‹åŠ¨æ‰§è¡Œå‘½ä»¤å®ç°sidecaræ³¨å…¥
    - å…·ä½“æ¥è¯´ï¼Œæ‰§è¡Œ`istioctl kube-inject -f samples/sleep/sleep.yaml`å‘½ä»¤å³å¯å°†sidecaræ³¨å…¥åˆ°æŒ‡å®šçš„Pod
    - ä»¥ä¸Šå‘½ä»¤ä½¿ç”¨istioå®‰è£…åˆ°é›†ç¾¤çš„é…ç½®è¿›è¡Œæ³¨å…¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æœ¬åœ°é…ç½®ï¼Œå…·ä½“æ–¹æ³•å‚è€ƒ[æ‰‹åŠ¨æ³¨å…¥][æ‰‹åŠ¨æ³¨å…¥]ï¼›
    - ç”±äºå¯¹èµ„æºæ¨¡æ¿çš„å…¥ä¾µæ€§ï¼Œ**æ‰‹åŠ¨æ³¨å…¥ä»…åœ¨ç‰¹å®šæƒ…å†µä¸‹ä½¿ç”¨**ã€‚

æœ¬æ–‡ä»…ä»‹ç»æ›´å¸¸ç”¨çš„è‡ªåŠ¨æ³¨å…¥æ–¹å¼ï¼Œæ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# ä¸ºå‘½åç©ºé—´è®¾ç½®ç‰¹å®šæ ‡ç­¾ï¼Œä»¥ default ä¸ºä¾‹
$ kubectl label namespace default istio-injection=enabled --overwrite
namespace/default labeled
$ kubectl get ns default --show-labels                               
NAME         STATUS   AGE    LABELS
default      Active   2m2s   istio-injection=enabled,kubernetes.io/metadata.name=default

# åˆ é™¤æ ‡ç­¾å‘½ä»¤ï¼škubectl label namespace default istio-injection-
```

æ·»åŠ æ ‡ç­¾åï¼Œæ–°éƒ¨ç½²çš„Podéƒ½ä¼šè‡ªåŠ¨æ³¨å…¥sidecarï¼Œä½†ä¸ä¼šä¿®æ”¹èµ„æºæ¸…å•ã€‚

##### 8.4.5.2 éƒ¨ç½²Podè¿›è¡ŒéªŒè¯

è¿™é‡Œä»ç„¶ä½¿ç”¨ç¬¬ä¸€èŠ‚ä¸­åªå®šä¹‰äº†ä¸€ä¸ªå¸¸è§„å®¹å™¨çš„ [deployment.yaml](k8s_actions_guide/version1/base_manifest/deployment.yaml)
æ¨¡æ¿è¿›è¡ŒéªŒè¯ï¼Œæ³¨æ„è¿˜éœ€è¦éƒ¨ç½²ç›¸å…³çš„å‡ ä¸ªèµ„æºï¼š

- [configmap.yaml](k8s_actions_guide/version1/base_manifest/configmap.yaml)
- [secret.yaml](k8s_actions_guide/version1/base_manifest/secret.yaml)
- [service.yaml](k8s_actions_guide/version1/expose_manifest/service.yaml)
    - Istioçš„mTLSä»…åœ¨å®šä¹‰äº†serviceçš„å·¥ä½œè´Ÿè½½ä¸Šç”Ÿæ•ˆï¼Œæ‰€ä»¥å¿…é¡»éƒ¨ç½²serviceã€‚

æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# 1. éƒ¨ç½²configmapã€secretä»¥åŠserviceï¼Œæ­¥éª¤ç•¥ã€‚

# 2. éƒ¨ç½²deployment
$ kubectl apply -f deployment.yaml

# 3. å¯ä»¥çœ‹åˆ° READY å¤„çš„2/2è¡¨ç¤ºPodå†…éƒ¨æœ‰2ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œ
$ kubectl get po -l app=go-multiroute
NAME                            READY   STATUS    RESTARTS   AGE
go-multiroute-b6fcdf544-7xfn7   2/2     Running   0          2m40s
go-multiroute-b6fcdf544-dqncx   2/2     Running   0          5m27s

# 4. æŸ¥çœ‹Podäº‹ä»¶ï¼Œå¯ä»¥çœ‹åˆ°Podå¯åŠ¨è¿‡ç¨‹ä¸­åˆ›å»ºäº†æ³¨å…¥çš„istio-initå’Œistio-proxyå®¹å™¨ï¼ŒåŠ ä¸ŠåŸæœ¬çš„ go-multiroute ä¸€å…±3ä¸ªå®¹å™¨
# -- ä½†å…¶ä¸­çš„istio-initæ˜¯åˆå§‹åŒ–å®¹å™¨
$ kubectl describe po go-multiroute-b6fcdf544-7xfn7 |grep Events: -A 15
Events:
  Type    Reason     Age    From               Message
  ----    ------     ----   ----               -------
  Normal  Scheduled  5m16s  default-scheduler  Successfully assigned default/go-multiroute-b6fcdf544-7xfn7 to k8s-node1
  Normal  Pulled     2d3h   kubelet            Container image "docker.io/istio/proxyv2:1.20.3" already present on machine
  Normal  Created    2d3h   kubelet            Created container istio-init
  Normal  Started    2d3h   kubelet            Started container istio-init
  Normal  Pulled     2d3h   kubelet            Container image "docker.io/leigg/go_multiroute:v1" already present on machine
  Normal  Created    2d3h   kubelet            Created container go-multiroute
  Normal  Started    2d3h   kubelet            Started container go-multiroute
  Normal  Pulled     2d3h   kubelet            Container image "docker.io/istio/proxyv2:1.20.3" already present on machine
  Normal  Created    2d3h   kubelet            Created container istio-proxy
  Normal  Started    2d3h   kubelet            Started container istio-proxy
  
# 5. æŸ¥çœ‹istioæ­£åœ¨ä»£ç†çš„æ‰€æœ‰Podï¼ŒåŒ…æ‹¬æ¯ä¸ªPodçš„xDSåŒæ­¥çŠ¶æ€ï¼Œå¯æ·»åŠ  -n æŒ‡å®š namespace
$ ./istioctl proxy-status                        
NAME                                      CLUSTER        CDS        LDS        EDS        RDS        ECDS         ISTIOD                     VERSION
go-multiroute-b6fcdf544-7xfn7.default     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-78478fdc7-qmzbb     1.20.3
go-multiroute-b6fcdf544-dqncx.default     Kubernetes     SYNCED     SYNCED     SYNCED     SYNCED     NOT SENT     istiod-78478fdc7-qmzbb     1.20.3
```

##### 8.4.5.3 Istioç‰¹æ€§ä¹‹mTLS

Istioæä¾›è¯¸å¤šç‰¹æ€§ï¼Œè¿™é‡Œå°†ä»‹ç»å¦‚ä½•ä½¿ç”¨å…¶ä¸­çš„**mTLS**ï¼ˆåŒå‘TLSï¼‰ç‰¹æ€§ã€‚
å¯ç”¨mTLSå¯ä»¥å®ç°sidecarä¹‹é—´çš„**åŒå‘èº«ä»½è®¤è¯ã€ä¼ è¾“æµé‡åŠ å¯†**ï¼Œå¯ä»¥é¿å…ä¸­é—´äººæ”»å‡»ï¼Œæé«˜ä¼ è¾“å®‰å…¨æ€§ã€‚
éƒ¨ç½²åï¼ŒIstioçš„æ§åˆ¶é¢å¯ä»¥è‡ªåŠ¨å®Œæˆå°†è¦è¿‡æœŸçš„sidecarè¯ä¹¦è½®æ¢ã€‚
è¦å¯ç”¨mTLSï¼Œå¿…é¡»å¯åŠ¨ä¸¤ä¸ªä¸åŒçš„æœåŠ¡è¿›è¡Œäº’ç›¸é€šä¿¡ï¼Œå‰é¢å·²ç»éƒ¨ç½²äº†ä¸€ä¸ª`go-multiroute`æœåŠ¡ï¼Œ
å®ƒé€šè¿‡configmapæä¾›äº†ä¸¤ä¸ªHTTPæ¥å£`/route1`å’Œ`/route2`ï¼Œè¿™é‡Œå°†å…¶ä½œä¸ºè¢«è°ƒç”¨ç«¯ï¼Œ
ç„¶åæˆ‘ä»¬å†å¯åŠ¨ä¸€ä¸ªè°ƒç”¨ç«¯æœåŠ¡[istio_client_test.yaml](k8s_actions_guide/version1/istio_manifest/istio_client_test.yaml)ï¼Œ
æ„å»ºå’Œä¸Šä¼ é•œåƒçš„æ­¥éª¤ç•¥ï¼ŒåŒ…å«ä»£ç å®ç°åœ¨å†…çš„ç›¸å…³æ¸…å•åœ¨ [istio_manifest/](k8s_actions_guide/version1/istio_manifest) ç›®å½•ä¸‹ã€‚

æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# ä¸ºäº†é¿å…ç½‘ç»œç­–ç•¥çš„å¹²æ‰°ï¼Œå…ˆåˆ é™¤ä¹‹å‰éƒ¨ç½²çš„é»˜è®¤æ‹’ç» networkpolicy
kubectl delete networkpolicy block-internal-all-egress
kubectl delete networkpolicy deny-all-ingress

# éƒ¨ç½²è°ƒç”¨ç«¯Pod
kubectl apply -f istio_client_test_pod.yaml

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—ï¼ˆå¯åŠ¨æ—¶å‘èµ·è°ƒç”¨ï¼‰
$ kubectl logs istio-client-test-$POD_ID                                       
2024/03/08 08:07:22 status:200 text: [v1] Hello, You are at /route1, Got: route1's content

# ç„¶åå¯åœ¨istio-client-testä¸­çš„Podä¸Šè¿›è¡ŒæŠ“åŒ…æµ‹è¯•ã€‚
# - ä½¿ç”¨tcpdumpæŠ“å–é»˜è®¤ç½‘å¡ä¸Šæ¥æºæ˜¯3000ç«¯å£çš„tcpæ•°æ®æµï¼Œå¯ä»¥è§‚å¯Ÿåˆ°åŒ…å«"Hello"å­—çœ¼çš„httpå“åº”æ˜æ–‡
# - ï¼ˆå¼€å§‹æŠ“åŒ…åï¼Œéœ€è¦åŒæ­¥åœ¨ç›¸åŒçš„Podä¸Šçš„å¦ä¸€ä¸ªå®¹å™¨ä¸­æ‰§è¡Œcurlè®¿é—®go-multirouteæœåŠ¡ï¼škubectl exec -it istio-client-test-$POD_ID -c istio-client-test -- curl go-multiroute:3000/route1ï¼‰
# - ï¼ˆæ‰§è¡Œcurlè®¿é—®åï¼Œè¿™è¾¹åº”ç«‹å³å¯ä»¥è§‚å¯Ÿåˆ°æ§åˆ¶å°è¾“å‡ºç›¸å…³tcpæ•°æ®ï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -c tcpdump -- tcpdump -nX tcp src port 3000
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
09:43:58.668073 IP 20.2.36.112.3000 > 20.2.36.117.60022: Flags [P.], seq 3671286507:3671287547, ack 2394647540, win 291, options [nop,nop,TS val 2452817 ecr 2452816], length 1040
...
	0x0040:  204f 4b0d 0a64 6174 653a 2053 756e 2c20  .OK..date:.Sun,.
	0x0050:  3130 204d 6172 2032 3032 3420 3039 3a34  10.Mar.2024.09:4
	0x0060:  333a 3538 2047 4d54 0d0a 636f 6e74 656e  3:58.GMT..conten
...
	0x00e0:  643a 2073 6964 6563 6172 7e32 302e 322e  d:.sidecar~20.2.
	0x00f0:  3336 2e31 3132 7e67 6f2d 6d75 6c74 6972  36.112~go-multir
	0x0100:  6f75 7465 2d62 3666 6364 6635 3434 2d62  oute-b6fcdf544-b
	0x0110:  7a7a 7237 2e64 6566 6175 6c74 7e64 6566  zzr7.default~def
	0x0120:  6175 6c74 2e73 7663 2e63 6c75 7374 6572  ault.svc.cluster
	0x0130:  2e6c 6f63 616c 0d0a 782d 656e 766f 792d  .local..x-envoy-
	0x0140:  7065 6572 2d6d 6574 6164 6174 613a 2043  peer-metadata:.C
	0x0150:  6945 4b44 6b46 5155 4639 4454 3035 5551  iEKDkFQUF9DT05UQ
...
	0x03e0:  5555 5344 786f 4e5a 3238 7462 5856 7364  UUSDxoNZ28tbXVsd
	0x03f0:  476c 7962 3356 305a 513d 3d0d 0a73 6572  Glyb3V0ZQ==..ser
	0x0400:  7665 723a 2069 7374 696f 2d65 6e76 6f79  ver:.istio-envoy
	0x0410:  0d0a 0d0a 4865 6c6c 6f2c 2059 6f75 2061  ....Hello,.You.a
	0x0420:  7265 2061 7420 2f72 6f75 7465 312c 2047  re.at./route1,.G
	0x0430:  6f74 3a20 726f 7574 6531 2773 2063 6f6e  ot:.route1's.con
	0x0440:  7465 6e74                                tent
```

ç°åœ¨ä¸º `go-multiroute`
æœåŠ¡é…ç½®åŒå‘è®¤è¯ç­–ç•¥ï¼ˆmTLSï¼‰ï¼š[peer_authn.yaml](k8s_actions_guide/version1/istio_manifest/peer_authn.yaml)ï¼Œ
å®ƒåŒæ ·æ˜¯ä»¥K8sèµ„æºæ¸…å•çš„å½¢å¼éƒ¨ç½²ï¼Œè¯¥èµ„æºçš„`kind`ä¸º`PeerAuthentication`ã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# éƒ¨ç½²mTLSç­–ç•¥
$ kubectl apply -f peer_authn.yaml           
peerauthentication.security.istio.io/go-multiroute created

# å¯ä½¿ç”¨ç¼©å†™å½¢å¼ï¼špa
$ kubectl get peerauthentications
NAME            MODE     AGE
go-multiroute   STRICT   4m42s
```

éƒ¨ç½²åï¼Œè®¿é—® `go-multiroute` æœåŠ¡å°±å¿…é¡»éµå¾ªç­–ç•¥ä¸­é…ç½®çš„å¼ºåˆ¶ï¼ˆSTRICTï¼‰åŒå‘TLSé€šä¿¡æ¨¡å¼ã€‚
è¿™å¯ä»¥é€šè¿‡ä¸Šé¢ä½¿ç”¨è¿‡çš„tcpdumpæŠ“åŒ…æ–¹å¼æ¥éªŒè¯ï¼ŒæŠ“å–ç»“æœå°†æ˜¯å„ç§ä¹±ç ï¼Œæ— æ³•è§‚å¯Ÿåˆ°äººçœ¼å¯è¯»çš„æ˜æ–‡ã€‚

> å¯ç”¨mTLSç‰¹æ€§éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š
>- å¯¹å·²å­˜åœ¨çš„æœåŠ¡å¯ç”¨mTLSï¼Œç”±äºæœåŠ¡å¯èƒ½æ­£åœ¨è¢«è°ƒç”¨ï¼Œ
   > éœ€è¦å…ˆè®¾ç½®ç­–ç•¥ä¸º`PERMISSIVE`æ¨¡å¼ï¼ˆåŒæ—¶æ¥æ”¶æ˜æ–‡å’ŒHTTPSæµé‡ï¼‰è¿›è¡Œè¿‡æ¸¡ï¼Œ
   > ç­‰å¾…ç›¸å…³æœåŠ¡æ›´æ–°ï¼ˆå»ºè®®ç­‰å¾…1minï¼‰åå†åˆ‡æ¢åˆ°`STRICT`æ¨¡å¼ã€‚
>- è‹¥è¦å…³é—­mTLSï¼Œ**ç›´æ¥åˆ é™¤ç­–ç•¥æ˜¯ä¸èµ·ä½œç”¨çš„**ï¼Œå¿…é¡»å°†ç­–ç•¥æ”¹ä¸º`DISABLE`æ¨¡å¼ç„¶ååº”ç”¨ï¼Œè¿™æ ·æ‰ä¼šç”Ÿæ•ˆã€‚
   > åŒç†ï¼Œä¸ºäº†é¿å…å½±å“æ­£åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œéœ€è¦å…ˆè®¾ç½®ç­–ç•¥ä¸º`PERMISSIVE`æ¨¡å¼è¿›è¡Œè¿‡æ¸¡ï¼Œä¸€æ®µæ—¶é—´åå†åˆ‡æ¢åˆ°`DISABLE`æ¨¡å¼ã€‚
>- Istioæ”¯æŒä¸ºçº¯TCPæˆ–åŸºäºTCPçš„HTTPã€gRPCç­‰åè®®æä¾›mTLSæ”¯æŒï¼›**Istioä¸ä¼šä»£ç†UDPåè®®**ï¼ˆä½†Envoyæœ¬èº«æ”¯æŒï¼‰ï¼Œ
   > å³åº”ç”¨å®¹å™¨çš„UDPæ•°æ®æŠ¥æ–‡ä¸ä¼šç»è¿‡sidecarå®¹å™¨çš„ç½‘ç»œæ ˆï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦åœ¨Istioçš„æµé‡ç­–ç•¥ä¸­é…ç½®åº”ç”¨çš„UDPç«¯å£ï¼›

å…¶ä»–å»ºè®®å’ŒTipsï¼š

- å¯ä»¥è®¾ç½®æ ¹å‘½åç©ºé—´`istio-system`çš„é»˜è®¤mTLSæ¨¡å¼ä¸º`STRICT`
  ä»¥å½±å“æ•´ä¸ªç½‘æ ¼èŒƒå›´ï¼Œä½¿ç”¨æ¨¡æ¿ [peer_authn_default.yaml](k8s_actions_guide/version1/istio_manifest/peer_authn_default.yaml)ã€‚
- å°†æ¨¡æ¿ä¸­çš„`namespace`å­—æ®µæ”¹ä¸ºéæ ¹å‘½åç©ºé—´ä»¥å½±å“ç‰¹å®šå‘½åç©ºé—´ï¼›
- ç­–ç•¥ä¼˜å…ˆçº§ï¼šå·¥ä½œè´Ÿè½½çº§åˆ« > å‘½åç©ºé—´çº§åˆ« > æ ¹å‘½åç©ºé—´çº§åˆ«;

> å¯¹ç­‰è®¤è¯å³mTLSæ˜¯Istioæä¾›çš„ä¸¤ä¸ªè®¤è¯ç‰¹æ€§ä¹‹ä¸€ï¼Œå¦ä¸€ä¸ªè®¤è¯ç‰¹æ€§æ˜¯è¯·æ±‚è®¤è¯ï¼ˆ`RequestAuthentication`ï¼‰ï¼Œå®ƒä½¿ç”¨JWTæŠ€æœ¯å®ç°é’ˆå¯¹HTTPè¯·æ±‚çš„è®¤è¯ã€‚
> ç”±äºç¯‡å¹…æ‰€é™å’Œä½¿ç”¨é¢‘ç‡ä¸é«˜ï¼Œæœ¬æ–‡ä¸ä¼šè¯¦è¿°ï¼Œ
> è¯·å‚è€ƒ[è¯·æ±‚è®¤è¯](https://istio.io/latest/zh/docs/concepts/security/#request-authentication)ã€‚

**æ¸…ç†**

```shell
kubectl delete -f peer_authn.yaml
```

##### 8.4.5.4 Istioç‰¹æ€§ä¹‹æˆæƒ

Istioé€šè¿‡é¢„å…ˆå®‰è£…åˆ°Kubernetesé›†ç¾¤ä¸­çš„`AuthorizationPolicy`è‡ªå®šä¹‰APIèµ„æºæ¥æä¾›ç»†ç²’åº¦çš„æˆæƒåŠŸèƒ½ï¼Œå…¶å…·æœ‰å¦‚ä¸‹ä¼˜ç‚¹å’Œç‰¹æ€§ï¼š

- å®ç°**æ‹’ç»æˆ–å…è®¸**æŒ‡å®šçš„ä¸åŒ`é€šä¿¡æº`ä¹‹é—´çš„æµé‡è®¿é—®ï¼›
- `é€šä¿¡æº`å¯ä»¥æ˜¯ä¸€ç»„Pod/IPå—/æœåŠ¡è´¦å·ï¼Œç”šè‡³æ˜¯ä¸€æ•´ä¸ªå‘½åç©ºé—´ï¼›
- å¯ä»¥é™åˆ¶å…·ä½“æ‰§è¡Œçš„HTTPæ–¹æ³•ï¼Œå¦‚GETã€POSTç­‰ï¼›
- å¯ä»¥é™åˆ¶å…·ä½“è®¿é—®çš„HTTPè·¯ç”±ï¼Œå¦‚`/get_order`ï¼›
- å¤§éƒ¨åˆ†ç»´åº¦æ”¯æŒ**æ’é™¤åŒ¹é…**ï¼Œæ¯”å¦‚`to.operations.notPaths: /get_order`è¡¨ç¤ºåŒ¹é…é™¤äº†`/get_order`ä»¥å¤–çš„HTTPè·¯ç”±ï¼›
- å¯ä»¥è®¾ç½®**å·¥ä½œè´Ÿè½½ã€å‘½åç©ºé—´æˆ–ç½‘æ ¼ç»´åº¦**çš„é»˜è®¤æˆæƒç­–ç•¥ï¼Œä¾‹å¦‚é»˜è®¤æ‹’ç»æˆ–å…è®¸èŒƒå›´å†…çš„æ‰€æœ‰HTTPé€šä¿¡ï¼›
- å¯ä»¥ä¸ºç­–ç•¥è®¾ç½®é™„åŠ æ¡ä»¶ï¼Œä¾‹å¦‚è‹¥è¦æ‹’ç»é€šä¿¡æºAåˆ°Bä¹‹é—´çš„è®¿é—®ï¼Œè¿˜è¦æ±‚HTTPè¯·æ±‚çš„Headerä¸­å¿…é¡»æºå¸¦`version: v1`é”®å€¼å¯¹ï¼›
- æ”¯æŒHTTP 1.1/2ä»¥åŠHTTPS

> æ³¨æ„ï¼šç”±äºK8så†…ç½®çš„NetworkPolicy APIä¸Istioçš„AuthorizationPolicy APIå­˜åœ¨åŠŸèƒ½ä¸Šçš„é‡å ï¼Œä¸ºäº†é™ä½æ¶æ„å¤æ‚åº¦ï¼Œ
> å»ºè®®ä¸€æ—¦å¯ç”¨AuthorizationPolicy APIï¼Œå°±å°½é‡åœæ­¢ä½¿ç”¨NetworkPolicy APIï¼ˆä½†å¯ä»¥ä½¿ç”¨NetworkPolicyæ¥æ§åˆ¶å·¥ä½œè´Ÿè½½çš„UDPé€šä¿¡ï¼‰ã€‚

ä¸€ä¸ª`AuthorizationPolicy`èµ„æºæ¸…å•ç”±ä»¥ä¸‹ä¸‰éƒ¨åˆ†ç»„æˆï¼š

- selectorï¼ˆé€‰æ‹©å™¨ï¼‰ï¼šåŒ¹é…ä¸€ç»„è¦æ‰§è¡Œç­–ç•¥çš„ç›®æ ‡ï¼›
- actionï¼ˆåŠ¨ä½œï¼‰ï¼šè¦æ‰§è¡Œçš„åŠ¨ä½œï¼Œå¯ä»¥`DENY`æˆ–`ALLOW`ï¼Œå¦å¤–è¿˜æ”¯æŒ`CUSTOM`å’Œ`AUDIT`åŠ¨ä½œï¼›
    - åŒ…å«`CUSTOM`åŠ¨ä½œçš„ç­–ç•¥æ˜¯å°†åŒ¹é…åçš„è®¿é—®ä¿¡æ¯**å…ˆ**
      äº¤ç»™å¤–éƒ¨ç¨‹åºå†³æ–­ï¼Œè‹¥ç»“æœæ˜¯å…è®¸ï¼Œå†ç”±å…¶ä»–ç­–ç•¥åˆ¤æ–­ã€‚å¹¶ä¸å¸¸ç”¨ï¼Œè¯·å‚è€ƒ [CUSTOMæˆæƒ][CUSTOMæˆæƒ]
      å’Œ [éƒ¨ç½²å¤–éƒ¨æˆæƒ][éƒ¨ç½²å¤–éƒ¨æˆæƒ]ã€‚
- rulesï¼ˆè§„åˆ™é›†åˆï¼‰ï¼šä»€ä¹ˆæ¡ä»¶ä¸‹æ§åˆ¶è°åˆ°è°çš„è®¿é—®ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š
    - `from`å­—æ®µæŒ‡å®šè¯·æ±‚æ¥æºï¼Œæ”¯æŒæŒ‡å®šå‘½åç©ºé—´/è®¤è¯èº«ä»½/æœåŠ¡è´¦å·/IPå—ï¼›
    - `to`å­—æ®µæŒ‡å®šè¯·æ±‚æ–¹æ³•ã€è·¯ç”±å’Œç«¯å£ï¼›
    - `when`å­—æ®µæŒ‡å®šæ¡ä»¶ï¼ˆè§¦å‘æ—¶æœºï¼‰ï¼Œå‚è€ƒ[Istioæˆæƒç­–ç•¥ä¹‹`when`å­—æ®µ][Istioæˆæƒç­–ç•¥ä¹‹`when`å­—æ®µ]ï¼›

**æˆæƒå¼•æ“çš„æ‰§è¡Œè¿‡ç¨‹**

1. è‹¥èŒƒå›´å†…æ²¡æœ‰åˆ›å»ºä»»ä½•ç­–ç•¥ï¼Œåˆ™å…è®¸ï¼›
2. æŒ‰ç…§åŠ¨ä½œ`CUSTOM`->`DENY`->`ALLOW`çš„é¡ºåºä¾æ¬¡åŒ¹é…ç­–ç•¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­**åªè¦æˆåŠŸåŒ¹é…ä¸€ä¸ªæ‹’ç»ç­–ç•¥åˆ™ç«‹å³æ‰§è¡Œ**ï¼›
3. è‹¥æ²¡æœ‰åˆ›å»ºä»»ä½•`ALLOW`ç­–ç•¥ï¼Œåˆ™å…è®¸ï¼›
4. æœ€åï¼Œåœ¨å®šä¹‰äº†`ALLOW`ç­–ç•¥çš„æƒ…å†µä¸‹å´æ²¡æœ‰åŒ¹é…åˆ°ä»»ä½•ä¸€ä¸ªå…è®¸ç­–ç•¥åˆ™æ‹’ç»ã€‚

**åœ¨æ™®é€š TCP åè®®ä¸Šä½¿ç”¨ Istio æˆæƒ**  
Istioæˆæƒç­–ç•¥æ”¯æŒçº¯TCPå’ŒåŸºäºTCPçš„å…¶ä»–åè®®ï¼Œè‹¥åœ¨é’ˆå¯¹çº¯TCPå·¥ä½œè´Ÿè½½çš„æˆæƒç­–ç•¥ä¸­é…ç½®äº†ä»…HTTPæ”¯æŒçš„å­—æ®µå¦‚`methods`ç­‰ï¼Œ
åˆ™Istioå°†å¿½ç•¥è¿™äº›å­—æ®µï¼Œä½†ä¸å½±å“å…¶ä»–å­—æ®µçš„åŒ¹é…è¡Œä¸ºã€‚æ³¨æ„ï¼Œæ‰€æœ‰æˆæƒç­–ç•¥éƒ½å°†ä¸‹å‘ç»™Envoyæ‰§è¡Œï¼Œæ‰€ä»¥è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹æ˜¯é«˜æ•ˆçš„ã€‚
ä»…HTTPæ”¯æŒçš„å­—æ®µå¦‚ä¸‹ï¼š

- `source.request_principals`
- `operation`éƒ¨åˆ†ä¸­çš„ `hosts`ã€`methods` å’Œ `paths` å­—æ®µ
- `when.key`ä¸­çš„`request.headers`ã€`request.auth.claims/principal/audiences/presenter`

ä¸ºäº†æ›´æ¥è¿‘æœ€ä½³å®è·µå’Œå®é™…ç¯å¢ƒï¼Œæ¼”ç¤ºå°†å®Œæˆä»¥ä¸‹ç›®æ ‡ï¼ˆæä¾›æ¨¡æ¿ï¼‰ï¼š

- åˆ›å»ºdefaultç©ºé—´ä¸‹çš„é»˜è®¤æ‹’ç»ç­–ç•¥ï¼›
    - [authz-allow-nothing.yaml](k8s_actions_guide/version1/istio_manifest/authz-allow-nothing.yaml)ï¼›
    - æ³¨æ„ï¼Œè¿™ä¸ä¼šå½±å“UDPé€šä¿¡ï¼›
- åˆ›å»ºä¸€ä¸ªå…è®¸ç­–ç•¥ï¼Œå…è®¸â‘ æ»¡è¶³æ¡ä»¶ä½äº`other_ns`å‘½åç©ºé—´ã€æˆ–ã€‘æœåŠ¡å¸æˆ·ä¸º`cluster.local/ns/default/sa/default`çš„å·¥ä½œè´Ÿè½½
  **é€šè¿‡** â‘¡`GET`å’Œ`POST` æ–¹æ³•è®¿é—®â‘¢defaultå‘½åç©ºé—´ä¸‹ä¸`app: go-multiroute`æ ‡ç­¾åŒ¹é…çš„å·¥ä½œè´Ÿè½½æä¾›çš„â‘£ä»¥`/route`
  ä¸ºå‰ç¼€çš„è·¯ç”±ï¼Œé™„åŠ æ¡ä»¶â‘¤æ˜¯HTTP Headerä¸­åŒ…å«é”®å€¼å¯¹`version: v1`ï¼›
    - [authz-allow-to-go-multiroute.yaml](k8s_actions_guide/version1/istio_manifest/authz-allow-to-go-multiroute.yaml)

æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# é¦–å…ˆéƒ¨ç½²é»˜è®¤æ‹’ç»ç­–ç•¥
$ kubectl apply -f authz-allow-nothing.yaml 
authorizationpolicy.security.istio.io/allow-nothing created

# æ­¤æ—¶ istio-client-test æµ‹è¯•è®¿é—® go-multiroute ä¼šå¾—åˆ°æ˜ç¡®çš„æ‹’ç»è®¿é—®æç¤ºï¼
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v1" go-multiroute:3000/route1
RBAC: access denied

# éƒ¨ç½²ç¬¬äºŒä¸ªç­–ç•¥
$ kubectl apply -f authz-allow-to-go-multiroute.yaml                                    
authorizationpolicy.security.istio.io/allow-to-go-multiroute created

# æŸ¥çœ‹defaultç©ºé—´ä¸­çš„æˆæƒç­–ç•¥åˆ—è¡¨
$ kubectl get authorizationpolicies                                                                                       
NAME                     AGE
allow-nothing            2m
allow-to-go-multiroute   2m

# å¯ä»¥è®¿é—®ï¼Œå› ä¸ºæ»¡è¶³ rules ä¸­æ‰€è¦æ±‚çš„å„ç§æ¡ä»¶
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v1" go-multiroute:3000/route1
[v1] Hello, You are at /route1, Got: route1's content
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v1" go-multiroute:3000/route2
[v1] Hello, You are at /route2, Got: route2's content
$ kubectl exec -it istio-client-test-$POD_ID -- curl -X POST -H "version: v1" go-multiroute:3000/route2
[v1] Hello, You are at /route2, Got: route2's content

# --------- è§‚å¯Ÿä¸‹é¢è¢«æ‹’ç»çš„æƒ…å†µ -----------
# - æ‹’ç»è®¿é—®ï¼ˆheaderä¸ç¬¦åˆï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v2" go-multiroute:3000/route1
RBAC: access denied
# - æ‹’ç»è®¿é—®ï¼ˆmethodä¸ç¬¦åˆï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl -X PATCH -H "version: v1" go-multiroute:3000/route1
RBAC: access denied
# - æ‹’ç»è®¿é—®ï¼ˆè·¯ç”±ä¸ç¬¦åˆï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v1" go-multiroute:3000
RBAC: access denied

# ä¿®æ”¹istio-client-testä½¿ç”¨çš„ServiceAccountä¸º`sa-test`ï¼ˆåˆ›å»ºSAçš„æ­¥éª¤ç•¥ï¼‰
$ kubectl patch deployment istio-client-test -p '{"spec": {"template": {"spec": {"serviceAccountName": "sa-test"}}}}'
deployment.apps/istio-client-test patched
# ~ç­‰å¾…deploymentå†…Podæ›´æ–°å®Œæ¯•
# - æ‹’ç»è®¿é—®ï¼ˆServiceAccountä¸ç¬¦åˆï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl -H "version: v1" go-multiroute:3000/route1
RBAC: access denied
# ï¼ˆä¸ºäº†æ–¹ä¾¿ä¸‹ä¸€èŠ‚çš„æ¼”ç¤ºï¼Œè¯·å›æ»šè¿™æ¬¡patchï¼‰
```

æœ€åï¼Œæœ¬èŠ‚ä¸­çš„ç¤ºä¾‹å¹¶æœªåˆ—å‡ºå¯ç”¨çš„å…¨éƒ¨å­—æ®µï¼Œå¦‚æœ‰å…´è¶£è¯·æŸ¥çœ‹[Istioæˆæƒç­–ç•¥è§„èŒƒ][Istioæˆæƒç­–ç•¥è§„èŒƒ]ã€‚å…¶ä»–å¯ä¾›å‚è€ƒçš„æ–‡æ¡£ï¼š

- [ä¸º Ingress ç½‘å…³é…ç½®æˆæƒ](https://istio.io/latest/zh/docs/ops/configuration/security/security-policy-examples/)
- [ä¸º TCP å·¥ä½œè´Ÿè½½é…ç½®æˆæƒ](https://istio.io/latest/zh/docs/tasks/security/authorization/authz-tcp/)

**æ¸…ç†**

```shell
kubectl delete -f authz-allow-nothing.yaml
kubectl delete -f authz-allow-to-go-multiroute.yaml
```

##### 8.4.5.5 Istioç‰¹æ€§ä¹‹æµé‡ç®¡ç†

Istioçš„[æµé‡ç®¡ç†][Istioæµé‡ç®¡ç†]å¯ä»¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- æ™ºèƒ½è·¯ç”±ï¼šå¯¹åˆ°è¾¾K8s Serviceçš„HTTPæµé‡æ ¹æ®æƒé‡/HTTP-Header/sourceLabelsç­‰ç»´åº¦è¿›è¡Œ**åˆ†æµ**ï¼ŒåŸºäºæ­¤å¯è½»æ¾å®ç°ç°åº¦å‘å¸ƒã€A/B
  æµ‹è¯•ã€é‡‘ä¸é›€å‘å¸ƒç­‰éƒ¨ç½²ç­–ç•¥ï¼›
- æœåŠ¡å‘ç°ã€å¥åº·æ£€æŸ¥ï¼šEnvoyä»£ç†ä¼šä¸»åŠ¨å‘ç°éœ€è¦å…³å¿ƒçš„åç«¯æœåŠ¡çš„ç«¯ç‚¹åˆ—è¡¨ï¼Œå¹¶é€šè¿‡å¥åº·æ£€æŸ¥ç§»é™¤å¤±æ•ˆçš„ç«¯ç‚¹ï¼›
- è´Ÿè½½å‡è¡¡ï¼šEnvoyä»£ç†ä¼šæ ¹æ®é¢„è®¾çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆå¦‚éšæœºã€è½®è¯¢ã€åŠ æƒè½®è¯¢å’Œæœ€å°‘è¿æ¥ç­‰ï¼‰å°†è¯·æ±‚å‡åŒ€åœ°åˆ†å‘åˆ°åç«¯æœåŠ¡ï¼›
    - åœ¨é€‰æ‹©å…·ä½“çš„è´Ÿè½½å‡è¡¡ç®—æ³•ä¹‹å‰ï¼ŒEnvoyæ”¯æŒä¸‰ç§ç±»å‹çš„è´Ÿè½½å‡è¡¡å™¨ï¼ˆä¸åŒç±»å‹æ”¯æŒä¸åŒç®—æ³•ï¼‰ï¼š
        - simpleï¼šåŸºäºå¸¸ç”¨è´Ÿè½½å‡è¡¡ç®—æ³•çš„ç®€å•è´Ÿè½½å‡è¡¡
        - consistentHashLBï¼šåŸºäºä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„è´Ÿè½½å‡è¡¡
        - localityLbSettingï¼šåŸºäºåœ°åŸŸçš„æœ¬åœ°æ€§è´Ÿè½½å‡è¡¡
- æœåŠ¡å¼¹æ€§ï¼šæ”¯æŒä¸ºåç«¯é…ç½®é™é€Ÿã€ç†”æ–­ã€è¶…æ—¶å’Œé‡è¯•ç­‰å¼¹æ€§èƒ½åŠ›ï¼›
- æ•…éšœæ³¨å…¥ï¼šæ”¯æŒå¯¹åç«¯æœåŠ¡è¿›è¡Œæ•…éšœæ³¨å…¥ï¼Œæ¨¡æ‹ŸæœåŠ¡æ•…éšœï¼Œä»¥ä¾¿è¿›è¡ŒæœåŠ¡å¼¹æ€§æµ‹è¯•ã€‚ä¹Ÿå¯ç”¨æ¥å®ç°æ‰‹åŠ¨ç†”æ–­çš„ç›®çš„ï¼›
- æµé‡é•œåƒï¼šä¹Ÿç§°ä¸ºå½±å­æµé‡ï¼Œç”¨äºå°†å®æ—¶æµé‡çš„å‰¯æœ¬å‘é€åˆ°å¦ä¸€ç»„åç«¯ï¼Œä¸€èˆ¬ç”¨äºçº¿ä¸Šæµé‡åˆ†æã€ç»Ÿè®¡å’Œç¨‹åºæµ‹è¯•ç­‰ç”¨é€”ï¼›
- Ingresså’ŒEgressï¼šæ§åˆ¶ Istio æœåŠ¡ç½‘æ ¼çš„å…¥ç«™æµé‡å’Œå…¥ç«™æµé‡ï¼Œå‰è€…å¯ä»¥æ›¿ä»£K8så†…ç½®çš„Ingressã€‚

ä»¥ä¸Šè¿™äº›ç‰¹æ€§æ˜¯é€šè¿‡Istioé¢„å®‰è£…çš„ `VirtualService` å’Œ `DestinationRule` ä¸¤ä¸ªK8s APIèµ„æºå®ç°çš„ï¼Œå®ƒä»¬åˆ†åˆ«å®šä¹‰äº†è·¯ç”±è§„åˆ™å’Œç›®æ ‡è§„åˆ™ã€‚
é€šä¿—æ¥è¯´ï¼Œ`VirtualService`å®šä¹‰äº†å¦‚ä½•è¿›è¡Œè·¯ç”±ï¼ˆHowï¼‰ï¼Œ`DestinationRule`å®šä¹‰äº†è·¯ç”±åˆ°å“ªå„¿ï¼ˆWhereï¼‰ï¼Œ
ä¸€å®šç¨‹åº¦ä¸Šæ˜¯**å‰è€…å¼•ç”¨åè€…**çš„å…³ç³»ã€‚

> æ³¨æ„ï¼šVirtualServiceå’ŒDestinationRuleèµ„æºå¹¶ä¸æ˜¯å¼ºç»‘å®šçš„å…³ç³»ï¼Œå®ƒä»¬å¯ä»¥å„è‡ªå®šä¹‰å¹¶ç‹¬ç«‹å·¥ä½œï¼Œ
> ä»…åœ¨å®šä¹‰subsetï¼ˆå­é›†ï¼‰æ—¶å‰è€…æ‰ä¼šä¾èµ–åè€…ã€‚ä½†åªæœ‰å°†äºŒè€…ç»“åˆä½¿ç”¨æ‰èƒ½å……åˆ†åº”ç”¨Istioä¸°å¯Œçš„æµé‡ç®¡ç†ç‰¹æ€§ã€‚

ä¸ºäº†å°½å¯èƒ½æ¨¡æ‹Ÿå®é™…ç¯å¢ƒï¼Œæœ¬èŠ‚æ¼”ç¤ºå†…å®¹å°†å¢åŠ ä¸€ä¸ªåä¸º `go-multiroute-v2` çš„æœåŠ¡ç‰ˆæœ¬æ¨¡æ‹Ÿé‡‘ä¸é›€å‘å¸ƒï¼Œ
å®ƒä¸ä¹‹å‰éƒ¨ç½²çš„ç‰ˆæœ¬åŒºåˆ«åœ¨äºæ¨¡æ¿ä¸­å®šä¹‰äº†ä¸åŒçš„ç¯å¢ƒå˜é‡`VERSION`ï¼Œç›¸å…³èµ„æºå¦‚ä¸‹ï¼š

- [deployment-v2.yaml](k8s_actions_guide/version1/base_manifest/deployment-v2.yaml)

æ–°ç‰ˆæœ¬çš„å·¥ä½œè´Ÿè½½çš„éƒ¨ç½²æ­¥éª¤ç•¥ã€‚æœ¬æ¬¡æ¼”ç¤ºå°†å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

- æ™ºèƒ½è·¯ç”±ï¼šå¯¹å‘é€åˆ°Serviceï¼šgo-multirouteçš„æµé‡è¿›è¡ŒæŒ‰æ¯”ä¾‹åˆ†æµï¼Œå³Deployment `go-multiroute` å’Œ `go-multiroute-v2`
  åˆ†åˆ«æ¥æ”¶80%å’Œ20%çš„æµé‡ï¼›åŒæ—¶å°†HTTP Headerä¸­æºå¸¦ `test-version: v2` çš„è¯·æ±‚å…¨éƒ¨è·¯ç”±åˆ°`go-multiroute-v2`ï¼›
- è´Ÿè½½å‡è¡¡ï¼šåˆ†æµä¹‹åï¼Œå¯¹å‘é€åˆ°æ¯ä¸ªDeploymentæ§åˆ¶ä¸‹çš„Podå®ä¾‹çš„æµé‡è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œä½¿ç”¨éšæœºç®—æ³•ï¼›
- æœåŠ¡å¼¹æ€§ï¼šå¯¹å‘é€åˆ°Serviceï¼šgo-multirouteçš„æµé‡é™åˆ¶æœ€å¤š5ä¸ªè¯·æ±‚çš„å¹¶å‘æ•°ï¼Œå¹¶é…ç½®ç†”æ–­ã€è¶…æ—¶æœºåˆ¶ï¼›

æ–°å¢ä¸‹é¢çš„YAMLæ¸…å•ï¼š

- [route-destinationrule.yaml](k8s_actions_guide/version1/istio_manifest/route-destinationrule.yaml)
- [route-virtualservice.yaml](k8s_actions_guide/version1/istio_manifest/route-virtualservice.yaml)

æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# éƒ¨ç½²æµé‡ç­–ç•¥
$ kubectl apply -f route-destinationrule.yaml -f route-virtualservice.yaml
destinationrule.networking.istio.io/go-multiroute created
virtualservice.networking.istio.io/go-multiroute created

# ç°åœ¨è¿›å…¥client podéªŒè¯å„é¡¹é…ç½®æ˜¯å¦ç”Ÿæ•ˆ
$ kubectl exec -it istio-client-test-$POD_ID -- sh

# 8æ¯”2çš„æƒé‡åˆ†æµï¼šè®¿é—®10æ¬¡ï¼Œè§‚å¯Ÿè¿”å›ç»“æœï¼ˆæ¯ä¸ªç»“æœçš„å‰4ä¸ªå­—ç¬¦è¡¨ç¤ºå“åº”çš„deploymentç‰ˆæœ¬ï¼‰
/ $ for i in $(seq 1 10); do curl -s go-multiroute:3000/route1 && sleep 1 && echo; done
[v2] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content
[v1] Hello, You are at /route1, Got: route1's content

# æµ‹è¯•ç‰¹å®šheaderçš„åˆ†æµ
/ $ for i in $(seq 1 5); do curl -s -H "test-version: v2" go-multiroute:3000/route1 && sleep 1 && echo; done
[v2] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content
[v2] Hello, You are at /route1, Got: route1's content

# æµ‹è¯•åˆ†æµåçš„è´Ÿè½½å‡è¡¡ï¼šè½®è¯¢ï¼ˆå¯è§‚å¯Ÿåˆ°v1ç‰ˆæœ¬çš„ipåˆ†å¸ƒæ˜¯å‡è¡¡çš„ï¼‰
/ $ for i in $(seq 1 10); do curl -s go-multiroute:3000/get_ip && sleep 1 && echo; done
[v2] Hello, Your ip is 20.2.36.111
[v2] Hello, Your ip is 20.2.36.112
[v1] Hello, Your ip is 20.2.36.113
[v1] Hello, Your ip is 20.2.36.114
[v1] Hello, Your ip is 20.2.36.113
[v1] Hello, Your ip is 20.2.36.114
[v1] Hello, Your ip is 20.2.36.113
[v2] Hello, Your ip is 20.2.36.111
[v1] Hello, Your ip is 20.2.36.114
[v1] Hello, Your ip is 20.2.36.113

# æµ‹è¯•è¶…æ—¶
# - ç”±äºæ¥å£ /test_timeout ä¼šç­‰å¾…3så†è¿”å›ï¼Œè¶…è¿‡äº†ç­–ç•¥ä¸­çš„2sï¼Œæ‰€ä»¥ä¼šè¶…æ—¶
/ $ for i in $(seq 1 3); do curl -s go-multiroute:3000/test_timeout && echo " $(date)"; done
upstream request timeout Thu Mar 14 05:47:29 UTC 2024
upstream request timeout Thu Mar 14 05:47:30 UTC 2024
upstream request timeout Thu Mar 14 05:47:31 UTC 2024

# æµ‹è¯•ç†”æ–­
# - ç”±äºServiceï¼šgo-multirouteç›®å‰çš„ç«¯ç‚¹è¾ƒå¤šï¼ˆ2ä¸ªDeploymentå…±4ä¸ªPodå¯¹åº”4ä¸ªç«¯ç‚¹ï¼‰ï¼Œä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿæµ‹è¯•ç»“æœï¼Œå…ˆåˆ é™¤deployment-v1ï¼ˆæ“ä½œç•¥ï¼‰ã€‚
# - ç°åœ¨åªå‰©ä¸‹deployment-v2ï¼Œå…¶ä¸­Podå‰¯æœ¬æ•°ä¸º2ï¼Œå°†å…¶æ”¹ä¸º1ï¼Œæ“ä½œç•¥ã€‚è€Œä¸”è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸ºè½®è¯¢ï¼Œæ ¹æ®å¦‚ä¸‹ç†”æ–­ç­–ç•¥è®¡ç®—ï¼š
#    outlierDetection: # å®šä¹‰ç†”æ–­ç­–ç•¥
#      consecutive5xxErrors: 3 # æŒ‡å®šè¿ç»­å¤šå°‘ä¸ª 5xx é”™è¯¯ä¼šå¯¼è‡´ç«¯ç‚¹è¢«å‰”é™¤ï¼Œé»˜è®¤5ï¼Œ0è¡¨ç¤ºç¦ç”¨ï¼ˆä½†æ˜¯æ—¶é—´çª—å£æœªçŸ¥ï¼‰
#      interval: 1s # ç†”æ–­æ£€æµ‹é—´éš”ï¼Œé»˜è®¤10sï¼Œè¦æ±‚>=1ms
#      baseEjectionTime: 10s # åˆå§‹çš„ç«¯ç‚¹å‰”é™¤æ—¶é—´ï¼Œæ”¯æŒå•ä½ ms s m hï¼Œé»˜è®¤30sï¼Œè¦æ±‚>=1ms
#      maxEjectionPercent: 100
# å³æœ€å°‘å¹¶å‘3(=1x3)ä¸ªè¯·æ±‚åï¼Œå°†è§¦å‘ç†”æ–­ï¼Œ10såæ¢å¤ï¼ˆå‘½ä»¤å°¾éƒ¨çš„&è¡¨ç¤ºå¹¶å‘ï¼‰
# - è§‚å¯Ÿ3ä¸ªè¯·æ±‚å“åº”çŠ¶æ€ç å‡ä¸º500ï¼Œå› æ­¤ä¼šç«‹å³è§¦å‘ç†”æ–­ï¼Œä¸‹ä¸€æ­¥è¿›è¡ŒéªŒè¯
/ $ seq 3 | xargs -I {} sh -c 'curl -s -H "test-version:v2" -H "need_500:true" http://go-multiroute:3000/test_circuit_breaker &' && echo $(date)
Fri Mar 15 06:17:41 UTC 2024
[v2] test_circuit_breaker returned 500
[v2] test_circuit_breaker returned 500
[v2] test_circuit_breaker returned 500

# ç«‹å³æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤éªŒè¯ç†”æ–­ç­–ç•¥å·²è§¦å‘
# - ä¸‹é¢çš„å‘½ä»¤æ˜¯ä»¥1æ¬¡/1sçš„é¢‘ç‡é¡ºåºæ‰§è¡Œ12ä¸ªHTTPè¯·æ±‚
# - è§‚å¯Ÿå‰å‡ ä¸ªå“åº”å†…å®¹æ˜¯æ¥è‡ªEnvoyçš„no healthy upstreamï¼Œè¯´æ˜ç†”æ–­ç­–ç•¥å·²è§¦å‘ï¼Œå¹¶åœ¨çº¦10såæ¢å¤ï¼ˆä¹‹ååˆè§¦å‘ï¼‰
/ $ seq 12 | xargs -I {} sh -c 'curl -s -H "test-version:v2" http://go-multiroute:3000/test_circuit_breaker && echo " $(date)" && sleep 1'
no healthy upstream Fri Mar 15 06:17:44 UTC 2024
no healthy upstream Fri Mar 15 06:17:45 UTC 2024
no healthy upstream Fri Mar 15 06:17:46 UTC 2024
no healthy upstream Fri Mar 15 06:17:47 UTC 2024
no healthy upstream Fri Mar 15 06:17:48 UTC 2024
no healthy upstream Fri Mar 15 06:17:49 UTC 2024
no healthy upstream Fri Mar 15 06:17:50 UTC 2024
[v2] test_circuit_breaker returned 500
 Fri Mar 15 06:17:51 UTC 2024   <--- çº¦10såæ¢å¤ï¼
[v2] test_circuit_breaker returned 500
 Fri Mar 15 06:17:52 UTC 2024
[v2] test_circuit_breaker returned 500
 Fri Mar 15 06:17:53 UTC 2024
no healthy upstream Fri Mar 15 06:17:54 UTC 2024
no healthy upstream Fri Mar 15 06:17:55 UTC 2024

# æµ‹è¯•æœ€å¤§å¹¶å‘æ•°â‘ 
# - ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œè¿™é‡Œæš‚æ—¶æ³¨é‡Šç†”æ–­ç­–ç•¥é…ç½®ï¼Œä»¥åŠå°†deployment-v2çš„å‰¯æœ¬æ•°æ”¹ä¸º1ï¼ˆæ“ä½œç•¥ï¼‰
# - è¿›å…¥é»˜è®¤å®¹å™¨å†…è¿›è¡Œå¹¶å‘è®¿é—®ï¼ˆé…ç½®æœ€å¤§å¹¶å‘æ•°5ï¼Œæµ‹è¯•å¹¶å‘æ•°8ï¼Œç»“æœä¸­5ä¸ªå“åº”æˆåŠŸï¼Œ3ä¸ªè¶…æ—¶ï¼‰
/ $ seq 8 | xargs -I {} sh -c 'curl -s http://go-multiroute:3000/test_limiter &'
[v1] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
upstream request timeoutupstream request timeoutupstream request timeout

# æµ‹è¯•æœ€å¤§å¹¶å‘æ•°â‘¡
# - ä¿®æ”¹é…ç½®ä¸­çš„æœ€å¤§å¹¶å‘æ•°ä¸º3ï¼Œæ“ä½œç•¥
# - å¯è§‚å¯Ÿåˆ°æµ‹è¯•å¹¶å‘æ•°6ï¼Œç»“æœä¸­3ä¸ªå“åº”æˆåŠŸï¼Œ3ä¸ªè¶…æ—¶ï¼‰
# - ä¹‹æ‰€ä»¥è¶…æ—¶æ˜¯å› ä¸ºè¯¥æ¥å£é»˜è®¤sleep 1sï¼Œå¯¹äºéå¹¶å‘æ‰§è¡Œçš„è¯·æ±‚ï¼Œå…¶å“åº”è€—æ—¶å¿…å°†è¶…è¿‡1sï¼Œåˆ™è§¦å‘ VirtualService ä¸­çš„timeout: 1200ms
/ $ seq 6 | xargs -I {} sh -c 'curl -s -H "test-version:v2" http://go-multiroute:3000/test_limiter &'
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
[v2] Hello, You are at /test_limiter, Got: test_limiter's content
upstream request timeoutupstream request timeoutupstream request timeout
```

**å®Œæ•´çš„é‡‘ä¸é›€å‘å¸ƒ**

é€šè¿‡`VirtualService`APIå¯ä»¥å®ç°å°†æµé‡è·¯ç”±åˆ°ä¸åŒç‰ˆæœ¬çš„æœåŠ¡ï¼ˆPodç»„ï¼‰ï¼Œè¿™æ˜¯ç¬¬ä¸€æ­¥ï¼›åˆ†æµä»¥åï¼Œæˆ‘ä»¬éœ€è¦è§‚å¯Ÿä¸€æ®µæ—¶é—´å†…v2ç‰ˆæœ¬æœåŠ¡çš„è¯·æ±‚å¤„ç†æ˜¯å¦æ­£å¸¸ï¼Œè¿™æ˜¯ç¬¬äºŒæ­¥ï¼›
è‹¥ä¸æ­£å¸¸ï¼Œåˆ™éœ€è¦å›æ»šï¼Œå°†æµé‡å…¨éƒ¨è·¯ç”±å›v1ç‰ˆæœ¬ã€‚è‹¥åŸºæœ¬æ­£å¸¸ï¼Œåˆ™å¯ä»¥è¿›è¡Œç¬¬ä¸‰æ­¥ï¼Œå³ä¿®æ”¹`VirtualService`æ¸…å•ä¸­çš„è·¯ç”±è§„åˆ™ï¼Œ
å°†æ‰€æœ‰æµé‡ä»…è·¯ç”±åˆ°v2ç‰ˆæœ¬å³å¯ï¼›æœ€åï¼Œç»§ç»­è§‚å¯Ÿä¸€æ®µæ—¶é—´ï¼Œç¡®ä¿v2ç‰ˆæœ¬æœåŠ¡ç¨³å®šï¼Œåˆ™å¯ä»¥åˆ é™¤v1ç‰ˆæœ¬æœåŠ¡äº†ã€‚

**æ¸…ç†**

```shell
$ kubectl delete -f route-destinationrule.yaml -f route-virtualservice.yaml
destinationrule.networking.istio.io "go-multiroute" deleted
virtualservice.networking.istio.io "go-multiroute" deleted
```

##### 8.4.5.6 æµé‡ç®¡ç†ä¹‹Ingressç½‘å…³

ä¸K8så†…ç½®çš„Ingressç±»ä¼¼ï¼Œå¦‚æœä½ æŒ‰ç…§å‰é¢çš„[å®‰è£…æ­¥éª¤](#8431-å®‰è£…)Istioåœ¨å®‰è£…æ—¶ä¹Ÿéƒ¨ç½²äº†ä¸€ä¸ªIngress
ç½‘å…³ï¼ˆæœ¬è´¨æ˜¯Envoyï¼‰æ¥ç®¡ç†é›†ç¾¤çš„å…¥ç«™æµé‡ï¼Œå®ƒå¯ä»¥ç”¨æ¥æ›¿æ¢K8så†…ç½®çš„Ingressï¼Œ
å¥½å¤„æ˜¯å®ƒå…·æœ‰æ›´ç»†ç²’åº¦çš„æ§åˆ¶åŠŸèƒ½ã€‚

> æ³¨æ„ï¼šK8s Ingressä¹Ÿå¯ä¸Istioç½‘æ ¼ååŒå·¥ä½œã€‚

å¦‚æœæ²¡æœ‰å®‰è£…Ingressç½‘å…³ï¼Œä½¿ç”¨`istioctl install`å‘½ä»¤å®‰è£…å³å¯ã€‚ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æ£€æŸ¥æ˜¯å¦å®‰è£…ï¼š

```shell
$ kubectl get deploy,svc,hpa -n istio-system |grep gateway -B 1
NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-ingressgateway   1/1     1            1           3d7h
--
NAME                           TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                      AGE
service/istio-ingressgateway   LoadBalancer   20.1.185.158   <pending>     15021:31132/TCP,80:31227/TCP,443:30215/TCP   3d7h
--
NAME                                                       REFERENCE                         TARGETS         MINPODS   MAXPODS   REPLICAS   AGE
horizontalpodautoscaler.autoscaling/istio-ingressgateway   Deployment/istio-ingressgateway   <unknown>/80%   1         5         1          3d7
```

å¯è§Ingressç½‘å…³æ˜¯ä»¥Deploymentå½¢å¼éƒ¨ç½²ï¼Œå¹¶ä¸”è¿˜åˆ›å»ºäº†ä¸€ä¸ªHPAä»¥ä¾›Podå‰¯æœ¬å¼¹æ€§ä¼¸ç¼©ã€‚æœ€åï¼ŒIstioä¸ºIngressç½‘å…³åˆ›å»ºäº†ä¸€ä¸ªLoadBalancerç±»å‹çš„Serviceï¼Œå°†å…¶å¯¹å¤–æš´éœ²ã€‚
ä½†ç”±äºç¬”è€…çš„é›†ç¾¤æ˜¯è‡ªå»ºçš„ï¼Œæ‰€ä»¥æ— æ³•ä¸ºLoadBalancerç±»å‹çš„Serviceåˆ†é…ä¸€ä¸ªå¤–éƒ¨çš„å…¬ç½‘IPï¼Œä½†æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒçš„ `CLUSTER-IP`
å­—æ®µå³`20.1.185.158`æ¥åšé›†ç¾¤å†…çš„è®¿é—®æµ‹è¯•ã€‚

ä¸K8s Ingressä¸åŒçš„æ˜¯ï¼ŒIstio Ingressç½‘å…³çš„ç¼–ç¨‹æ–¹å¼æ˜¯ä¸€ä¸ªGateway èµ„æºç»‘å®šä¸€ä¸ªVirtualService èµ„æºçš„ç»„åˆã€‚å½“ç„¶ä¹Ÿéå¸¸ç®€å•ï¼Œ
ä½ å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ¼”ç¤ºæ¥äº†è§£å…·ä½“ç»†èŠ‚ã€‚

æœ¬èŠ‚æ¼”ç¤ºè¦å®ç°çš„ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼šå°†`Service: go-multiroute`çš„3000ç«¯å£é€šè¿‡Ingresså¯¹å¤–æš´éœ²åˆ°80å’Œ443ç«¯å£ï¼Œ
ä½¿ç”¨è¯ä¹¦å¯¹åº”çš„åŸŸåæ˜¯ï¼š`*.foobar.com`ï¼Œç„¶ååœ¨ä»»ä¸€é›†ç¾¤èŠ‚ç‚¹ä¸Šè¿›è¡Œè®¿é—®æµ‹è¯•ã€‚
æ–°å¢çš„èµ„æºæ¸…å•æ–‡ä»¶å¦‚ä¸‹ï¼š

- [ingress-gwy.yaml](k8s_actions_guide/version1/istio_manifest/ingress-gwy.yaml)
- [ingress-virtualservice.yaml](k8s_actions_guide/version1/istio_manifest/ingress-virtualservice.yaml)

å…·ä½“æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# 1. å› ä¸ºä½¿ç”¨äº†HTTPSåè®®ï¼Œæ‰€ä»¥å…ˆä¸ºæœåŠ¡ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦

# - 1.1 ç”Ÿæˆæ ¹ç§é’¥å’Œæ ¹è¯ä¹¦
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 \
  -subj '/O=example Inc./CN=example.com' \
  -keyout ca.key -out ca.crt
openssl x509 -noout -text -in ca.crt # check crt

# - 1.2 ä½¿ç”¨æ ¹è¯ä¹¦å’Œæ ¹ç§é’¥ä¸ºæ³›åŸŸå *.foobar.com ç”Ÿæˆç§é’¥å’Œè¯ä¹¦ï¼ˆfoobar.key | foobar.crtï¼‰
openssl genrsa -out foobar.key 2048
openssl req -key foobar.key -new -out foobar.csr -subj '/C=US/ST=California/CN=*.foobar.com/O=My Company'
openssl x509 -req -in foobar.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out foobar.crt -days 365

# 2. åˆ›å»ºç½‘å…³ä½¿ç”¨çš„secretï¼ˆåªèƒ½åœ¨istio-systemç©ºé—´ä¸‹åˆ›å»ºæ‰èƒ½è¢«æ‰¾åˆ°ï¼‰
kubectl create secret tls cert-foobar --cert=foobar.crt --key=foobar.key -n istio-system

# - ä½¿ç”¨istioctlæŸ¥çœ‹ç½‘å…³Podå…³è”çš„secretï¼ˆæœ€åä¸€ä¸ªå‚æ•°æ˜¯<POD>.[ns]çš„æ ¼å¼ï¼‰
$ ./istioctl pc secret istio-ingressgateway-d4db74f5b-l44h4.istio-system
RESOURCE NAME                TYPE           STATUS     VALID CERT     SERIAL NUMBER                        NOT AFTER                NOT BEFORE
default                      Cert Chain     ACTIVE     true           653e6e499c6dd8ac7309498fa7ee7dd5     2024-03-17T12:28:45Z     2024-03-16T12:26:45Z
kubernetes://cert-foobar     Cert Chain     ACTIVE     true           aaec8a8aee3fc3f9                     2024-04-15T15:49:40Z     2024-03-16T15:49:40Z
ROOTCA                       CA             ACTIVE     true           f915f3f5c5b3b5ffe27c8b3894d3d2bb     2034-03-11T04:58:57Z     2024-03-13T04:58:57Z


# 3. åˆ›å»ºGatewayå’ŒVirtualService
kubectl apply -f ingress-gwy.yaml -f ingress-virtualservice.yaml

# ä½¿ç”¨istioctlæŸ¥çœ‹ç½‘å…³è·¯ç”±
$ ./istioctl pc routes istio-ingressgateway-d4db74f5b-l44h4.istio-system
NAME          VHOST NAME                                       DOMAINS                                                   MATCH                  VIRTUAL SERVICE
http.8080     go-multiroute.default.svc.cluster.local:8080     go-multiroute.default.svc.cluster.local, *.foobar.com     /*                     ingress-go-multiroute.default
              backend                                          *                                                         /healthz/ready*        
              backend                                          *                                                         /stats/prometheus*

# 4.1 ä»»ä½•ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šè¿›è¡ŒHTTPè®¿é—®
$ curl -H "Host: go-multiroute.default.svc.cluster.local" 20.1.185.158/route1  
[v2] Hello, You are at /route1, Got: route1's content
$ curl -H "Host: x.foobar.com" 20.1.185.158/route1 
[v2] Hello, You are at /route1, Got: route1's content
$ curl 20.1.185.158/route1 -w %{http_code}% # ä¸å¸¦åŒ¹é…ä¸»æœºåçš„Hostå¤´éƒ¨ä¼šè¢«å½“åš404å¤„ç†
404

# 4.2 ç°åœ¨è¿›è¡ŒHTTPSè®¿é—®
$ echo '20.1.185.158 go-multiroute.default.svc.cluster.local' >> /etc/hosts
$ echo '20.1.185.158 x.foobar.com' >> /etc/hosts
# -k ç¦ç”¨å®¢æˆ·ç«¯å¯¹æœåŠ¡å™¨è¯ä¹¦çš„æ£€æŸ¥ï¼ˆå› ä¸ºæ ¹è¯ä¹¦æ²¡æœ‰å¯¹go-multiroute...è¿™ä¸ªåœ°å€ç”Ÿæˆè¿‡è¯ä¹¦ï¼‰
$ curl -k -H "Host: go-multiroute.default.svc.cluster.local" https://go-multiroute.default.svc.cluster.local/route1
[v2] Hello, You are at /route1, Got: route1's content
$ curl --cacert ./ca.crt https://x.foobar.com/route1   
[v2] Hello, You are at /route1, Got: route1's content
```

æ¼”ç¤ºå®Œæˆã€‚ä¸‹é¢æˆ‘ä»¬ç®€å•çœ‹ä¸€ä¸‹ç½‘å…³çš„ä¸€äº›è¿è¡Œæ—¶ä¿¡æ¯ï¼š

```shell
# listeneræ˜¯å½“å‰ç½‘å…³Podï¼ˆEnvoyï¼‰è¿è¡Œæ—¶ç›‘å¬çš„ç«¯å£ä»¥åŠå¯¹åº”æœåŠ¡ã€‚è¿™é‡Œå‰ä¸¤è¡Œå°±æ˜¯æˆ‘ä»¬åˆšæ‰çš„é…ç½®
$ ./istioctl pc listener istio-ingressgateway-d4db74f5b-l44h4.istio-system
ADDRESSES PORT  MATCH                                                     DESTINATION
0.0.0.0   8080  ALL                                                       Route: http.8080
0.0.0.0   8443  SNI: *.foobar.com,go-multiroute.default.svc.cluster.local Route: https.8443.https.ingress-go-multiroute.default
0.0.0.0   15021 ALL                                                       Inline Route: /healthz/ready*
0.0.0.0   15090 ALL                                                       Inline Route: /stats/prometheus*

# routesæ˜¯å½“å‰ç½‘å…³Podï¼ˆEnvoyï¼‰è¿è¡Œæ—¶ç»´æŠ¤çš„è·¯ç”±è§„åˆ™ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆšæ‰é…ç½®çš„ä¸¤æ¡è§„åˆ™
# - æ³¨æ„è§‚å¯Ÿã€VIRTUAL SERVICEã€‘åˆ—ï¼Œè¯¥åˆ—é404å³è¯´æ˜ç½‘å…³å†…é…ç½®çš„ç›®æ ‡æˆåŠŸåŒ¹é…åˆ°äº†å®šä¹‰çš„è™šæ‹Ÿè·¯ç”±ï¼
$ ./istioctl pc routes istio-ingressgateway-d4db74f5b-l44h4.istio-system
NAME                                               VHOST NAME                                       DOMAINS                                                   MATCH                  VIRTUAL SERVICE
http.8080                                          go-multiroute.default.svc.cluster.local:8080     go-multiroute.default.svc.cluster.local, *.foobar.com     /*                     ingress-go-multiroute.default
https.8443.https.ingress-go-multiroute.default     go-multiroute.default.svc.cluster.local:8443     go-multiroute.default.svc.cluster.local, *.foobar.com     /*                     ingress-go-multiroute.default
                                                   backend                                          *                                                         /healthz/ready*        
                                                   backend                                          *                                                         /stats/prometheus*     

# clustersæ˜¯å½“å‰ç½‘å…³Podï¼ˆEnvoyï¼‰è¿è¡Œæ—¶ç»´æŠ¤çš„åç«¯ï¼ˆenvoyä¸­ç§°ä¸ºclusterï¼‰åˆ—è¡¨
$ ./istioctl pc clusters istio-ingressgateway-d4db74f5b-l44h4.istio-system
SERVICE FQDN                                            PORT      SUBSET     DIRECTION     TYPE           DESTINATION RULE
BlackHoleCluster                                        -         -          -             STATIC         
agent                                                   -         -          -             STATIC         
go-multiroute.default.svc.cluster.local                 3000      -          outbound      EDS            
istio-ingressgateway.istio-system.svc.cluster.local     80        -          outbound      EDS            
istio-ingressgateway.istio-system.svc.cluster.local     443       -          outbound      EDS            
istio-ingressgateway.istio-system.svc.cluster.local     15021     -          outbound      EDS            
istiod.istio-system.svc.cluster.local                   443       -          outbound      EDS            
istiod.istio-system.svc.cluster.local                   15010     -          outbound      EDS            
istiod.istio-system.svc.cluster.local                   15012     -          outbound      EDS            
istiod.istio-system.svc.cluster.local                   15014     -          outbound      EDS            
kube-dns.kube-system.svc.cluster.local                  53        -          outbound      EDS            
kube-dns.kube-system.svc.cluster.local                  9153      -          outbound      EDS            
kubernetes.default.svc.cluster.local                    443       -          outbound      EDS            
prometheus_stats                                        -         -          -             STATIC         
sds-grpc                                                -         -          -             STATIC         
xds-grpc                                                -         -          -             STATIC         
zipkin                                                  -         -          -             STRICT_DNS  

# endpointæ˜¯ç½‘å…³Podï¼ˆEnvoyï¼‰è¿è¡Œæ—¶ç»´æŠ¤çš„clusterèƒŒåçš„æ‰€æœ‰ç«¯ç‚¹å¥åº·çŠ¶æ€ï¼ˆæ¯”å¦‚ä¸€ä¸ªserviceåé¢å¯èƒ½æœ‰å‡ ä¸ªpodï¼Œå°±éƒ½ä¼šå±•ç¤ºåœ¨è¿™é‡Œï¼‰
$ ./istioctl pc endpoint istio-ingressgateway-d4db74f5b-l44h4.istio-system
ENDPOINT                                                STATUS      OUTLIER CHECK     CLUSTER
127.0.0.1:15000                                         HEALTHY     OK                prometheus_stats
127.0.0.1:15020                                         HEALTHY     OK                agent
192.168.31.2:6443                                       HEALTHY     OK                outbound|443||kubernetes.default.svc.cluster.local
20.2.36.83:53                                           HEALTHY     OK                outbound|53||kube-dns.kube-system.svc.cluster.local
20.2.36.83:9153                                         HEALTHY     OK                outbound|9153||kube-dns.kube-system.svc.cluster.local
20.2.36.86:8080                                         HEALTHY     OK                outbound|80||istio-ingressgateway.istio-system.svc.cluster.local
20.2.36.86:8443                                         HEALTHY     OK                outbound|443||istio-ingressgateway.istio-system.svc.cluster.local
20.2.36.86:15021                                        HEALTHY     OK                outbound|15021||istio-ingressgateway.istio-system.svc.cluster.local
20.2.36.89:3000                                         HEALTHY     OK                outbound|3000||go-multiroute.default.svc.cluster.local
20.2.36.90:53                                           HEALTHY     OK                outbound|53||kube-dns.kube-system.svc.cluster.local
20.2.36.90:9153                                         HEALTHY     OK                outbound|9153||kube-dns.kube-system.svc.cluster.local
20.2.36.91:15010                                        HEALTHY     OK                outbound|15010||istiod.istio-system.svc.cluster.local
20.2.36.91:15012                                        HEALTHY     OK                outbound|15012||istiod.istio-system.svc.cluster.local
20.2.36.91:15014                                        HEALTHY     OK                outbound|15014||istiod.istio-system.svc.cluster.local
20.2.36.91:15017                                        HEALTHY     OK                outbound|443||istiod.istio-system.svc.cluster.local
unix://./etc/istio/proxy/XDS                            HEALTHY     OK                xds-grpc
unix://./var/run/secrets/workload-spiffe-uds/socket     HEALTHY     OK                sds-grpc

# å®ƒä»¬éƒ½å¯ä»¥é€šè¿‡ä¸€äº›å‚æ•°è¿›è¡Œè¿‡æ»¤
$ ./istioctl pc endpoint istio-ingressgateway-d4db74f5b-l44h4.istio-system --port 3000
ENDPOINT            STATUS      OUTLIER CHECK     CLUSTER
20.2.36.92:3000     HEALTHY     OK                outbound|3000||go-multiroute.default.svc.cluster.local
20.2.36.94:3000     HEALTHY     OK                outbound|3000||go-multiroute.default.svc.cluster.local
```

æœ€åï¼Œæœ‰ä¸€ä¸ªå°çš„ç»†èŠ‚éœ€è¦æ³¨æ„ï¼Œåˆ é™¤åŒ…å«è¯ä¹¦çš„secretå¹¶ä¸ä¼šå½±å“ç½‘å…³ç»§ç»­æ­£å¸¸å“åº”å¯¹åº”è¯ä¹¦åŸŸåçš„è¯·æ±‚ï¼Œ
è¿™æ˜¯å› ä¸ºç½‘å…³ä¸ä¼šå¤„ç†åˆ é™¤è¯ä¹¦çš„æ“ä½œï¼Œé™¤éç½‘å…³é‡å¯é‡æ–°åŠ è½½è¿™äº›æ•°æ®ã€‚æ‰€ä»¥è¦åˆ é™¤ä¸€ä¸ªå¯¹å¤–çš„æœåŠ¡ç«¯å£ï¼Œæˆ‘ä»¬å¿…é¡»åˆ é™¤å¯¹åº”çš„Gatewayé…ç½®ã€‚
æ­¤å¤–ï¼Œåœ¨éƒ¨ç½²éªŒè¯è¿‡ç¨‹ä¸­ï¼Œè§‚å¯Ÿç½‘å…³Podçš„æ—¥å¿—å¯ä»¥ç¡®è®¤ç½‘å…³æ˜¯å¦æˆåŠŸåŠ è½½äº†æ–°é…ç½®ã€‚

**æ¸…ç†**

```shell
kubectl delete -f ingress-virtualservice.yaml -f ingress-gwy.yaml
```

**æ‰©å±•ä¸»é¢˜**

- [é…ç½®åŒå‘TLSå…¥ç«™ç½‘å…³](https://istio.io/latest/zh/docs/tasks/traffic-management/ingress/secure-ingress/#configure-a-mutual-tls-ingress-gateway)
- [å½“ä¸ºå¤šä¸ª Gateway é…ç½®äº†ç›¸åŒçš„ TLS è¯ä¹¦å¯¼è‡´ 404 å¼‚å¸¸](https://istio.io/latest/zh/docs/ops/common-problems/network-issues/#not-found-errors-occur-when-multiple-gateways-configured-with-same-TLS-certificate)
- [ä¸å‘é€ SNI æ—¶é…ç½® SNI è·¯ç”±](https://istio.io/latest/zh/docs/ops/common-problems/network-issues/#configuring-SNI-routing-when-not-sending-SNI)

##### 8.4.5.7 æµé‡ç®¡ç†ä¹‹è®¿é—®å¤–éƒ¨æœåŠ¡

Ingressç½‘å…³æ§åˆ¶çš„æ˜¯å¤–éƒ¨æµé‡å¦‚ä½•è¿›å…¥ç½‘æ ¼ï¼Œä½†ç½‘æ ¼å¦‚ä½•è®¿é—®å¤–éƒ¨æœåŠ¡å‘¢ï¼Ÿç›®å‰çš„é»˜è®¤åšæ³•æ˜¯sidecaræ²¡æœ‰é’ˆå¯¹æœªçŸ¥ç›®æ ‡æœåŠ¡çš„æµé‡ä»£ç†åšå‡ºä»»ä½•é™åˆ¶ï¼Œ
æ¯”å¦‚åº”ç”¨å®¹å™¨å¯ä»¥ç›´æ¥è®¿é—®ç±»ä¼¼`www.google.com`çš„å¤–éƒ¨åŸŸåæˆ–IPï¼Œè¿™ç§ä¸å—æ§çš„å¯¹å¤–è®¿é—®ä¼šå¸¦æ¥å®‰å…¨é£é™©ï¼Œ
å°¤å…¶åœ¨æŸäº›ç»„ç»‡è¦æ±‚å¯¹æ‰€æœ‰å¯¹å¤–æµé‡è¿›è¡ŒåŠ å¯†æ—¶ã€‚

Istioæä¾›äº†ä¸‰ç§æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼š

1. é…ç½®sidecarä»£ç†æ‹’ç»è°ƒç”¨æœªçŸ¥çš„ç›®æ ‡æœåŠ¡
2. é…ç½®ServiceEntryæ¥å£°æ˜å¤–éƒ¨æœåŠ¡ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡VirtualServiceå’ŒDestinationRuleæ¥æ§åˆ¶ç½‘æ ¼å¦‚ä½•è®¿é—®å¤–éƒ¨æœåŠ¡
3. å¯¹äºç‰¹å®šIPèŒƒå›´çš„ç›®æ ‡æœåŠ¡ï¼Œé…ç½®Istioä½¿åº”ç”¨å®¹å™¨ç»•è¿‡sidecarä»£ç†

æœ¬èŠ‚å†…å®¹ä¸»è¦å‚è€ƒè‡ª[Istioï¼šè®¿é—®å¤–éƒ¨æœåŠ¡][Istioè®¿é—®å¤–éƒ¨æœåŠ¡]ï¼Œå…¶ä¸­ç¬¬ä¸€ç§å’Œç¬¬ä¸‰ç§æ–¹å¼æ“ä½œèµ·æ¥éƒ½å¾ˆç®€å•ï¼Œæ‰€ä»¥æœ¬èŠ‚æ¼”ç¤ºä»…é™äºç¬¬äºŒç§æ–¹å¼ï¼Œ
è¯»è€…å¯ä»¥ç»“åˆæœ¬èŠ‚æ¼”ç¤ºå’Œå®˜æ–‡åŠ æ·±å¯¹ServiceEntryçš„ç†è§£ã€‚

æœ¬èŠ‚æ¼”ç¤ºå°†å®ç°å¦‚æœé€šè¿‡ServiceEntry+VirtualServiceçš„æ–¹å¼æ¥ç®¡ç†ç½‘æ ¼å¦‚ä½•è®¿é—®å¤–éƒ¨çš„ä¸€ä¸ªä¸“ç”¨äºHTTPæµ‹è¯•çš„ç½‘ç«™`httpbin.org`ï¼Œ
æ‰€ä½¿ç”¨çš„æ¸…å•æ˜¯ [external-access-control.yaml](k8s_actions_guide/version1/istio_manifest/external-access-control.yaml)ï¼Œ
æ¼”ç¤ºæ­¥éª¤å¦‚ä¸‹ï¼š

```shell
# éƒ¨ç½²ä¸¤ç§å¯¹è±¡
$ kubectl apply -f external-access-control.yaml
serviceentry.networking.istio.io/httpbin created
virtualservice.networking.istio.io/httpbin created

# éªŒè¯ä¸€ï¼šæ ¹è·¯ç”±é‡å®šå‘åˆ° /ip ï¼ˆ-Lè·Ÿéšè·³è½¬ï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl -L httpbin.org
{
  "origin": "119.x.198.51"
}
# éªŒè¯äºŒï¼šè®¾ç½®è¶…æ—¶2sï¼Œè¦æ±‚å»¶æ—¶3sè¿”å›ï¼ˆé¢„æœŸè¶…æ—¶ï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl httpbin.org/delay/3 -I
HTTP/1.1 504 Gateway Timeout
content-length: 24
content-type: text/plain
date: Mon, 18 Mar 2024 09:59:12 GMT
server: envoy

# éªŒè¯ä¸‰ï¼šè®¾ç½®è¶…æ—¶2sï¼Œè¦æ±‚å»¶æ—¶1sè¿”å›ï¼ˆé¢„æœŸæ­£å¸¸200ï¼‰
$ kubectl exec -it istio-client-test-$POD_ID -- curl httpbin.org/delay/1 -I
HTTP/1.1 200 OK
date: Tue, 19 Mar 2024 13:29:55 GMT
content-type: application/json
content-length: 1473
server: envoy
access-control-allow-origin: *
access-control-allow-credentials: true
x-envoy-upstream-service-time: 1557
```

**ç†è§£åŸç†**

åˆ›å»ºIstio ServiceEntryå¯¹è±¡å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†ä¸€ä¸ªå¤–éƒ¨çš„åŸŸåæ³¨å†Œåˆ°Istio sidecarä¸­ï¼Œä¹‹åå°±å¯ä»¥åœ¨VirtualServiceä¸­å¼•ç”¨è¯¥åŸŸåå¹¶ç¼–å†™è·¯ç”±è§„åˆ™ã€‚
è‹¥æ²¡æœ‰æ³¨å†Œå¤–éƒ¨æœåŠ¡å°±ç›´æ¥å¼•å…¥å¤–éƒ¨Hoståˆ°è·¯ç”±ç­–ç•¥ä¸­ï¼Œåˆ›å»ºå¯¹è±¡ä¸ä¼šæŠ¥é”™ï¼Œä½†æ˜¯åº”ç”¨åœ¨è®¿é—®æ—¶ä¼šå¾—åˆ°503çš„çŠ¶æ€ç ç»“æœã€‚

ServiceEntryå¯¹è±¡æ”¯æŒä¸ºæŒ‡å®šHostå£°æ˜å¤šä¸ªIPåœ°å€ä»¥åŠåˆ†åˆ«ä¸ºæ¯ä¸ªIPæŒ‡å®šç«¯å£ï¼Œå…å»äº†DNSæŸ¥è¯¢çš„æ­¥éª¤ï¼Œæ–¹ä¾¿ç®¡ç†ä»…é€šè¿‡IPå…¬å¼€çš„å¤–éƒ¨æœåŠ¡ï¼Œ
å…·ä½“è¯·å‚è€ƒå…¶ç¼–å†™[è§„èŒƒ](https://istio.io/latest/docs/reference/config/networking/service-entry/)ã€‚

##### 8.4.5.8 æµé‡ç®¡ç†ä¹‹Egressç½‘å…³

Ingressç½‘å…³å’ŒEgressç½‘å…³å…±åŒå®ç°äº†ç½‘æ ¼ç½‘ç»œçš„ä¸œè¥¿å‘æµé‡æ§åˆ¶ã€‚ä½†ç›¸æ¯”Ingressè€Œè¨€ï¼ŒEgressç½‘å…³å¹¶ä¸ç®—å¸¸ç”¨ï¼Œ
å› ä¸ºå¤§éƒ¨åˆ†ç³»ç»Ÿå¹¶ä¸ä¼šè¦æ±‚å¯¹å‡ºå£æµé‡åšæ§åˆ¶ï¼Œé™¤éæ˜¯ä¸€äº›ç‰¹æ®Šçš„ã€å¯¹ç½‘ç»œå‡ºç«™å®‰å…¨æœ‰ç‰¹åˆ«ç®¡æ§çš„ç³»ç»Ÿã€‚
ä¹Ÿæ˜¯ç”±äºsidecarçš„å­˜åœ¨ï¼ŒIstioå¯ä»¥å¾ˆè½»æ¾çš„å®ç°å¯¹å‡ºç«™æµé‡çš„ç®¡æ§ã€‚è¿™é‡Œçš„ç®¡æ§åŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

- é’ˆå¯¹æŒ‡å®šåŸŸåçš„å‡ºç«™æµé‡çš„æµé‡ç®¡ç†ï¼ˆç†”æ–­/è¶…æ—¶ç­‰ï¼‰
- é’ˆå¯¹æŒ‡å®šåŸŸåçš„å‡ºç«™æµé‡çš„åŠ å¯†ï¼ˆTLSï¼‰
    - ä¾‹å¦‚æŸäº›é¡¹ç›®ä¸å…è®¸æœåŠ¡å™¨å¯¹å¤–å‘èµ·HTTPè®¿é—®ï¼Œæ‰€ä»¥å½“appå‘èµ·HTTPè¯·æ±‚æ—¶ï¼Œè¯·æ±‚åˆ°è¾¾Egressç½‘å…³åï¼ŒEgressç½‘å…³å°†æŒ‰ç­–ç•¥å¯¹ç›®æ ‡å‘èµ·HTTPSè¯·æ±‚
- ç»Ÿä¸€ç›‘æ§å¹¶è®°å½•ç½‘æ ¼æœåŠ¡çš„å‡ºç«™æµé‡ï¼ˆåœ¨Egressç½‘å…³å¤„æŸ¥è¯¢å³å¯ï¼‰

> K8sè™½ç„¶æ²¡æœ‰æå‡ºEgressç½‘å…³çš„æ¦‚å¿µï¼Œä½†æä¾›äº†NetworkPolicyæ¥æ§åˆ¶Egressæµé‡ï¼Œå…¶åŸç†æ˜¯é€šè¿‡CNIå³ç½‘ç»œæ’ä»¶æ¥å®ç°çš„ï¼ˆéƒ¨åˆ†åŠŸèƒ½éœ€è¦å®‰è£…çš„CNIæ’ä»¶æ”¯æŒï¼‰ï¼Œ
> ä½†æ‰€æä¾›çš„åŠŸèƒ½ä¸°å¯Œæ€§æ— æ³•ä¸Istioç›¸æå¹¶è®ºã€‚

æ­¤å¤–ï¼ŒIstioè¿˜æåŠäº†Egressç½‘å…³çš„å¦ä¸€ä¸ªä½¿ç”¨åœºæ™¯æ˜¯ï¼šâ€œé›†ç¾¤ä¸­çš„åº”ç”¨èŠ‚ç‚¹æ²¡æœ‰å…¬æœ‰ IPï¼Œæ‰€ä»¥åœ¨è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ç½‘æ ¼ Service
æ— æ³•è®¿é—®äº’è”ç½‘ã€‚é€šè¿‡å®šä¹‰Egress gatewayï¼Œå°†å…¬æœ‰IPåˆ†é…ç»™ Egress Gateway èŠ‚ç‚¹ï¼Œç”¨å®ƒå¼•å¯¼æ‰€æœ‰çš„å‡ºç«™æµé‡ï¼Œå¯ä»¥ä½¿åº”ç”¨èŠ‚ç‚¹ä»¥å—æ§çš„æ–¹å¼è®¿é—®å¤–éƒ¨æœåŠ¡ã€‚â€

**å®‰è£…Egressç½‘å…³**

å®‰è£…Egressç½‘å…³ï¼ŒåŒæ—¶å¼€å¯sidecarçš„è®¿é—®æ—¥å¿—

```shell
# ä¿®æ”¹ iop é…ç½®æ–‡ä»¶ istio-operator.yaml
# æ­¤å‘½ä»¤ä¼šæ›´æ”¹å·²å®‰è£…çš„åç§°ä¸ºistioçš„configmapï¼Œå¹¶å‘ç½‘æ ¼ä¸­æ‰€æœ‰çš„Envoyå®ä¾‹æ³¨å…¥æ–°çš„é…ç½®ã€‚

#spec:
#  components:
#    egressGateways:
#    - enabled: true  
#      name: istio-egressgateway
#    ...
#  meshConfig:
#    ...
#    accessLogFile: /dev/stdout
#    accessLogEncoding: JSON

# å†æ¬¡å®‰è£…istio
$ ./istioctl install -f istio-operator.yaml

# æŸ¥çœ‹å·²å®‰è£…çš„egressç½‘å…³
$ kubectl get deploy,svc -n istio-system |grep egress -B 1
NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/istio-egressgateway    1/1     1            1           4m58s
--
NAME                           TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)                                      AGE
service/istio-egressgateway    ClusterIP      20.1.68.34     <none>        80/TCP,443/TCP                               4m58s

# æŸ¥è¯¢sidecarçš„è®¿é—®æ—¥å¿—
$ kubectl exec -it istio-client-test-$POD_ID -- curl go-multiroute:3000/route1
[v2] Hello, You are at /route1, Got: route1's content

# ç®€å•åˆ†æä¸€ä¸‹å®¢æˆ·ç«¯sidecarçš„è®¿é—®æ—¥å¿—

# â‘ upstreamæ˜¯æŒ‡sidecarä»£ç†çš„æœåŠ¡ï¼ˆä¹Ÿæ˜¯è½¬å‘ç›®æ ‡ï¼‰ï¼Œå³sidecar1ä¸sidecar2ï¼ˆè¿œç«¯èŠ‚ç‚¹ï¼‰ä¹‹é—´çš„è¿æ¥
# client-app <---> sidecar1    ----------->    sidecar2 <---> server-app
# upstream_local_address -- sidecar1ä¸sidecar2è¿æ¥æ—¶çš„ip:port
# upstream_host -- sidecar2çš„ip:port
# upstream_cluster -- sidecar2çš„DNSä¿¡æ¯

# â‘¡downstreamæ˜¯æŒ‡sidecaræ¥æ”¶æµé‡çš„å®¢æˆ·ç«¯ï¼Œå³sidecar1ä¸client-appï¼ˆè¿‘ç«¯èŠ‚ç‚¹ï¼‰ä¹‹é—´çš„è¿æ¥
# client-app <---> sidecar1    ----------->    sidecar2 <---> server-app
# downstream_remote_addressï¼šclient-appçš„ip:portï¼ˆä¸downstream_local_addresså»ºç«‹è¿æ¥ï¼‰
# downstream_local_addressï¼šsidecar1çš„ip:port

# å…¶ä»–è¿˜æœ‰response_codeã€routeã€durationã€request_idã€bytes_sentç­‰æœ‰ç”¨ä¿¡æ¯ã€‚
$ kubectl logs -l app=istio-client-test -c istio-proxy --tail 1
{"upstream_transport_failure_reason":null,"protocol":"HTTP/1.1","user_agent":"curl/7.59.0","route_name":"default",
"response_code":200,"upstream_local_address":"20.2.36.96:39984","connection_termination_details":null,
"request_id":"5877d0cb-bd2b-4aa6-83c1-dd2e7dbf01be","response_flags":"-","upstream_host":"20.2.36.94:3000",
"bytes_sent":53,"x_forwarded_for":null,"upstream_cluster":"outbound|3000||go-multiroute.default.svc.cluster.local",
"authority":"go-multiroute:3000","start_time":"2024-03-17T16:42:07.449Z","method":"GET",
"response_code_details":"via_upstream","downstream_local_address":"20.1.207.122:3000","requested_server_name":null,
"duration":2,"upstream_service_time":"2","downstream_remote_address":"20.2.36.96:46218","path":"/route1","bytes_received":0}

# æ­¤å¤–ï¼Œä½ è¿˜å¯ä»¥æŸ¥çœ‹æœåŠ¡ç«¯istio-proxyçš„æ—¥å¿—ï¼Œå¹¶è‡ªè¡Œåˆ†æè·å¾—æ›´æ¸…æ™°çš„è®¿é—®è®°å½•è®¤è¯†ã€‚
```

sidecaré»˜è®¤çš„æ—¥å¿—çº§åˆ«æ˜¯Infoï¼Œæœ‰æ—¶å€™å¯èƒ½éœ€è¦ä¸ºç‰¹å®šè´Ÿè½½è®¾ç½®Debugçº§åˆ«æ—¥å¿—ï¼Œä»¥ä¾¿è¿›è¡Œç½‘ç»œæ•…éšœæ’æŸ¥ã€‚å¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼è®¾ç½®ï¼š

```shell
# æ–¹å¼ä¸€
kubectl exec {POD-NAME} -c istio-proxy -- curl -X POST http://127.0.0.1:15000/logging?level=debug
# æ–¹å¼äºŒ
./istioctl pc log <POD-NAME>.[NAMESPACE] --level debug
```

æœ¬èŠ‚æ¼”ç¤ºåŒ…å«ä¸¤éƒ¨åˆ†ï¼š

- æ¼”ç¤ºä¸€ï¼šEgressç½‘å…³é€æ˜è½¬å‘HTTPè¯·æ±‚ï¼ˆHTTP->HTTPï¼‰
    - ä½¿ç”¨æ¨¡æ¿ï¼š[egressgwy-proxy-http2http.yaml][egressgwy-proxy-http2http.yaml]
- æ¼”ç¤ºäºŒï¼šEgressç½‘å…³é€æ˜è½¬å‘HTTPSè¯·æ±‚ï¼ˆHTTPS->HTTPSï¼‰
    - ä½¿ç”¨æ¨¡æ¿ï¼š[egressgwy-proxy-https2https.yaml][egressgwy-proxy-https2https.yaml]
- æ¼”ç¤ºä¸‰ï¼šEgressç½‘å…³å°†HTTPè¯·æ±‚è½¬æ¢ä¸ºHTTPSè¯·æ±‚ï¼ˆHTTP->HTTPSï¼‰
    - ä½¿ç”¨æ¨¡æ¿ï¼š[egressgwy-proxy-http2https.yaml][egressgwy-proxy-http2https.yaml]
- ~~æ¼”ç¤ºå››ï¼šEgressç½‘å…³å°†HTTPSè¯·æ±‚è½¬æ¢ä¸ºHTTPè¯·æ±‚ï¼ˆHTTPS->HTTPï¼‰~~ æ²¡æœ‰è¿™ç§è¦æ±‚

[egressgwy-proxy-http2http.yaml]: k8s_actions_guide/version1/istio_manifest/egressgwy-proxy-http2http.yaml

[egressgwy-proxy-https2https.yaml]: k8s_actions_guide/version1/istio_manifest/egressgwy-proxy-https2https.yaml

[egressgwy-proxy-http2https.yaml]: k8s_actions_guide/version1/istio_manifest/egressgwy-proxy-http2https.yaml

**æ¼”ç¤ºä¸€ï¼šEgressç½‘å…³é€æ˜è½¬å‘HTTPè¯·æ±‚ï¼ˆHTTP->HTTPï¼‰**

```shell
# éƒ¨ç½²ç­–ç•¥
$ kubectl apply -f egressgwy-proxy-http2http.yaml
serviceentry.networking.istio.io/istio-io created
gateway.networking.istio.io/egress-istio-io created
virtualservice.networking.istio.io/egressgateway-proxy-http-istio-io created

# éªŒè¯ï¼šåœ¨æ³¨å…¥sidecarçš„å®¢æˆ·ç«¯å®¹å™¨ä¸­è®¿é—®æ³¨å†Œçš„å¤–éƒ¨æœåŠ¡ï¼ˆé¢„æœŸï¼šHTTPè®¿é—®åº”è¯¥è¿”å›301ï¼‰
$ kubectl exec -it istio-client-test-668bb6fc86-mmqf9 -- curl istio.io -I              
HTTP/1.1 301 Moved Permanently
content-type: text/plain; charset=utf-8
date: Wed, 20 Mar 2024 04:12:07 GMT
location: https://istio.io/
server: envoy
x-nf-request-id: 01HSD0YB5MSPEPC1Y5R85AMREM
x-envoy-upstream-service-time: 387
transfer-encoding: chunked

# éªŒè¯ï¼šæŸ¥è¯¢egressç½‘å…³æ—¥å¿—ï¼Œç¡®è®¤æµé‡é€šè¿‡ç½‘å…³è½¬å‘ï¼ˆæ ¹æ® upstream_cluster å’Œ response_code å­—æ®µåˆ¤æ–­ï¼‰
# - åœ¨éƒ¨ç½²ç­–ç•¥å‰ï¼Œegressç½‘å…³ä¸ä¼šå‡ºç°è¿™æ¡è®¿é—®æ—¥å¿—
# - ç½‘å…³ä¸­çš„ upstream æ˜¯æŒ‡è‡ªå·±æ‰€ä»£ç†çš„æœåŠ¡ï¼Œè€Œegressä»£ç†çš„æ˜¯å¤–éƒ¨æœåŠ¡ï¼›
$ kubectl logs -l istio=egressgateway -nistio-system --tail 2
{"requested_server_name":null,"authority":"istio.io","upstream_service_time":"376","path":"/","downstream_remote_address":"20.2.36.112:42936",
"x_forwarded_for":"20.2.36.112","upstream_local_address":"20.2.36.108:52900","downstream_local_address":"20.2.36.108:8080",
"duration":377,"bytes_sent":32,"upstream_transport_failure_reason":null,"response_code_details":"via_upstream",
"response_flags":"-","request_id":"252fce5c-0a92-99c2-93cd-4ce7ba0bd995","connection_termination_details":null,
"response_code":301,"upstream_cluster":"outbound|80||istio.io","start_time":"2024-03-18T16:52:08.157Z","bytes_received":0,
"upstream_host":"75.2.60.5:80","method":"GET","user_agent":"curl/7.59.0","route_name":null,"protocol":"HTTP/2"}
2024-03-18T16:35:39.362022Z	info	xdsproxy	connected to upstream XDS server: istiod.istio-system.svc:15012

# æ¸…ç†
$ kubectl delete -f egressgwy-proxy-http2http.yaml
```

**æ¼”ç¤ºäºŒï¼šEgressç½‘å…³é€æ˜è½¬å‘HTTPSè¯·æ±‚ï¼ˆHTTPS->HTTPSï¼‰**

```shell
# éƒ¨ç½²ç­–ç•¥
$ kubectl apply -f egressgwy-proxy-https2https.yaml
serviceentry.networking.istio.io/istio-io-https created
gateway.networking.istio.io/egress-istio-io-https created
virtualservice.networking.istio.io/egressgateway-proxy-https-istio-io created

# éªŒè¯ï¼šæŸ¥è¯¢egressç½‘å…³æ—¥å¿—ï¼Œç¡®è®¤æµé‡é€šè¿‡ç½‘å…³è½¬å‘ï¼ˆæ ¹æ® upstream_cluster å’Œ response_code å­—æ®µåˆ¤æ–­ï¼‰
# - åœ¨éƒ¨ç½²ç­–ç•¥å‰ï¼Œegressç½‘å…³ä¸ä¼šå‡ºç°è¿™æ¡è®¿é—®æ—¥å¿—
$ kubectl logs -l istio=egressgateway -nistio-system --tail 1
{"upstream_local_address":"20.2.36.108:35544","duration":961,"requested_server_name":"istio.io","protocol":null,"path":null,
"method":null,"bytes_received":454,"authority":null,"connection_termination_details":null,"response_flags":"-","bytes_sent":3204,
"start_time":"2024-03-18T17:33:45.987Z","user_agent":null,"upstream_transport_failure_reason":null,"upstream_cluster":"outbound|443||istio.io",
"response_code_details":null,"upstream_service_time":null,"route_name":null,"upstream_host":"75.2.60.5:443","response_code":0,
"downstream_local_address":"20.2.36.108:8443","request_id":null,"x_forwarded_for":null,"downstream_remote_address":"20.2.36.112:52658"}

# æ¸…ç†
$ kubectl delete -f egressgwy-proxy-https2https.yaml
```

**æ¼”ç¤ºä¸‰ï¼šEgressç½‘å…³å°†HTTPè¯·æ±‚è½¬æ¢ä¸ºHTTPSè¯·æ±‚ï¼ˆHTTP->HTTPSï¼‰**

```shell
# éƒ¨ç½²ç­–ç•¥
$ kk apply -f egressgwy-proxy-http2https.yaml 
serviceentry.networking.istio.io/istio-io created
gateway.networking.istio.io/egress-istio-io-http2https created
destinationrule.networking.istio.io/egressgateway-for-istio-io created
virtualservice.networking.istio.io/egressgateway-proxy-istio-io-http2https created
destinationrule.networking.istio.io/originate-tls-for-istio-io created

# éªŒè¯ï¼šåœ¨å®¢æˆ·ç«¯å®¹å™¨ä½¿ç”¨httpåè®®è®¿é—®hostï¼ˆé¢„æœŸä¼šå› ä¸ºç½‘å…³çš„è½¬å‘è€Œå¾—åˆ°200å“åº”ï¼‰
# - è‹¥æ²¡æœ‰ç½‘ç®¡çš„tlsè½¬å‘ï¼Œåˆ™ä¼šå¾—åˆ°301å“åº”
$ kk exec -it istio-client-test-$POD_ID -- curl istio.io -I
HTTP/1.1 200 OK
...

# æ¸…ç†
$ kubectl delete -f egressgwy-proxy-http2https.yaml
```

è¿™ä¸‰ä¸ªæ¼”ç¤ºå¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†Egressç½‘å…³çš„ä½¿ç”¨åœºæ™¯ã€‚å¯¹äºæ¼”ç¤ºä¸‰ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ç½‘å…³æ˜¯ä»¥`SIMPLE`æ–¹å¼å¯¹`istio.io`å‘èµ·TLSè¿æ¥ï¼Œ
è¿™è¡¨ç¤ºä½œä¸ºå®¢æˆ·ç«¯çš„ç½‘å…³æ²¡æœ‰æä¾›è‡ªå·±çš„è¯ä¹¦ç»™å¯¹æ–¹ä¸»æœºï¼Œå› æ­¤å­˜åœ¨ç¬¬å››ä¸ªåœºæ™¯å°±æ˜¯ï¼šç½‘å…³ä¸å¯¹æ–¹ä¸»æœºä¹‹é—´å»ºç«‹mTLSè¿æ¥ã€‚
è¿™ä¸ªåœºæ™¯æ¯”è¾ƒå°‘è§ï¼Œå®ƒé¦–å…ˆè¦æ±‚å¯¹æ–¹ä¸»æœºéœ€è¦éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¦åˆ™æä¾›ä¹Ÿæ²¡æ„ä¹‰ï¼›å¦‚æœ‰å…´è¶£ï¼Œè¯·å‚è€ƒå®˜æ–¹æä¾›çš„
[Egressç½‘å…³å‘èµ·çš„mTLS][Egressç½‘å…³å‘èµ·çš„mTLSæ¼”ç¤º] æ¼”ç¤ºã€‚

[Egressç½‘å…³å‘èµ·çš„mTLSæ¼”ç¤º]: https://istio.io/latest/zh/docs/tasks/traffic-management/egress/egress-gateway-tls-origination/#perform-mutual-TLS-origination-with-an-egress-gateway

**å¿…è¦çš„å®‰å…¨æªæ–½**

è¯·æ³¨æ„ï¼ŒIstioæ— æ³•åšåˆ°è®©é›†ç¾¤ä¸­çš„æ‰€æœ‰å‡ºç«™æµé‡éƒ½ç»è¿‡Egressç½‘å…³è½¬å‘ï¼Œæ‰€ä»¥å­˜åœ¨é›†ç¾¤æœåŠ¡**ç»•è¿‡Egressç½‘å…³ç›´æ¥è®¿é—®å¤–éƒ¨æœåŠ¡**çš„å¯èƒ½ï¼Œ
è¿™äº›æœåŠ¡çš„å¤–ç«™è®¿é—®èƒ½å¤Ÿå®Œå…¨è„±ç¦»Istioçš„æ§åˆ¶å’Œç›‘æ§ã€‚

å¦‚æœä½ ä¸å¸Œæœ›é›†ç¾¤ä¸­æœ‰ä»»ä½•Podçš„å‡ºç«™æµé‡èƒ½å¤Ÿç»•è¿‡Egressç½‘å…³ï¼ˆè„±ç¦»Istioçš„æ§åˆ¶å’Œç›‘æ§ï¼‰ï¼Œ
å»ºè®®ä½ éƒ¨ç½²K8sçš„ NetworkPolicy æ¥ä¿è¯**ä»…å…è®¸**æ¥è‡ªEgressç½‘å…³çš„æµé‡å¯ä»¥é€šè¿‡é›†ç¾¤è¾¹ç¼˜ï¼Œ
å…·ä½“è¯·å‚è€ƒ[Istio Egresså®‰å…¨äº‹é¡¹][Istio Egresså®‰å…¨]ã€‚

**ä»…å…è®¸è®¿é—®å·²æ³¨å†Œçš„æœåŠ¡**

å¦‚æœä½ å¸Œæœ›æ§åˆ¶ç½‘æ ¼å†…çš„æœåŠ¡**ä»…èƒ½è®¿é—®**å·²åœ¨ç½‘æ ¼æˆ–é›†ç¾¤ä¸­æ³¨å†Œçš„æœåŠ¡ï¼Œé‚£ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹ IstioOperator é…ç½®æ–‡ä»¶æ¥å®Œæˆã€‚æ‰§è¡Œå‘½ä»¤ï¼š
`istioctl install -f istio-operator.yaml --set meshConfig.outboundTrafficPolicy.mode=REGISTRY_ONLY`ï¼Œé»˜è®¤çš„ `mode`
é…ç½®æ˜¯`ALLOW_ANY`ï¼Œå³å…è®¸è®¿é—®ä»»ä½•åŸŸåï¼Œè€Œ`REGISTRY_ONLY`è¡¨ç¤º**ä»…å…è®¸è®¿é—®å·²æ³¨å†Œçš„æœåŠ¡**ã€‚æ›´æ”¹é…ç½®åï¼Œç­‰å¾…å‡ ç§’é’Ÿç”Ÿæ•ˆï¼Œ
ç„¶åä½ å°±ä¼šå‘ç°ç½‘æ ¼å†…çš„æœåŠ¡æ— æ³•è®¿é—®ç±»ä¼¼`api.alibaba.com`è¿™æ ·çš„å¤–éƒ¨åœ°å€äº†ï¼Œå› ä¸ºå®ƒæ²¡æœ‰åœ¨ç½‘æ ¼å†…è¿›è¡Œæ³¨å†Œï¼Œ
é€šè¿‡ ServiceEntry å¯¹è±¡å®Œæˆç½‘æ ¼å†…çš„æœåŠ¡æ³¨å†Œå°±å¯ä»¥æ­£å¸¸è®¿é—®äº†ã€‚

æœ€åï¼Œå¦‚æœä½ åœ¨é…ç½®TLSæ—¶æ„Ÿåˆ°å›°æƒ‘ï¼Œå¯ä»¥é˜…è¯»å®˜ç½‘æ–‡æ¡£
[ç†è§£ TLS é…ç½®](https://istio.io/latest/zh/docs/ops/configuration/traffic-management/tls-configuration/)ã€‚

##### 8.4.5.9 å…¶ä»–ç¤ºä¾‹

- ä½ å¯ä»¥å°†ç½‘æ ¼ä¸­çš„å‡ºç«™æµé‡é€šè¿‡ ServiceEntry å¼•å¯¼è‡³å…¶ä»–ä¸“ç”¨ä»£ç†ï¼ˆè€Œä¸æ˜¯Egressç½‘å…³ï¼‰ï¼Œç„¶åç”±ä¸“ç”¨ä»£ç†è´Ÿè´£æ§åˆ¶å’Œè½¬å‘æµé‡ï¼›
    - [ä½¿ç”¨å¤–éƒ¨HTTPSä»£ç†](https://istio.io/latest/zh/docs/tasks/traffic-management/egress/http-proxy/)
- ä¸Šä¸€èŠ‚ä¸­çš„æ¼”ç¤ºæ¡ˆä¾‹éƒ½æ˜¯é’ˆå¯¹å•ä¸€åŸŸåçš„å¼•å¯¼é…ç½®ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ºä¸€ä¸ªæ³›åŸŸååˆ›å»º ServiceEntry å’Œ Gateway ç­‰å¯¹è±¡
    - [Wildcard ä¸»æœºçš„ Egress](https://istio.io/latest/zh/docs/tasks/traffic-management/egress/wildcard-egress-hosts/)
- æµé‡é•œåƒï¼šä½ å¯ä»¥é…ç½®å°†è®¿é—®æŸä¸ªHostçš„æµé‡æŒ‰ç™¾åˆ†æ¯”å¤åˆ¶åˆ°å…¶ä»–ç›®æ ‡ï¼Œè¿™å¯ä»¥åŠ©ä½ å®ç°å®æ–½æµé‡åˆ†æå’Œå®‰å…¨å®¡è®¡ï¼›
    - [æµé‡é•œåƒ](https://istio.io/latest/zh/docs/tasks/traffic-management/mirroring/)
- é€Ÿç‡é™åˆ¶ï¼šä½ å¯ä»¥ä¸ºingressç½‘å…³å’Œsidecaré…ç½®é€Ÿç‡é™åˆ¶ï¼Œä»¥é™åˆ¶è®¿é—®æŸä¸ªHostçš„æµé‡é€Ÿç‡ï¼›
    - [é€Ÿç‡é™åˆ¶](https://istio.io/latest/zh/docs/tasks/policy-enforcement/rate-limit/)

æ­¤å¤–ï¼Œè¿˜æœ‰å¯è§‚æµ‹æ€§ç›¸å…³çš„æ›´å¤šç¤ºä¾‹ï¼Œè¯·å‚è€ƒ[Istio å¯è§‚æµ‹æ€§](https://istio.io/latest/zh/docs/tasks/observability/)ã€‚

#### 8.4.6 æ•…éšœå¤„ç†

**æ•…éšœä¸€ï¼šé…ç½®ä¸‹å‘å¤±è´¥**

æ•…éšœä½“ç°ä¸ºåº”ç”¨å®¹å™¨æ²¡æœ‰å®‰è£…é…ç½®çš„è·¯ç”±ç­–ç•¥æ‰§è¡Œï¼Œé€šè¿‡`istioctl pc route ...`æ— æ³•çœ‹åˆ°æœ€æ–°çš„è·¯ç”±ç­–ç•¥ã€‚
æ­¤å¤–è§‚å¯Ÿistiodæ—¥å¿—å‘ç°å¤§é‡`error`çº§åˆ«çš„æ—¥å¿—ã€‚

```shell
$ kubectl logs -l app=istiod -nistio-system --tail 5
2024-03-18T15:28:07.316091Z	error	security	Failed to authenticate client from 20.2.36.105:40058: 
Authenticator ClientCertAuthenticator: no verified chain is found; Authenticator KubeJWTAuthenticator: 
failed to validate the JWT from cluster "Kubernetes": the service account authentication returns an error: 
[invalid bearer token, service account token has expired]
...é‡å¤
```

å…·ä½“åŸç†ç¬”è€…è¿˜æœªæŸ¥æ˜ï¼Œä½†å·²ç»æŸ¥åˆ°çš„é—®é¢˜æ˜¯è¿è¡Œappå®¹å™¨çš„èŠ‚ç‚¹ä¸K8sé›†ç¾¤ä¸»èŠ‚ç‚¹æ—¶é—´ä¸åŒæ­¥ï¼ˆç›¸å·®å¥½å‡ ä¸ªå°æ—¶ï¼‰ï¼Œ
åŒæ­¥åæ— éœ€æ“ä½œé›†ç¾¤ï¼Œé—®é¢˜è‡ªåŠ¨æ¶ˆå¤±ã€‚

å…³äºæµé‡ç®¡ç†é…ç½®ç›¸å…³çš„æ•…éšœï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£[æµé‡ç®¡ç†é—®é¢˜](https://istio.io/latest/zh/docs/ops/common-problems/network-issues/)ã€‚

#### 8.4.7 IstioæœåŠ¡çš„å¥åº·æ£€æŸ¥

Istioéœ€è¦å¯¹APPå®¹å™¨çš„éƒ¨åˆ†ç±»å‹çš„**å­˜æ´»åŠå°±ç»ªæ¢é’ˆ**è§„åˆ™è¿›è¡Œé‡å†™ï¼Œä»¥ä½¿å®ƒä»¬èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚è¿™æ˜¯å› ä¸ºï¼š

- å¯¹äºHTTPç±»å‹çš„æ¢é’ˆï¼škubeletè´Ÿè´£å‘åº”ç”¨å‘é€æ¢æµ‹è¯·æ±‚ã€‚ä½†åœ¨å¯ç”¨Istio mTLSçš„æƒ…å†µä¸‹ï¼Œç”±äºkubeletæ²¡æœ‰Istioé¢å‘çš„è¯ä¹¦ï¼Œå› æ­¤å¥åº·æ£€æŸ¥ä¼šå¤±è´¥ï¼›
- å¯¹äºTCPç±»å‹çš„æ¢é’ˆï¼škubeletä»…æ£€æŸ¥PodæŸç«¯å£æ˜¯å¦å¼€æ”¾ã€‚ä½†åœ¨æ³¨å…¥Istio sidecarçš„æƒ…å†µä¸‹ï¼Œ
  Podå·²ç»è¢«`istio-init`åˆå§‹åŒ–å®¹å™¨æ‰€æ·»åŠ çš„iptablesè§„åˆ™å°†ä»ä»»æ„ç«¯å£æµå…¥Podçš„æµé‡è½¬å‘åˆ°sidecarå¤„ç†ï¼Œå› ä¸ºä»å¤–éƒ¨æ¢æµ‹Podçš„ä»»æ„TCPç«¯å£éƒ½ä¼šæˆåŠŸï¼›
    - `iptables -t nat -A PREROUTING -p tcp -j REDIRECT --to-port 15001`æ˜¯ä¸€æ¡ç¤ºä¾‹iptablesè§„åˆ™ï¼ˆå®é™…ä¼šç¨å¤æ‚ç‚¹ï¼‰ï¼Œ
      å®ƒå°†æ‰€æœ‰è¿›å…¥Podçš„TCPæµé‡è½¬å‘åˆ°sidecarçš„15001ç«¯å£ï¼Œå³åªè¦sidecarå®¹å™¨çš„15001ç«¯å£æ­£å¸¸ç›‘å¬ï¼Œåˆ™å¤–éƒ¨å¯¹Podçš„ä»»æ„TCPç«¯å£æ¢æµ‹éƒ½ä¼šæˆåŠŸã€‚

å…¶ä»–ç±»å‹çš„æ¢é’ˆå¦‚Shellå‘½ä»¤ã€gRPCç±»å‹çš„æ¢é’ˆåˆ™ä¸ä¼šè¢«é‡å†™ã€‚å½“å·¥ä½œè´Ÿè½½éƒ¨ç½²åï¼Œä½ å¯ä»¥æŸ¥çœ‹å…¶æè¿°æ¥äº†è§£é‡å†™åçš„è§„åˆ™ã€‚
å½“ç„¶ï¼Œè‹¥ä½ ä¸å¸Œæœ›ä¸ºå…¨å±€å¼€å¯é»˜è®¤é‡å†™**æˆ–**æƒ³è¦ä¸ºç‰¹å®šè´Ÿè½½å…³é—­è§„åˆ™é‡å†™è¡Œä¸ºï¼ŒIstioä¹Ÿæä¾›äº†å¯¹åº”çš„æ–¹æ³•ï¼Œå…·ä½“æ“ä½œè¾ƒä¸ºç®€å•ï¼Œ
è¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£ [Istio å¥åº·æ£€æŸ¥][Istioå¥åº·æ£€æŸ¥]ã€‚

#### 8.4.8 åè®®é€‰æ‹©

é¦–å…ˆï¼ŒIstio æä¾›çš„sidecarä»£ç†æ”¯æŒåŸå§‹TCPå’ŒåŸºäºTCPçš„HTTPç³»åˆ—åè®®ä»¥åŠgRPCåè®®ã€‚Istio æ³¨å…¥çš„sidecarä¸ä¼šä»£ç†UDPåè®®ï¼Œ
å¤–éƒ¨æµé‡å°†ç›´æ¥åˆ°è¾¾APPå®¹å™¨è€Œä¸ä¼šç”±sidecarè½¬å‘ã€‚

> Istio è¿˜å®éªŒæ€§çš„å¯¹mongoã€redisã€mysqlåè®®è¿›è¡Œæ”¯æŒã€‚

**æ˜¾å¼çš„ä¸ºServiceæŒ‡å®šåè®®ç±»å‹**

å½“æˆ‘ä»¬ä¸ºåº”ç”¨å®šä¹‰K8s Serviceå¯¹è±¡æ—¶ï¼Œé€šå¸¸æŒ‰ç…§ä¸‹é¢çš„æ¨¡æ¿å®šä¹‰ï¼š

```yaml
...
spec:
  type: ClusterIP
  selector:
    ...
  ports:
    - name: custom-name
      port: 80
      targetPort: 80
```

ç„¶è€Œè¿™ç§å®šä¹‰æ–¹å¼å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯æ²¡æœ‰æŒ‡å®šåè®®ç±»å‹ï¼ˆK8så¯èƒ½ä¸éœ€è¦ï¼Œä½†Istioéœ€è¦ï¼‰ã€‚Istioä»…æ”¯æŒå¯¹HTTP/HTTP2æµé‡çš„è¯†åˆ«ï¼Œ
å¯¹äºå…¶ä»–TCPæµé‡ï¼Œç»Ÿä¸€å½“åšä¸é€æ˜çš„åŸå§‹TCPæµé‡è¿›å…¥è·¯ç”±è§„åˆ™ï¼ˆVirtualServiceï¼‰åŒ¹é…ã€‚æ­¤æ—¶ï¼Œå¦‚æœä½ æå‰ä¸ºHTTPSæµé‡å®šä¹‰äº†`tls`
ç±»å‹çš„è·¯ç”±è§„åˆ™ï¼Œé‚£ä¹ˆå¾ˆé—æ†¾ï¼Œè¿™æ¡è§„åˆ™ä¸ä¼šç”Ÿæ•ˆï¼Œsidecarå°†æŒ‰ç…§é»˜è®¤æ–¹å¼è½¬å‘æµé‡ï¼Œé™¤äº†è·¯ç”±è§„åˆ™ï¼Œä¸€äº›é«˜çº§æµé‡ç­–ç•¥ï¼ˆDestinationRuleï¼‰ä¹Ÿéƒ½å°†å½¢åŒè™šè®¾ã€‚

å› æ­¤ï¼Œ**æœ€å¥½æ˜¾å¼çš„ä¸ºServiceæŒ‡å®šåè®®ç±»å‹**ï¼ŒIstioæ”¯æŒä¸¤ç§è¯†åˆ«æ–¹å¼ï¼š

1. Serviceä¸­çš„`ports.name`å‘½åæ ¼å¼ä¸º`<protocol>[-<suffix>]`ï¼Œä¾‹å¦‚`http`æˆ–`http-xxx`ï¼›
    - _ä¸å»ºè®®_ã€‚å› ä¸ºä¸sidecarä¸åŒï¼Œå½“Serviceä½œä¸ºIngressç½‘å…³çš„åç«¯æ—¶ï¼Œç½‘å…³æ— æ³•æ ¹æ®`ports.name`æ¥è¯†åˆ«åè®®ç±»å‹ï¼Œå› æ­¤å»ºè®®éƒ½ä½¿ç”¨ç¬¬äºŒç§ã€‚
2. åœ¨ç‰ˆæœ¬ v1.18+ çš„Kubernetesï¼Œé€šè¿‡ `ports.appProtocol` å­—æ®µé…ç½®åè®®ï¼ˆä¼˜å…ˆäºç¬¬ä¸€ç§ï¼‰ã€‚

**å¤‡æ³¨**ï¼šæœ¬èŠ‚å†…å®¹æ˜¯å¯¹å®˜æ–¹æ–‡æ¡£ [Istio åè®®é€‰æ‹©][Istioåè®®é€‰æ‹©] æ›´æ·±åº¦çš„è§£è¯»ä¸è¡¥å……ã€‚

#### 8.4.9 æµé‡è·¯ç”±è¯¦ç»†è¿‡ç¨‹

å‡è®¾ç°åœ¨å·²ç»å®šä¹‰äº†ä¸€ä¸ª VirtualServiceï¼ˆä¸‹ç®€ç§°VSï¼‰ å’Œ DestinationRuleï¼ˆä¸‹ç®€ç§°DRï¼‰ å¯¹è±¡ï¼Œä¸‹é¢åŸºäºæ­¤å‡è®¾è¿›è¡Œé˜è¿°ã€‚

åœ¨ Istio çš„æµé‡è·¯ç”±ä¸­ï¼Œæˆ‘ä»¬å°†æ•´ä¸ªè¿‡ç¨‹åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š

- **åŒ¹é…å‰ç«¯**ï¼šåŒ¹é…å¾…å¤„ç†æµé‡çš„åè®®ç±»å‹
    - Istio å°†åˆ›å»ºçš„ä¸Šè¿°è·¯ç”±è§„åˆ™å†™å…¥ sidecar å®¹å™¨ï¼ˆæˆ–ç½‘å…³ï¼‰ï¼Œå¯é€šè¿‡`istioctl pc route $SIDE_CAR_POD_ID`è¿›è¡ŒéªŒè¯ï¼›
    - å½“æµé‡å‘é€è‡³ sidecar ï¼ˆæˆ–ç½‘å…³ï¼‰æ—¶ï¼Œåè€…æ ¹æ® VS ä¸­å®šä¹‰çš„æµé‡åè®®è¿›è¡ŒåŒ¹é…ï¼›
        - è‹¥å®šä¹‰äº†`http`åè®®ï¼Œåˆ™åŒ¹é…HTTP/HTTP2/gRPCåè®®ç±»å‹çš„æµé‡ï¼ˆä¼šæ£€æŸ¥[`Host`å¤´éƒ¨][HTTP-host-header]
          æ˜¯å¦åŒ¹é…ï¼Œè‹¥æ˜¯gRPCåˆ™æ£€æŸ¥[`:authority`å¤´éƒ¨][gRPC authorityå¤´éƒ¨]ï¼‰ï¼›
        - è‹¥å®šä¹‰äº†`tls`åè®®ï¼Œåˆ™åŒ¹é…TLSåè®®ç±»å‹ï¼ˆåŒ…å«HTTPSå’ŒTCP over TLSï¼‰çš„æµé‡ï¼ˆä¼šåœ¨é…ç½®äº† `tls.sniHosts`
          çš„æƒ…å†µä¸‹æ£€æŸ¥[`SNI`å¤´éƒ¨][what-is-sni]æ˜¯å¦åŒ¹é…ï¼Œå¹¶ä¸”æ— æ³•ä½¿ç”¨pathå’Œheaderç›¸å…³çš„åŒ¹é…æ¡ä»¶ï¼‰ï¼›
        - è‹¥å®šä¹‰äº†`tcp`åè®®ï¼Œåˆ™åŒ¹é…åŸå§‹TCPåè®®ç±»å‹ï¼ˆåŒ…å«ä»¥ä¸Šæ‰€æœ‰åè®®ï¼‰çš„æµé‡ï¼ˆæ²¡æœ‰å¤´éƒ¨å¯ä¾›æ£€æŸ¥ï¼Œä½†å¯ä»¥æ·»åŠ ç›®æ ‡å­ç½‘ã€ç«¯å£æˆ–æºè´Ÿè½½æ ‡ç­¾çš„åŒ¹é…æ¡ä»¶ï¼‰ï¼›
    - è‹¥ sidecar ï¼ˆæˆ–ç½‘å…³ï¼‰æ²¡æœ‰åŒ¹é…åˆ°é…ç½®ä¸­çš„æµé‡åè®®ï¼Œåˆ™æŒ‰ä»¥ä¸‹æµç¨‹å¤„ç†æµé‡:
        - æƒ…å†µ1ï¼šè‹¥æ˜¯ ingress ç½‘å…³ï¼Œåˆ™è¿”å›404ã€‚è‹¥æ˜¯ egress ç½‘å…³ï¼Œç”±äºæµé‡æœªåˆ°ç½‘å…³ï¼Œåˆ™ç”±sidecarè‡ªè¡Œå¤„ç†ï¼ˆå‚ç…§æƒ…å†µ2ï¼‰ï¼›
        - æƒ…å†µ2ï¼šè‹¥æ˜¯ sidecarï¼Œåˆ™æŒ‰æœ¬åœ°è·¯ç”±è¡¨è½¬å‘ï¼Œç›®çš„åœ°å¯èƒ½æ˜¯ç½‘æ ¼å†…/å¤–çš„æœåŠ¡ï¼Œå…·ä½“è½¬å‘è§„åˆ™å¦‚ä¸‹:
            - è‹¥æ˜¯ç½‘æ ¼å†…æœåŠ¡ï¼Œåˆ™å¯èƒ½ä½¿ç”¨ mTLS è¿›è¡Œè½¬å‘ï¼ˆå‰ææ˜¯é…ç½®äº†ç›¸åº”çš„ mTLS ç­–ç•¥ï¼‰ï¼›
            - å…¶ä»–æƒ…å†µåˆ™åº”è¯¥æ˜¯ç»Ÿä¸€å½“åšä¸é€æ˜çš„TCPæµé‡å¤„ç†ã€‚
- **è½¬å‘åç«¯**ï¼šå†³å®šä»¥ä½•ç§åè®®è½¬å‘æµé‡è‡³åç«¯
    - å½“ sidecar ï¼ˆæˆ–ç½‘å…³ï¼‰æˆåŠŸåŒ¹é…åˆ°æµé‡åè®®åï¼Œä¼šæ ¹æ® VS ä¸­å®šä¹‰çš„`route.destination`è¿›è¡Œè½¬å‘ï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ï¼›
    - è‹¥ VS ä¸­ä¸ºè½¬å‘åç«¯è¿˜å®šä¹‰äº†`subset`ï¼ˆé‚£è¯¥åç«¯ä¸€å®šæ˜¯é›†ç¾¤å†…å®šä¹‰çš„Serviceï¼‰ï¼Œåˆ™æŸ¥æ‰¾ Host å¯¹åº”çš„ DR è§„åˆ™ï¼Œæ ¹æ® DR
      è§„åˆ™ä¸­å®šä¹‰çš„`subset`è¿›è¡Œè½¬å‘ï¼ˆè‹¥æ‰¾ä¸åˆ°å¯¹åº”çš„`subset`åˆ™è¿”å›404ï¼‰ï¼›
        - è½¬å‘æ—¶éµå¾ª DR ä¸­å®šä¹‰çš„`spec.trafficPolicy`ï¼›
    - è‹¥ VS ä¸­æ²¡æœ‰å®šä¹‰`subset`ï¼Œåˆ™ä¹ŸæŸ¥æ‰¾ Host å¯¹åº”çš„ DR è§„åˆ™ï¼Œæ ¹æ® DR è§„åˆ™ä¸­å®šä¹‰çš„`spec.trafficPolicy`è¿›è¡Œè½¬å‘ï¼›
        - è‹¥æ²¡æœ‰å¯¹åº”çš„ DR è§„åˆ™ï¼Œåˆ™æŒ‰æœ¬åœ°è·¯ç”±è¡¨è½¬å‘ï¼›
    - è½¬å‘æ—¶éœ€è¦å†³å®šä½¿ç”¨ä½•ç§åè®®ç±»å‹ï¼š
        - è‹¥åç«¯æ˜¯é›†ç¾¤å†…å®šä¹‰çš„ Serviceï¼Œåˆ™ä½¿ç”¨ Service å®šä¹‰ä¸­çš„`ports[?].appProtocol`æˆ–`ports.name`æŒ‡ç¤ºçš„åè®®ï¼›
        - è‹¥åç«¯æ˜¯é€šè¿‡ Istio ServiceEntry æ³¨å†Œçš„å¤–éƒ¨æœåŠ¡ï¼Œåˆ™ä½¿ç”¨ ServiceEntry ä¸­å®šä¹‰çš„`ports[?].protocol`æŒ‡ç¤ºçš„åè®®ï¼›

**å…³äº Headless Service**

K8sä¸­çš„Headless Service æ˜¯ä¸€ç§ç‰¹æ®Šçš„ Serviceï¼Œå®ƒæ²¡æœ‰ ClusterIPï¼Œè€Œæ˜¯é€šè¿‡DNSè§£æçš„æ–¹å¼ï¼Œå°† Service çš„åç§°è§£æä¸ºä¸€ç»„ Pod çš„
IP åœ°å€ã€‚è¿™ç§ç±»å‹çš„ Service ä½œä¸º Istio çš„è½¬å‘åç«¯æ—¶ï¼ŒIstio è¦æ±‚å®ƒå¿…é¡»å®šä¹‰ `ports`å­—æ®µï¼Œå¦åˆ™æ— æ³•åŒ¹é…ã€‚

## å‚è€ƒ

- [Kuberneteså®æˆ˜@ç¾ Brendan Burns Eddie Villalba](https://book.douban.com/subject/35346815/)
- [Ambient Mesh å…¥é—¨](https://istio.io/latest/zh/docs/ops/ambient/getting-started/)
- [Istio æœåŠ¡ç½‘æ ¼ï¼šæ·±å…¥å­¦ä¹ ç½‘ç»œæµé‡å’Œæ¶æ„](https://mp.weixin.qq.com/s/KXGvEN8obm3efsDdfHbgsA)
- [Enovyå®˜æ–¹æ–‡æ¡£](https://cloudnative.to/envoy/)
- [äº‘åŸç”Ÿæ¶æ„ä¸‹çš„å¾®æœåŠ¡ä¹‹ï¼šenvoy åŸç†åŸºç¡€](https://www.modb.pro/db/211373)
- [Istio å®‰å…¨](https://istio.io/latest/zh/docs/concepts/security)
- [Istio è®¤è¯ç­–ç•¥](https://istio.io/latest/zh/docs/tasks/security/authentication/authn-policy/)
- [Istio æˆæƒ](https://istio.io/latest/zh/docs/concepts/security/#authorization)
- [Envoyæ—¥å¿—åˆ†æ](https://www.zhaohuabing.com/istio-guide/docs/debug-istio/envoy-log/)

[MetricsAPI]: https://kubernetes.io/zh-cn/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/#metrics-api

[cadvisor]: https://learn.lianglianglee.com/ä¸“æ /ç”±æµ…å…¥æ·±åƒé€%20Docker-å®Œ/08%20%20å®¹å™¨ç›‘æ§ï¼šå®¹å™¨ç›‘æ§åŸç†åŠ%20cAdvisor%20çš„å®‰è£…ä¸ä½¿ç”¨.md

[Introducing Ambient Mesh]: https://istio.io/v1.15/blog/2022/introducing-ambient-mesh/

[Whatâ€™s a service meshï¼ŸAnd why do I need one?]: https://dzone.com/articles/whats-a-service-mesh-and-why-do-i-need-one

[Istioå®‰è£…æŒ‡å—]: https://istio.io/latest/zh/docs/setup/install/

[ä½¿ç”¨å¤–éƒ¨æ§åˆ¶å¹³é¢å®‰è£… Istio]: https://istio.io/latest/zh/docs/setup/install/external-controlplane

[æ‰‹åŠ¨æ³¨å…¥]: https://istio.io/latest/zh/docs/setup/additional-setup/sidecar-injection/#manual-sidecar-injection

[Istioæˆæƒç­–ç•¥ä¹‹`when`å­—æ®µ]: https://istio.io/latest/zh/docs/reference/config/security/conditions/

[CUSTOMæˆæƒ]: https://istio.io/latest/zh/docs/reference/config/security/authorization-policy/#AuthorizationPolicy-Action

[éƒ¨ç½²å¤–éƒ¨æˆæƒ]: https://istio.io/latest/zh/docs/tasks/security/authorization/authz-custom/

[Istioæˆæƒç­–ç•¥è§„èŒƒ]: https://istio.io/latest/zh/docs/reference/config/security/authorization-policy/

[Istioæµé‡ç®¡ç†]: https://istio.io/latest/zh/docs/concepts/traffic-management/

[Istioè®¿é—®å¤–éƒ¨æœåŠ¡]: https://istio.io/latest/zh/docs/tasks/traffic-management/egress/egress-control/#access-an-external-http-service

[Istio Egresså®‰å…¨]: https://istio.io/latest/zh/docs/tasks/traffic-management/egress/egress-gateway/#additional-security-considerations

[Istio vs Linkerd]: https://imesh.ai/blog/istio-vs-linkerd-the-best-service-mesh-for-2023/

[Istioå¥åº·æ£€æŸ¥]: https://istio.io/latest/zh/docs/ops/configuration/mesh/app-health-check/

[Istioåè®®é€‰æ‹©]: https://istio.io/latest/zh/docs/ops/configuration/traffic-management/protocol-selection/

[HTTP-host-header]: https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host

[gRPC authorityå¤´éƒ¨]: https://chromium.googlesource.com/external/github.com/grpc/grpc/+/HEAD/doc/PROTOCOL-HTTP2.md#protocol

[what-is-sni]: https://www.cloudflare.com/zh-cn/learning/ssl/what-is-sni/